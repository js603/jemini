{"ast":null,"code":"import React,{useState,useEffect,useRef}from'react';import{initializeApp}from'firebase/app';import{getAuth,signInAnonymously,signInWithCustomToken,onAuthStateChanged}from'firebase/auth';import{getFirestore,doc,setDoc,getDoc,collection,query,onSnapshot,serverTimestamp,addDoc,getDocs,deleteDoc,runTransaction,orderBy,limit}from'firebase/firestore';// ====================================================================\n// Firebase configuration information - 수정 금지\nimport{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const defaultFirebaseConfig={apiKey:\"AIzaSyBNJtmpRWzjobrY556bnHkwbZmpFJqgPX8\",authDomain:\"text-adventure-game-cb731.firebaseapp.com\",projectId:\"text-adventure-game-cb731\",storageBucket:\"text-adventure-game-cb731.appspot.com\",messagingSenderId:\"1092941614820\",appId:\"1:1092941614820:web:5545f36014b73c268026f1\",measurementId:\"G-FNGF42T1FP\"};// 수정금지\nconst firebaseConfig=defaultFirebaseConfig;const appId=firebaseConfig.projectId;const initialAuthToken=null;// ====================================================================\nconst professions={'1':{name:'몰락한 귀족/기사',motivation:'가문의 몰락 원인을 조사하고, 잃어버린 가문의 보물을 찾아야 합니다.'},'2':{name:'평범한 마을 사람/농부',motivation:'갑자기 마을에 나타난 괴생명체로부터 마을을 지켜야 합니다.'},'3':{name:'젊은 마법사/견습생',motivation:'스승님의 실종에 대한 단서를 찾아야 합니다.'},'4':{name:'용병/모험가',motivation:'의뢰받은 임무를 수행하던 중 예상치 못한 사건에 휘말렸습니다.'},'5':{name:'도적/암살자',motivation:'길드에서 내려온 첫 번째 임무를 완수하고, 그 과정에서 수상한 음모를 감지해야 합니다.'},'6':{name:'왕족/공주/왕자',motivation:'왕실 내의 불화와 암투 속에서 자신의 입지를 다져야 합니다.'}};// Firestore 경로 유틸\nconst getMainScenarioRef=(db,appId)=>doc(db,'artifacts',appId,'public','data','mainScenario','main');const getPrivatePlayerStateRef=(db,appId,userId)=>doc(db,'artifacts',appId,'users',userId,'playerState','state');const getGameStatusRef=(db,appId)=>doc(db,'artifacts',appId,'public','data','gameStatus','status');const getMajorEventsRef=(db,appId)=>collection(db,'artifacts',appId,'public','data','majorEvents');const getPersonalStoryLogRef=(db,appId,userId)=>collection(db,'artifacts',appId,'users',userId,'personalStoryLog');// 상태 초기화 유틸\nconst getDefaultGameState=()=>({publicLog:[],choices:[],player:{currentLocation:'방랑자의 안식처'},subtleClues:[],lastUpdate:null});const getDefaultPrivatePlayerState=()=>({stats:{strength:10,intelligence:10,agility:10,charisma:10},inventory:[],initialMotivation:'',reputation:{},activeQuests:[],companions:[],knownClues:[],characterCreated:false,profession:'',choices:[],groups:[],npcRelations:{},knownEventIds:[]});function App(){const[gameState,setGameState]=useState(getDefaultGameState());const[personalStoryLog,setPersonalStoryLog]=useState([]);const[privatePlayerState,setPrivatePlayerState]=useState(getDefaultPrivatePlayerState());const[displayedChoices,setDisplayedChoices]=useState([]);const[choicesTimestamp,setChoicesTimestamp]=useState(null);const[isTextLoading,setIsTextLoading]=useState(false);const[activeUsers,setActiveUsers]=useState([]);const[chatMessages,setChatMessages]=useState([]);const[currentChatMessage,setCurrentChatMessage]=useState('');const[actionLocks,setActionLocks]=useState({});const[db,setDb]=useState(null);const[auth,setAuth]=useState(null);const[userId,setUserId]=useState(null);const[isAuthReady,setIsAuthReady]=useState(false);const logEndRef=useRef(null);const chatEndRef=useRef(null);const[nickname,setNickname]=useState(()=>localStorage.getItem('nickname')||'');const[showNicknameModal,setShowNicknameModal]=useState(!localStorage.getItem('nickname'));const[nicknameInput,setNicknameInput]=useState('');const[accordion,setAccordion]=useState({gameLog:true,chat:true,users:true,playerInfo:true,chronicle:true});const[showResetModal,setShowResetModal]=useState(false);const[isResetting,setIsResetting]=useState(false);const[llmError,setLlmError]=useState(null);const[llmRetryPrompt,setLlmRetryPrompt]=useState(null);const[isLoading,setIsLoading]=useState(true);const[allMajorEvents,setAllMajorEvents]=useState([]);const[knownMajorEvents,setKnownMajorEvents]=useState([]);const handleNicknameSubmit=()=>{if(nicknameInput.trim()){const finalNickname=nicknameInput.trim();setNickname(finalNickname);localStorage.setItem('nickname',finalNickname);setShowNicknameModal(false);if(userId&&db){const userDocRef=doc(db,'artifacts',appId,'public','data','activeUsers',userId);setDoc(userDocRef,{nickname:finalNickname},{merge:true});}}};const getDisplayName=uid=>{const safeUid=String(uid||'');if(uid===userId){const safeUserId=String(userId||'');return nickname||`플레이어 ${safeUserId.substring(0,4)}`;}const user=activeUsers.find(u=>u.id===uid);return(user===null||user===void 0?void 0:user.nickname)||`플레이어 ${safeUid.substring(0,4)}`;};const resetAllGameData=async()=>{if(!db||!isAuthReady)return;setIsResetting(true);try{const collectionsToDelete=[collection(db,'artifacts',appId,'public','data','chatMessages'),collection(db,'artifacts',appId,'public','data','activeUsers'),getMajorEventsRef(db,appId)];for(const colRef of collectionsToDelete){const snapshot=await getDocs(colRef);for(const docSnap of snapshot.docs){await deleteDoc(docSnap.ref);}}const usersColRef=collection(db,'artifacts',appId,'users');const usersSnapshot=await getDocs(usersColRef);for(const userDoc of usersSnapshot.docs){const personalLogRef=getPersonalStoryLogRef(db,appId,userDoc.id);const personalLogSnapshot=await getDocs(personalLogRef);for(const logDoc of personalLogSnapshot.docs){await deleteDoc(logDoc.ref);}const playerStateColRef=collection(db,'artifacts',appId,'users',userDoc.id,'playerState');const playerStateSnapshot=await getDocs(playerStateColRef);for(const stateDoc of playerStateSnapshot.docs){await deleteDoc(stateDoc.ref);}await deleteDoc(doc(db,'artifacts',appId,'users',userDoc.id));}await deleteDoc(getMainScenarioRef(db,appId));await deleteDoc(getGameStatusRef(db,appId));localStorage.clear();setGameState(getDefaultGameState());setPrivatePlayerState(getDefaultPrivatePlayerState());setChatMessages([]);setActionLocks({});console.log(\"모든 서버 및 클라이언트 데이터가 성공적으로 초기화되었습니다.\");}catch(e){console.error(\"전체 데이터 초기화 중 오류 발생:\",e);}finally{setIsResetting(false);setShowResetModal(false);window.location.reload();}};useEffect(()=>{try{const app=initializeApp(firebaseConfig);const firestoreDb=getFirestore(app);const firebaseAuth=getAuth(app);setDb(firestoreDb);setAuth(firebaseAuth);const unsubscribeAuth=onAuthStateChanged(firebaseAuth,async user=>{if(user){setUserId(user.uid);setIsAuthReady(true);}else{await(initialAuthToken?signInWithCustomToken(firebaseAuth,initialAuthToken):signInAnonymously(firebaseAuth));}});return()=>unsubscribeAuth();}catch(error){console.error(\"Firebase initialization error:\",error);setLlmError(\"Firebase 초기화에 실패했습니다.\");}},[]);useEffect(()=>{if(!isAuthReady||!db||!userId)return;const privateStateRef=getPrivatePlayerStateRef(db,appId,userId);getDoc(privateStateRef).then(docSnap=>{if(!docSnap.exists()){setDoc(privateStateRef,getDefaultPrivatePlayerState());}});const unsubscribePrivateState=onSnapshot(privateStateRef,snapshot=>{if(snapshot.exists()){setPrivatePlayerState({...getDefaultPrivatePlayerState(),...snapshot.data()});}if(isLoading)setIsLoading(false);});const personalLogQuery=query(getPersonalStoryLogRef(db,appId,userId),orderBy(\"timestamp\",\"desc\"),limit(50));const unsubscribePersonalLog=onSnapshot(personalLogQuery,snapshot=>{const stories=snapshot.docs.map(doc=>({id:doc.id,...doc.data()})).reverse();setPersonalStoryLog(stories);});return()=>{unsubscribePrivateState();unsubscribePersonalLog();};},[isAuthReady,db,userId]);useEffect(()=>{if(!isAuthReady||!db)return;const unsubscribes=[onSnapshot(getMainScenarioRef(db,appId),snap=>{if(snap.exists()){const data=snap.data();setGameState(prev=>{var _data$player;return{...prev,publicLog:data.publicLog||[],choices:data.choices||[],player:{...prev.player,currentLocation:((_data$player=data.player)===null||_data$player===void 0?void 0:_data$player.currentLocation)||prev.player.currentLocation},subtleClues:data.subtleClues||[],lastUpdate:data.lastUpdate};});}}),onSnapshot(getGameStatusRef(db,appId),docSnap=>{var _docSnap$data;setActionLocks(((_docSnap$data=docSnap.data())===null||_docSnap$data===void 0?void 0:_docSnap$data.actionLocks)||{});}),onSnapshot(query(collection(db,'artifacts',appId,'public','data','chatMessages')),snapshot=>{const messages=snapshot.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>{var _a$timestamp,_b$timestamp;return(((_a$timestamp=a.timestamp)===null||_a$timestamp===void 0?void 0:_a$timestamp.toMillis())||0)-(((_b$timestamp=b.timestamp)===null||_b$timestamp===void 0?void 0:_b$timestamp.toMillis())||0);});setChatMessages(messages);}),onSnapshot(query(collection(db,'artifacts',appId,'public','data','activeUsers')),snapshot=>{const cutoffTime=Date.now()-60*1000;const users=snapshot.docs.map(d=>({id:d.id,...d.data()})).filter(u=>u.lastActive&&u.lastActive.toMillis()>cutoffTime);setActiveUsers(users);}),onSnapshot(query(getMajorEventsRef(db,appId)),snapshot=>{const events=snapshot.docs.map(doc=>({id:doc.id,...doc.data()})).sort((a,b)=>{var _a$timestamp2,_b$timestamp2;return(((_a$timestamp2=a.timestamp)===null||_a$timestamp2===void 0?void 0:_a$timestamp2.toMillis())||0)-(((_b$timestamp2=b.timestamp)===null||_b$timestamp2===void 0?void 0:_b$timestamp2.toMillis())||0);});setAllMajorEvents(events);})];return()=>unsubscribes.forEach(unsub=>unsub());},[isAuthReady,db]);useEffect(()=>{if(!db||!userId||allMajorEvents.length===0)return;const currentKnownIds=privatePlayerState.knownEventIds||[];const newDiscoveredEvents=[];allMajorEvents.forEach(event=>{if((event===null||event===void 0?void 0:event.location)===gameState.player.currentLocation&&!currentKnownIds.includes(event.id)){newDiscoveredEvents.push(event.id);}});if(newDiscoveredEvents.length>0){const privateStateRef=getPrivatePlayerStateRef(db,appId,userId);const updatedKnownEventIds=[...currentKnownIds,...newDiscoveredEvents];setDoc(privateStateRef,{knownEventIds:updatedKnownEventIds},{merge:true});}const knownEvents=allMajorEvents.filter(event=>(privatePlayerState.knownEventIds||[]).includes(event===null||event===void 0?void 0:event.id));setKnownMajorEvents(knownEvents);},[gameState.player.currentLocation,allMajorEvents,privatePlayerState.knownEventIds,db,userId]);useEffect(()=>{if(!db||!userId||!nickname)return;const userDocRef=doc(db,'artifacts',appId,'public','data','activeUsers',userId);setDoc(userDocRef,{lastActive:serverTimestamp(),nickname:nickname||`플레이어 ${userId.substring(0,4)}`,profession:privatePlayerState.profession},{merge:true});const handleVisibilityChange=()=>{if(document.visibilityState==='visible'){setDoc(userDocRef,{lastActive:serverTimestamp()},{merge:true});}};document.addEventListener('visibilitychange',handleVisibilityChange);return()=>document.removeEventListener('visibilitychange',handleVisibilityChange);},[db,userId,nickname,privatePlayerState.profession]);useEffect(()=>{if(accordion.gameLog&&logEndRef.current)logEndRef.current.scrollIntoView({behavior:\"smooth\"});},[personalStoryLog,accordion.gameLog]);useEffect(()=>{if(accordion.chat&&chatEndRef.current)chatEndRef.current.scrollIntoView({behavior:\"smooth\"});},[chatMessages,accordion.chat]);const systemPrompt=`\n    ### 페르소나 (Persona)\n    당신은 이 세계의 '수호자'이자 '사관(史官)'이며, 플레이어들에게는 '게임 마스터(GM)'로 알려져 있습니다. 당신의 임무는 단순한 이야기 생성을 넘어, 일관된 역사와 살아 숨 쉬는 세계관을 구축하는 것입니다. 모든 묘사와 사건은 이 세계의 정해진 분위기와 역사적 사실 위에서 피어나는 한 편의 서사시여야 합니다.\n\n    ### 세계관 설정: 페이디드 판타지 (Faded Fantasy)\n    이 세계는 오래되었고, 과거의 영광은 빛이 바랬습니다. 위대한 왕국들은 쇠락의 길을 걷고 있으며, 잊혀진 유적에는 강력하지만 위험한 마법의 흔적이 남아있습니다. 도시는 화려함 뒤에 부패를 숨기고 있고, 황야에는 미지의 위험이 도사립니다. 사람들은 서로를 쉽게 믿지 않으며, 각자의 생존을 위해 발버둥 칩니다. 당신의 모든 묘사는 이 '아름답지만 슬픈' 분위기를 반영해야 합니다.\n\n    ### 핵심 구동 원칙\n    1.  **일관성의 원칙 (Canon) (가장 중요)**: User Prompt에 제공된 [세계의 연대기], [주요 세력 및 인물], [플레이어 정보]는 이 세계의 '정사(正史)'입니다. 당신은 절대 이 사실들을 왜곡하거나 모순되는 내용을 만들어서는 안 됩니다. 이 정보들을 바탕으로 세계를 확장해 나가십시오.\n\n    2.  **상호연결성의 원칙 (Interconnection)**: 당신은 뛰어난 이야기꾼으로서, 현재 발생하는 사건을 과거의 역사나 다른 플레이어의 행적과 연결지어야 합니다. 예를 들어, 한 플레이어가 던전에서 발견한 고대 문양은, 다른 플레이어가 수도에서 쫓고 있는 비밀 결사의 상징일 수 있습니다. 세상이 서로 연결되어 있음을 플레이어가 느끼게 하십시오.\n\n    3.  **장면 중심의 서사 원칙 (Scene-Centric)**: 플레이어의 '[선택]'은 하나의 '장면'을 시작하는 것과 같습니다. 당신의 \"personalStory\"는 반드시 그 선택의 즉각적인 결과와 묘사로 시작되어야 합니다. 대화라면 실제 대화 내용이, 행동이라면 그 행동의 과정과 결과가 구체적으로 서술되어야 합니다.\n\n    4.  **'보여주기, 말하지 않기' 원칙 (Show, Don't Tell)**: \"마을이 가난하다\"고 설명하지 마십시오. 대신 \"굶주린 아이들이 흙바닥에 주저앉아 있고, 대부분의 건물은 지붕이 허술하게 덧대어져 있다\"고 묘사하십시오. 플레이어가 스스로 분위기와 상황을 파악하게 만드십시오.\n\n    ### JSON 출력 구조\n    {\n      \"publicLogEntry\": \"만약 이 행동이 주변의 다른 플레이어나 NPC가 명백히 인지할 수 있는 '공개적인 사건'이라면, 3인칭 시점의 객관적인 기록을 한 문장으로 작성. (예: '플레이어 A가 경비병을 공격했다.') 그렇지 않으면 null.\",\n      \"personalStory\": \"플레이어의 선택으로 시작된 '장면'에 대한 상세하고 감정적인 1인칭 또는 2인칭 서사. 플레이어의 내면 묘사, 감각, 대화 내용 등을 포함.\",\n      \"choices\": [\"'personalStory'의 결과에 따라 플레이어가 할 수 있는 논리적인 다음 행동들.\"],\n      \"privateChoices\": [\"오직 행동 주체의 특성 때문에 가능한 특별한 행동들.\"],\n      \"groupChoices\": [\"같은 그룹 소속원들만 할 수 있는 비밀 행동들.\"],\n      \"majorEvent\": {\n        \"summary\": \"만약 이 사건이 후대에 '역사'로 기록될 만한 중대한 전환점이라면, 사관의 어조로 요약. (예: '왕국력 342년, 방랑자의 안식처에서 발생한 이 사건은 훗날 '붉은 달 교단'의 부흥을 알리는 서막이 되었다.') 그렇지 않으면 null.\",\n        \"location\": \"사건이 발생한 장소 이름. majorEvent가 있을 경우 필수.\"\n      },\n      \"sharedStateUpdates\": {\n        \"location\": \"플레이어 그룹의 현재 위치. 변경되었을 경우에만 포함.\",\n        \"subtleClues\": [{\"location\": \"장소명\", \"clue\": \"새롭게 생성된 단서\"}]\n      },\n      \"privateStateUpdates\": {\n        \"inventory\": [\"업데이트된 전체 인벤토리 목록\"],\n        \"stats\": {\"strength\": 12, \"intelligence\": 10, \"agility\": 10, \"charisma\": 10 },\n        \"activeQuests\": [\"업데이트된 개인 퀘스트 목록\"],\n        \"knownClues\": [\"새롭게 알게 된 단서 목록\"],\n        \"groups\": [\"업데이트된 소속 그룹 목록\"],\n        \"npcRelations\": {\"가라크\": 55, \"엘라라\": -10}\n      }\n    }\n  `;const buildLlmPrompt=choice=>{var _privatePlayerState$p,_gameState$player$cur;const factions=(privatePlayerState.groups||[]).join(', ')||'없음';const npcs=Object.entries(privatePlayerState.npcRelations||{}).map(_ref=>{let[name,value]=_ref;return`${name} (관계도: ${value})`;}).join(', ')||'없음';const personalLogEntries=(personalStoryLog||[]).slice(-10).map(entry=>{var _entry$action,_entry$story;return`[나의 행동: ${(_entry$action=entry===null||entry===void 0?void 0:entry.action)!==null&&_entry$action!==void 0?_entry$action:'알 수 없는 행동'}] -> ${(_entry$story=entry===null||entry===void 0?void 0:entry.story)!==null&&_entry$story!==void 0?_entry$story:''}`;}).join('\\n');const publicLogEntries=(gameState.publicLog||[]).slice(-10).map(entry=>{var _entry$actor$displayN,_entry$actor,_entry$log;return`[${(_entry$actor$displayN=entry===null||entry===void 0?void 0:(_entry$actor=entry.actor)===null||_entry$actor===void 0?void 0:_entry$actor.displayName)!==null&&_entry$actor$displayN!==void 0?_entry$actor$displayN:'누군가'}] ${(_entry$log=entry===null||entry===void 0?void 0:entry.log)!==null&&_entry$log!==void 0?_entry$log:''}`;}).join('\\n');const userPrompt=`\n[세계의 연대기 (World Chronicle)]\n- 내가 발견한, 세상에 일어난 주요 역사적 사건들입니다. 이 기록은 절대적인 사실입니다.\n- ${knownMajorEvents.length>0?knownMajorEvents.map(h=>h.summary).join('\\n- '):\"아직 기록된 역사가 없음\"}\n\n[나의 여정록 (My Journey Log) - 최근 기록]\n- 이것은 나의 개인적인 경험과 생각의 기록입니다.\n${personalLogEntries||\"아직 여정을 시작하지 않음\"}\n\n[주변의 최근 사건들 (Recent Public Events)]\n- 내가 있는 장소 주변에서 최근 일어난 공개적인 사건들입니다.\n${publicLogEntries||\"최근에 주변에서 별다른 일은 없었음\"}\n\n[주요 세력 및 인물 (Key Factions & NPCs)]\n- 나와 관련된 주요 세력: ${factions}\n- 나와 관계를 맺은 주요 인물: ${npcs}\n\n[나의 현재 상태 (My Current State)]\n- 이름: ${getDisplayName(userId)}\n- 직업: ${(_privatePlayerState$p=privatePlayerState.profession)!==null&&_privatePlayerState$p!==void 0?_privatePlayerState$p:'미정'}\n- 현재 위치: ${(_gameState$player$cur=gameState.player.currentLocation)!==null&&_gameState$player$cur!==void 0?_gameState$player$cur:'알 수 없는 곳'}\n- 소지품 및 능력치: ${JSON.stringify({inventory:privatePlayerState.inventory||[],stats:privatePlayerState.stats||{}})}\n\n[주변 관찰자 (Nearby Observers)]\n- 현재 장소에 함께 있는 다른 플레이어들입니다. 이들은 이번 턴에 행동하지 않습니다.\n- ${(activeUsers||[]).map(u=>u.nickname||`플레이어 ${u.id.substring(0,4)}`).join(', ')||\"주변에 다른 플레이어가 없음\"}\n\n[나의 선택 (My Action)]\n- 위 모든 상황 속에서, 나는 다음 행동을 선택했습니다. 이 선택으로 시작될 '장면'을 연출해주십시오.\n- \"${choice}\"\n`;return userPrompt;};const callGeminiTextLLM=async userPrompt=>{setIsTextLoading(true);const mainApiKey=\"AIzaSyDC11rqjU30OJnLjaBFOaazZV0klM5raU8\";const backupApiKey=\"AIzaSyAhscNjW8GmwKPuKzQ47blCY_bDanR-B84\";const getApiUrl=apiKey=>`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;const payload={contents:[{role:\"user\",parts:[{text:systemPrompt}]},{role:\"model\",parts:[{text:\"{}\"}]},{role:\"user\",parts:[{text:userPrompt}]}]};const tryGeminiCall=async apiKey=>fetch(getApiUrl(apiKey),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});try{var _result$candidates,_result$candidates$,_result$candidates$$c,_result$candidates$$c2,_result$candidates$$c3;let response=await tryGeminiCall(mainApiKey);if(!response.ok){response=await tryGeminiCall(backupApiKey);}if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}const result=await response.json();const llmOutputText=(_result$candidates=result.candidates)===null||_result$candidates===void 0?void 0:(_result$candidates$=_result$candidates[0])===null||_result$candidates$===void 0?void 0:(_result$candidates$$c=_result$candidates$.content)===null||_result$candidates$$c===void 0?void 0:(_result$candidates$$c2=_result$candidates$$c.parts)===null||_result$candidates$$c2===void 0?void 0:(_result$candidates$$c3=_result$candidates$$c2[0])===null||_result$candidates$$c3===void 0?void 0:_result$candidates$$c3.text;const jsonMatch=llmOutputText===null||llmOutputText===void 0?void 0:llmOutputText.match(/\\{[\\s\\S]*\\}/);if(jsonMatch)return JSON.parse(jsonMatch[0]);throw new Error(\"Valid JSON object not found in LLM response.\");}catch(error){console.error(\"LLM API call error:\",error);setLlmError(error.message||'LLM 호출 실패');return null;}finally{setIsTextLoading(false);}};const sendChatMessage=async()=>{if(!db||!userId||!isAuthReady||!currentChatMessage.trim())return;try{const chatCollectionRef=collection(db,'artifacts',appId,'public','data','chatMessages');await addDoc(chatCollectionRef,{userId,displayName:getDisplayName(userId),message:currentChatMessage,timestamp:serverTimestamp()});setCurrentChatMessage('');}catch(error){console.error(\"Error sending chat message:\",error);}};const updateNarratives=async(llmResponse,playerChoice)=>{var _llmResponse$majorEve,_llmResponse$majorEve2,_updatedScenarioDoc$d;const mainScenarioRef=getMainScenarioRef(db,appId);await runTransaction(db,async transaction=>{var _llmResponse$sharedSt,_llmResponse$sharedSt2;const scenarioDoc=await transaction.get(mainScenarioRef);if(!scenarioDoc.exists()){throw new Error(\"치명적 오류: 게임의 기본 시나리오 데이터가 없습니다.\");}const currentData=scenarioDoc.data();const updates={choices:llmResponse.choices||[],'player.currentLocation':((_llmResponse$sharedSt=llmResponse.sharedStateUpdates)===null||_llmResponse$sharedSt===void 0?void 0:_llmResponse$sharedSt.location)||currentData.player.currentLocation,subtleClues:((_llmResponse$sharedSt2=llmResponse.sharedStateUpdates)===null||_llmResponse$sharedSt2===void 0?void 0:_llmResponse$sharedSt2.subtleClues)||currentData.subtleClues,lastUpdate:serverTimestamp()};if(llmResponse.publicLogEntry){const newPublicLog={actor:{id:userId,displayName:getDisplayName(userId)},log:llmResponse.publicLogEntry,timestamp:new Date()};updates.publicLog=[...(currentData.publicLog||[]),newPublicLog];}transaction.update(mainScenarioRef,updates);});const personalLogRef=getPersonalStoryLogRef(db,appId,userId);await addDoc(personalLogRef,{action:playerChoice,story:llmResponse.personalStory||\"특별한 일은 일어나지 않았다.\",timestamp:serverTimestamp()});if((_llmResponse$majorEve=llmResponse.majorEvent)!==null&&_llmResponse$majorEve!==void 0&&_llmResponse$majorEve.summary&&(_llmResponse$majorEve2=llmResponse.majorEvent)!==null&&_llmResponse$majorEve2!==void 0&&_llmResponse$majorEve2.location){await addDoc(getMajorEventsRef(db,appId),{...llmResponse.majorEvent,timestamp:serverTimestamp(),actor:{id:userId,displayName:getDisplayName(userId)}});}await updatePrivateState(llmResponse);const newPublicChoices=llmResponse.choices||[];setDisplayedChoices(newPublicChoices);const updatedScenarioDoc=await getDoc(mainScenarioRef);setChoicesTimestamp(((_updatedScenarioDoc$d=updatedScenarioDoc.data())===null||_updatedScenarioDoc$d===void 0?void 0:_updatedScenarioDoc$d.lastUpdate)||null);};const updatePrivateState=async llmResponse=>{const privateStateRef=getPrivatePlayerStateRef(db,appId,userId);const updates=llmResponse.privateStateUpdates?{...llmResponse.privateStateUpdates}:{};const newPrivateChoices=llmResponse.privateChoices||[];const newGroupChoices=llmResponse.groupChoices||[];updates.choices=[...newPrivateChoices,...newGroupChoices];if(Object.keys(updates).length>0){await setDoc(privateStateRef,updates,{merge:true});}};const getActionScope=choice=>{const npcMatch=choice.match(/(.+)에게 말을 건다/);if(npcMatch){return`npc:${npcMatch[1].trim()}`;}return`location:${gameState.player.currentLocation}`;};const createCharacter=async choice=>{setIsTextLoading(true);try{const choiceKey=choice.split('.')[0];const selectedProfession=professions[choiceKey];if(selectedProfession){const privateStateRef=getPrivatePlayerStateRef(db,appId,userId);await setDoc(privateStateRef,{...getDefaultPrivatePlayerState(),characterCreated:true,profession:selectedProfession.name,initialMotivation:selectedProfession.motivation},{merge:true});const personalLogRef=getPersonalStoryLogRef(db,appId,userId);await addDoc(personalLogRef,{action:\"여정에 나서다\",story:`나는 '${selectedProfession.name}'으로서, '${selectedProfession.motivation}'라는 동기를 품고 이 세상에 첫 발을 내디뎠다.`,timestamp:serverTimestamp()});const mainScenarioRef=getMainScenarioRef(db,appId);const newPublicLogEntry={actor:{id:userId,displayName:getDisplayName(userId)},log:`새로운 모험가, '${getDisplayName(userId)}'님이 여관에 모습을 드러냈습니다.`,timestamp:new Date()};await runTransaction(db,async transaction=>{const scenarioDoc=await transaction.get(mainScenarioRef);const baseData=scenarioDoc.exists()?scenarioDoc.data():getDefaultGameState();const updatedPublicLog=[...(baseData.publicLog||[]),newPublicLogEntry];const newChoices=[\"여관을 둘러본다.\",\"다른 모험가에게 말을 건다.\",\"여관 주인에게 정보를 묻는다.\"];const payload={publicLog:updatedPublicLog,choices:newChoices,player:baseData.player,subtleClues:baseData.subtleClues||[],lastUpdate:serverTimestamp()};transaction.set(mainScenarioRef,payload);});const updatedDoc=await getDoc(mainScenarioRef);if(updatedDoc.exists()){setDisplayedChoices(updatedDoc.data().choices);setChoicesTimestamp(updatedDoc.data().lastUpdate);}}}catch(e){console.error(\"등장 이벤트 추가 실패: \",e);setLlmError(\"게임 세계에 합류하는 중 오류가 발생했습니다.\");}finally{setIsTextLoading(false);}};const performPlayerAction=async choice=>{setIsTextLoading(true);setLlmRetryPrompt({playerChoice:choice});const mainScenarioRef=getMainScenarioRef(db,appId);const gameStatusRef=getGameStatusRef(db,appId);const scope=getActionScope(choice);try{var _await$getDoc$data;const freshScenarioDoc=await getDoc(mainScenarioRef);const serverTimestampValue=freshScenarioDoc.exists()?freshScenarioDoc.data().lastUpdate:null;if(choicesTimestamp&&serverTimestampValue&&choicesTimestamp.toMillis()<serverTimestampValue.toMillis()){const conflictStory=`당신이 '${choice}'(을)를 하려던 찰나, 세상은 이미 당신의 예상과 달라져 있었습니다. 주변을 다시 둘러보니 상황이 바뀌어 있습니다.`;const personalLogRef=getPersonalStoryLogRef(db,appId,userId);await addDoc(personalLogRef,{action:choice,story:conflictStory,timestamp:serverTimestamp()});const newChoices=freshScenarioDoc.data().choices||[];setDisplayedChoices(newChoices);setChoicesTimestamp(serverTimestampValue);setIsTextLoading(false);return;}const currentLocks=((_await$getDoc$data=(await getDoc(gameStatusRef)).data())===null||_await$getDoc$data===void 0?void 0:_await$getDoc$data.actionLocks)||{};if(currentLocks[scope]&&currentLocks[scope]!==userId){throw new Error(`현재 '${scope.split(':')[1]}'(은)는 다른 플레이어(${getDisplayName(currentLocks[scope])})가 사용 중입니다.`);}await setDoc(gameStatusRef,{actionLocks:{...currentLocks,[scope]:userId}},{merge:true});const userPromptText=buildLlmPrompt(choice);const llmResponse=await callGeminiTextLLM(userPromptText);if(llmResponse){await updateNarratives(llmResponse,choice);setLlmError(null);setLlmRetryPrompt(null);}else if(!llmError){setLlmError(\"LLM으로부터 유효한 응답을 받지 못했습니다.\");}}catch(error){console.error(\"행동 처리 중 오류:\",error.message);setLlmError(error.message);}finally{const finalLocksDoc=await getDoc(gameStatusRef);if(finalLocksDoc.exists()){const finalLocks=finalLocksDoc.data().actionLocks||{};if(finalLocks[scope]===userId){delete finalLocks[scope];await setDoc(gameStatusRef,{actionLocks:finalLocks},{merge:true});}}setIsTextLoading(false);}};const handleChoiceClick=async choice=>{if(isTextLoading)return;if(!privatePlayerState.characterCreated){await createCharacter(choice);}else{await performPlayerAction(choice);}};const toggleAccordion=key=>{setAccordion(prev=>({...prev,[key]:!prev[key]}));};const LlmErrorModal=()=>/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 text-center\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-xl font-bold text-red-400\",children:\"\\uC624\\uB958\\uAC00 \\uBC1C\\uC0DD\\uD588\\uC2B5\\uB2C8\\uB2E4\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-200\",children:llmError}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-center gap-4\",children:[llmRetryPrompt&&/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md\",onClick:async()=>{setLlmError(null);if(llmRetryPrompt.playerChoice){await handleChoiceClick(llmRetryPrompt.playerChoice);}},children:\"\\uC7AC\\uC2DC\\uB3C4\"}),/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-gray-600 hover:bg-gray-700 font-bold rounded-md\",onClick:()=>{setLlmError(null);setLlmRetryPrompt(null);},children:\"\\uB2EB\\uAE30\"})]})]})});if(showNicknameModal){return/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-xl font-bold text-gray-100\",children:\"\\uB2C9\\uB124\\uC784\\uC744 \\uC785\\uB825\\uD558\\uC138\\uC694\"}),/*#__PURE__*/_jsx(\"input\",{className:\"w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg\",placeholder:\"\\uB2C9\\uB124\\uC784\",value:nicknameInput,onChange:e=>setNicknameInput(e.target.value),onKeyDown:e=>{if(e.key==='Enter')handleNicknameSubmit();},autoFocus:true}),/*#__PURE__*/_jsx(\"button\",{className:\"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md transition duration-300 disabled:opacity-50\",onClick:handleNicknameSubmit,disabled:!nicknameInput.trim(),children:\"\\uC2DC\\uC791\\uD558\\uAE30\"})]})});}if(isLoading){return/*#__PURE__*/_jsxs(\"div\",{className:\"min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-16 w-16 border-b-2 border-gray-300\"}),/*#__PURE__*/_jsx(\"span\",{className:\"ml-4 text-xl\",children:\"\\uB370\\uC774\\uD130\\uB97C \\uBD88\\uB7EC\\uC624\\uB294 \\uC911...\"})]});}const renderGameLog=()=>/*#__PURE__*/_jsxs(\"div\",{className:\"mb-2\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between cursor-pointer select-none\",onClick:()=>toggleAccordion('gameLog'),children:[/*#__PURE__*/_jsx(\"h2\",{className:\"text-lg font-bold text-gray-100\",children:\"\\uB098\\uC758 \\uC5EC\\uC815\\uB85D\"}),/*#__PURE__*/_jsx(\"div\",{className:\"text-xl\",children:accordion.gameLog?'▼':'▲'})]}),accordion.gameLog&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex justify-end mb-2\",children:/*#__PURE__*/_jsx(\"button\",{className:\"px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded-md\",onClick:()=>setShowResetModal(true),children:\"\\uC804\\uCCB4 \\uB370\\uC774\\uD130 \\uCD08\\uAE30\\uD654\"})}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex-grow bg-gray-700 p-4 rounded-md overflow-y-auto h-96 custom-scrollbar text-sm md:text-base leading-relaxed\",style:{maxHeight:'24rem'},children:[(personalStoryLog||[]).length===0&&!privatePlayerState.characterCreated&&/*#__PURE__*/_jsxs(\"div\",{className:\"mb-4 p-2 rounded bg-gray-900/50 text-center\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-yellow-300 font-semibold italic text-lg\",children:\"\\uBAA8\\uD5D8\\uC758 \\uC11C\\uB9C9\"}),/*#__PURE__*/_jsx(\"p\",{className:\"whitespace-pre-wrap mt-1\",children:\"\\uB2F9\\uC2E0\\uC740 \\uC5B4\\uB5A4 \\uC6B4\\uBA85\\uC744 \\uC120\\uD0DD\\uD558\\uC2DC\\uACA0\\uC2B5\\uB2C8\\uAE4C?\"})]}),(personalStoryLog||[]).map((event,index)=>{var _event$story;return/*#__PURE__*/_jsxs(\"div\",{className:\"mb-4 p-2 rounded bg-gray-900/50\",children:[(event===null||event===void 0?void 0:event.action)&&/*#__PURE__*/_jsxs(\"p\",{className:\"text-yellow-300 font-semibold italic text-sm\",children:[\"\\uB098\\uC758 \\uC120\\uD0DD: \",event.action]}),/*#__PURE__*/_jsx(\"p\",{className:\"whitespace-pre-wrap mt-1\",dangerouslySetInnerHTML:{__html:((_event$story=event===null||event===void 0?void 0:event.story)!==null&&_event$story!==void 0?_event$story:'').replace(/\\n/g,'<br />')}})]},event.id||index);}),isTextLoading&&/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-center items-center mt-4\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-300\"}),/*#__PURE__*/_jsx(\"span\",{className:\"ml-3 text-gray-400\",children:\"\\uC774\\uC57C\\uAE30\\uB97C \\uC0DD\\uC131 \\uC911...\"})]}),Object.entries(actionLocks||{}).map(_ref2=>{let[scope,lockedBy]=_ref2;if(lockedBy===userId)return null;return/*#__PURE__*/_jsx(\"div\",{className:\"text-center text-yellow-400 font-semibold p-2 bg-black bg-opacity-20 rounded-md mt-2\",children:`'${scope.split(':')[1]}' 영역은 ${getDisplayName(lockedBy)}님이 사용 중입니다...`},scope);}),/*#__PURE__*/_jsx(\"div\",{ref:logEndRef})]})]})]});const renderChoices=()=>/*#__PURE__*/_jsx(\"div\",{className:\"flex flex-col gap-3\",children:privatePlayerState.characterCreated?[...(displayedChoices||[]),...(privatePlayerState.choices||[])].map((choice,index)=>{if(!choice)return null;const scope=getActionScope(choice);const isLockedByOther=actionLocks[scope]&&actionLocks[scope]!==userId;const allPrivateChoices=privatePlayerState.choices||[];const isPersonalChoice=allPrivateChoices.includes(choice);let buttonStyle='bg-blue-600 hover:bg-blue-700';let prefix='';if(isPersonalChoice){buttonStyle='bg-green-600 hover:bg-green-700';prefix='[개인] ';}if(isLockedByOther){buttonStyle='bg-gray-500 cursor-not-allowed';prefix=`[${getDisplayName(actionLocks[scope])} 사용 중] `;}return/*#__PURE__*/_jsxs(\"button\",{className:`px-6 py-3 font-bold rounded-md shadow-lg transition duration-300 disabled:opacity-50 ${buttonStyle} text-white`,onClick:()=>handleChoiceClick(choice),disabled:isTextLoading||isLockedByOther,children:[prefix,choice]},`${choice}-${index}`);}):Object.keys(professions).map(key=>/*#__PURE__*/_jsxs(\"button\",{onClick:()=>handleChoiceClick(`${key}. ${professions[key].name}`),disabled:isTextLoading,className:\"px-6 py-4 bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white font-bold rounded-md shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-wait text-left\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-lg text-blue-300\",children:`${key}. ${professions[key].name}`}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm font-normal text-gray-300 mt-1\",children:professions[key].motivation})]},key))});const renderSidebar=()=>{var _privatePlayerState$s,_privatePlayerState$s2,_privatePlayerState$s3,_privatePlayerState$s4,_privatePlayerState$s5,_privatePlayerState$s6,_privatePlayerState$s7,_privatePlayerState$s8;return/*#__PURE__*/_jsxs(\"div\",{className:\"w-full lg:w-1/3 flex flex-col space-y-6 bg-gray-700 p-4 rounded-lg shadow-inner\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"mb-2\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between cursor-pointer select-none\",onClick:()=>toggleAccordion('playerInfo'),children:[/*#__PURE__*/_jsx(\"h4\",{className:\"text-md font-semibold text-gray-200\",children:\"\\uB0B4 \\uC815\\uBCF4\"}),/*#__PURE__*/_jsx(\"div\",{className:\"text-xl\",children:accordion.playerInfo?'▼':'▲'})]}),accordion.playerInfo&&/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-600 p-3 rounded-md text-xs md:text-sm text-gray-300 space-y-1 h-48 overflow-y-auto custom-scrollbar\",children:[/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-blue-300\",children:\"\\uC774\\uB984:\"}),\" \",getDisplayName(userId)]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-blue-300\",children:\"\\uC9C1\\uC5C5:\"}),\" \",privatePlayerState.profession||'미정']}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-blue-300\",children:\"\\uC704\\uCE58:\"}),\" \",gameState.player.currentLocation||'알 수 없는 곳']}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-blue-300\",children:\"\\uB2A5\\uB825\\uCE58:\"}),\" \\uD798(\",(_privatePlayerState$s=(_privatePlayerState$s2=privatePlayerState.stats)===null||_privatePlayerState$s2===void 0?void 0:_privatePlayerState$s2.strength)!==null&&_privatePlayerState$s!==void 0?_privatePlayerState$s:10,\") \\uC9C0\\uB2A5(\",(_privatePlayerState$s3=(_privatePlayerState$s4=privatePlayerState.stats)===null||_privatePlayerState$s4===void 0?void 0:_privatePlayerState$s4.intelligence)!==null&&_privatePlayerState$s3!==void 0?_privatePlayerState$s3:10,\") \\uBBFC\\uCCA9(\",(_privatePlayerState$s5=(_privatePlayerState$s6=privatePlayerState.stats)===null||_privatePlayerState$s6===void 0?void 0:_privatePlayerState$s6.agility)!==null&&_privatePlayerState$s5!==void 0?_privatePlayerState$s5:10,\") \\uCE74\\uB9AC\\uC2A4\\uB9C8(\",(_privatePlayerState$s7=(_privatePlayerState$s8=privatePlayerState.stats)===null||_privatePlayerState$s8===void 0?void 0:_privatePlayerState$s8.charisma)!==null&&_privatePlayerState$s7!==void 0?_privatePlayerState$s7:10,\")\"]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-blue-300\",children:\"\\uC778\\uBCA4\\uD1A0\\uB9AC:\"}),\" \",(privatePlayerState.inventory||[]).join(', ')||'비어있음']}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-blue-300\",children:\"\\uD018\\uC2A4\\uD2B8:\"}),\" \",(privatePlayerState.activeQuests||[]).join(', ')||'없음']}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-blue-300\",children:\"\\uB2E8\\uC11C:\"}),\" \",(privatePlayerState.knownClues||[]).join(', ')||'없음']}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-green-300\",children:\"\\uC18C\\uC18D \\uADF8\\uB8F9:\"}),\" \",(privatePlayerState.groups||[]).join(', ')||'없음']}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-yellow-300\",children:\"NPC \\uAD00\\uACC4:\"}),/*#__PURE__*/_jsx(\"ul\",{className:\"list-disc list-inside ml-4\",children:Object.entries(privatePlayerState.npcRelations||{}).length>0?Object.entries(privatePlayerState.npcRelations).map(_ref3=>{let[name,value]=_ref3;return/*#__PURE__*/_jsx(\"li\",{children:`${name}: ${value}`},name);}):/*#__PURE__*/_jsx(\"li\",{children:\"\\uC54C\\uB824\\uC9C4 \\uAD00\\uACC4 \\uC5C6\\uC74C\"})})]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mb-2\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between cursor-pointer select-none\",onClick:()=>toggleAccordion('chronicle'),children:[/*#__PURE__*/_jsx(\"h4\",{className:\"text-md font-semibold text-gray-200\",children:\"\\uC138\\uACC4\\uC758 \\uC5F0\\uB300\\uAE30\"}),/*#__PURE__*/_jsx(\"div\",{className:\"text-xl\",children:accordion.chronicle?'▼':'▲'})]}),accordion.chronicle&&/*#__PURE__*/_jsx(\"div\",{className:\"bg-gray-600 p-3 rounded-md text-xs md:text-sm text-gray-300 space-y-1 h-32 overflow-y-auto custom-scrollbar\",children:(knownMajorEvents||[]).length>0?/*#__PURE__*/_jsx(\"ul\",{className:\"list-disc list-inside\",children:(knownMajorEvents||[]).map(event=>{var _event$summary;return/*#__PURE__*/_jsx(\"li\",{children:(_event$summary=event===null||event===void 0?void 0:event.summary)!==null&&_event$summary!==void 0?_event$summary:'기록이 손상되었습니다.'},event===null||event===void 0?void 0:event.id);})}):/*#__PURE__*/_jsx(\"p\",{children:\"\\uC544\\uC9C1 \\uBC1C\\uACAC\\uD55C \\uC8FC\\uC694 \\uC0AC\\uAC74\\uC774 \\uC5C6\\uC2B5\\uB2C8\\uB2E4. \\uC138\\uC0C1\\uC744 \\uD0D0\\uD5D8\\uD574 \\uBCF4\\uC138\\uC694.\"})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mb-2\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between cursor-pointer select-none\",onClick:()=>toggleAccordion('users'),children:[/*#__PURE__*/_jsx(\"h4\",{className:\"text-md font-semibold text-gray-200\",children:\"\\uD604\\uC7AC \\uD50C\\uB808\\uC774\\uC5B4\\uB4E4\"}),/*#__PURE__*/_jsx(\"div\",{className:\"text-xl\",children:accordion.users?'▼':'▲'})]}),accordion.users&&/*#__PURE__*/_jsx(\"div\",{className:\"bg-gray-600 p-3 rounded-md h-32 overflow-y-auto custom-scrollbar\",children:(activeUsers||[]).length>0?/*#__PURE__*/_jsx(\"ul\",{className:\"text-sm text-gray-300 space-y-1\",children:(activeUsers||[]).map(user=>/*#__PURE__*/_jsxs(\"li\",{className:\"truncate p-1 rounded-md\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-medium text-green-300\",children:getDisplayName(user.id)}),/*#__PURE__*/_jsxs(\"span\",{className:\"text-gray-400 text-xs\",children:[\" (\",user.profession||'모험가',\")\"]})]},user.id))}):/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-400\",children:\"\\uD65C\\uB3D9 \\uC911\\uC778 \\uD50C\\uB808\\uC774\\uC5B4\\uAC00 \\uC5C6\\uC2B5\\uB2C8\\uB2E4.\"})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mb-2\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between cursor-pointer select-none\",onClick:()=>toggleAccordion('chat'),children:[/*#__PURE__*/_jsx(\"h4\",{className:\"text-md font-semibold text-gray-200\",children:\"\\uACF5\\uAC1C \\uCC44\\uD305\"}),/*#__PURE__*/_jsx(\"div\",{className:\"text-xl\",children:accordion.chat?'▼':'▲'})]}),accordion.chat&&/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-600 p-3 rounded-md flex flex-col h-48\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex-grow overflow-y-auto custom-scrollbar mb-3 text-sm space-y-2\",children:[(chatMessages||[]).map(msg=>/*#__PURE__*/_jsx(\"div\",{children:/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsxs(\"span\",{className:\"font-medium text-yellow-300\",children:[getDisplayName(msg.userId),\":\"]}),\" \",msg.message]})},msg.id)),/*#__PURE__*/_jsx(\"div\",{ref:chatEndRef})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",className:\"flex-grow p-2 rounded-l-md bg-gray-700 border border-gray-600\",value:currentChatMessage,onChange:e=>setCurrentChatMessage(e.target.value),onKeyPress:e=>e.key==='Enter'&&sendChatMessage(),disabled:!isAuthReady}),/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-blue-600 hover:bg-blue-700 font-bold rounded-r-md\",onClick:sendChatMessage,disabled:!isAuthReady||!currentChatMessage.trim(),children:\"\\uBCF4\\uB0B4\\uAE30\"})]})]})]})]});};return/*#__PURE__*/_jsxs(\"div\",{className:\"min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center justify-center p-4 font-sans\",children:[llmError&&/*#__PURE__*/_jsx(LlmErrorModal,{}),showResetModal&&/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-xl font-bold text-red-400\",children:\"\\u26A0\\uFE0F \\uBAA8\\uB4E0 \\uB370\\uC774\\uD130\\uB97C \\uCD08\\uAE30\\uD654\\uD560\\uAE4C\\uC694?\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-200\",children:\"\\uC774 \\uC791\\uC5C5\\uC740 \\uB418\\uB3CC\\uB9B4 \\uC218 \\uC5C6\\uC2B5\\uB2C8\\uB2E4. \\uBAA8\\uB4E0 \\uC2DC\\uB098\\uB9AC\\uC624, \\uB85C\\uADF8, \\uC720\\uC800, \\uCC44\\uD305 \\uB370\\uC774\\uD130\\uAC00 \\uC0AD\\uC81C\\uB429\\uB2C8\\uB2E4.\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-end gap-3\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-gray-600 hover:bg-gray-700 font-bold rounded-md\",onClick:()=>setShowResetModal(false),disabled:isResetting,children:\"\\uCDE8\\uC18C\"}),/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-red-600 hover:bg-red-700 font-bold rounded-md\",onClick:resetAllGameData,disabled:isResetting,children:isResetting?'초기화 중...':'초기화'})]})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"w-full max-w-5xl bg-gray-800 rounded-lg shadow-xl p-6 md:p-8 flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col w-full lg:w-2/3 space-y-6\",children:[renderGameLog(),renderChoices()]}),renderSidebar()]}),/*#__PURE__*/_jsx(\"style\",{children:`\n        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');\n        body { font-family: 'Noto Sans KR', sans-serif; }\n        .custom-scrollbar::-webkit-scrollbar { width: 8px; }\n        .custom-scrollbar::-webkit-scrollbar-track { background: #4a5568; border-radius: 10px; }\n        .custom-scrollbar::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 10px; }\n        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }\n        `})]});}export default App;","map":{"version":3,"names":["React","useState","useEffect","useRef","initializeApp","getAuth","signInAnonymously","signInWithCustomToken","onAuthStateChanged","getFirestore","doc","setDoc","getDoc","collection","query","onSnapshot","serverTimestamp","addDoc","getDocs","deleteDoc","runTransaction","orderBy","limit","jsx","_jsx","jsxs","_jsxs","Fragment","_Fragment","defaultFirebaseConfig","apiKey","authDomain","projectId","storageBucket","messagingSenderId","appId","measurementId","firebaseConfig","initialAuthToken","professions","name","motivation","getMainScenarioRef","db","getPrivatePlayerStateRef","userId","getGameStatusRef","getMajorEventsRef","getPersonalStoryLogRef","getDefaultGameState","publicLog","choices","player","currentLocation","subtleClues","lastUpdate","getDefaultPrivatePlayerState","stats","strength","intelligence","agility","charisma","inventory","initialMotivation","reputation","activeQuests","companions","knownClues","characterCreated","profession","groups","npcRelations","knownEventIds","App","gameState","setGameState","personalStoryLog","setPersonalStoryLog","privatePlayerState","setPrivatePlayerState","displayedChoices","setDisplayedChoices","choicesTimestamp","setChoicesTimestamp","isTextLoading","setIsTextLoading","activeUsers","setActiveUsers","chatMessages","setChatMessages","currentChatMessage","setCurrentChatMessage","actionLocks","setActionLocks","setDb","auth","setAuth","setUserId","isAuthReady","setIsAuthReady","logEndRef","chatEndRef","nickname","setNickname","localStorage","getItem","showNicknameModal","setShowNicknameModal","nicknameInput","setNicknameInput","accordion","setAccordion","gameLog","chat","users","playerInfo","chronicle","showResetModal","setShowResetModal","isResetting","setIsResetting","llmError","setLlmError","llmRetryPrompt","setLlmRetryPrompt","isLoading","setIsLoading","allMajorEvents","setAllMajorEvents","knownMajorEvents","setKnownMajorEvents","handleNicknameSubmit","trim","finalNickname","setItem","userDocRef","merge","getDisplayName","uid","safeUid","String","safeUserId","substring","user","find","u","id","resetAllGameData","collectionsToDelete","colRef","snapshot","docSnap","docs","ref","usersColRef","usersSnapshot","userDoc","personalLogRef","personalLogSnapshot","logDoc","playerStateColRef","playerStateSnapshot","stateDoc","clear","console","log","e","error","window","location","reload","app","firestoreDb","firebaseAuth","unsubscribeAuth","privateStateRef","then","exists","unsubscribePrivateState","data","personalLogQuery","unsubscribePersonalLog","stories","map","reverse","unsubscribes","snap","prev","_data$player","_docSnap$data","messages","d","sort","a","b","_a$timestamp","_b$timestamp","timestamp","toMillis","cutoffTime","Date","now","filter","lastActive","events","_a$timestamp2","_b$timestamp2","forEach","unsub","length","currentKnownIds","newDiscoveredEvents","event","includes","push","updatedKnownEventIds","knownEvents","handleVisibilityChange","document","visibilityState","addEventListener","removeEventListener","current","scrollIntoView","behavior","systemPrompt","buildLlmPrompt","choice","_privatePlayerState$p","_gameState$player$cur","factions","join","npcs","Object","entries","_ref","value","personalLogEntries","slice","entry","_entry$action","_entry$story","action","story","publicLogEntries","_entry$actor$displayN","_entry$actor","_entry$log","actor","displayName","userPrompt","h","summary","JSON","stringify","callGeminiTextLLM","mainApiKey","backupApiKey","getApiUrl","payload","contents","role","parts","text","tryGeminiCall","fetch","method","headers","body","_result$candidates","_result$candidates$","_result$candidates$$c","_result$candidates$$c2","_result$candidates$$c3","response","ok","Error","status","result","json","llmOutputText","candidates","content","jsonMatch","match","parse","message","sendChatMessage","chatCollectionRef","updateNarratives","llmResponse","playerChoice","_llmResponse$majorEve","_llmResponse$majorEve2","_updatedScenarioDoc$d","mainScenarioRef","transaction","_llmResponse$sharedSt","_llmResponse$sharedSt2","scenarioDoc","get","currentData","updates","sharedStateUpdates","publicLogEntry","newPublicLog","update","personalStory","majorEvent","updatePrivateState","newPublicChoices","updatedScenarioDoc","privateStateUpdates","newPrivateChoices","privateChoices","newGroupChoices","groupChoices","keys","getActionScope","npcMatch","createCharacter","choiceKey","split","selectedProfession","newPublicLogEntry","baseData","updatedPublicLog","newChoices","set","updatedDoc","performPlayerAction","gameStatusRef","scope","_await$getDoc$data","freshScenarioDoc","serverTimestampValue","conflictStory","currentLocks","userPromptText","finalLocksDoc","finalLocks","handleChoiceClick","toggleAccordion","key","LlmErrorModal","className","children","onClick","placeholder","onChange","target","onKeyDown","autoFocus","disabled","renderGameLog","style","maxHeight","index","_event$story","dangerouslySetInnerHTML","__html","replace","_ref2","lockedBy","renderChoices","isLockedByOther","allPrivateChoices","isPersonalChoice","buttonStyle","prefix","renderSidebar","_privatePlayerState$s","_privatePlayerState$s2","_privatePlayerState$s3","_privatePlayerState$s4","_privatePlayerState$s5","_privatePlayerState$s6","_privatePlayerState$s7","_privatePlayerState$s8","_ref3","_event$summary","msg","type","onKeyPress"],"sources":["C:/workspaces/gemini/src/App.jsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\r\nimport { initializeApp } from 'firebase/app';\r\nimport {\r\n  getAuth,\r\n  signInAnonymously,\r\n  signInWithCustomToken,\r\n  onAuthStateChanged\r\n} from 'firebase/auth';\r\nimport {\r\n  getFirestore,\r\n  doc,\r\n  setDoc,\r\n  getDoc,\r\n  collection,\r\n  query,\r\n  onSnapshot,\r\n  serverTimestamp,\r\n  addDoc,\r\n  getDocs,\r\n  deleteDoc,\r\n  runTransaction,\r\n  orderBy,\r\n  limit\r\n} from 'firebase/firestore';\r\n\r\n// ====================================================================\r\n// Firebase configuration information - 수정 금지\r\nconst defaultFirebaseConfig = {\r\n  apiKey: \"AIzaSyBNJtmpRWzjobrY556bnHkwbZmpFJqgPX8\",\r\n  authDomain: \"text-adventure-game-cb731.firebaseapp.com\",\r\n  projectId: \"text-adventure-game-cb731\",\r\n  storageBucket: \"text-adventure-game-cb731.appspot.com\",\r\n  messagingSenderId: \"1092941614820\",\r\n  appId: \"1:1092941614820:web:5545f36014b73c268026f1\",\r\n  measurementId: \"G-FNGF42T1FP\"\r\n};\r\n\r\n// 수정금지\r\nconst firebaseConfig = defaultFirebaseConfig;\r\nconst appId = firebaseConfig.projectId;\r\nconst initialAuthToken = null;\r\n// ====================================================================\r\n\r\nconst professions = {\r\n  '1': { name: '몰락한 귀족/기사', motivation: '가문의 몰락 원인을 조사하고, 잃어버린 가문의 보물을 찾아야 합니다.' },\r\n  '2': { name: '평범한 마을 사람/농부', motivation: '갑자기 마을에 나타난 괴생명체로부터 마을을 지켜야 합니다.' },\r\n  '3': { name: '젊은 마법사/견습생', motivation: '스승님의 실종에 대한 단서를 찾아야 합니다.' },\r\n  '4': { name: '용병/모험가', motivation: '의뢰받은 임무를 수행하던 중 예상치 못한 사건에 휘말렸습니다.' },\r\n  '5': { name: '도적/암살자', motivation: '길드에서 내려온 첫 번째 임무를 완수하고, 그 과정에서 수상한 음모를 감지해야 합니다.' },\r\n  '6': { name: '왕족/공주/왕자', motivation: '왕실 내의 불화와 암투 속에서 자신의 입지를 다져야 합니다.' },\r\n};\r\n\r\n// Firestore 경로 유틸\r\nconst getMainScenarioRef = (db, appId) => doc(db, 'artifacts', appId, 'public', 'data', 'mainScenario', 'main');\r\nconst getPrivatePlayerStateRef = (db, appId, userId) => doc(db, 'artifacts', appId, 'users', userId, 'playerState', 'state');\r\nconst getGameStatusRef = (db, appId) => doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'status');\r\nconst getMajorEventsRef = (db, appId) => collection(db, 'artifacts', appId, 'public', 'data', 'majorEvents');\r\nconst getPersonalStoryLogRef = (db, appId, userId) => collection(db, 'artifacts', appId, 'users', userId, 'personalStoryLog');\r\n\r\n\r\n// 상태 초기화 유틸\r\nconst getDefaultGameState = () => ({\r\n  publicLog: [],\r\n  choices: [],\r\n  player: {\r\n    currentLocation: '방랑자의 안식처',\r\n  },\r\n  subtleClues: [],\r\n  lastUpdate: null,\r\n});\r\n\r\nconst getDefaultPrivatePlayerState = () => ({\r\n    stats: { strength: 10, intelligence: 10, agility: 10, charisma: 10 },\r\n    inventory: [],\r\n    initialMotivation: '',\r\n    reputation: {},\r\n    activeQuests: [],\r\n    companions: [],\r\n    knownClues: [],\r\n    characterCreated: false,\r\n    profession: '',\r\n    choices: [],\r\n    groups: [],\r\n    npcRelations: {},\r\n    knownEventIds: [],\r\n});\r\n\r\n\r\nfunction App() {\r\n  const [gameState, setGameState] = useState(getDefaultGameState());\r\n  const [personalStoryLog, setPersonalStoryLog] = useState([]);\r\n  const [privatePlayerState, setPrivatePlayerState] = useState(getDefaultPrivatePlayerState());\r\n  const [displayedChoices, setDisplayedChoices] = useState([]);\r\n  const [choicesTimestamp, setChoicesTimestamp] = useState(null);\r\n  const [isTextLoading, setIsTextLoading] = useState(false);\r\n  const [activeUsers, setActiveUsers] = useState([]);\r\n  const [chatMessages, setChatMessages] = useState([]);\r\n  const [currentChatMessage, setCurrentChatMessage] = useState('');\r\n  const [actionLocks, setActionLocks] = useState({});\r\n  const [db, setDb] = useState(null);\r\n  const [auth, setAuth] = useState(null);\r\n  const [userId, setUserId] = useState(null);\r\n  const [isAuthReady, setIsAuthReady] = useState(false);\r\n  const logEndRef = useRef(null);\r\n  const chatEndRef = useRef(null);\r\n  const [nickname, setNickname] = useState(() => localStorage.getItem('nickname') || '');\r\n  const [showNicknameModal, setShowNicknameModal] = useState(!localStorage.getItem('nickname'));\r\n  const [nicknameInput, setNicknameInput] = useState('');\r\n  const [accordion, setAccordion] = useState({ gameLog: true, chat: true, users: true, playerInfo: true, chronicle: true });\r\n  const [showResetModal, setShowResetModal] = useState(false);\r\n  const [isResetting, setIsResetting] = useState(false);\r\n  const [llmError, setLlmError] = useState(null);\r\n  const [llmRetryPrompt, setLlmRetryPrompt] = useState(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [allMajorEvents, setAllMajorEvents] = useState([]);\r\n  const [knownMajorEvents, setKnownMajorEvents] = useState([]);\r\n\r\n  const handleNicknameSubmit = () => {\r\n    if (nicknameInput.trim()) {\r\n      const finalNickname = nicknameInput.trim();\r\n      setNickname(finalNickname);\r\n      localStorage.setItem('nickname', finalNickname);\r\n      setShowNicknameModal(false);\r\n      if (userId && db) {\r\n          const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'activeUsers', userId);\r\n          setDoc(userDocRef, { nickname: finalNickname }, { merge: true });\r\n      }\r\n    }\r\n  };\r\n\r\n  const getDisplayName = (uid) => {\r\n    const safeUid = String(uid || '');\r\n    if (uid === userId) {\r\n      const safeUserId = String(userId || '');\r\n      return nickname || `플레이어 ${safeUserId.substring(0, 4)}`;\r\n    }\r\n    const user = activeUsers.find(u => u.id === uid);\r\n    return user?.nickname || `플레이어 ${safeUid.substring(0, 4)}`;\r\n  };\r\n\r\n  const resetAllGameData = async () => {\r\n    if (!db || !isAuthReady) return;\r\n    setIsResetting(true);\r\n    try {\r\n        const collectionsToDelete = [\r\n            collection(db, 'artifacts', appId, 'public', 'data', 'chatMessages'),\r\n            collection(db, 'artifacts', appId, 'public', 'data', 'activeUsers'),\r\n            getMajorEventsRef(db, appId)\r\n        ];\r\n\r\n        for (const colRef of collectionsToDelete) {\r\n            const snapshot = await getDocs(colRef);\r\n            for (const docSnap of snapshot.docs) {\r\n                await deleteDoc(docSnap.ref);\r\n            }\r\n        }\r\n\r\n        const usersColRef = collection(db, 'artifacts', appId, 'users');\r\n        const usersSnapshot = await getDocs(usersColRef);\r\n        for (const userDoc of usersSnapshot.docs) {\r\n            const personalLogRef = getPersonalStoryLogRef(db, appId, userDoc.id);\r\n            const personalLogSnapshot = await getDocs(personalLogRef);\r\n            for(const logDoc of personalLogSnapshot.docs) {\r\n                await deleteDoc(logDoc.ref);\r\n            }\r\n\r\n            const playerStateColRef = collection(db, 'artifacts', appId, 'users', userDoc.id, 'playerState');\r\n            const playerStateSnapshot = await getDocs(playerStateColRef);\r\n            for (const stateDoc of playerStateSnapshot.docs) {\r\n                await deleteDoc(stateDoc.ref);\r\n            }\r\n            await deleteDoc(doc(db, 'artifacts', appId, 'users', userDoc.id));\r\n        }\r\n\r\n        await deleteDoc(getMainScenarioRef(db, appId));\r\n        await deleteDoc(getGameStatusRef(db, appId));\r\n        \r\n        localStorage.clear();\r\n\r\n        setGameState(getDefaultGameState());\r\n        setPrivatePlayerState(getDefaultPrivatePlayerState());\r\n        setChatMessages([]);\r\n        setActionLocks({});\r\n\r\n        console.log(\"모든 서버 및 클라이언트 데이터가 성공적으로 초기화되었습니다.\");\r\n\r\n    } catch (e) {\r\n        console.error(\"전체 데이터 초기화 중 오류 발생:\", e);\r\n    } finally {\r\n      setIsResetting(false);\r\n      setShowResetModal(false);\r\n      window.location.reload();\r\n    }\r\n  };\r\n  \r\n  useEffect(() => {\r\n    try {\r\n      const app = initializeApp(firebaseConfig);\r\n      const firestoreDb = getFirestore(app);\r\n      const firebaseAuth = getAuth(app);\r\n      setDb(firestoreDb);\r\n      setAuth(firebaseAuth);\r\n      const unsubscribeAuth = onAuthStateChanged(firebaseAuth, async (user) => {\r\n        if (user) {\r\n          setUserId(user.uid);\r\n          setIsAuthReady(true);\r\n        } else {\r\n            await (initialAuthToken ? signInWithCustomToken(firebaseAuth, initialAuthToken) : signInAnonymously(firebaseAuth));\r\n        }\r\n      });\r\n      return () => unsubscribeAuth();\r\n    } catch (error) {\r\n      console.error(\"Firebase initialization error:\", error);\r\n      setLlmError(\"Firebase 초기화에 실패했습니다.\");\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!isAuthReady || !db || !userId) return;\r\n\r\n    const privateStateRef = getPrivatePlayerStateRef(db, appId, userId);\r\n    getDoc(privateStateRef).then(docSnap => {\r\n        if (!docSnap.exists()) {\r\n            setDoc(privateStateRef, getDefaultPrivatePlayerState());\r\n        }\r\n    });\r\n    const unsubscribePrivateState = onSnapshot(privateStateRef, (snapshot) => {\r\n      if (snapshot.exists()) {\r\n        setPrivatePlayerState({ ...getDefaultPrivatePlayerState(), ...snapshot.data() });\r\n      }\r\n      if (isLoading) setIsLoading(false);\r\n    });\r\n\r\n    const personalLogQuery = query(getPersonalStoryLogRef(db, appId, userId), orderBy(\"timestamp\", \"desc\"), limit(50));\r\n    const unsubscribePersonalLog = onSnapshot(personalLogQuery, (snapshot) => {\r\n        const stories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).reverse();\r\n        setPersonalStoryLog(stories);\r\n    });\r\n\r\n    return () => {\r\n      unsubscribePrivateState();\r\n      unsubscribePersonalLog();\r\n    };\r\n  }, [isAuthReady, db, userId]);\r\n\r\n  useEffect(() => {\r\n    if (!isAuthReady || !db) return;\r\n\r\n    const unsubscribes = [\r\n      onSnapshot(getMainScenarioRef(db, appId), (snap) => {\r\n        if (snap.exists()) {\r\n          const data = snap.data();\r\n          setGameState(prev => ({\r\n            ...prev,\r\n            publicLog: data.publicLog || [],\r\n            choices: data.choices || [],\r\n            player: { ...prev.player, currentLocation: data.player?.currentLocation || prev.player.currentLocation },\r\n            subtleClues: data.subtleClues || [],\r\n            lastUpdate: data.lastUpdate\r\n          }));\r\n        }\r\n      }),\r\n      onSnapshot(getGameStatusRef(db, appId), (docSnap) => {\r\n        setActionLocks(docSnap.data()?.actionLocks || {});\r\n      }),\r\n      onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'chatMessages')), (snapshot) => {\r\n        const messages = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));\r\n        setChatMessages(messages);\r\n      }),\r\n      onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'activeUsers')), (snapshot) => {\r\n        const cutoffTime = Date.now() - 60 * 1000;\r\n        const users = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).filter(u => u.lastActive && u.lastActive.toMillis() > cutoffTime);\r\n        setActiveUsers(users);\r\n      }),\r\n      onSnapshot(query(getMajorEventsRef(db, appId)), (snapshot) => {\r\n        const events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))\r\n            .sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));\r\n        setAllMajorEvents(events);\r\n      })\r\n    ];\r\n    return () => unsubscribes.forEach(unsub => unsub());\r\n  }, [isAuthReady, db]);\r\n\r\n  useEffect(() => {\r\n    if (!db || !userId || allMajorEvents.length === 0) return;\r\n\r\n    const currentKnownIds = privatePlayerState.knownEventIds || [];\r\n    const newDiscoveredEvents = [];\r\n\r\n    allMajorEvents.forEach(event => {\r\n        if (event?.location === gameState.player.currentLocation && !currentKnownIds.includes(event.id)) {\r\n            newDiscoveredEvents.push(event.id);\r\n        }\r\n    });\r\n\r\n    if (newDiscoveredEvents.length > 0) {\r\n        const privateStateRef = getPrivatePlayerStateRef(db, appId, userId);\r\n        const updatedKnownEventIds = [...currentKnownIds, ...newDiscoveredEvents];\r\n        setDoc(privateStateRef, { knownEventIds: updatedKnownEventIds }, { merge: true });\r\n    }\r\n\r\n    const knownEvents = allMajorEvents.filter(event => (privatePlayerState.knownEventIds || []).includes(event?.id));\r\n    setKnownMajorEvents(knownEvents);\r\n\r\n  }, [gameState.player.currentLocation, allMajorEvents, privatePlayerState.knownEventIds, db, userId]);\r\n\r\n\r\n  useEffect(() => {\r\n    if (!db || !userId || !nickname) return;\r\n    const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'activeUsers', userId);\r\n    setDoc(userDocRef, {\r\n      lastActive: serverTimestamp(),\r\n      nickname: nickname || `플레이어 ${userId.substring(0, 4)}`,\r\n      profession: privatePlayerState.profession,\r\n    }, { merge: true });\r\n\r\n    const handleVisibilityChange = () => {\r\n      if (document.visibilityState === 'visible') {\r\n        setDoc(userDocRef, { lastActive: serverTimestamp() }, { merge: true });\r\n      }\r\n    };\r\n    document.addEventListener('visibilitychange', handleVisibilityChange);\r\n    return () => document.removeEventListener('visibilitychange', handleVisibilityChange);\r\n  }, [db, userId, nickname, privatePlayerState.profession]);\r\n\r\n  useEffect(() => {\r\n    if (accordion.gameLog && logEndRef.current) logEndRef.current.scrollIntoView({ behavior: \"smooth\" });\r\n  }, [personalStoryLog, accordion.gameLog]);\r\n\r\n  useEffect(() => {\r\n    if (accordion.chat && chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: \"smooth\" });\r\n  }, [chatMessages, accordion.chat]);\r\n\r\n  const systemPrompt = `\r\n    ### 페르소나 (Persona)\r\n    당신은 이 세계의 '수호자'이자 '사관(史官)'이며, 플레이어들에게는 '게임 마스터(GM)'로 알려져 있습니다. 당신의 임무는 단순한 이야기 생성을 넘어, 일관된 역사와 살아 숨 쉬는 세계관을 구축하는 것입니다. 모든 묘사와 사건은 이 세계의 정해진 분위기와 역사적 사실 위에서 피어나는 한 편의 서사시여야 합니다.\r\n\r\n    ### 세계관 설정: 페이디드 판타지 (Faded Fantasy)\r\n    이 세계는 오래되었고, 과거의 영광은 빛이 바랬습니다. 위대한 왕국들은 쇠락의 길을 걷고 있으며, 잊혀진 유적에는 강력하지만 위험한 마법의 흔적이 남아있습니다. 도시는 화려함 뒤에 부패를 숨기고 있고, 황야에는 미지의 위험이 도사립니다. 사람들은 서로를 쉽게 믿지 않으며, 각자의 생존을 위해 발버둥 칩니다. 당신의 모든 묘사는 이 '아름답지만 슬픈' 분위기를 반영해야 합니다.\r\n\r\n    ### 핵심 구동 원칙\r\n    1.  **일관성의 원칙 (Canon) (가장 중요)**: User Prompt에 제공된 [세계의 연대기], [주요 세력 및 인물], [플레이어 정보]는 이 세계의 '정사(正史)'입니다. 당신은 절대 이 사실들을 왜곡하거나 모순되는 내용을 만들어서는 안 됩니다. 이 정보들을 바탕으로 세계를 확장해 나가십시오.\r\n\r\n    2.  **상호연결성의 원칙 (Interconnection)**: 당신은 뛰어난 이야기꾼으로서, 현재 발생하는 사건을 과거의 역사나 다른 플레이어의 행적과 연결지어야 합니다. 예를 들어, 한 플레이어가 던전에서 발견한 고대 문양은, 다른 플레이어가 수도에서 쫓고 있는 비밀 결사의 상징일 수 있습니다. 세상이 서로 연결되어 있음을 플레이어가 느끼게 하십시오.\r\n\r\n    3.  **장면 중심의 서사 원칙 (Scene-Centric)**: 플레이어의 '[선택]'은 하나의 '장면'을 시작하는 것과 같습니다. 당신의 \"personalStory\"는 반드시 그 선택의 즉각적인 결과와 묘사로 시작되어야 합니다. 대화라면 실제 대화 내용이, 행동이라면 그 행동의 과정과 결과가 구체적으로 서술되어야 합니다.\r\n\r\n    4.  **'보여주기, 말하지 않기' 원칙 (Show, Don't Tell)**: \"마을이 가난하다\"고 설명하지 마십시오. 대신 \"굶주린 아이들이 흙바닥에 주저앉아 있고, 대부분의 건물은 지붕이 허술하게 덧대어져 있다\"고 묘사하십시오. 플레이어가 스스로 분위기와 상황을 파악하게 만드십시오.\r\n\r\n    ### JSON 출력 구조\r\n    {\r\n      \"publicLogEntry\": \"만약 이 행동이 주변의 다른 플레이어나 NPC가 명백히 인지할 수 있는 '공개적인 사건'이라면, 3인칭 시점의 객관적인 기록을 한 문장으로 작성. (예: '플레이어 A가 경비병을 공격했다.') 그렇지 않으면 null.\",\r\n      \"personalStory\": \"플레이어의 선택으로 시작된 '장면'에 대한 상세하고 감정적인 1인칭 또는 2인칭 서사. 플레이어의 내면 묘사, 감각, 대화 내용 등을 포함.\",\r\n      \"choices\": [\"'personalStory'의 결과에 따라 플레이어가 할 수 있는 논리적인 다음 행동들.\"],\r\n      \"privateChoices\": [\"오직 행동 주체의 특성 때문에 가능한 특별한 행동들.\"],\r\n      \"groupChoices\": [\"같은 그룹 소속원들만 할 수 있는 비밀 행동들.\"],\r\n      \"majorEvent\": {\r\n        \"summary\": \"만약 이 사건이 후대에 '역사'로 기록될 만한 중대한 전환점이라면, 사관의 어조로 요약. (예: '왕국력 342년, 방랑자의 안식처에서 발생한 이 사건은 훗날 '붉은 달 교단'의 부흥을 알리는 서막이 되었다.') 그렇지 않으면 null.\",\r\n        \"location\": \"사건이 발생한 장소 이름. majorEvent가 있을 경우 필수.\"\r\n      },\r\n      \"sharedStateUpdates\": {\r\n        \"location\": \"플레이어 그룹의 현재 위치. 변경되었을 경우에만 포함.\",\r\n        \"subtleClues\": [{\"location\": \"장소명\", \"clue\": \"새롭게 생성된 단서\"}]\r\n      },\r\n      \"privateStateUpdates\": {\r\n        \"inventory\": [\"업데이트된 전체 인벤토리 목록\"],\r\n        \"stats\": {\"strength\": 12, \"intelligence\": 10, \"agility\": 10, \"charisma\": 10 },\r\n        \"activeQuests\": [\"업데이트된 개인 퀘스트 목록\"],\r\n        \"knownClues\": [\"새롭게 알게 된 단서 목록\"],\r\n        \"groups\": [\"업데이트된 소속 그룹 목록\"],\r\n        \"npcRelations\": {\"가라크\": 55, \"엘라라\": -10}\r\n      }\r\n    }\r\n  `;\r\n\r\n  const buildLlmPrompt = (choice) => {\r\n    const factions = (privatePlayerState.groups || []).join(', ') || '없음';\r\n    const npcs = Object.entries(privatePlayerState.npcRelations || {})\r\n      .map(([name, value]) => `${name} (관계도: ${value})`)\r\n      .join(', ') || '없음';\r\n\r\n    const personalLogEntries = (personalStoryLog || []).slice(-10).map(entry =>\r\n      `[나의 행동: ${entry?.action ?? '알 수 없는 행동'}] -> ${entry?.story ?? ''}`\r\n    ).join('\\n');\r\n\r\n    const publicLogEntries = (gameState.publicLog || []).slice(-10).map(entry =>\r\n        `[${entry?.actor?.displayName ?? '누군가'}] ${entry?.log ?? ''}`\r\n      ).join('\\n');\r\n\r\n    const userPrompt = `\r\n[세계의 연대기 (World Chronicle)]\r\n- 내가 발견한, 세상에 일어난 주요 역사적 사건들입니다. 이 기록은 절대적인 사실입니다.\r\n- ${knownMajorEvents.length > 0 ? knownMajorEvents.map(h => h.summary).join('\\n- ') : \"아직 기록된 역사가 없음\"}\r\n\r\n[나의 여정록 (My Journey Log) - 최근 기록]\r\n- 이것은 나의 개인적인 경험과 생각의 기록입니다.\r\n${personalLogEntries || \"아직 여정을 시작하지 않음\"}\r\n\r\n[주변의 최근 사건들 (Recent Public Events)]\r\n- 내가 있는 장소 주변에서 최근 일어난 공개적인 사건들입니다.\r\n${publicLogEntries || \"최근에 주변에서 별다른 일은 없었음\"}\r\n\r\n[주요 세력 및 인물 (Key Factions & NPCs)]\r\n- 나와 관련된 주요 세력: ${factions}\r\n- 나와 관계를 맺은 주요 인물: ${npcs}\r\n\r\n[나의 현재 상태 (My Current State)]\r\n- 이름: ${getDisplayName(userId)}\r\n- 직업: ${privatePlayerState.profession ?? '미정'}\r\n- 현재 위치: ${gameState.player.currentLocation ?? '알 수 없는 곳'}\r\n- 소지품 및 능력치: ${JSON.stringify({ inventory: privatePlayerState.inventory || [], stats: privatePlayerState.stats || {} })}\r\n\r\n[주변 관찰자 (Nearby Observers)]\r\n- 현재 장소에 함께 있는 다른 플레이어들입니다. 이들은 이번 턴에 행동하지 않습니다.\r\n- ${(activeUsers || []).map(u => u.nickname || `플레이어 ${u.id.substring(0,4)}`).join(', ') || \"주변에 다른 플레이어가 없음\"}\r\n\r\n[나의 선택 (My Action)]\r\n- 위 모든 상황 속에서, 나는 다음 행동을 선택했습니다. 이 선택으로 시작될 '장면'을 연출해주십시오.\r\n- \"${choice}\"\r\n`;\r\n    return userPrompt;\r\n  };\r\n\r\n  const callGeminiTextLLM = async (userPrompt) => {\r\n    setIsTextLoading(true);\r\n    const mainApiKey = \"AIzaSyDC11rqjU30OJnLjaBFOaazZV0klM5raU8\";\r\n    const backupApiKey = \"AIzaSyAhscNjW8GmwKPuKzQ47blCY_bDanR-B84\";\r\n    const getApiUrl = (apiKey) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;\r\n\r\n    const payload = { contents: [{ role: \"user\", parts: [{ text: systemPrompt }] }, { role: \"model\", parts: [{ text: \"{}\" }] }, { role: \"user\", parts: [{ text: userPrompt }] }] };\r\n\r\n    const tryGeminiCall = async (apiKey) => fetch(getApiUrl(apiKey), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });\r\n\r\n    try {\r\n      let response = await tryGeminiCall(mainApiKey);\r\n      if (!response.ok) {\r\n        response = await tryGeminiCall(backupApiKey);\r\n      }\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n      const result = await response.json();\r\n      const llmOutputText = result.candidates?.[0]?.content?.parts?.[0]?.text;\r\n      const jsonMatch = llmOutputText?.match(/\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) return JSON.parse(jsonMatch[0]);\r\n      throw new Error(\"Valid JSON object not found in LLM response.\");\r\n    } catch (error) {\r\n      console.error(\"LLM API call error:\", error);\r\n      setLlmError(error.message || 'LLM 호출 실패');\r\n      return null;\r\n    } finally {\r\n      setIsTextLoading(false);\r\n    }\r\n  };\r\n\r\n  const sendChatMessage = async () => {\r\n    if (!db || !userId || !isAuthReady || !currentChatMessage.trim()) return;\r\n    try {\r\n      const chatCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'chatMessages');\r\n      await addDoc(chatCollectionRef, { userId, displayName: getDisplayName(userId), message: currentChatMessage, timestamp: serverTimestamp() });\r\n      setCurrentChatMessage('');\r\n    } catch (error) {\r\n      console.error(\"Error sending chat message:\", error);\r\n    }\r\n  };\r\n\r\n  const updateNarratives = async (llmResponse, playerChoice) => {\r\n    const mainScenarioRef = getMainScenarioRef(db, appId);\r\n\r\n    await runTransaction(db, async (transaction) => {\r\n        const scenarioDoc = await transaction.get(mainScenarioRef);\r\n        if (!scenarioDoc.exists()) {\r\n            throw new Error(\"치명적 오류: 게임의 기본 시나리오 데이터가 없습니다.\");\r\n        }\r\n        const currentData = scenarioDoc.data();\r\n        \r\n        const updates = {\r\n            choices: llmResponse.choices || [],\r\n            'player.currentLocation': llmResponse.sharedStateUpdates?.location || currentData.player.currentLocation,\r\n            subtleClues: llmResponse.sharedStateUpdates?.subtleClues || currentData.subtleClues,\r\n            lastUpdate: serverTimestamp()\r\n        };\r\n\r\n        if (llmResponse.publicLogEntry) {\r\n            const newPublicLog = {\r\n                actor: { id: userId, displayName: getDisplayName(userId) },\r\n                log: llmResponse.publicLogEntry,\r\n                timestamp: new Date()\r\n            };\r\n            updates.publicLog = [...(currentData.publicLog || []), newPublicLog];\r\n        }\r\n        transaction.update(mainScenarioRef, updates);\r\n    });\r\n\r\n    const personalLogRef = getPersonalStoryLogRef(db, appId, userId);\r\n    await addDoc(personalLogRef, {\r\n        action: playerChoice,\r\n        story: llmResponse.personalStory || \"특별한 일은 일어나지 않았다.\",\r\n        timestamp: serverTimestamp()\r\n    });\r\n\r\n    if (llmResponse.majorEvent?.summary && llmResponse.majorEvent?.location) {\r\n        await addDoc(getMajorEventsRef(db, appId), {\r\n            ...llmResponse.majorEvent,\r\n            timestamp: serverTimestamp(),\r\n            actor: { id: userId, displayName: getDisplayName(userId) }\r\n        });\r\n    }\r\n\r\n    await updatePrivateState(llmResponse);\r\n\r\n    const newPublicChoices = llmResponse.choices || [];\r\n    setDisplayedChoices(newPublicChoices);\r\n    const updatedScenarioDoc = await getDoc(mainScenarioRef);\r\n    setChoicesTimestamp(updatedScenarioDoc.data()?.lastUpdate || null);\r\n  };\r\n  \r\n  const updatePrivateState = async (llmResponse) => {\r\n    const privateStateRef = getPrivatePlayerStateRef(db, appId, userId);\r\n    const updates = llmResponse.privateStateUpdates ? { ...llmResponse.privateStateUpdates } : {};\r\n    const newPrivateChoices = llmResponse.privateChoices || [];\r\n    const newGroupChoices = llmResponse.groupChoices || [];\r\n    updates.choices = [...newPrivateChoices, ...newGroupChoices];\r\n  \r\n    if (Object.keys(updates).length > 0) {\r\n      await setDoc(privateStateRef, updates, { merge: true });\r\n    }\r\n  };\r\n\r\n  const getActionScope = (choice) => {\r\n    const npcMatch = choice.match(/(.+)에게 말을 건다/);\r\n    if (npcMatch) {\r\n        return `npc:${npcMatch[1].trim()}`;\r\n    }\r\n    return `location:${gameState.player.currentLocation}`;\r\n  };\r\n\r\n  const createCharacter = async (choice) => {\r\n    setIsTextLoading(true);\r\n    try {\r\n        const choiceKey = choice.split('.')[0];\r\n        const selectedProfession = professions[choiceKey];\r\n        if (selectedProfession) {\r\n            const privateStateRef = getPrivatePlayerStateRef(db, appId, userId);\r\n            await setDoc(privateStateRef, {\r\n                ...getDefaultPrivatePlayerState(),\r\n                characterCreated: true,\r\n                profession: selectedProfession.name,\r\n                initialMotivation: selectedProfession.motivation,\r\n            }, { merge: true });\r\n\r\n            const personalLogRef = getPersonalStoryLogRef(db, appId, userId);\r\n            await addDoc(personalLogRef, {\r\n                action: \"여정에 나서다\",\r\n                story: `나는 '${selectedProfession.name}'으로서, '${selectedProfession.motivation}'라는 동기를 품고 이 세상에 첫 발을 내디뎠다.`,\r\n                timestamp: serverTimestamp()\r\n            });\r\n\r\n            const mainScenarioRef = getMainScenarioRef(db, appId);\r\n            const newPublicLogEntry = {\r\n                actor: { id: userId, displayName: getDisplayName(userId) },\r\n                log: `새로운 모험가, '${getDisplayName(userId)}'님이 여관에 모습을 드러냈습니다.`,\r\n                timestamp: new Date()\r\n            };\r\n            \r\n            await runTransaction(db, async (transaction) => {\r\n                const scenarioDoc = await transaction.get(mainScenarioRef);\r\n                const baseData = scenarioDoc.exists() ? scenarioDoc.data() : getDefaultGameState();\r\n                \r\n                const updatedPublicLog = [...(baseData.publicLog || []), newPublicLogEntry];\r\n                const newChoices = [\"여관을 둘러본다.\", \"다른 모험가에게 말을 건다.\", \"여관 주인에게 정보를 묻는다.\"];\r\n\r\n                const payload = {\r\n                    publicLog: updatedPublicLog,\r\n                    choices: newChoices,\r\n                    player: baseData.player,\r\n                    subtleClues: baseData.subtleClues || [],\r\n                    lastUpdate: serverTimestamp()\r\n                };\r\n                \r\n                transaction.set(mainScenarioRef, payload);\r\n            });\r\n\r\n            const updatedDoc = await getDoc(mainScenarioRef);\r\n            if(updatedDoc.exists()) {\r\n                setDisplayedChoices(updatedDoc.data().choices);\r\n                setChoicesTimestamp(updatedDoc.data().lastUpdate);\r\n            }\r\n        }\r\n    } catch (e) {\r\n        console.error(\"등장 이벤트 추가 실패: \", e);\r\n        setLlmError(\"게임 세계에 합류하는 중 오류가 발생했습니다.\");\r\n    } finally {\r\n        setIsTextLoading(false);\r\n    }\r\n  };\r\n\r\n  const performPlayerAction = async (choice) => {\r\n    setIsTextLoading(true);\r\n    setLlmRetryPrompt({ playerChoice: choice });\r\n\r\n    const mainScenarioRef = getMainScenarioRef(db, appId);\r\n    const gameStatusRef = getGameStatusRef(db, appId);\r\n    const scope = getActionScope(choice);\r\n\r\n    try {\r\n        const freshScenarioDoc = await getDoc(mainScenarioRef);\r\n        const serverTimestampValue = freshScenarioDoc.exists() ? freshScenarioDoc.data().lastUpdate : null;\r\n\r\n        if (choicesTimestamp && serverTimestampValue && choicesTimestamp.toMillis() < serverTimestampValue.toMillis()) {\r\n            const conflictStory = `당신이 '${choice}'(을)를 하려던 찰나, 세상은 이미 당신의 예상과 달라져 있었습니다. 주변을 다시 둘러보니 상황이 바뀌어 있습니다.`;\r\n            \r\n            const personalLogRef = getPersonalStoryLogRef(db, appId, userId);\r\n            await addDoc(personalLogRef, {\r\n                action: choice,\r\n                story: conflictStory,\r\n                timestamp: serverTimestamp()\r\n            });\r\n\r\n            const newChoices = freshScenarioDoc.data().choices || [];\r\n            setDisplayedChoices(newChoices);\r\n            setChoicesTimestamp(serverTimestampValue);\r\n            \r\n            setIsTextLoading(false);\r\n            return; \r\n        }\r\n\r\n        const currentLocks = (await getDoc(gameStatusRef)).data()?.actionLocks || {};\r\n        if (currentLocks[scope] && currentLocks[scope] !== userId) {\r\n            throw new Error(`현재 '${scope.split(':')[1]}'(은)는 다른 플레이어(${getDisplayName(currentLocks[scope])})가 사용 중입니다.`);\r\n        }\r\n        await setDoc(gameStatusRef, { actionLocks: { ...currentLocks, [scope]: userId } }, { merge: true });\r\n\r\n        const userPromptText = buildLlmPrompt(choice);\r\n        const llmResponse = await callGeminiTextLLM(userPromptText);\r\n\r\n        if (llmResponse) {\r\n            await updateNarratives(llmResponse, choice);\r\n            setLlmError(null);\r\n            setLlmRetryPrompt(null);\r\n        } else if (!llmError) {\r\n            setLlmError(\"LLM으로부터 유효한 응답을 받지 못했습니다.\");\r\n        }\r\n    } catch (error) {\r\n        console.error(\"행동 처리 중 오류:\", error.message);\r\n        setLlmError(error.message);\r\n    } finally {\r\n        const finalLocksDoc = await getDoc(gameStatusRef);\r\n        if (finalLocksDoc.exists()) {\r\n            const finalLocks = finalLocksDoc.data().actionLocks || {};\r\n            if (finalLocks[scope] === userId) {\r\n                delete finalLocks[scope];\r\n                await setDoc(gameStatusRef, { actionLocks: finalLocks }, { merge: true });\r\n            }\r\n        }\r\n        setIsTextLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleChoiceClick = async (choice) => {\r\n    if (isTextLoading) return;\r\n\r\n    if (!privatePlayerState.characterCreated) {\r\n        await createCharacter(choice);\r\n    } else {\r\n        await performPlayerAction(choice);\r\n    }\r\n  };\r\n  \r\n  const toggleAccordion = (key) => {\r\n    setAccordion(prev => ({ ...prev, [key]: !prev[key] }));\r\n  };\r\n\r\n  const LlmErrorModal = () => (\r\n    <div className=\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\">\r\n      <div className=\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 text-center\">\r\n        <h3 className=\"text-xl font-bold text-red-400\">오류가 발생했습니다</h3>\r\n        <p className=\"text-gray-200\">{llmError}</p>\r\n        <div className=\"flex justify-center gap-4\">\r\n          {llmRetryPrompt && (\r\n            <button\r\n              className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md\"\r\n              onClick={async () => {\r\n                setLlmError(null);\r\n                if (llmRetryPrompt.playerChoice) {\r\n                  await handleChoiceClick(llmRetryPrompt.playerChoice);\r\n                }\r\n              }}\r\n            >\r\n              재시도\r\n            </button>\r\n          )}\r\n          <button\r\n            className=\"px-4 py-2 bg-gray-600 hover:bg-gray-700 font-bold rounded-md\"\r\n            onClick={() => {\r\n              setLlmError(null);\r\n              setLlmRetryPrompt(null);\r\n            }}\r\n          >\r\n            닫기\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  if (showNicknameModal) {\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\">\r\n          <div className=\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4\">\r\n            <h3 className=\"text-xl font-bold text-gray-100\">닉네임을 입력하세요</h3>\r\n            <input className=\"w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg\" placeholder=\"닉네임\" value={nicknameInput} onChange={e => setNicknameInput(e.target.value)} onKeyDown={e => { if (e.key === 'Enter') handleNicknameSubmit(); }} autoFocus />\r\n            <button className=\"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md transition duration-300 disabled:opacity-50\" onClick={handleNicknameSubmit} disabled={!nicknameInput.trim()}>시작하기</button>\r\n          </div>\r\n        </div>\r\n    )\r\n  }\r\n\r\n  if (isLoading) {\r\n    return <div className=\"min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center\"><div className=\"animate-spin rounded-full h-16 w-16 border-b-2 border-gray-300\"></div><span className=\"ml-4 text-xl\">데이터를 불러오는 중...</span></div>;\r\n  }\r\n  \r\n  const renderGameLog = () => (\r\n    <div className=\"mb-2\">\r\n      <div className=\"flex items-center justify-between cursor-pointer select-none\" onClick={() => toggleAccordion('gameLog')}>\r\n        <h2 className=\"text-lg font-bold text-gray-100\">나의 여정록</h2>\r\n        <div className=\"text-xl\">{accordion.gameLog ? '▼' : '▲'}</div>\r\n      </div>\r\n      {accordion.gameLog && (\r\n        <>\r\n          <div className=\"flex justify-end mb-2\">\r\n            <button className=\"px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded-md\" onClick={() => setShowResetModal(true)}>전체 데이터 초기화</button>\r\n          </div>\r\n          <div className=\"flex-grow bg-gray-700 p-4 rounded-md overflow-y-auto h-96 custom-scrollbar text-sm md:text-base leading-relaxed\" style={{ maxHeight: '24rem' }}>\r\n            {(personalStoryLog || []).length === 0 && !privatePlayerState.characterCreated && (\r\n              <div className=\"mb-4 p-2 rounded bg-gray-900/50 text-center\">\r\n                  <p className=\"text-yellow-300 font-semibold italic text-lg\">모험의 서막</p>\r\n                  <p className=\"whitespace-pre-wrap mt-1\">당신은 어떤 운명을 선택하시겠습니까?</p>\r\n              </div>\r\n            )}\r\n            {(personalStoryLog || []).map((event, index) => (\r\n              <div key={event.id || index} className=\"mb-4 p-2 rounded bg-gray-900/50\">\r\n                {event?.action && (\r\n                   <p className=\"text-yellow-300 font-semibold italic text-sm\">\r\n                      나의 선택: {event.action}\r\n                   </p>\r\n                )}\r\n                <p className=\"whitespace-pre-wrap mt-1\" dangerouslySetInnerHTML={{ __html: (event?.story ?? '').replace(/\\n/g, '<br />') }}></p>\r\n              </div>\r\n            ))}\r\n            {isTextLoading && (\r\n              <div className=\"flex justify-center items-center mt-4\">\r\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-300\"></div>\r\n                <span className=\"ml-3 text-gray-400\">이야기를 생성 중...</span>\r\n              </div>\r\n            )}\r\n            {Object.entries(actionLocks || {}).map(([scope, lockedBy]) => {\r\n              if (lockedBy === userId) return null;\r\n              return (\r\n                  <div key={scope} className=\"text-center text-yellow-400 font-semibold p-2 bg-black bg-opacity-20 rounded-md mt-2\">\r\n                      {`'${scope.split(':')[1]}' 영역은 ${getDisplayName(lockedBy)}님이 사용 중입니다...`}\r\n                  </div>\r\n              )\r\n            })}\r\n            <div ref={logEndRef} />\r\n          </div>\r\n        </>\r\n      )}\r\n    </div>\r\n  );\r\n\r\n  const renderChoices = () => (\r\n    <div className=\"flex flex-col gap-3\">\r\n        {privatePlayerState.characterCreated ? (\r\n            [...(displayedChoices || []), ...(privatePlayerState.choices || [])].map((choice, index) => {\r\n                if (!choice) return null;\r\n                const scope = getActionScope(choice);\r\n                const isLockedByOther = actionLocks[scope] && actionLocks[scope] !== userId;\r\n                const allPrivateChoices = privatePlayerState.choices || [];\r\n                const isPersonalChoice = allPrivateChoices.includes(choice);\r\n                \r\n                let buttonStyle = 'bg-blue-600 hover:bg-blue-700';\r\n                let prefix = '';\r\n\r\n                if (isPersonalChoice) {\r\n                  buttonStyle = 'bg-green-600 hover:bg-green-700';\r\n                  prefix = '[개인] ';\r\n                }\r\n                \r\n                if (isLockedByOther) {\r\n                  buttonStyle = 'bg-gray-500 cursor-not-allowed';\r\n                  prefix = `[${getDisplayName(actionLocks[scope])} 사용 중] `;\r\n                }\r\n\r\n                return (\r\n                    <button\r\n                        key={`${choice}-${index}`}\r\n                        className={`px-6 py-3 font-bold rounded-md shadow-lg transition duration-300 disabled:opacity-50 ${buttonStyle} text-white`}\r\n                        onClick={() => handleChoiceClick(choice)}\r\n                        disabled={isTextLoading || isLockedByOther}\r\n                    >\r\n                        {prefix}{choice}\r\n                    </button>\r\n                )\r\n            })\r\n        ) : (\r\n            Object.keys(professions).map(key => (\r\n                <button\r\n                    key={key}\r\n                    onClick={() => handleChoiceClick(`${key}. ${professions[key].name}`)}\r\n                    disabled={isTextLoading}\r\n                    className=\"px-6 py-4 bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white font-bold rounded-md shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-wait text-left\"\r\n                >\r\n                    <p className=\"text-lg text-blue-300\">{`${key}. ${professions[key].name}`}</p>\r\n                    <p className=\"text-sm font-normal text-gray-300 mt-1\">{professions[key].motivation}</p>\r\n                </button>\r\n            ))\r\n        )}\r\n    </div>\r\n  );\r\n\r\n  const renderSidebar = () => (\r\n    <div className=\"w-full lg:w-1/3 flex flex-col space-y-6 bg-gray-700 p-4 rounded-lg shadow-inner\">\r\n        <div className=\"mb-2\">\r\n            <div className=\"flex items-center justify-between cursor-pointer select-none\" onClick={() => toggleAccordion('playerInfo')}>\r\n                <h4 className=\"text-md font-semibold text-gray-200\">내 정보</h4>\r\n                <div className=\"text-xl\">{accordion.playerInfo ? '▼' : '▲'}</div>\r\n            </div>\r\n            {accordion.playerInfo && (\r\n              <div className=\"bg-gray-600 p-3 rounded-md text-xs md:text-sm text-gray-300 space-y-1 h-48 overflow-y-auto custom-scrollbar\">\r\n                <p><span className=\"font-semibold text-blue-300\">이름:</span> {getDisplayName(userId)}</p>\r\n                <p><span className=\"font-semibold text-blue-300\">직업:</span> {privatePlayerState.profession || '미정'}</p>\r\n                <p><span className=\"font-semibold text-blue-300\">위치:</span> {gameState.player.currentLocation || '알 수 없는 곳'}</p>\r\n                <p><span className=\"font-semibold text-blue-300\">능력치:</span> 힘({privatePlayerState.stats?.strength ?? 10}) 지능({privatePlayerState.stats?.intelligence ?? 10}) 민첩({privatePlayerState.stats?.agility ?? 10}) 카리스마({privatePlayerState.stats?.charisma ?? 10})</p>\r\n                <p><span className=\"font-semibold text-blue-300\">인벤토리:</span> {(privatePlayerState.inventory || []).join(', ') || '비어있음'}</p>\r\n                <p><span className=\"font-semibold text-blue-300\">퀘스트:</span> {(privatePlayerState.activeQuests || []).join(', ') || '없음'}</p>\r\n                <p><span className=\"font-semibold text-blue-300\">단서:</span> {(privatePlayerState.knownClues || []).join(', ') || '없음'}</p>\r\n                <p><span className=\"font-semibold text-green-300\">소속 그룹:</span> {(privatePlayerState.groups || []).join(', ') || '없음'}</p>\r\n                <div>\r\n                    <span className=\"font-semibold text-yellow-300\">NPC 관계:</span>\r\n                    <ul className=\"list-disc list-inside ml-4\">\r\n                        {Object.entries(privatePlayerState.npcRelations || {}).length > 0 ? \r\n                            Object.entries(privatePlayerState.npcRelations).map(([name, value]) => <li key={name}>{`${name}: ${value}`}</li>) :\r\n                            <li>알려진 관계 없음</li>\r\n                        }\r\n                    </ul>\r\n                </div>\r\n              </div>\r\n            )}\r\n        </div>\r\n\r\n        <div className=\"mb-2\">\r\n            <div className=\"flex items-center justify-between cursor-pointer select-none\" onClick={() => toggleAccordion('chronicle')}>\r\n                <h4 className=\"text-md font-semibold text-gray-200\">세계의 연대기</h4>\r\n                <div className=\"text-xl\">{accordion.chronicle ? '▼' : '▲'}</div>\r\n            </div>\r\n            {accordion.chronicle && (\r\n                <div className=\"bg-gray-600 p-3 rounded-md text-xs md:text-sm text-gray-300 space-y-1 h-32 overflow-y-auto custom-scrollbar\">\r\n                    {(knownMajorEvents || []).length > 0 ? (\r\n                        <ul className=\"list-disc list-inside\">\r\n                            {(knownMajorEvents || []).map((event) => <li key={event?.id}>{event?.summary ?? '기록이 손상되었습니다.'}</li>)}\r\n                        </ul>\r\n                    ) : (\r\n                        <p>아직 발견한 주요 사건이 없습니다. 세상을 탐험해 보세요.</p>\r\n                    )}\r\n                </div>\r\n            )}\r\n        </div>\r\n        \r\n        <div className=\"mb-2\">\r\n            <div className=\"flex items-center justify-between cursor-pointer select-none\" onClick={() => toggleAccordion('users')}>\r\n                <h4 className=\"text-md font-semibold text-gray-200\">현재 플레이어들</h4>\r\n                <div className=\"text-xl\">{accordion.users ? '▼' : '▲'}</div>\r\n            </div>\r\n            {accordion.users && (\r\n                <div className=\"bg-gray-600 p-3 rounded-md h-32 overflow-y-auto custom-scrollbar\">\r\n                    {(activeUsers || []).length > 0 ? (\r\n                        <ul className=\"text-sm text-gray-300 space-y-1\">\r\n                            {(activeUsers || []).map(user => (\r\n                                <li key={user.id} className=\"truncate p-1 rounded-md\">\r\n                                    <span className=\"font-medium text-green-300\">{getDisplayName(user.id)}</span>\r\n                                    <span className=\"text-gray-400 text-xs\"> ({user.profession || '모험가'})</span>\r\n                                </li>\r\n                            ))}\r\n                        </ul>\r\n                    ) : <p className=\"text-sm text-gray-400\">활동 중인 플레이어가 없습니다.</p>}\r\n                </div>\r\n            )}\r\n        </div>\r\n        \r\n        <div className=\"mb-2\">\r\n            <div className=\"flex items-center justify-between cursor-pointer select-none\" onClick={() => toggleAccordion('chat')}>\r\n                <h4 className=\"text-md font-semibold text-gray-200\">공개 채팅</h4>\r\n                <div className=\"text-xl\">{accordion.chat ? '▼' : '▲'}</div>\r\n            </div>\r\n            {accordion.chat && (\r\n                <div className=\"bg-gray-600 p-3 rounded-md flex flex-col h-48\">\r\n                    <div className=\"flex-grow overflow-y-auto custom-scrollbar mb-3 text-sm space-y-2\">\r\n                        {(chatMessages || []).map((msg) => (\r\n                            <div key={msg.id}><p><span className=\"font-medium text-yellow-300\">{getDisplayName(msg.userId)}:</span> {msg.message}</p></div>\r\n                        ))}\r\n                        <div ref={chatEndRef} />\r\n                    </div>\r\n                    <div className=\"flex\">\r\n                        <input type=\"text\" className=\"flex-grow p-2 rounded-l-md bg-gray-700 border border-gray-600\" value={currentChatMessage} onChange={(e) => setCurrentChatMessage(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && sendChatMessage()} disabled={!isAuthReady} />\r\n                        <button className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 font-bold rounded-r-md\" onClick={sendChatMessage} disabled={!isAuthReady || !currentChatMessage.trim()}>보내기</button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center justify-center p-4 font-sans\">\r\n      {llmError && <LlmErrorModal />}\r\n      {showResetModal && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\">\r\n          <div className=\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4\">\r\n            <h3 className=\"text-xl font-bold text-red-400\">⚠️ 모든 데이터를 초기화할까요?</h3>\r\n            <p className=\"text-gray-200\">이 작업은 되돌릴 수 없습니다. 모든 시나리오, 로그, 유저, 채팅 데이터가 삭제됩니다.</p>\r\n            <div className=\"flex justify-end gap-3\">\r\n              <button className=\"px-4 py-2 bg-gray-600 hover:bg-gray-700 font-bold rounded-md\" onClick={() => setShowResetModal(false)} disabled={isResetting}>취소</button>\r\n              <button className=\"px-4 py-2 bg-red-600 hover:bg-red-700 font-bold rounded-md\" onClick={resetAllGameData} disabled={isResetting}>{isResetting ? '초기화 중...' : '초기화'}</button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"w-full max-w-5xl bg-gray-800 rounded-lg shadow-xl p-6 md:p-8 flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6\">\r\n        <div className=\"flex flex-col w-full lg:w-2/3 space-y-6\">\r\n            {renderGameLog()}\r\n            {renderChoices()}\r\n        </div>\r\n        {renderSidebar()}\r\n      </div>\r\n\r\n      <style>\r\n        {`\r\n        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');\r\n        body { font-family: 'Noto Sans KR', sans-serif; }\r\n        .custom-scrollbar::-webkit-scrollbar { width: 8px; }\r\n        .custom-scrollbar::-webkit-scrollbar-track { background: #4a5568; border-radius: 10px; }\r\n        .custom-scrollbar::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 10px; }\r\n        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }\r\n        `}\r\n      </style>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default App;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}