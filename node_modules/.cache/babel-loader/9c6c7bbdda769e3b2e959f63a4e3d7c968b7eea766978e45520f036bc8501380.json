{"ast":null,"code":"import React,{useState,useEffect,useRef}from'react';import{initializeApp}from'firebase/app';import{getAuth,signInAnonymously,// 익명 로그인 임포트\nsignInWithCustomToken,// 커스텀 토큰 로그인 임포트\nonAuthStateChanged}from'firebase/auth';import{getFirestore,doc,setDoc,getDoc,collection,query,onSnapshot,serverTimestamp,addDoc,getDocs,// 추가: 문서 목록을 가져오기 위해\ndeleteDoc,// 추가: 문서를 삭제하기 위해\nwhere// [수정] where 임포트 추가\n}from'firebase/firestore';// ====================================================================\n// Firebase configuration information (default if not provided by Canvas environment)\nimport{jsxs as _jsxs,jsx as _jsx}from\"react/jsx-runtime\";const defaultFirebaseConfig={apiKey:\"AIzaSyBNJtmpRWzjobrY556bnHkwbZmpFJqgPX8\",// Replace with your actual Firebase API key\nauthDomain:\"text-adventure-game-cb731.firebaseapp.com\",projectId:\"text-adventure-game-cb731\",storageBucket:\"text-adventure-game-cb731.firebaseapis.com\",messagingSenderId:\"1092941614820\",appId:\"1:1092941614820:web:5545f36014b73c268026f1\",measurementId:\"G-FNGF42T1FP\"};// Use global variables provided by Canvas environment\nconst firebaseConfig=defaultFirebaseConfig;const appId=firebaseConfig.projectId;const initialAuthToken=null;// ====================================================================\n// Initial profession information and motivations for the game\nconst professions={'1':{name:'몰락한 귀족/기사',motivation:'가문의 몰락 원인을 조사하고, 잃어버린 가문의 보물을 찾아야 합니다.'},'2':{name:'평범한 마을 사람/농부',motivation:'갑자기 마을에 나타난 괴생명체로부터 마을을 지켜야 합니다.'},'3':{name:'젊은 마법사/견습생',motivation:'스승님의 실종에 대한 단서를 찾아야 합니다.'},'4':{name:'용병/모험가',motivation:'의뢰받은 임무를 수행하던 중 예상치 못한 사건에 휘말렸습니다.'},'5':{name:'도적/암살자',motivation:'길드에서 내려온 첫 번째 임무를 완수하고, 그 과정에서 수상한 음모를 감지해야 합니다.'},'6':{name:'왕족/공주/왕자',motivation:'왕실 내의 불화와 암투 속에서 자신의 입지를 다져야 합니다.'}};function App(){// Current game text log (private)\nconst[gameLog,setGameLog]=useState([]);// LLM text response loading state\nconst[isTextLoading,setIsTextLoading]=useState(false);// Game phase: 'characterSelection' or 'playing'\nconst[gamePhase,setGamePhase]=useState('characterSelection');// Player character information\nconst[playerCharacter,setPlayerCharacter]=useState({profession:'',stats:{strength:10,intelligence:10,agility:10,charisma:10},// Base stats\ninventory:[],initialMotivation:'',currentLocation:'방랑자의 안식처',// Set initial location to 'Wanderer's Rest'\nreputation:{},// NPC/faction reputation (managed by LLM)\nactiveQuests:[],// Active quests (managed by LLM)\ncompanions:[]// Companions (managed by LLM)\n});// Current choices presented to the player\nconst[currentChoices,setCurrentChoices]=useState([]);// Feedback modal display status\nconst[showFeedbackModal,setShowFeedbackModal]=useState(false);// Feedback text\nconst[feedbackText,setFeedbackText]=useState('');// Shared game log (multiplayer)\nconst[sharedGameLog,setSharedGameLog]=useState([]);// List of active users (multiplayer)\nconst[activeUsers,setActiveUsers]=useState([]);// List of chat messages (public chat)\nconst[chatMessages,setChatMessages]=useState([]);// Current chat input value (public chat)\nconst[currentChatMessage,setCurrentChatMessage]=useState('');// Private chat related states\nconst[showPlayerChatModal,setShowPlayerChatModal]=useState(false);const[selectedPlayerForChat,setSelectedPlayerForChat]=useState(null);// { id, displayName, profession }\nconst[privateChatMessages,setPrivateChatMessages]=useState([]);const[currentPrivateChatMessage,setCurrentPrivateChatMessage]=useState('');// [수정] 개인 채팅 모달이 사용자에게 의해 닫혔는지 여부를 추적하는 상태\nconst[isPrivateChatModalManuallyClosed,setIsPrivateChatModalManuallyClosed]=useState(false);// [추가] Companion scenario progress status\nconst[isCompanionActionInProgress,setIsCompanionActionInProgress]=useState(false);const[actingPlayer,setActingPlayer]=useState(null);// [추가] Information of the player currently acting\n// Firebase and authentication status\nconst[db,setDb]=useState(null);const[auth,setAuth]=useState(null);const[userId,setUserId]=useState(null);const[isAuthReady,setIsAuthReady]=useState(false);// Refs to keep scroll at the bottom\nconst logEndRef=useRef(null);const sharedLogEndRef=useRef(null);const chatEndRef=useRef(null);// Ref for public chat log\nconst privateChatEndRef=useRef(null);// Ref for private chat log\n// Firebase initialization and authentication handling\nuseEffect(()=>{try{// Check if Firebase API key is a placeholder.\nif(firebaseConfig.apiKey===\"YOUR_API_KEY\"||!firebaseConfig.apiKey){console.error(\"Firebase initialization error: firebaseConfig.apiKey must be replaced with your actual Firebase API key.\");setGameLog(prev=>[...prev,\"오류: Firebase API 키가 올바르게 설정되지 않았습니다. 코드를 확인해주세요.\"]);return;// Firebase initialization is stopped.\n}const app=initializeApp(firebaseConfig);const firestoreDb=getFirestore(app);const firebaseAuth=getAuth(app);setDb(firestoreDb);setAuth(firebaseAuth);const unsubscribeAuth=onAuthStateChanged(firebaseAuth,async user=>{if(user){setUserId(user.uid);setIsAuthReady(true);}else{// If no user is logged in, attempt anonymous sign-in.\ntry{if(initialAuthToken){await signInWithCustomToken(firebaseAuth,initialAuthToken);}else{await signInAnonymously(firebaseAuth);}}catch(error){console.error(\"Firebase authentication failed:\",error);setGameLog(prev=>[...prev,\"오류: Firebase 인증에 실패했습니다.\"]);}}});return()=>unsubscribeAuth();}catch(error){console.error(\"Firebase initialization error:\",error);setGameLog(prev=>[...prev,\"오류: 게임을 초기화할 수 없습니다.\"]);}},[]);// Set multiplayer data listeners after Firebase authentication is complete\nuseEffect(()=>{if(!db||!isAuthReady||!userId||!auth)return;// [수정] Add listener to monitor game status (scenario progress, etc.)\nconst gameStatusDocRef=doc(db,'artifacts',appId,'public','data','gameStatus','status');const unsubscribeGameStatus=onSnapshot(gameStatusDocRef,docSnap=>{if(docSnap.exists()){const data=docSnap.data();setIsCompanionActionInProgress(data.isActionInProgress||false);setActingPlayer(data.actingPlayer||null);// Update acting player information\n}},error=>{console.error(\"Game status snapshot error:\",error);});// 1. Shared game log listener\n// Firestore security rules adjust the path.\n// Public data is at /artifacts/{appId}/public/data/{your_collection_name}\nconst sharedLogCollectionRef=collection(db,'artifacts',appId,'public','data','sharedGameLog');const qSharedLog=query(sharedLogCollectionRef);const unsubscribeSharedLog=onSnapshot(qSharedLog,snapshot=>{const logs=snapshot.docs.map(doc=>({id:doc.id,...doc.data()})).sort((a,b)=>{var _a$timestamp,_b$timestamp;return(((_a$timestamp=a.timestamp)===null||_a$timestamp===void 0?void 0:_a$timestamp.toMillis())||0)-(((_b$timestamp=b.timestamp)===null||_b$timestamp===void 0?void 0:_b$timestamp.toMillis())||0);});// Sort by timestamp\nsetSharedGameLog(logs);},error=>{console.error(\"Shared game log snapshot error:\",error);});// 2. Active user list listener\n// Public data is at /artifacts/{appId}/public/data/{your_collection_name}\nconst activeUsersCollectionRef=collection(db,'artifacts',appId,'public','data','activeUsers');const qActiveUsers=query(activeUsersCollectionRef);const unsubscribeActiveUsers=onSnapshot(qActiveUsers,snapshot=>{// Filter to show only users active within the last 60 seconds.\nconst cutoffTime=Date.now()-60*1000;// 60 seconds (1 minute)\nconst users=snapshot.docs.map(doc=>({id:doc.id,...doc.data()})).filter(user=>user.lastActive&&user.lastActive.toMillis()>cutoffTime);// Filter by lastActive timestamp\nsetActiveUsers(users);},error=>{console.error(\"Active users snapshot error:\",error);});// 3. Public chat message listener\nconst chatCollectionRef=collection(db,'artifacts',appId,'public','data','chatMessages');const qChatMessages=query(chatCollectionRef);const unsubscribeChatMessages=onSnapshot(qChatMessages,snapshot=>{const messages=snapshot.docs.map(doc=>({id:doc.id,...doc.data()})).sort((a,b)=>{var _a$timestamp2,_b$timestamp2;return(((_a$timestamp2=a.timestamp)===null||_a$timestamp2===void 0?void 0:_a$timestamp2.toMillis())||0)-(((_b$timestamp2=b.timestamp)===null||_b$timestamp2===void 0?void 0:_b$timestamp2.toMillis())||0);});// Sort by timestamp\nsetChatMessages(messages);},error=>{console.error(\"Chat messages snapshot error:\",error);});// Update user presence (periodically)\nconst updateUserPresence=async()=>{if(userId){try{const userDocRef=doc(db,'artifacts',appId,'public','data','activeUsers',userId);await setDoc(userDocRef,{lastActive:serverTimestamp(),displayName:`플레이어 ${userId.substring(0,4)}`,// Display only part of the user ID\nprofession:playerCharacter.profession,// Add player profession\nisCompanion:playerCharacter.companions.length>0// [추가] Companion status\n},{merge:true});}catch(error){console.error(\"Failed to update user presence:\",error);}}};updateUserPresence();// Initial update\nconst presenceInterval=setInterval(updateUserPresence,30000);// Update every 30 seconds\nreturn()=>{unsubscribeSharedLog();unsubscribeActiveUsers();unsubscribeChatMessages();// Clean up chat listener\nunsubscribeGameStatus();// [수정] Clean up game status listener\nclearInterval(presenceInterval);};},[db,isAuthReady,userId,auth,playerCharacter.profession,playerCharacter.companions]);// Add playerCharacter.companions to dependency array\n// Cleanup inactive users function (client-side)\n// This function runs client-side, so it only works when the app is running.\n// A more robust and secure method would be to use Firebase Cloud Functions.\nconst cleanupInactiveUsers=async()=>{if(!db||!isAuthReady||!userId)return;const inactiveThreshold=1*60*1000;// 1 minute (60 seconds)\nconst cutoffTime=Date.now()-inactiveThreshold;try{const activeUsersCollectionRef=collection(db,'artifacts',appId,'public','data','activeUsers');const querySnapshot=await getDocs(activeUsersCollectionRef);// Get all documents.\nquerySnapshot.forEach(async docSnapshot=>{const userData=docSnapshot.data();// Delete users whose lastActive timestamp is older than 5 minutes.\nif(userData.lastActive&&userData.lastActive.toMillis()<cutoffTime){console.log(`DEBUG: Deleting inactive user: ${docSnapshot.id}`);await deleteDoc(doc(db,'artifacts',appId,'public','data','activeUsers',docSnapshot.id));}});}catch(error){console.error(\"Error cleaning up inactive users:\",error);}};// Set interval for cleaning up inactive users\nuseEffect(()=>{if(!db||!isAuthReady||!userId)return;// Run cleanup function every 1 minute.\nconst cleanupInterval=setInterval(cleanupInactiveUsers,1*60*1000);// Run every 1 minute\nreturn()=>clearInterval(cleanupInterval);// Clean up interval on component unmount\n},[db,isAuthReady,userId]);// Re-run whenever db, isAuthReady, userId change\n// Set initial message and profession choices when the game starts\nuseEffect(()=>{if(gamePhase==='characterSelection'){setGameLog([\"환영합니다! 당신은 중세 유럽풍 판타지 왕국의 모험가가 될 것입니다. 당신은 지금 '방랑자의 안식처'라는 아늑한 여관에 도착했습니다.\",\"어떤 직업을 선택하시겠습니까?\"]);setCurrentChoices(Object.keys(professions).map(key=>`${key}. ${professions[key].name}`));}},[gamePhase]);// Scroll to the bottom whenever the game log is updated\nuseEffect(()=>{if(logEndRef.current){logEndRef.current.scrollIntoView({behavior:\"smooth\"});}},[gameLog]);// Scroll to the bottom whenever the shared log is updated\nuseEffect(()=>{if(sharedLogEndRef.current){sharedLogEndRef.current.scrollIntoView({behavior:\"smooth\"});}},[sharedGameLog]);// Scroll to the bottom whenever chat messages are updated\nuseEffect(()=>{if(chatEndRef.current){chatEndRef.current.scrollIntoView({behavior:\"smooth\"});}},[chatMessages]);// Scroll private chat messages\nuseEffect(()=>{if(privateChatEndRef.current){privateChatEndRef.current.scrollIntoView({behavior:\"smooth\"});}},[privateChatMessages]);// Function to generate private chat room ID (sorts two user IDs for consistent ID generation)\nconst getPrivateChatRoomId=(user1Id,user2Id)=>{const sortedIds=[user1Id,user2Id].sort();return`${sortedIds[0]}_${sortedIds[1]}`;};// Existing private chat listener (receives only conversations with the selected player)\nuseEffect(()=>{if(!db||!isAuthReady||!userId||!selectedPlayerForChat){setPrivateChatMessages([]);// Initialize messages if no player is selected\nreturn;}const chatRoomId=getPrivateChatRoomId(userId,selectedPlayerForChat.id);const privateChatCollectionRef=collection(db,'artifacts',appId,'privateChats',chatRoomId,'messages');const qPrivateChat=query(privateChatCollectionRef);const unsubscribePrivateChat=onSnapshot(qPrivateChat,snapshot=>{const messages=snapshot.docs.map(doc=>({id:doc.id,...doc.data()})).sort((a,b)=>{var _a$timestamp3,_b$timestamp3;return(((_a$timestamp3=a.timestamp)===null||_a$timestamp3===void 0?void 0:_a$timestamp3.toMillis())||0)-(((_b$timestamp3=b.timestamp)===null||_b$timestamp3===void 0?void 0:_b$timestamp3.toMillis())||0);});setPrivateChatMessages(messages);},error=>{console.error(\"Private chat messages snapshot error:\",error);});return()=>unsubscribePrivateChat();},[db,isAuthReady,userId,selectedPlayerForChat,appId]);// Added appId to dependency array\n// [NEW] 수신 메시지 알림 리스너 (collectionGroup 사용하지 않음)\nuseEffect(()=>{if(!db||!isAuthReady||!userId){return;}// 현재 사용자의 incomingMessages 컬렉션을 감시합니다.\nconst incomingMessagesCollectionRef=collection(db,'artifacts',appId,'users',userId,'incomingMessages');const qIncomingMessages=query(incomingMessagesCollectionRef);const unsubscribeIncomingMessages=onSnapshot(qIncomingMessages,snapshot=>{snapshot.docChanges().forEach(change=>{if(change.type===\"added\"){const notification=change.doc.data();const senderId=change.doc.id;// 문서 ID가 senderId가 됩니다.\n// 모달이 이미 열려있거나 수동으로 닫힌 상태가 아니라면\n// [수정] isPrivateChatModalManuallyClosed를 의존성 배열에서 제거했으므로,\n// 이 useEffect는 해당 상태 변화에 직접 반응하지 않습니다.\n// 따라서, 모달이 닫힌 상태에서만 알림을 처리하도록 로직을 유지합니다.\nif(!showPlayerChatModal){// Removed !isPrivateChatModalManuallyClosed from here\nconst senderInfo=activeUsers.find(user=>user.id===senderId);if(senderInfo){openPlayerChatModal(senderInfo);}else{// activeUsers에 없는 경우, 알림 정보로 임시 플레이어 정보 생성\nopenPlayerChatModal({id:senderId,displayName:notification.senderDisplayName||`알 수 없는 플레이어 ${senderId.substring(0,4)}`,profession:'알 수 없음'// activeUsers에서 가져올 수 없으므로 기본값\n});}// 알림을 처리했으므로 해당 알림 문서를 삭제합니다.\ndeleteDoc(doc(db,'artifacts',appId,'users',userId,'incomingMessages',senderId)).catch(error=>{console.error(\"Error deleting incoming message notification:\",error);});}}});},error=>{console.error(\"Incoming private messages notification error:\",error);});return()=>unsubscribeIncomingMessages();},[db,isAuthReady,userId,showPlayerChatModal,activeUsers,appId]);// Removed isPrivateChatModalManuallyClosed from dependency array\n// Define the system prompt to send to the LLM\nconst systemPrompt=`\n    당신은 중세 유럽풍 판타지 텍스트 어드벤처 게임의 스토리텔러이자 게임 마스터입니다.\n    이 게임은 멀티플레이어 게임이며, 현재 접속 중인 다른 플레이어들도 같은 시나리오에 참여합니다.\n    모든 플레이어는 '방랑자의 안식처'라는 여관에서 게임을 시작합니다.\n    플레이어의 선택과 현재 게임 상태를 기반으로 스토리를 진행하고, 새로운 상황을 묘사하며, 다음 선택지를 제시해야 합니다.\n    당신은 3인칭으로 서술하며, 진지하고 서사적인 어조와 객관적이고 정보 전달적인 어조를 적절히 섞어 사용합니다.\n    정보는 직접적인 설명, 간접적인 묘사, NPC 대화, 아이템/문서 등 다양한 방식으로 제공합니다.\n    묘사의 세부 정도는 LLM이 유연하게 조절하되, 중요하거나 인상적인 장면에서는 상세하게 묘사합니다.\n    플레이어의 목표는 고정되어 있지 않으며, 플레이어의 선택과 행동에 따라 유동적으로 형성되어 무한한 엔딩으로 이어집니다.\n    간단한 인벤토리 시스템(주요 스토리 아이템 위주)을 고려하며, 아이템 획득 또는 사용 시 스토리 묘사에 반영합니다.\n    간단한 텍스트 기반 전투(선택 및 확률 기반)를 시뮬레이션합니다. 전투 시 적을 묘사하고, 플레이어의 행동, 능력치와 확률에 기반한 결과, 능력치 변화 또는 피해를 묘사합니다.\n    능력치(힘, 지능, 민첩, 카리스마)가 존재하며, 플레이어의 행동에 따라 능력치가 어떻게 변화하고 성장하는지 서사적으로 묘사해야 합니다.\n    LLM 기반 퍼즐을 생성하고 해결을 유도할 수 있습니다. 퍼즐을 제시할 때는 퍼즐의 내용과 해결 방법을 명확히 제시합니다.\n    시간 제한은 없습니다.\n\n    **멀티플레이어 시나리오 지침:**\n    1.  **시작 지점:** 모든 플레이어는 '방랑자의 안식처'에서 시작하며, 당신은 이 여관의 분위기와 그 안에 있는 다른 플레이어들을 묘사해야 합니다.\n    2.  **다른 플레이어 등장:** 현재 게임에 접속해 있는 다른 플레이어들을 스토리 내에서 등장인물로 자연스럽게 포함시키십시오. 이들은 동료가 될 수도 있고, 경쟁자가 될 수도 있습니다.\n    3.  **플레이어 간 상호작용 (LLM 반영 중요):** 플레이어가 다른 플레이어와 상호작용(대화, 협력, 경쟁 등)을 선택하면, 당신은 해당 상호작용의 결과를 시뮬레이션하고 다음 선택지를 제공해야 합니다. **특히, 플레이어 간의 개인 대화 내용이 있다면, 이 내용을 시나리오 진행에 가장 우선적으로 반영하여 스토리를 전개하십시오.** 예를 들어, 한 플레이어가 다른 플레이어에게 말을 걸면, 당신은 그 플레이어의 캐릭터(직업, 성향 등)에 기반한 반응을 생성하고, 대화를 이어나갈 선택지를 제시합니다.\n    4.  **공유된 스토리:** 모든 플레이어의 선택과 상호작용이 하나의 공유된 시나리오에 영향을 미치도록 스토리를 발전시키십시오.\n\n    이야기를 통해 새로운 퀘스트를 암시적으로 도입합니다. 예를 들어, NPC가 도움을 요청하거나, 어떤 발견이 새로운 목표로 이어질 수 있습니다.\n    NPC 및 세력 평판을 이야기 내에서 암시적으로 관리합니다. 플레이어의 행동이 NPC 반응에 어떻게 영향을 미치는지 묘사합니다.\n    플레이어에게 잠재적인 동료를 소개합니다. 동료가 영입되면, 그들의 존재와 플레이어 및 세계와의 상호작용을 묘사합니다.\n    퀘스트 진행 상황, 평판 변화, 동료 상호작용을 JSON 출력에 명확히 포함하여 게임 로직이 이를 추적할 수 있도록 합니다.\n\n    당신은 항상 유효한 JSON 형식으로 응답해야 합니다. 구문에 세심한 주의를 기울이십시오. 모든 문자열은 올바르게 인용되어야 하며, 객체 또는 배열의 마지막 요소 뒤에 후행 쉼표가 없어야 합니다. 배열의 모든 요소는 쉼표로 구분되어야 합니다. 다음 JSON 스키마를 엄격히 따르십시오:\n    {\n      \"story\": \"현재 상황에 대한 스토리 텍스트 (3인칭으로 서술).\",\n      \"choices\": [\"선택지 1\", \"선택지 2\", ...],\n      \"inventoryUpdates\": [\"아이템1\", \"아이템2\", ...],\n      \"statChanges\": {\"strength\": 12, \"intelligence\": 10, ...},\n      \"location\": \"플레이어의 현재 위치\",\n      \"reputationUpdates\": {\"세력명\": \"상태\", ...},\n      \"activeQuestsUpdates\": [\"퀘스트1\", \"퀘스트2\", ...],\n      \"companionsUpdates\": [\"동료1\", \"동료2\", ...]\n    }\n    항상 2개에서 5개 사이의 'choices'를 제공하십시오.\n    'inventoryUpdates', 'statChanges', 'location', 'reputationUpdates', 'activeQuestsUpdates', 'companionsUpdates'는 변경 사항이 없더라도 현재 상태를 포함하여야 합니다.\n    스토리 텍스트는 500자 이내여야 합니다.\n  `;// LLM text generation function (Gemini-2.0-flash)\nconst callGeminiTextLLM=async promptData=>{setIsTextLoading(true);console.log(\"DEBUG: Starting callGeminiTextLLM\");// Enter your Gemini API key here.\n// Since this is not a Canvas environment, you must enter the key directly.\nconst apiKey=\"AIzaSyDC11rqjU30OJnLjaBFOaazZV0klM5raU8\";// <-- Enter your actual Gemini API key here!\nconst apiUrl=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;const userPrompt=`\n      현재 게임 단계: ${promptData.phase}\n      플레이어 직업: ${promptData.character.profession}\n      플레이어 초기 동기: ${promptData.character.initialMotivation}\n      현재 능력치: ${JSON.stringify(promptData.character.stats)}\n      현재 인벤토리: ${JSON.stringify(promptData.character.inventory)}\n      현재 위치: ${promptData.character.currentLocation}\n      현재 평판: ${JSON.stringify(promptData.character.reputation)}\n      현재 활성 퀘스트: ${JSON.stringify(promptData.character.activeQuests)}\n      현재 동료: ${JSON.stringify(promptData.character.companions)}\n      이전 게임 로그 (마지막 5개 항목): ${JSON.stringify(promptData.history.slice(-5))}\n      플레이어의 마지막 선택: ${promptData.playerChoice}\n\n      **현재 접속 중인 다른 플레이어들:**\n      ${JSON.stringify(promptData.activeUsers)}\n\n      **현재 플레이어와 관련된 최근 개인 대화 내용 (LLM이 시나리오에 우선 반영):**\n      ${promptData.privateChatHistory&&promptData.privateChatHistory.length>0?JSON.stringify(promptData.privateChatHistory.slice(-5)):'없음'}\n\n      위 정보를 바탕으로 다음 스토리 부분을 한국어로 생성하고, 시스템 프롬프트의 JSON 스키마에 따라 선택지를 제공하십시오.\n    `;const chatHistory=[{role:\"user\",parts:[{text:systemPrompt}]},{role:\"user\",parts:[{text:userPrompt}]}];const payload={contents:chatHistory};console.log(\"DEBUG: Payload:\",JSON.stringify(payload,null,2));try{const response=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});console.log(\"DEBUG: Fetch response received.\");if(!response.ok){const errorBody=await response.text();console.error(\"DEBUG: HTTP Error Response:\",response.status,response.statusText,errorBody);throw new Error(`HTTP error! status: ${response.status}, body: ${errorBody}`);}const result=await response.json();console.log(\"DEBUG: Parsed JSON result:\",JSON.stringify(result,null,2));if(result.candidates&&result.candidates.length>0&&result.candidates[0].content&&result.candidates[0].content.parts&&result.candidates[0].content.parts.length>0){let llmOutputText=result.candidates[0].content.parts[0].text;console.log(\"DEBUG: LLM Raw Output Text:\",llmOutputText);// Extract JSON object from the LLM response, in case it includes pre/postamble text.\nconst jsonMatch=llmOutputText.match(/\\{[\\s\\S]*\\}/);if(jsonMatch){llmOutputText=jsonMatch[0];}else{throw new Error(\"Valid JSON object not found in LLM response.\");}// Attempt to parse the extracted JSON string.\ntry{const llmOutput=JSON.parse(llmOutputText);console.log(\"DEBUG: LLM Parsed Output JSON:\",JSON.stringify(llmOutput,null,2));return llmOutput;}catch(parsingError){console.error(\"JSON Parsing Error:\",parsingError);console.error(\"Malformed JSON string from LLM:\",llmOutputText);throw new Error(`LLM response was not valid JSON. Details: ${parsingError.message}`);}}else{console.error(\"LLM response structure is different than expected:\",result);throw new Error(\"Invalid LLM response structure.\");}}catch(error){console.error(\"LLM API call error:\",error);return{story:`오류: LLM API 호출 중 문제가 발생했습니다: ${error.message}. 네트워크 연결을 확인하고 다시 시도해주세요.`,choices:[\"다시 시도\"],inventoryUpdates:promptData.character.inventory,statChanges:promptData.character.stats,location:promptData.character.currentLocation,reputationUpdates:promptData.character.reputation,activeQuestsUpdates:promptData.character.activeQuests,companionsUpdates:promptData.character.companions};}finally{setIsTextLoading(false);console.log(\"DEBUG: Finished callGeminiTextLLM\");}};// Function to save game state.\nconst saveGame=async()=>{if(!db||!userId||!isAuthReady){setGameLog(prev=>[...prev,\"오류: 게임을 저장할 수 없습니다. 인증 상태를 확인해주세요.\"]);return;}setIsTextLoading(true);try{// Private data is at /artifacts/{appId}/users/{userId}/{your_collection_name}\nconst gameDocRef=doc(db,'artifacts',appId,'users',userId,'textAdventureGame','gameState');await setDoc(gameDocRef,{gameLog:gameLog,gamePhase:gamePhase,playerCharacter:playerCharacter,currentChoices:currentChoices,timestamp:new Date().toISOString()});setGameLog(prev=>[...prev,\"\\n게임이 성공적으로 저장되었습니다.\"]);}catch(error){console.error(\"Game save error:\",error);setGameLog(prev=>[...prev,`\\n게임 저장 중 오류가 발생했습니다: ${error.message}`]);}finally{setIsTextLoading(false);}};// Function to load game state.\nconst loadGame=async()=>{if(!db||!userId||!isAuthReady){setGameLog(prev=>[...prev,\"오류: 게임을 불러올 수 없습니다. 인증 상태를 확인해주세요.\"]);return;}setIsTextLoading(true);try{// Private data is at /artifacts/{appId}/users/{userId}/{your_collection_name}\nconst gameDocRef=doc(db,'artifacts',appId,'users',userId,'textAdventureGame','gameState');const docSnap=await getDoc(gameDocRef);if(docSnap.exists()){const savedData=docSnap.data();setGameLog(savedData.gameLog||[]);setGamePhase(savedData.gamePhase||'characterSelection');setPlayerCharacter(savedData.playerCharacter||{profession:'',stats:{strength:10,intelligence:10,agility:10,charisma:10},inventory:[],initialMotivation:'',currentLocation:'방랑자의 안식처',// Set initial location to 'Wanderer's Rest'\nreputation:{},activeQuests:[],companions:[]});setCurrentChoices(savedData.currentChoices||[]);setGameLog(prev=>[...prev,\"\\n게임이 성공적으로 불러와졌습니다.\"]);}else{setGameLog(prev=>[...prev,\"\\n저장된 게임이 없습니다.\"]);}}catch(error){console.error(\"Game load error:\",error);setGameLog(prev=>[...prev,`\\n게임 불러오기 중 오류가 발생했습니다: ${error.message}`]);}finally{setIsTextLoading(false);}};// Function to send user feedback.\nconst sendFeedback=async()=>{if(!db||!userId||!isAuthReady||!feedbackText.trim()){setGameLog(prev=>[...prev,\"피드백을 보낼 수 없습니다. 내용을 입력하거나 인증 상태를 확인해주세요.\"]);return;}setIsTextLoading(true);try{// Private data is at /artifacts/{appId}/users/{userId}/{your_collection_name}\nconst feedbackCollectionRef=collection(db,'artifacts',appId,'users',userId,'feedback');await addDoc(feedbackCollectionRef,{feedback:feedbackText,gameLogSnapshot:gameLog.slice(-10),// Snapshot of the last 10 logs\nplayerCharacterSnapshot:playerCharacter,timestamp:serverTimestamp()});setGameLog(prev=>[...prev,\"\\n피드백이 성공적으로 전송되었습니다. 감사합니다!\"]);setFeedbackText('');setShowFeedbackModal(false);}catch(error){console.error(\"Feedback submission error:\",error);setGameLog(prev=>[...prev,`\\n피드백 전송 중 오류가 발생했습니다: ${error.message}`]);}finally{setIsTextLoading(false);}};// Function to send a public chat message\nconst sendChatMessage=async()=>{if(!db||!userId||!isAuthReady||!currentChatMessage.trim()){console.warn(\"채팅 메시지를 보낼 수 없습니다. 내용을 입력하거나 인증 상태를 확인해주세요.\");return;}try{const chatCollectionRef=collection(db,'artifacts',appId,'public','data','chatMessages');await addDoc(chatCollectionRef,{userId:userId,displayName:`플레이어 ${userId.substring(0,4)}`,message:currentChatMessage,timestamp:serverTimestamp()});setCurrentChatMessage('');// Clear input field after sending message\n}catch(error){console.error(\"Error sending chat message:\",error);}};// Function to send a private chat message\nconst sendPrivateChatMessage=async()=>{if(!db||!userId||!isAuthReady||!selectedPlayerForChat||!currentPrivateChatMessage.trim()){console.warn(\"개인 메시지를 보낼 수 없습니다. 내용을 입력하거나 대화 상대를 선택해주세요.\");return;}try{const chatRoomId=getPrivateChatRoomId(userId,selectedPlayerForChat.id);const privateChatCollectionRef=collection(db,'artifacts',appId,'privateChats',chatRoomId,'messages');await addDoc(privateChatCollectionRef,{senderId:userId,receiverId:selectedPlayerForChat.id,// Explicit receiver ID\ndisplayName:`플레이어 ${userId.substring(0,4)}`,message:currentPrivateChatMessage,timestamp:serverTimestamp()});// [NEW] 수신자에게 새 메시지 알림 플래그 추가\nconst receiverNotificationDocRef=doc(db,'artifacts',appId,'users',selectedPlayerForChat.id,'incomingMessages',userId);await setDoc(receiverNotificationDocRef,{lastMessageTimestamp:serverTimestamp(),senderDisplayName:`플레이어 ${userId.substring(0,4)}`,senderId:userId// 알림 규칙을 위해 senderId 필드를 추가합니다.\n},{merge:true});setCurrentPrivateChatMessage('');// Clear input field after sending message\n}catch(error){console.error(\"Error sending private message:\",error);}};// Open private chat modal\nconst openPlayerChatModal=player=>{setSelectedPlayerForChat(player);setShowPlayerChatModal(true);// [수정] 모달을 열 때 isPrivateChatModalManuallyClosed를 항상 false로 설정\nsetIsPrivateChatModalManuallyClosed(false);// [NEW] 모달을 열 때 해당 발신자로부터의 알림 플래그를 삭제합니다.\nif(db&&userId&&player.id){deleteDoc(doc(db,'artifacts',appId,'users',userId,'incomingMessages',player.id)).catch(error=>{console.error(\"Error deleting incoming message notification on modal open:\",error);});}};// Close private chat modal\nconst closePlayerChatModal=async()=>{if(!db||!userId||!selectedPlayerForChat)return;try{const chatRoomId=getPrivateChatRoomId(userId,selectedPlayerForChat.id);// [수정] chatRoomId 문서 자체를 참조하고, 그 안에 status 필드를 업데이트\nconst chatRoomDocRef=doc(db,'artifacts',appId,'privateChats',chatRoomId);await setDoc(chatRoomDocRef,{status:{// status 필드 안에 객체로 저장\n[`closedBy.${userId}`]:true,lastClosedBy:userId,lastClosedAt:serverTimestamp()}},{merge:true});setSelectedPlayerForChat(null);setPrivateChatMessages([]);setCurrentPrivateChatMessage('');setShowPlayerChatModal(false);// [수정] 모달을 닫을 때 isPrivateChatModalManuallyClosed를 true로 설정\nsetIsPrivateChatModalManuallyClosed(true);}catch(error){console.error(\"Error closing private chat modal:\",error);}};// New useEffect: Listen for private chat close signals from the other user\nuseEffect(()=>{if(!db||!isAuthReady||!userId||!selectedPlayerForChat)return;const chatRoomId=getPrivateChatRoomId(userId,selectedPlayerForChat.id);// [수정] chatRoomId 문서 자체를 참조\nconst chatRoomDocRef=doc(db,'artifacts',appId,'privateChats',chatRoomId);const unsubscribeChatStatus=onSnapshot(chatRoomDocRef,docSnap=>{if(docSnap.exists()){const data=docSnap.data();// [수정] status 필드 내의 데이터에 접근\nconst statusData=data.status||{};const otherUserId=selectedPlayerForChat.id;// If the other user has closed the chat and it's not me who closed it last\nif(statusData.closedBy&&statusData.closedBy[otherUserId]&&statusData.lastClosedBy!==userId){// Close the modal if it's open and the other user closed it\nif(showPlayerChatModal){setSelectedPlayerForChat(null);setPrivateChatMessages([]);setCurrentPrivateChatMessage('');setShowPlayerChatModal(false);setIsPrivateChatModalManuallyClosed(false);// Reset manual close state\nsetGameLog(prev=>[...prev,`\\n> ${selectedPlayerForChat.displayName}님이 대화를 종료했습니다.`]);}}}},error=>{console.error(\"Private chat status snapshot error:\",error);});return()=>unsubscribeChatStatus();},[db,isAuthReady,userId,selectedPlayerForChat,showPlayerChatModal,appId]);// Added appId to dependency array\n// Private chat end and scenario reflection function (modified)\nconst handleEndPrivateChatAndReflectScenario=async()=>{if(!selectedPlayerForChat)return;// [수정] Close modal first to improve user experience before LLM call\nclosePlayerChatModal();// Start loading state\nsetIsTextLoading(true);setGameLog(prev=>[...prev,`\\n> ${selectedPlayerForChat.displayName}님과의 대화 내용을 바탕으로 시나리오를 진행합니다...\\n`]);// Construct promptData to send to LLM\nconst promptData={phase:'playing',playerChoice:`플레이어 ${selectedPlayerForChat.displayName}님과의 대화 종료.`,character:playerCharacter,history:gameLog,activeUsers:activeUsers.filter(user=>user.id!==userId),privateChatHistory:privateChatMessages};try{// [수정] Update shared scenario progress status in Firestore\nconst gameStatusDocRef=doc(db,'artifacts',appId,'public','data','gameStatus','status');await setDoc(gameStatusDocRef,{isActionInProgress:true,actingPlayer:{id:userId,displayName:`플레이어 ${userId.substring(0,4)}`}},{merge:true});const llmResponse=await callGeminiTextLLM(promptData);// Ideally, Cloud Functions should be used to update multiple players' states.\n// For now, update only current player's state and shared log on the client side.\nsetGameLog(prev=>[...prev,llmResponse.story]);if(db&&userId){const sharedLogCollectionRef=collection(db,'artifacts',appId,'public','data','sharedGameLog');await addDoc(sharedLogCollectionRef,{userId:userId,displayName:`플레이어 ${userId.substring(0,4)}`,content:`[${playerCharacter.profession}]이(가) ${selectedPlayerForChat.displayName}님과 대화 후: ${llmResponse.story}`,timestamp:serverTimestamp()});}setPlayerCharacter(prev=>({...prev,inventory:llmResponse.inventoryUpdates&&llmResponse.inventoryUpdates.length>0?llmResponse.inventoryUpdates:prev.inventory,stats:llmResponse.statChanges&&!isObjectEmpty(llmResponse.statChanges)?llmResponse.statChanges:prev.stats,currentLocation:llmResponse.location||prev.currentLocation,reputation:llmResponse.reputationUpdates&&!isObjectEmpty(llmResponse.reputationUpdates)?llmResponse.reputationUpdates:prev.reputation,activeQuests:llmResponse.activeQuestsUpdates&&llmResponse.activeQuestsUpdates.length>0?llmResponse.activeQuestsUpdates:prev.activeQuests,companions:llmResponse.companionsUpdates&&llmResponse.companionsUpdates.length>0?llmResponse.companionsUpdates:prev.companions}));setCurrentChoices(llmResponse.choices||[]);}catch(error){console.error(\"Error processing private chat with LLM:\",error);setGameLog(prev=>[...prev,`\\n오류: 개인 대화 내용을 시나리오에 반영하는 중 문제가 발생했습니다: ${error.message}`]);}finally{// [수정] Change status back to false after scenario progress is complete\nconst gameStatusDocRef=doc(db,'artifacts',appId,'public','data','gameStatus','status');await setDoc(gameStatusDocRef,{isActionInProgress:false,actingPlayer:null},{merge:true});setIsTextLoading(false);// End loading state\n}};// Helper function to check if an object is empty\nconst isObjectEmpty=obj=>Object.keys(obj).length===0&&obj.constructor===Object;// Player choice button click handler (modified)\nconst handleChoiceClick=async choice=>{// [수정] Cannot select if another player is acting\nif(isTextLoading||isCompanionActionInProgress)return;setGameLog(prev=>[...prev,`\\n> 당신의 선택: ${choice}\\n`]);setCurrentChoices([]);let promptData;try{// [수정] Set scenario progress status to true\nif(db&&userId){const gameStatusDocRef=doc(db,'artifacts',appId,'public','data','gameStatus','status');await setDoc(gameStatusDocRef,{isActionInProgress:true,actingPlayer:{id:userId,displayName:`플레이어 ${userId.substring(0,4)}`}},{merge:true});}if(gamePhase==='characterSelection'){const chosenProfessionKey=choice.split('.')[0].trim();const chosenProfession=professions[chosenProfessionKey];if(chosenProfession){const initialCharacterState={profession:chosenProfession.name,stats:{strength:chosenProfession.name.includes('기사')||chosenProfession.name.includes('용병')?12:10,intelligence:chosenProfession.name.includes('마법사')?12:10,agility:chosenProfession.name.includes('도적')?12:10,charisma:chosenProfession.name.includes('왕족')?12:10},inventory:[],initialMotivation:chosenProfession.motivation,currentLocation:'방랑자의 안식처',reputation:{},activeQuests:[],companions:[]};setPlayerCharacter(initialCharacterState);promptData={phase:'characterSelection',playerChoice:choice,character:initialCharacterState,history:gameLog,activeUsers:activeUsers.filter(user=>user.id!==userId),privateChatHistory:[]};const llmResponse=await callGeminiTextLLM(promptData);setGameLog(prev=>[...prev,llmResponse.story]);setPlayerCharacter(prev=>({...prev,inventory:llmResponse.inventoryUpdates&&llmResponse.inventoryUpdates.length>0?llmResponse.inventoryUpdates:prev.inventory,stats:llmResponse.statChanges&&!isObjectEmpty(llmResponse.statChanges)?llmResponse.statChanges:prev.stats,currentLocation:llmResponse.location||prev.currentLocation,reputation:llmResponse.reputationUpdates&&!isObjectEmpty(llmResponse.reputationUpdates)?llmResponse.reputationUpdates:prev.reputation,activeQuests:llmResponse.activeQuestsUpdates&&llmResponse.activeQuestsUpdates.length>0?llmResponse.activeQuestsUpdates:prev.activeQuests,companions:llmResponse.companionsUpdates&&llmResponse.companionsUpdates.length>0?llmResponse.companionsUpdates:prev.companions}));setCurrentChoices(llmResponse.choices||[]);setGamePhase('playing');}else{setGameLog(prev=>[...prev,\"유효하지 않은 선택입니다. 제시된 직업 중 하나를 선택해주세요.\"]);setCurrentChoices(Object.keys(professions).map(key=>`${key}. ${professions[key].name}`));}}else{// gamePhase === 'playing'\npromptData={phase:'playing',playerChoice:choice,character:playerCharacter,history:gameLog,activeUsers:activeUsers.filter(user=>user.id!==userId),privateChatHistory:[]};const llmResponse=await callGeminiTextLLM(promptData);setGameLog(prev=>[...prev,llmResponse.story]);if(db&&userId){const sharedLogCollectionRef=collection(db,'artifacts',appId,'public','data','sharedGameLog');await addDoc(sharedLogCollectionRef,{userId:userId,displayName:`플레이어 ${userId.substring(0,4)}`,content:`[${playerCharacter.profession}]의 선택: ${choice}\\n\\n${llmResponse.story}`,timestamp:serverTimestamp()});}setPlayerCharacter(prev=>({...prev,inventory:llmResponse.inventoryUpdates&&llmResponse.inventoryUpdates.length>0?llmResponse.inventoryUpdates:prev.inventory,stats:llmResponse.statChanges&&!isObjectEmpty(llmResponse.statChanges)?llmResponse.statChanges:prev.stats,currentLocation:llmResponse.location||prev.currentLocation,reputation:llmResponse.reputationUpdates&&!isObjectEmpty(llmResponse.reputationUpdates)?llmResponse.reputationUpdates:prev.reputation,activeQuests:llmResponse.activeQuestsUpdates&&llmResponse.activeQuestsUpdates.length>0?llmResponse.activeQuestsUpdates:prev.activeQuests,companions:llmResponse.companionsUpdates&&llmResponse.companionsUpdates.length>0?llmResponse.companionsUpdates:prev.companions}));setCurrentChoices(llmResponse.choices||[]);}}catch(error){console.error(\"Error during choice handling:\",error);setGameLog(prev=>[...prev,`\\n오류가 발생했습니다: ${error.message}`]);}finally{// [수정] Change status back to false after scenario progress is complete\nif(db&&userId){const gameStatusDocRef=doc(db,'artifacts',appId,'public','data','gameStatus','status');await setDoc(gameStatusDocRef,{isActionInProgress:false,actingPlayer:null},{merge:true});}}};const isMyTurn=!isCompanionActionInProgress||actingPlayer&&actingPlayer.id===userId;const isCompanionSystemActive=playerCharacter.companions.length>0;return/*#__PURE__*/_jsxs(\"div\",{className:\"min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center justify-center p-4 font-sans\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"w-full max-w-5xl bg-gray-800 rounded-lg shadow-xl p-6 md:p-8 flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col w-full lg:w-2/3 space-y-6\",children:[isAuthReady&&userId&&/*#__PURE__*/_jsxs(\"div\",{className:\"text-xs text-gray-500 text-center mb-2\",children:[\"\\uC0AC\\uC6A9\\uC790 ID: \",userId]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex-grow bg-gray-700 p-4 rounded-md overflow-y-auto h-96 custom-scrollbar text-sm md:text-base leading-relaxed\",children:[gameLog.map((line,index)=>/*#__PURE__*/_jsx(\"p\",{className:\"whitespace-pre-wrap mb-1\",dangerouslySetInnerHTML:{__html:line.replace(/\\n/g,'<br />')}},index)),isTextLoading&&/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-center items-center mt-4\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-300\"}),/*#__PURE__*/_jsx(\"span\",{className:\"ml-3 text-gray-400\",children:\"\\uC774\\uC57C\\uAE30\\uB97C \\uC0DD\\uC131 \\uC911...\"})]}),isCompanionSystemActive&&isCompanionActionInProgress&&!isMyTurn&&/*#__PURE__*/_jsx(\"div\",{className:\"text-center text-yellow-400 font-semibold p-2 bg-black bg-opacity-20 rounded-md mt-2\",children:actingPlayer?`${actingPlayer.displayName}님이 선택하고 있습니다...`:\"동료가 선택하고 있습니다...\"}),/*#__PURE__*/_jsx(\"div\",{ref:logEndRef}),\" \"]}),gamePhase==='playing'&&/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-700 p-3 rounded-md text-xs md:text-sm text-gray-300 space-y-1\",children:[/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-gray-100\",children:\"\\uC9C1\\uC5C5:\"}),\" \",playerCharacter.profession]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-gray-100\",children:\"\\uC704\\uCE58:\"}),\" \",playerCharacter.currentLocation]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-gray-100\",children:\"\\uB2A5\\uB825\\uCE58:\"}),\" \\uD798(\",playerCharacter.stats.strength,\") \\uC9C0\\uB2A5(\",playerCharacter.stats.intelligence,\") \\uBBFC\\uCCA9(\",playerCharacter.stats.agility,\") \\uCE74\\uB9AC\\uC2A4\\uB9C8(\",playerCharacter.stats.charisma,\")\"]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-gray-100\",children:\"\\uC778\\uBCA4\\uD1A0\\uB9AC:\"}),\" \",playerCharacter.inventory.length>0?playerCharacter.inventory.join(', '):'비어있음']}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-gray-100\",children:\"\\uD3C9\\uD310:\"}),\" \",Object.keys(playerCharacter.reputation).length>0?Object.entries(playerCharacter.reputation).map(_ref=>{let[key,value]=_ref;return`${key}: ${value}`;}).join(', '):'없음']}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-gray-100\",children:\"\\uD018\\uC2A4\\uD2B8:\"}),\" \",playerCharacter.activeQuests.length>0?playerCharacter.activeQuests.join(', '):'없음']}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-gray-100\",children:\"\\uB3D9\\uB8CC:\"}),\" \",playerCharacter.companions.length>0?playerCharacter.companions.join(', '):'없음']})]}),/*#__PURE__*/_jsx(\"div\",{className:\"flex flex-col gap-3\",children:currentChoices.map((choice,index)=>/*#__PURE__*/_jsx(\"button\",{className:\"px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed\",onClick:()=>handleChoiceClick(choice)// [수정] Disable when companion is acting\n,disabled:isTextLoading||isCompanionSystemActive&&!isMyTurn,children:choice},index))}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col md:flex-row gap-3 mt-4\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed\",onClick:saveGame,disabled:isTextLoading||!isAuthReady||!userId||gamePhase==='characterSelection',children:\"\\uAC8C\\uC784 \\uC800\\uC7A5\"}),/*#__PURE__*/_jsx(\"button\",{className:\"flex-1 px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed\",onClick:loadGame,disabled:isTextLoading||!isAuthReady||!userId,children:\"\\uAC8C\\uC784 \\uBD88\\uB7EC\\uC624\\uAE30\"}),/*#__PURE__*/_jsx(\"button\",{className:\"flex-1 px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed\",onClick:()=>setShowFeedbackModal(true),disabled:isTextLoading||!isAuthReady||!userId,children:\"\\uD53C\\uB4DC\\uBC31 \\uBCF4\\uB0B4\\uAE30\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"w-full lg:w-1/3 flex flex-col space-y-6 bg-gray-700 p-4 rounded-lg shadow-inner\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-lg font-bold text-gray-100 text-center mb-4\",children:\"\\uACF5\\uC720\\uB41C \\uBAA8\\uD5D8\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-600 p-3 rounded-md h-48 overflow-y-auto custom-scrollbar\",children:[/*#__PURE__*/_jsx(\"h4\",{className:\"text-md font-semibold text-gray-200 mb-2\",children:\"\\uD604\\uC7AC \\uD50C\\uB808\\uC774\\uC5B4\\uB4E4:\"}),activeUsers.length>0?/*#__PURE__*/_jsx(\"ul\",{className:\"text-sm text-gray-300 space-y-1\",children:activeUsers.map(user=>/*#__PURE__*/_jsxs(\"li\",{className:\"truncate flex justify-between items-center p-1 rounded-md hover:bg-gray-500 cursor-pointer\"// Added hover and cursor styles\n,onDoubleClick:()=>user.id!==userId&&openPlayerChatModal(user)// Double-click handler\n,children:[/*#__PURE__*/_jsxs(\"span\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-medium text-blue-300\",children:user.displayName}),user.isCompanion&&/*#__PURE__*/_jsx(\"span\",{className:\"text-green-400 ml-2\",children:\"(\\uB3D9\\uB8CC)\"})]}),user.id!==userId&&/*#__PURE__*/// Do not show chat button for self\n_jsx(\"button\",{className:\"ml-2 px-3 py-1 bg-indigo-500 hover:bg-indigo-600 text-white text-xs rounded-md\",onClick:()=>openPlayerChatModal(user),children:\"\\uB300\\uD654\\uD558\\uAE30\"})]},user.id))}):/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-400\",children:\"\\uD65C\\uB3D9 \\uC911\\uC778 \\uD50C\\uB808\\uC774\\uC5B4\\uAC00 \\uC5C6\\uC2B5\\uB2C8\\uB2E4.\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-600 p-3 rounded-md flex-grow h-96 overflow-y-auto custom-scrollbar\",children:[/*#__PURE__*/_jsx(\"h4\",{className:\"text-md font-semibold text-gray-200 mb-2\",children:\"\\uBAA8\\uB4E0 \\uD50C\\uB808\\uC774\\uC5B4\\uC758 \\uD65C\\uB3D9:\"}),sharedGameLog.length>0?/*#__PURE__*/_jsxs(\"div\",{className:\"text-sm text-gray-300 space-y-2\",children:[sharedGameLog.map(logEntry=>/*#__PURE__*/_jsxs(\"div\",{className:\"border-b border-gray-500 pb-2 last:border-b-0\",children:[/*#__PURE__*/_jsxs(\"p\",{className:\"text-xs text-gray-400 mb-1\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-medium text-purple-300\",children:logEntry.displayName}),\" (\",logEntry.timestamp?new Date(logEntry.timestamp.toMillis()).toLocaleTimeString():'시간 없음',\")\"]}),/*#__PURE__*/_jsx(\"p\",{className:\"whitespace-pre-wrap\",dangerouslySetInnerHTML:{__html:logEntry.content.replace(/\\n/g,'<br />')}})]},logEntry.id)),/*#__PURE__*/_jsx(\"div\",{ref:sharedLogEndRef})]}):/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-400\",children:\"\\uACF5\\uC720\\uB41C \\uD65C\\uB3D9\\uC774 \\uC544\\uC9C1 \\uC5C6\\uC2B5\\uB2C8\\uB2E4.\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-600 p-3 rounded-md flex flex-col h-64\",children:[/*#__PURE__*/_jsx(\"h4\",{className:\"text-md font-semibold text-gray-200 mb-2\",children:\"\\uACF5\\uAC1C \\uCC44\\uD305:\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex-grow overflow-y-auto custom-scrollbar mb-3 text-sm text-gray-300 space-y-2\",children:[chatMessages.length>0?chatMessages.map(msg=>/*#__PURE__*/_jsxs(\"div\",{className:\"border-b border-gray-500 pb-1 last:border-b-0\",children:[/*#__PURE__*/_jsxs(\"p\",{className:\"text-xs text-gray-400\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-medium text-green-300\",children:msg.displayName}),\" (\",msg.timestamp?new Date(msg.timestamp.toMillis()).toLocaleTimeString():'시간 없음',\"):\"]}),/*#__PURE__*/_jsx(\"p\",{children:msg.message})]},msg.id)):/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-400\",children:\"\\uC544\\uC9C1 \\uCC44\\uD305 \\uBA54\\uC2DC\\uC9C0\\uAC00 \\uC5C6\\uC2B5\\uB2C8\\uB2E4.\"}),/*#__PURE__*/_jsx(\"div\",{ref:chatEndRef}),\" \"]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",className:\"flex-grow p-2 rounded-l-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm\",placeholder:\"\\uBA54\\uC2DC\\uC9C0\\uB97C \\uC785\\uB825\\uD558\\uC138\\uC694...\",value:currentChatMessage,onChange:e=>setCurrentChatMessage(e.target.value),onKeyPress:e=>{if(e.key==='Enter'){sendChatMessage();}},disabled:!isAuthReady||!userId}),/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-r-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm\",onClick:sendChatMessage,disabled:!isAuthReady||!userId||!currentChatMessage.trim(),children:\"\\uBCF4\\uB0B4\\uAE30\"})]})]})]})]}),showFeedbackModal&&/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-xl font-bold text-gray-100\",children:\"\\uD53C\\uB4DC\\uBC31 \\uBCF4\\uB0B4\\uAE30\"}),/*#__PURE__*/_jsx(\"textarea\",{className:\"w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 h-32 resize-none\",placeholder:\"\\uAC8C\\uC784\\uC5D0 \\uB300\\uD55C \\uD53C\\uB4DC\\uBC31\\uC744 \\uC5EC\\uAE30\\uC5D0 \\uC791\\uC131\\uD574\\uC8FC\\uC138\\uC694...\",value:feedbackText,onChange:e=>setFeedbackText(e.target.value),disabled:isTextLoading}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-end gap-3\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed\",onClick:()=>setShowFeedbackModal(false),disabled:isTextLoading,children:\"\\uCDE8\\uC18C\"}),/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed\",onClick:sendFeedback,disabled:isTextLoading||!feedbackText.trim(),children:\"\\uBCF4\\uB0B4\\uAE30\"})]})]})}),showPlayerChatModal&&selectedPlayerForChat&&/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 flex flex-col h-3/4 max-h-[80vh]\",children:[/*#__PURE__*/_jsxs(\"h3\",{className:\"text-xl font-bold text-gray-100\",children:[selectedPlayerForChat.displayName,\" (\",selectedPlayerForChat.profession,\") \\uB2D8\\uACFC \\uB300\\uD654\"]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex-grow bg-gray-700 p-3 rounded-md overflow-y-auto custom-scrollbar text-sm text-gray-300 space-y-2\",children:[privateChatMessages.length>0?privateChatMessages.map(msg=>/*#__PURE__*/_jsx(\"div\",{className:`flex ${msg.senderId===userId?'justify-end':'justify-start'}`,children:/*#__PURE__*/_jsxs(\"div\",{className:`p-2 rounded-lg max-w-[80%] ${msg.senderId===userId?'bg-blue-600 text-white':'bg-gray-600 text-gray-100'}`,children:[/*#__PURE__*/_jsxs(\"p\",{className:\"text-xs text-gray-300 mb-1\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-medium\",children:msg.displayName}),\" (\",msg.timestamp?new Date(msg.timestamp.toMillis()).toLocaleTimeString():'시간 없음',\")\"]}),/*#__PURE__*/_jsx(\"p\",{children:msg.message})]})},msg.id)):/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-400 text-center\",children:\"\\uC544\\uC9C1 \\uB300\\uD654\\uAC00 \\uC5C6\\uC2B5\\uB2C8\\uB2E4. \\uBA3C\\uC800 \\uBA54\\uC2DC\\uC9C0\\uB97C \\uBCF4\\uB0B4\\uC138\\uC694!\"}),/*#__PURE__*/_jsx(\"div\",{ref:privateChatEndRef})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",className:\"flex-grow p-2 rounded-l-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm\",placeholder:\"\\uAC1C\\uC778 \\uBA54\\uC2DC\\uC9C0\\uB97C \\uC785\\uB825\\uD558\\uC138\\uC694...\",value:currentPrivateChatMessage,onChange:e=>setCurrentPrivateChatMessage(e.target.value),onKeyPress:e=>{if(e.key==='Enter'){sendPrivateChatMessage();}},disabled:!isAuthReady||!userId||!selectedPlayerForChat}),/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-r-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm\",onClick:sendPrivateChatMessage,disabled:!isAuthReady||!userId||!selectedPlayerForChat||!currentPrivateChatMessage.trim(),children:\"\\uBCF4\\uB0B4\\uAE30\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-end gap-3 mt-4\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed\",onClick:handleEndPrivateChatAndReflectScenario,disabled:isTextLoading||privateChatMessages.length===0,children:\"\\uB300\\uD654 \\uC885\\uB8CC \\uBC0F \\uC2DC\\uB098\\uB9AC\\uC624 \\uBC18\\uC601\"}),/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-md transition duration-300\",onClick:closePlayerChatModal// [수정] Close button is always active\n,children:\"\\uB2EB\\uAE30\"})]})]})}),/*#__PURE__*/_jsx(\"style\",{children:`\n        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');\n        body {\n          font-family: 'Noto Sans KR', sans-serif;\n        }\n        .custom-scrollbar::-webkit-scrollbar {\n          width: 8px;\n        }\n        .custom-scrollbar::-webkit-scrollbar-track {\n          background: #4a5568; /* gray-600 */\n          border-radius: 10px;\n        }\n        .custom-scrollbar::-webkit-scrollbar-thumb {\n          background: #6b7280; /* gray-500 */\n          border-radius: 10px;\n        }\n        .custom-scrollbar::-webkit-scrollbar-thumb:hover {\n          background: #9ca3af; /* gray-400 */\n        }\n        `})]});}export default App;","map":{"version":3,"names":["React","useState","useEffect","useRef","initializeApp","getAuth","signInAnonymously","signInWithCustomToken","onAuthStateChanged","getFirestore","doc","setDoc","getDoc","collection","query","onSnapshot","serverTimestamp","addDoc","getDocs","deleteDoc","where","jsxs","_jsxs","jsx","_jsx","defaultFirebaseConfig","apiKey","authDomain","projectId","storageBucket","messagingSenderId","appId","measurementId","firebaseConfig","initialAuthToken","professions","name","motivation","App","gameLog","setGameLog","isTextLoading","setIsTextLoading","gamePhase","setGamePhase","playerCharacter","setPlayerCharacter","profession","stats","strength","intelligence","agility","charisma","inventory","initialMotivation","currentLocation","reputation","activeQuests","companions","currentChoices","setCurrentChoices","showFeedbackModal","setShowFeedbackModal","feedbackText","setFeedbackText","sharedGameLog","setSharedGameLog","activeUsers","setActiveUsers","chatMessages","setChatMessages","currentChatMessage","setCurrentChatMessage","showPlayerChatModal","setShowPlayerChatModal","selectedPlayerForChat","setSelectedPlayerForChat","privateChatMessages","setPrivateChatMessages","currentPrivateChatMessage","setCurrentPrivateChatMessage","isPrivateChatModalManuallyClosed","setIsPrivateChatModalManuallyClosed","isCompanionActionInProgress","setIsCompanionActionInProgress","actingPlayer","setActingPlayer","db","setDb","auth","setAuth","userId","setUserId","isAuthReady","setIsAuthReady","logEndRef","sharedLogEndRef","chatEndRef","privateChatEndRef","console","error","prev","app","firestoreDb","firebaseAuth","unsubscribeAuth","user","uid","gameStatusDocRef","unsubscribeGameStatus","docSnap","exists","data","isActionInProgress","sharedLogCollectionRef","qSharedLog","unsubscribeSharedLog","snapshot","logs","docs","map","id","sort","a","b","_a$timestamp","_b$timestamp","timestamp","toMillis","activeUsersCollectionRef","qActiveUsers","unsubscribeActiveUsers","cutoffTime","Date","now","users","filter","lastActive","chatCollectionRef","qChatMessages","unsubscribeChatMessages","messages","_a$timestamp2","_b$timestamp2","updateUserPresence","userDocRef","displayName","substring","isCompanion","length","merge","presenceInterval","setInterval","clearInterval","cleanupInactiveUsers","inactiveThreshold","querySnapshot","forEach","docSnapshot","userData","log","cleanupInterval","Object","keys","key","current","scrollIntoView","behavior","getPrivateChatRoomId","user1Id","user2Id","sortedIds","chatRoomId","privateChatCollectionRef","qPrivateChat","unsubscribePrivateChat","_a$timestamp3","_b$timestamp3","incomingMessagesCollectionRef","qIncomingMessages","unsubscribeIncomingMessages","docChanges","change","type","notification","senderId","senderInfo","find","openPlayerChatModal","senderDisplayName","catch","systemPrompt","callGeminiTextLLM","promptData","apiUrl","userPrompt","phase","character","JSON","stringify","history","slice","playerChoice","privateChatHistory","chatHistory","role","parts","text","payload","contents","response","fetch","method","headers","body","ok","errorBody","status","statusText","Error","result","json","candidates","content","llmOutputText","jsonMatch","match","llmOutput","parse","parsingError","message","story","choices","inventoryUpdates","statChanges","location","reputationUpdates","activeQuestsUpdates","companionsUpdates","saveGame","gameDocRef","toISOString","loadGame","savedData","sendFeedback","trim","feedbackCollectionRef","feedback","gameLogSnapshot","playerCharacterSnapshot","sendChatMessage","warn","sendPrivateChatMessage","receiverId","receiverNotificationDocRef","lastMessageTimestamp","player","closePlayerChatModal","chatRoomDocRef","lastClosedBy","lastClosedAt","unsubscribeChatStatus","statusData","otherUserId","closedBy","handleEndPrivateChatAndReflectScenario","llmResponse","isObjectEmpty","obj","constructor","handleChoiceClick","choice","chosenProfessionKey","split","chosenProfession","initialCharacterState","includes","isMyTurn","isCompanionSystemActive","className","children","line","index","dangerouslySetInnerHTML","__html","replace","ref","join","entries","_ref","value","onClick","disabled","onDoubleClick","logEntry","toLocaleTimeString","msg","placeholder","onChange","e","target","onKeyPress"],"sources":["C:/workspaces/gemini/src/App.jsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\r\nimport { initializeApp } from 'firebase/app';\r\nimport {\r\n  getAuth,\r\n  signInAnonymously, // 익명 로그인 임포트\r\n  signInWithCustomToken, // 커스텀 토큰 로그인 임포트\r\n  onAuthStateChanged\r\n} from 'firebase/auth';\r\nimport {\r\n  getFirestore,\r\n  doc,\r\n  setDoc,\r\n  getDoc,\r\n  collection,\r\n  query,\r\n  onSnapshot,\r\n  serverTimestamp,\r\n  addDoc,\r\n  getDocs, // 추가: 문서 목록을 가져오기 위해\r\n  deleteDoc, // 추가: 문서를 삭제하기 위해\r\n  where // [수정] where 임포트 추가\r\n} from 'firebase/firestore';\r\n\r\n// ====================================================================\r\n// Firebase configuration information (default if not provided by Canvas environment)\r\nconst defaultFirebaseConfig = {\r\n  apiKey: \"AIzaSyBNJtmpRWzjobrY556bnHkwbZmpFJqgPX8\", // Replace with your actual Firebase API key\r\n  authDomain: \"text-adventure-game-cb731.firebaseapp.com\",\r\n  projectId: \"text-adventure-game-cb731\",\r\n  storageBucket: \"text-adventure-game-cb731.firebaseapis.com\",\r\n  messagingSenderId: \"1092941614820\",\r\n  appId: \"1:1092941614820:web:5545f36014b73c268026f1\",\r\n  measurementId: \"G-FNGF42T1FP\"\r\n};\r\n\r\n// Use global variables provided by Canvas environment\r\nconst firebaseConfig = defaultFirebaseConfig;\r\nconst appId = firebaseConfig.projectId;\r\nconst initialAuthToken = null;\r\n// ====================================================================\r\n\r\n// Initial profession information and motivations for the game\r\nconst professions = {\r\n  '1': { name: '몰락한 귀족/기사', motivation: '가문의 몰락 원인을 조사하고, 잃어버린 가문의 보물을 찾아야 합니다.' },\r\n  '2': { name: '평범한 마을 사람/농부', motivation: '갑자기 마을에 나타난 괴생명체로부터 마을을 지켜야 합니다.' },\r\n  '3': { name: '젊은 마법사/견습생', motivation: '스승님의 실종에 대한 단서를 찾아야 합니다.' },\r\n  '4': { name: '용병/모험가', motivation: '의뢰받은 임무를 수행하던 중 예상치 못한 사건에 휘말렸습니다.' },\r\n  '5': { name: '도적/암살자', motivation: '길드에서 내려온 첫 번째 임무를 완수하고, 그 과정에서 수상한 음모를 감지해야 합니다.' },\r\n  '6': { name: '왕족/공주/왕자', motivation: '왕실 내의 불화와 암투 속에서 자신의 입지를 다져야 합니다.' },\r\n};\r\n\r\nfunction App() {\r\n  // Current game text log (private)\r\n  const [gameLog, setGameLog] = useState([]);\r\n  // LLM text response loading state\r\n  const [isTextLoading, setIsTextLoading] = useState(false);\r\n  // Game phase: 'characterSelection' or 'playing'\r\n  const [gamePhase, setGamePhase] = useState('characterSelection');\r\n  // Player character information\r\n  const [playerCharacter, setPlayerCharacter] = useState({\r\n    profession: '',\r\n    stats: { strength: 10, intelligence: 10, agility: 10, charisma: 10 }, // Base stats\r\n    inventory: [],\r\n    initialMotivation: '',\r\n    currentLocation: '방랑자의 안식처', // Set initial location to 'Wanderer's Rest'\r\n    reputation: {}, // NPC/faction reputation (managed by LLM)\r\n    activeQuests: [], // Active quests (managed by LLM)\r\n    companions: [], // Companions (managed by LLM)\r\n  });\r\n  // Current choices presented to the player\r\n  const [currentChoices, setCurrentChoices] = useState([]);\r\n  // Feedback modal display status\r\n  const [showFeedbackModal, setShowFeedbackModal] = useState(false);\r\n  // Feedback text\r\n  const [feedbackText, setFeedbackText] = useState('');\r\n  // Shared game log (multiplayer)\r\n  const [sharedGameLog, setSharedGameLog] = useState([]);\r\n  // List of active users (multiplayer)\r\n  const [activeUsers, setActiveUsers] = useState([]);\r\n  // List of chat messages (public chat)\r\n  const [chatMessages, setChatMessages] = useState([]);\r\n  // Current chat input value (public chat)\r\n  const [currentChatMessage, setCurrentChatMessage] = useState('');\r\n\r\n  // Private chat related states\r\n  const [showPlayerChatModal, setShowPlayerChatModal] = useState(false);\r\n  const [selectedPlayerForChat, setSelectedPlayerForChat] = useState(null); // { id, displayName, profession }\r\n  const [privateChatMessages, setPrivateChatMessages] = useState([]);\r\n  const [currentPrivateChatMessage, setCurrentPrivateChatMessage] = useState('');\r\n  // [수정] 개인 채팅 모달이 사용자에게 의해 닫혔는지 여부를 추적하는 상태\r\n  const [isPrivateChatModalManuallyClosed, setIsPrivateChatModalManuallyClosed] = useState(false);\r\n\r\n\r\n  // [추가] Companion scenario progress status\r\n  const [isCompanionActionInProgress, setIsCompanionActionInProgress] = useState(false);\r\n  const [actingPlayer, setActingPlayer] = useState(null); // [추가] Information of the player currently acting\r\n\r\n\r\n  // Firebase and authentication status\r\n  const [db, setDb] = useState(null);\r\n  const [auth, setAuth] = useState(null);\r\n  const [userId, setUserId] = useState(null);\r\n  const [isAuthReady, setIsAuthReady] = useState(false);\r\n\r\n  // Refs to keep scroll at the bottom\r\n  const logEndRef = useRef(null);\r\n  const sharedLogEndRef = useRef(null);\r\n  const chatEndRef = useRef(null); // Ref for public chat log\r\n  const privateChatEndRef = useRef(null); // Ref for private chat log\r\n\r\n  // Firebase initialization and authentication handling\r\n  useEffect(() => {\r\n    try {\r\n      // Check if Firebase API key is a placeholder.\r\n      if (firebaseConfig.apiKey === \"YOUR_API_KEY\" || !firebaseConfig.apiKey) {\r\n        console.error(\"Firebase initialization error: firebaseConfig.apiKey must be replaced with your actual Firebase API key.\");\r\n        setGameLog(prev => [...prev, \"오류: Firebase API 키가 올바르게 설정되지 않았습니다. 코드를 확인해주세요.\"]);\r\n        return; // Firebase initialization is stopped.\r\n      }\r\n\r\n      const app = initializeApp(firebaseConfig);\r\n      const firestoreDb = getFirestore(app);\r\n      const firebaseAuth = getAuth(app);\r\n\r\n      setDb(firestoreDb);\r\n      setAuth(firebaseAuth);\r\n\r\n      const unsubscribeAuth = onAuthStateChanged(firebaseAuth, async (user) => {\r\n        if (user) {\r\n          setUserId(user.uid);\r\n          setIsAuthReady(true);\r\n        } else {\r\n          // If no user is logged in, attempt anonymous sign-in.\r\n          try {\r\n            if (initialAuthToken) {\r\n              await signInWithCustomToken(firebaseAuth, initialAuthToken);\r\n            } else {\r\n              await signInAnonymously(firebaseAuth);\r\n            }\r\n          } catch (error) {\r\n            console.error(\"Firebase authentication failed:\", error);\r\n            setGameLog(prev => [...prev, \"오류: Firebase 인증에 실패했습니다.\"]);\r\n          }\r\n        }\r\n      });\r\n\r\n      return () => unsubscribeAuth();\r\n    } catch (error) {\r\n      console.error(\"Firebase initialization error:\", error);\r\n      setGameLog(prev => [...prev, \"오류: 게임을 초기화할 수 없습니다.\"]);\r\n    }\r\n  }, []);\r\n\r\n  // Set multiplayer data listeners after Firebase authentication is complete\r\n  useEffect(() => {\r\n    if (!db || !isAuthReady || !userId || !auth) return;\r\n\r\n    // [수정] Add listener to monitor game status (scenario progress, etc.)\r\n    const gameStatusDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'status');\r\n    const unsubscribeGameStatus = onSnapshot(gameStatusDocRef, (docSnap) => {\r\n        if (docSnap.exists()) {\r\n            const data = docSnap.data();\r\n            setIsCompanionActionInProgress(data.isActionInProgress || false);\r\n            setActingPlayer(data.actingPlayer || null); // Update acting player information\r\n        }\r\n    }, (error) => {\r\n        console.error(\"Game status snapshot error:\", error);\r\n    });\r\n\r\n    // 1. Shared game log listener\r\n    // Firestore security rules adjust the path.\r\n    // Public data is at /artifacts/{appId}/public/data/{your_collection_name}\r\n    const sharedLogCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'sharedGameLog');\r\n    const qSharedLog = query(sharedLogCollectionRef);\r\n    const unsubscribeSharedLog = onSnapshot(qSharedLog, (snapshot) => {\r\n      const logs = snapshot.docs\r\n        .map(doc => ({ id: doc.id, ...doc.data() }))\r\n        .sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0)); // Sort by timestamp\r\n      setSharedGameLog(logs);\r\n    }, (error) => {\r\n      console.error(\"Shared game log snapshot error:\", error);\r\n    });\r\n\r\n    // 2. Active user list listener\r\n    // Public data is at /artifacts/{appId}/public/data/{your_collection_name}\r\n    const activeUsersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'activeUsers');\r\n    const qActiveUsers = query(activeUsersCollectionRef);\r\n    const unsubscribeActiveUsers = onSnapshot(qActiveUsers, (snapshot) => {\r\n      // Filter to show only users active within the last 60 seconds.\r\n      const cutoffTime = Date.now() - 60 * 1000; // 60 seconds (1 minute)\r\n      const users = snapshot.docs\r\n        .map(doc => ({ id: doc.id, ...doc.data() }))\r\n        .filter(user => user.lastActive && user.lastActive.toMillis() > cutoffTime); // Filter by lastActive timestamp\r\n      setActiveUsers(users);\r\n    }, (error) => {\r\n      console.error(\"Active users snapshot error:\", error);\r\n    });\r\n\r\n    // 3. Public chat message listener\r\n    const chatCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'chatMessages');\r\n    const qChatMessages = query(chatCollectionRef);\r\n    const unsubscribeChatMessages = onSnapshot(qChatMessages, (snapshot) => {\r\n      const messages = snapshot.docs\r\n        .map(doc => ({ id: doc.id, ...doc.data() }))\r\n        .sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0)); // Sort by timestamp\r\n      setChatMessages(messages);\r\n    }, (error) => {\r\n      console.error(\"Chat messages snapshot error:\", error);\r\n    });\r\n\r\n    // Update user presence (periodically)\r\n    const updateUserPresence = async () => {\r\n      if (userId) {\r\n        try {\r\n          const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'activeUsers', userId);\r\n          await setDoc(userDocRef, {\r\n            lastActive: serverTimestamp(),\r\n            displayName: `플레이어 ${userId.substring(0, 4)}`, // Display only part of the user ID\r\n            profession: playerCharacter.profession, // Add player profession\r\n            isCompanion: playerCharacter.companions.length > 0, // [추가] Companion status\r\n          }, { merge: true });\r\n        } catch (error) {\r\n          console.error(\"Failed to update user presence:\", error);\r\n        }\r\n      }\r\n    };\r\n\r\n    updateUserPresence(); // Initial update\r\n    const presenceInterval = setInterval(updateUserPresence, 30000); // Update every 30 seconds\r\n\r\n    return () => {\r\n      unsubscribeSharedLog();\r\n      unsubscribeActiveUsers();\r\n      unsubscribeChatMessages(); // Clean up chat listener\r\n      unsubscribeGameStatus(); // [수정] Clean up game status listener\r\n      clearInterval(presenceInterval);\r\n    };\r\n  }, [db, isAuthReady, userId, auth, playerCharacter.profession, playerCharacter.companions]); // Add playerCharacter.companions to dependency array\r\n\r\n  // Cleanup inactive users function (client-side)\r\n  // This function runs client-side, so it only works when the app is running.\r\n  // A more robust and secure method would be to use Firebase Cloud Functions.\r\n  const cleanupInactiveUsers = async () => {\r\n    if (!db || !isAuthReady || !userId) return;\r\n\r\n    const inactiveThreshold = 1 * 60 * 1000; // 1 minute (60 seconds)\r\n    const cutoffTime = Date.now() - inactiveThreshold;\r\n\r\n    try {\r\n      const activeUsersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'activeUsers');\r\n      const querySnapshot = await getDocs(activeUsersCollectionRef); // Get all documents.\r\n\r\n      querySnapshot.forEach(async (docSnapshot) => {\r\n        const userData = docSnapshot.data();\r\n        // Delete users whose lastActive timestamp is older than 5 minutes.\r\n        if (userData.lastActive && userData.lastActive.toMillis() < cutoffTime) {\r\n          console.log(`DEBUG: Deleting inactive user: ${docSnapshot.id}`);\r\n          await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activeUsers', docSnapshot.id));\r\n        }\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Error cleaning up inactive users:\", error);\r\n    }\r\n  };\r\n\r\n  // Set interval for cleaning up inactive users\r\n  useEffect(() => {\r\n    if (!db || !isAuthReady || !userId) return;\r\n\r\n    // Run cleanup function every 1 minute.\r\n    const cleanupInterval = setInterval(cleanupInactiveUsers, 1 * 60 * 1000); // Run every 1 minute\r\n\r\n    return () => clearInterval(cleanupInterval); // Clean up interval on component unmount\r\n  }, [db, isAuthReady, userId]); // Re-run whenever db, isAuthReady, userId change\r\n\r\n  // Set initial message and profession choices when the game starts\r\n  useEffect(() => {\r\n    if (gamePhase === 'characterSelection') {\r\n      setGameLog([\r\n        \"환영합니다! 당신은 중세 유럽풍 판타지 왕국의 모험가가 될 것입니다. 당신은 지금 '방랑자의 안식처'라는 아늑한 여관에 도착했습니다.\",\r\n        \"어떤 직업을 선택하시겠습니까?\"\r\n      ]);\r\n      setCurrentChoices(Object.keys(professions).map(key => `${key}. ${professions[key].name}`));\r\n    }\r\n  }, [gamePhase]);\r\n\r\n  // Scroll to the bottom whenever the game log is updated\r\n  useEffect(() => {\r\n    if (logEndRef.current) {\r\n      logEndRef.current.scrollIntoView({ behavior: \"smooth\" });\r\n    }\r\n  }, [gameLog]);\r\n\r\n  // Scroll to the bottom whenever the shared log is updated\r\n  useEffect(() => {\r\n    if (sharedLogEndRef.current) {\r\n      sharedLogEndRef.current.scrollIntoView({ behavior: \"smooth\" });\r\n    }\r\n  }, [sharedGameLog]);\r\n\r\n  // Scroll to the bottom whenever chat messages are updated\r\n  useEffect(() => {\r\n    if (chatEndRef.current) {\r\n      chatEndRef.current.scrollIntoView({ behavior: \"smooth\" });\r\n    }\r\n  }, [chatMessages]);\r\n\r\n  // Scroll private chat messages\r\n  useEffect(() => {\r\n    if (privateChatEndRef.current) {\r\n      privateChatEndRef.current.scrollIntoView({ behavior: \"smooth\" });\r\n    }\r\n  }, [privateChatMessages]);\r\n\r\n  // Function to generate private chat room ID (sorts two user IDs for consistent ID generation)\r\n  const getPrivateChatRoomId = (user1Id, user2Id) => {\r\n    const sortedIds = [user1Id, user2Id].sort();\r\n    return `${sortedIds[0]}_${sortedIds[1]}`;\r\n  };\r\n\r\n  // Existing private chat listener (receives only conversations with the selected player)\r\n  useEffect(() => {\r\n    if (!db || !isAuthReady || !userId || !selectedPlayerForChat) {\r\n      setPrivateChatMessages([]); // Initialize messages if no player is selected\r\n      return;\r\n    }\r\n\r\n    const chatRoomId = getPrivateChatRoomId(userId, selectedPlayerForChat.id);\r\n    const privateChatCollectionRef = collection(db, 'artifacts', appId, 'privateChats', chatRoomId, 'messages');\r\n    const qPrivateChat = query(privateChatCollectionRef);\r\n\r\n    const unsubscribePrivateChat = onSnapshot(qPrivateChat, (snapshot) => {\r\n      const messages = snapshot.docs\r\n        .map(doc => ({ id: doc.id, ...doc.data() }))\r\n        .sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));\r\n      setPrivateChatMessages(messages);\r\n    }, (error) => {\r\n      console.error(\"Private chat messages snapshot error:\", error);\r\n    });\r\n\r\n    return () => unsubscribePrivateChat();\r\n  }, [db, isAuthReady, userId, selectedPlayerForChat, appId]); // Added appId to dependency array\r\n\r\n  // [NEW] 수신 메시지 알림 리스너 (collectionGroup 사용하지 않음)\r\n  useEffect(() => {\r\n    if (!db || !isAuthReady || !userId) {\r\n      return;\r\n    }\r\n\r\n    // 현재 사용자의 incomingMessages 컬렉션을 감시합니다.\r\n    const incomingMessagesCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'incomingMessages');\r\n    const qIncomingMessages = query(incomingMessagesCollectionRef);\r\n\r\n    const unsubscribeIncomingMessages = onSnapshot(qIncomingMessages, (snapshot) => {\r\n      snapshot.docChanges().forEach((change) => {\r\n        if (change.type === \"added\") {\r\n          const notification = change.doc.data();\r\n          const senderId = change.doc.id; // 문서 ID가 senderId가 됩니다.\r\n\r\n          // 모달이 이미 열려있거나 수동으로 닫힌 상태가 아니라면\r\n          // [수정] isPrivateChatModalManuallyClosed를 의존성 배열에서 제거했으므로,\r\n          // 이 useEffect는 해당 상태 변화에 직접 반응하지 않습니다.\r\n          // 따라서, 모달이 닫힌 상태에서만 알림을 처리하도록 로직을 유지합니다.\r\n          if (!showPlayerChatModal) { // Removed !isPrivateChatModalManuallyClosed from here\r\n            const senderInfo = activeUsers.find(user => user.id === senderId);\r\n            if (senderInfo) {\r\n              openPlayerChatModal(senderInfo);\r\n            } else {\r\n              // activeUsers에 없는 경우, 알림 정보로 임시 플레이어 정보 생성\r\n              openPlayerChatModal({\r\n                id: senderId,\r\n                displayName: notification.senderDisplayName || `알 수 없는 플레이어 ${senderId.substring(0, 4)}`,\r\n                profession: '알 수 없음' // activeUsers에서 가져올 수 없으므로 기본값\r\n              });\r\n            }\r\n            // 알림을 처리했으므로 해당 알림 문서를 삭제합니다.\r\n            deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'incomingMessages', senderId)).catch(error => {\r\n              console.error(\"Error deleting incoming message notification:\", error);\r\n            });\r\n          }\r\n        }\r\n      });\r\n    }, (error) => {\r\n      console.error(\"Incoming private messages notification error:\", error);\r\n    });\r\n\r\n    return () => unsubscribeIncomingMessages();\r\n  }, [db, isAuthReady, userId, showPlayerChatModal, activeUsers, appId]); // Removed isPrivateChatModalManuallyClosed from dependency array\r\n\r\n\r\n  // Define the system prompt to send to the LLM\r\n    const systemPrompt = `\r\n    당신은 중세 유럽풍 판타지 텍스트 어드벤처 게임의 스토리텔러이자 게임 마스터입니다.\r\n    이 게임은 멀티플레이어 게임이며, 현재 접속 중인 다른 플레이어들도 같은 시나리오에 참여합니다.\r\n    모든 플레이어는 '방랑자의 안식처'라는 여관에서 게임을 시작합니다.\r\n    플레이어의 선택과 현재 게임 상태를 기반으로 스토리를 진행하고, 새로운 상황을 묘사하며, 다음 선택지를 제시해야 합니다.\r\n    당신은 3인칭으로 서술하며, 진지하고 서사적인 어조와 객관적이고 정보 전달적인 어조를 적절히 섞어 사용합니다.\r\n    정보는 직접적인 설명, 간접적인 묘사, NPC 대화, 아이템/문서 등 다양한 방식으로 제공합니다.\r\n    묘사의 세부 정도는 LLM이 유연하게 조절하되, 중요하거나 인상적인 장면에서는 상세하게 묘사합니다.\r\n    플레이어의 목표는 고정되어 있지 않으며, 플레이어의 선택과 행동에 따라 유동적으로 형성되어 무한한 엔딩으로 이어집니다.\r\n    간단한 인벤토리 시스템(주요 스토리 아이템 위주)을 고려하며, 아이템 획득 또는 사용 시 스토리 묘사에 반영합니다.\r\n    간단한 텍스트 기반 전투(선택 및 확률 기반)를 시뮬레이션합니다. 전투 시 적을 묘사하고, 플레이어의 행동, 능력치와 확률에 기반한 결과, 능력치 변화 또는 피해를 묘사합니다.\r\n    능력치(힘, 지능, 민첩, 카리스마)가 존재하며, 플레이어의 행동에 따라 능력치가 어떻게 변화하고 성장하는지 서사적으로 묘사해야 합니다.\r\n    LLM 기반 퍼즐을 생성하고 해결을 유도할 수 있습니다. 퍼즐을 제시할 때는 퍼즐의 내용과 해결 방법을 명확히 제시합니다.\r\n    시간 제한은 없습니다.\r\n\r\n    **멀티플레이어 시나리오 지침:**\r\n    1.  **시작 지점:** 모든 플레이어는 '방랑자의 안식처'에서 시작하며, 당신은 이 여관의 분위기와 그 안에 있는 다른 플레이어들을 묘사해야 합니다.\r\n    2.  **다른 플레이어 등장:** 현재 게임에 접속해 있는 다른 플레이어들을 스토리 내에서 등장인물로 자연스럽게 포함시키십시오. 이들은 동료가 될 수도 있고, 경쟁자가 될 수도 있습니다.\r\n    3.  **플레이어 간 상호작용 (LLM 반영 중요):** 플레이어가 다른 플레이어와 상호작용(대화, 협력, 경쟁 등)을 선택하면, 당신은 해당 상호작용의 결과를 시뮬레이션하고 다음 선택지를 제공해야 합니다. **특히, 플레이어 간의 개인 대화 내용이 있다면, 이 내용을 시나리오 진행에 가장 우선적으로 반영하여 스토리를 전개하십시오.** 예를 들어, 한 플레이어가 다른 플레이어에게 말을 걸면, 당신은 그 플레이어의 캐릭터(직업, 성향 등)에 기반한 반응을 생성하고, 대화를 이어나갈 선택지를 제시합니다.\r\n    4.  **공유된 스토리:** 모든 플레이어의 선택과 상호작용이 하나의 공유된 시나리오에 영향을 미치도록 스토리를 발전시키십시오.\r\n\r\n    이야기를 통해 새로운 퀘스트를 암시적으로 도입합니다. 예를 들어, NPC가 도움을 요청하거나, 어떤 발견이 새로운 목표로 이어질 수 있습니다.\r\n    NPC 및 세력 평판을 이야기 내에서 암시적으로 관리합니다. 플레이어의 행동이 NPC 반응에 어떻게 영향을 미치는지 묘사합니다.\r\n    플레이어에게 잠재적인 동료를 소개합니다. 동료가 영입되면, 그들의 존재와 플레이어 및 세계와의 상호작용을 묘사합니다.\r\n    퀘스트 진행 상황, 평판 변화, 동료 상호작용을 JSON 출력에 명확히 포함하여 게임 로직이 이를 추적할 수 있도록 합니다.\r\n\r\n    당신은 항상 유효한 JSON 형식으로 응답해야 합니다. 구문에 세심한 주의를 기울이십시오. 모든 문자열은 올바르게 인용되어야 하며, 객체 또는 배열의 마지막 요소 뒤에 후행 쉼표가 없어야 합니다. 배열의 모든 요소는 쉼표로 구분되어야 합니다. 다음 JSON 스키마를 엄격히 따르십시오:\r\n    {\r\n      \"story\": \"현재 상황에 대한 스토리 텍스트 (3인칭으로 서술).\",\r\n      \"choices\": [\"선택지 1\", \"선택지 2\", ...],\r\n      \"inventoryUpdates\": [\"아이템1\", \"아이템2\", ...],\r\n      \"statChanges\": {\"strength\": 12, \"intelligence\": 10, ...},\r\n      \"location\": \"플레이어의 현재 위치\",\r\n      \"reputationUpdates\": {\"세력명\": \"상태\", ...},\r\n      \"activeQuestsUpdates\": [\"퀘스트1\", \"퀘스트2\", ...],\r\n      \"companionsUpdates\": [\"동료1\", \"동료2\", ...]\r\n    }\r\n    항상 2개에서 5개 사이의 'choices'를 제공하십시오.\r\n    'inventoryUpdates', 'statChanges', 'location', 'reputationUpdates', 'activeQuestsUpdates', 'companionsUpdates'는 변경 사항이 없더라도 현재 상태를 포함하여야 합니다.\r\n    스토리 텍스트는 500자 이내여야 합니다.\r\n  `;\r\n\r\n  // LLM text generation function (Gemini-2.0-flash)\r\n  const callGeminiTextLLM = async (promptData) => {\r\n    setIsTextLoading(true);\r\n    console.log(\"DEBUG: Starting callGeminiTextLLM\");\r\n    // Enter your Gemini API key here.\r\n    // Since this is not a Canvas environment, you must enter the key directly.\r\n    const apiKey = \"AIzaSyDC11rqjU30OJnLjaBFOaazZV0klM5raU8\"; // <-- Enter your actual Gemini API key here!\r\n    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;\r\n\r\n\tconst userPrompt = `\r\n      현재 게임 단계: ${promptData.phase}\r\n      플레이어 직업: ${promptData.character.profession}\r\n      플레이어 초기 동기: ${promptData.character.initialMotivation}\r\n      현재 능력치: ${JSON.stringify(promptData.character.stats)}\r\n      현재 인벤토리: ${JSON.stringify(promptData.character.inventory)}\r\n      현재 위치: ${promptData.character.currentLocation}\r\n      현재 평판: ${JSON.stringify(promptData.character.reputation)}\r\n      현재 활성 퀘스트: ${JSON.stringify(promptData.character.activeQuests)}\r\n      현재 동료: ${JSON.stringify(promptData.character.companions)}\r\n      이전 게임 로그 (마지막 5개 항목): ${JSON.stringify(promptData.history.slice(-5))}\r\n      플레이어의 마지막 선택: ${promptData.playerChoice}\r\n\r\n      **현재 접속 중인 다른 플레이어들:**\r\n      ${JSON.stringify(promptData.activeUsers)}\r\n\r\n      **현재 플레이어와 관련된 최근 개인 대화 내용 (LLM이 시나리오에 우선 반영):**\r\n      ${promptData.privateChatHistory && promptData.privateChatHistory.length > 0 ? JSON.stringify(promptData.privateChatHistory.slice(-5)) : '없음'}\r\n\r\n      위 정보를 바탕으로 다음 스토리 부분을 한국어로 생성하고, 시스템 프롬프트의 JSON 스키마에 따라 선택지를 제공하십시오.\r\n    `;\r\n\r\n    const chatHistory = [\r\n        { role: \"user\", parts: [{ text: systemPrompt }] },\r\n        { role: \"user\", parts: [{ text: userPrompt }] }\r\n    ];\r\n\r\n    const payload = {\r\n      contents: chatHistory,\r\n    };\r\n    console.log(\"DEBUG: Payload:\", JSON.stringify(payload, null, 2));\r\n\r\n    try {\r\n      const response = await fetch(apiUrl, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(payload)\r\n      });\r\n      console.log(\"DEBUG: Fetch response received.\");\r\n\r\n      if (!response.ok) {\r\n          const errorBody = await response.text();\r\n          console.error(\"DEBUG: HTTP Error Response:\", response.status, response.statusText, errorBody);\r\n          throw new Error(`HTTP error! status: ${response.status}, body: ${errorBody}`);\r\n      }\r\n\r\n      const result = await response.json();\r\n      console.log(\"DEBUG: Parsed JSON result:\", JSON.stringify(result, null, 2));\r\n\r\n      if (result.candidates && result.candidates.length > 0 &&\r\n          result.candidates[0].content && result.candidates[0].content.parts &&\r\n          result.candidates[0].content.parts.length > 0) {\r\n\r\n        let llmOutputText = result.candidates[0].content.parts[0].text;\r\n        console.log(\"DEBUG: LLM Raw Output Text:\", llmOutputText);\r\n\r\n        // Extract JSON object from the LLM response, in case it includes pre/postamble text.\r\n        const jsonMatch = llmOutputText.match(/\\{[\\s\\S]*\\}/);\r\n        if (jsonMatch) {\r\n            llmOutputText = jsonMatch[0];\r\n        } else {\r\n            throw new Error(\"Valid JSON object not found in LLM response.\");\r\n        }\r\n\r\n        // Attempt to parse the extracted JSON string.\r\n        try {\r\n            const llmOutput = JSON.parse(llmOutputText);\r\n            console.log(\"DEBUG: LLM Parsed Output JSON:\", JSON.stringify(llmOutput, null, 2));\r\n            return llmOutput;\r\n        } catch (parsingError) {\r\n            console.error(\"JSON Parsing Error:\", parsingError);\r\n            console.error(\"Malformed JSON string from LLM:\", llmOutputText);\r\n            throw new Error(`LLM response was not valid JSON. Details: ${parsingError.message}`);\r\n        }\r\n\r\n      } else {\r\n        console.error(\"LLM response structure is different than expected:\", result);\r\n        throw new Error(\"Invalid LLM response structure.\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"LLM API call error:\", error);\r\n      return {\r\n        story: `오류: LLM API 호출 중 문제가 발생했습니다: ${error.message}. 네트워크 연결을 확인하고 다시 시도해주세요.`,\r\n        choices: [\"다시 시도\"],\r\n        inventoryUpdates: promptData.character.inventory,\r\n        statChanges: promptData.character.stats,\r\n        location: promptData.character.currentLocation,\r\n        reputationUpdates: promptData.character.reputation,\r\n        activeQuestsUpdates: promptData.character.activeQuests,\r\n        companionsUpdates: promptData.character.companions,\r\n      };\r\n    } finally {\r\n      setIsTextLoading(false);\r\n      console.log(\"DEBUG: Finished callGeminiTextLLM\");\r\n    }\r\n  };\r\n\r\n  // Function to save game state.\r\n  const saveGame = async () => {\r\n    if (!db || !userId || !isAuthReady) {\r\n      setGameLog(prev => [...prev, \"오류: 게임을 저장할 수 없습니다. 인증 상태를 확인해주세요.\"]);\r\n      return;\r\n    }\r\n\r\n    setIsTextLoading(true);\r\n    try {\r\n      // Private data is at /artifacts/{appId}/users/{userId}/{your_collection_name}\r\n      const gameDocRef = doc(db, 'artifacts', appId, 'users', userId, 'textAdventureGame', 'gameState');\r\n      await setDoc(gameDocRef, {\r\n        gameLog: gameLog,\r\n        gamePhase: gamePhase,\r\n        playerCharacter: playerCharacter,\r\n        currentChoices: currentChoices,\r\n        timestamp: new Date().toISOString()\r\n      });\r\n      setGameLog(prev => [...prev, \"\\n게임이 성공적으로 저장되었습니다.\"]);\r\n    } catch (error) {\r\n      console.error(\"Game save error:\", error);\r\n      setGameLog(prev => [...prev, `\\n게임 저장 중 오류가 발생했습니다: ${error.message}`]);\r\n    } finally {\r\n      setIsTextLoading(false);\r\n    }\r\n  };\r\n\r\n  // Function to load game state.\r\n  const loadGame = async () => {\r\n    if (!db || !userId || !isAuthReady) {\r\n      setGameLog(prev => [...prev, \"오류: 게임을 불러올 수 없습니다. 인증 상태를 확인해주세요.\"]);\r\n      return;\r\n    }\r\n\r\n    setIsTextLoading(true);\r\n    try {\r\n      // Private data is at /artifacts/{appId}/users/{userId}/{your_collection_name}\r\n      const gameDocRef = doc(db, 'artifacts', appId, 'users', userId, 'textAdventureGame', 'gameState');\r\n      const docSnap = await getDoc(gameDocRef);\r\n\r\n      if (docSnap.exists()) {\r\n        const savedData = docSnap.data();\r\n        setGameLog(savedData.gameLog || []);\r\n        setGamePhase(savedData.gamePhase || 'characterSelection');\r\n        setPlayerCharacter(savedData.playerCharacter || {\r\n          profession: '',\r\n          stats: { strength: 10, intelligence: 10, agility: 10, charisma: 10 },\r\n          inventory: [],\r\n          initialMotivation: '',\r\n          currentLocation: '방랑자의 안식처', // Set initial location to 'Wanderer's Rest'\r\n          reputation: {},\r\n          activeQuests: [],\r\n          companions: [],\r\n        });\r\n        setCurrentChoices(savedData.currentChoices || []);\r\n        setGameLog(prev => [...prev, \"\\n게임이 성공적으로 불러와졌습니다.\"]);\r\n      } else {\r\n        setGameLog(prev => [...prev, \"\\n저장된 게임이 없습니다.\"]);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Game load error:\", error);\r\n      setGameLog(prev => [...prev, `\\n게임 불러오기 중 오류가 발생했습니다: ${error.message}`]);\r\n    } finally {\r\n      setIsTextLoading(false);\r\n    }\r\n  };\r\n\r\n  // Function to send user feedback.\r\n  const sendFeedback = async () => {\r\n    if (!db || !userId || !isAuthReady || !feedbackText.trim()) {\r\n      setGameLog(prev => [...prev, \"피드백을 보낼 수 없습니다. 내용을 입력하거나 인증 상태를 확인해주세요.\"]);\r\n      return;\r\n    }\r\n\r\n    setIsTextLoading(true);\r\n    try {\r\n      // Private data is at /artifacts/{appId}/users/{userId}/{your_collection_name}\r\n      const feedbackCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'feedback');\r\n      await addDoc(feedbackCollectionRef, {\r\n        feedback: feedbackText,\r\n        gameLogSnapshot: gameLog.slice(-10), // Snapshot of the last 10 logs\r\n        playerCharacterSnapshot: playerCharacter,\r\n        timestamp: serverTimestamp(),\r\n      });\r\n      setGameLog(prev => [...prev, \"\\n피드백이 성공적으로 전송되었습니다. 감사합니다!\"]);\r\n      setFeedbackText('');\r\n      setShowFeedbackModal(false);\r\n    } catch (error) {\r\n      console.error(\"Feedback submission error:\", error);\r\n      setGameLog(prev => [...prev, `\\n피드백 전송 중 오류가 발생했습니다: ${error.message}`]);\r\n    } finally {\r\n      setIsTextLoading(false);\r\n    }\r\n  };\r\n\r\n  // Function to send a public chat message\r\n  const sendChatMessage = async () => {\r\n    if (!db || !userId || !isAuthReady || !currentChatMessage.trim()) {\r\n      console.warn(\"채팅 메시지를 보낼 수 없습니다. 내용을 입력하거나 인증 상태를 확인해주세요.\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const chatCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'chatMessages');\r\n      await addDoc(chatCollectionRef, {\r\n        userId: userId,\r\n        displayName: `플레이어 ${userId.substring(0, 4)}`,\r\n        message: currentChatMessage,\r\n        timestamp: serverTimestamp(),\r\n      });\r\n      setCurrentChatMessage(''); // Clear input field after sending message\r\n    } catch (error) {\r\n      console.error(\"Error sending chat message:\", error);\r\n    }\r\n  };\r\n\r\n  // Function to send a private chat message\r\n  const sendPrivateChatMessage = async () => {\r\n    if (!db || !userId || !isAuthReady || !selectedPlayerForChat || !currentPrivateChatMessage.trim()) {\r\n      console.warn(\"개인 메시지를 보낼 수 없습니다. 내용을 입력하거나 대화 상대를 선택해주세요.\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const chatRoomId = getPrivateChatRoomId(userId, selectedPlayerForChat.id);\r\n      const privateChatCollectionRef = collection(db, 'artifacts', appId, 'privateChats', chatRoomId, 'messages');\r\n\r\n      await addDoc(privateChatCollectionRef, {\r\n        senderId: userId,\r\n        receiverId: selectedPlayerForChat.id, // Explicit receiver ID\r\n        displayName: `플레이어 ${userId.substring(0, 4)}`,\r\n        message: currentPrivateChatMessage,\r\n        timestamp: serverTimestamp(),\r\n      });\r\n\r\n      // [NEW] 수신자에게 새 메시지 알림 플래그 추가\r\n      const receiverNotificationDocRef = doc(db, 'artifacts', appId, 'users', selectedPlayerForChat.id, 'incomingMessages', userId);\r\n      await setDoc(receiverNotificationDocRef, {\r\n        lastMessageTimestamp: serverTimestamp(),\r\n        senderDisplayName: `플레이어 ${userId.substring(0, 4)}`,\r\n        senderId: userId // 알림 규칙을 위해 senderId 필드를 추가합니다.\r\n      }, { merge: true });\r\n\r\n      setCurrentPrivateChatMessage(''); // Clear input field after sending message\r\n    } catch (error) {\r\n      console.error(\"Error sending private message:\", error);\r\n    }\r\n  };\r\n\r\n  // Open private chat modal\r\n  const openPlayerChatModal = (player) => {\r\n    setSelectedPlayerForChat(player);\r\n    setShowPlayerChatModal(true);\r\n    // [수정] 모달을 열 때 isPrivateChatModalManuallyClosed를 항상 false로 설정\r\n    setIsPrivateChatModalManuallyClosed(false); \r\n\r\n    // [NEW] 모달을 열 때 해당 발신자로부터의 알림 플래그를 삭제합니다.\r\n    if (db && userId && player.id) {\r\n      deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'incomingMessages', player.id)).catch(error => {\r\n        console.error(\"Error deleting incoming message notification on modal open:\", error);\r\n      });\r\n    }\r\n  };\r\n\r\n  // Close private chat modal\r\n  const closePlayerChatModal = async () => {\r\n    if (!db || !userId || !selectedPlayerForChat) return;\r\n\r\n    try {\r\n      const chatRoomId = getPrivateChatRoomId(userId, selectedPlayerForChat.id);\r\n      // [수정] chatRoomId 문서 자체를 참조하고, 그 안에 status 필드를 업데이트\r\n      const chatRoomDocRef = doc(db, 'artifacts', appId, 'privateChats', chatRoomId);\r\n      await setDoc(chatRoomDocRef, {\r\n        status: { // status 필드 안에 객체로 저장\r\n          [`closedBy.${userId}`]: true, \r\n          lastClosedBy: userId, \r\n          lastClosedAt: serverTimestamp()\r\n        }\r\n      }, { merge: true });\r\n\r\n      setSelectedPlayerForChat(null);\r\n      setPrivateChatMessages([]);\r\n      setCurrentPrivateChatMessage('');\r\n      setShowPlayerChatModal(false);\r\n      // [수정] 모달을 닫을 때 isPrivateChatModalManuallyClosed를 true로 설정\r\n      setIsPrivateChatModalManuallyClosed(true); \r\n    } catch (error) {\r\n      console.error(\"Error closing private chat modal:\", error);\r\n    }\r\n  };\r\n\r\n  // New useEffect: Listen for private chat close signals from the other user\r\n  useEffect(() => {\r\n    if (!db || !isAuthReady || !userId || !selectedPlayerForChat) return;\r\n\r\n    const chatRoomId = getPrivateChatRoomId(userId, selectedPlayerForChat.id);\r\n    // [수정] chatRoomId 문서 자체를 참조\r\n    const chatRoomDocRef = doc(db, 'artifacts', appId, 'privateChats', chatRoomId);\r\n\r\n    const unsubscribeChatStatus = onSnapshot(chatRoomDocRef, (docSnap) => {\r\n      if (docSnap.exists()) {\r\n        const data = docSnap.data();\r\n        // [수정] status 필드 내의 데이터에 접근\r\n        const statusData = data.status || {}; \r\n        const otherUserId = selectedPlayerForChat.id;\r\n\r\n        // If the other user has closed the chat and it's not me who closed it last\r\n        if (statusData.closedBy && statusData.closedBy[otherUserId] && statusData.lastClosedBy !== userId) {\r\n          // Close the modal if it's open and the other user closed it\r\n          if (showPlayerChatModal) {\r\n            setSelectedPlayerForChat(null);\r\n            setPrivateChatMessages([]);\r\n            setCurrentPrivateChatMessage('');\r\n            setShowPlayerChatModal(false);\r\n            setIsPrivateChatModalManuallyClosed(false); // Reset manual close state\r\n            setGameLog(prev => [...prev, `\\n> ${selectedPlayerForChat.displayName}님이 대화를 종료했습니다.`]);\r\n          }\r\n        }\r\n      }\r\n    }, (error) => {\r\n      console.error(\"Private chat status snapshot error:\", error);\r\n    });\r\n\r\n    return () => unsubscribeChatStatus();\r\n  }, [db, isAuthReady, userId, selectedPlayerForChat, showPlayerChatModal, appId]); // Added appId to dependency array\r\n\r\n\r\n  // Private chat end and scenario reflection function (modified)\r\n  const handleEndPrivateChatAndReflectScenario = async () => {\r\n      if (!selectedPlayerForChat) return;\r\n\r\n      // [수정] Close modal first to improve user experience before LLM call\r\n      closePlayerChatModal();\r\n\r\n      // Start loading state\r\n      setIsTextLoading(true);\r\n      setGameLog(prev => [...prev, `\\n> ${selectedPlayerForChat.displayName}님과의 대화 내용을 바탕으로 시나리오를 진행합니다...\\n`]);\r\n\r\n      // Construct promptData to send to LLM\r\n      const promptData = {\r\n          phase: 'playing',\r\n          playerChoice: `플레이어 ${selectedPlayerForChat.displayName}님과의 대화 종료.`,\r\n          character: playerCharacter,\r\n          history: gameLog,\r\n          activeUsers: activeUsers.filter(user => user.id !== userId),\r\n          privateChatHistory: privateChatMessages\r\n      };\r\n\r\n      try {\r\n          // [수정] Update shared scenario progress status in Firestore\r\n          const gameStatusDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'status');\r\n          await setDoc(gameStatusDocRef, {\r\n              isActionInProgress: true,\r\n              actingPlayer: { id: userId, displayName: `플레이어 ${userId.substring(0, 4)}` }\r\n          }, { merge: true });\r\n\r\n          const llmResponse = await callGeminiTextLLM(promptData);\r\n\r\n          // Ideally, Cloud Functions should be used to update multiple players' states.\r\n          // For now, update only current player's state and shared log on the client side.\r\n          setGameLog(prev => [...prev, llmResponse.story]);\r\n\r\n          if (db && userId) {\r\n              const sharedLogCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'sharedGameLog');\r\n              await addDoc(sharedLogCollectionRef, {\r\n                  userId: userId,\r\n                  displayName: `플레이어 ${userId.substring(0, 4)}`,\r\n                  content: `[${playerCharacter.profession}]이(가) ${selectedPlayerForChat.displayName}님과 대화 후: ${llmResponse.story}`,\r\n                  timestamp: serverTimestamp(),\r\n              });\r\n          }\r\n\r\n          setPlayerCharacter(prev => ({\r\n              ...prev,\r\n              inventory: (llmResponse.inventoryUpdates && llmResponse.inventoryUpdates.length > 0) ? llmResponse.inventoryUpdates : prev.inventory,\r\n              stats: (llmResponse.statChanges && !isObjectEmpty(llmResponse.statChanges)) ? llmResponse.statChanges : prev.stats,\r\n              currentLocation: llmResponse.location || prev.currentLocation,\r\n              reputation: (llmResponse.reputationUpdates && !isObjectEmpty(llmResponse.reputationUpdates)) ? llmResponse.reputationUpdates : prev.reputation,\r\n              activeQuests: (llmResponse.activeQuestsUpdates && llmResponse.activeQuestsUpdates.length > 0) ? llmResponse.activeQuestsUpdates : prev.activeQuests,\r\n              companions: (llmResponse.companionsUpdates && llmResponse.companionsUpdates.length > 0) ? llmResponse.companionsUpdates : prev.companions,\r\n          }));\r\n          setCurrentChoices(llmResponse.choices || []);\r\n\r\n      } catch (error) {\r\n          console.error(\"Error processing private chat with LLM:\", error);\r\n          setGameLog(prev => [...prev, `\\n오류: 개인 대화 내용을 시나리오에 반영하는 중 문제가 발생했습니다: ${error.message}`]);\r\n      } finally {\r\n          // [수정] Change status back to false after scenario progress is complete\r\n          const gameStatusDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'status');\r\n          await setDoc(gameStatusDocRef, { isActionInProgress: false, actingPlayer: null }, { merge: true });\r\n\r\n          setIsTextLoading(false); // End loading state\r\n      }\r\n  };\r\n\r\n  // Helper function to check if an object is empty\r\n  const isObjectEmpty = (obj) => Object.keys(obj).length === 0 && obj.constructor === Object;\r\n\r\n  // Player choice button click handler (modified)\r\n  const handleChoiceClick = async (choice) => {\r\n    // [수정] Cannot select if another player is acting\r\n    if (isTextLoading || isCompanionActionInProgress) return;\r\n\r\n    setGameLog(prev => [...prev, `\\n> 당신의 선택: ${choice}\\n`]);\r\n    setCurrentChoices([]);\r\n\r\n    let promptData;\r\n\r\n    try {\r\n        // [수정] Set scenario progress status to true\r\n        if (db && userId) {\r\n            const gameStatusDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'status');\r\n            await setDoc(gameStatusDocRef, {\r\n                isActionInProgress: true,\r\n                actingPlayer: { id: userId, displayName: `플레이어 ${userId.substring(0, 4)}` }\r\n            }, { merge: true });\r\n        }\r\n\r\n        if (gamePhase === 'characterSelection') {\r\n          const chosenProfessionKey = choice.split('.')[0].trim();\r\n          const chosenProfession = professions[chosenProfessionKey];\r\n\r\n          if (chosenProfession) {\r\n            const initialCharacterState = {\r\n              profession: chosenProfession.name,\r\n              stats: {\r\n                strength: chosenProfession.name.includes('기사') || chosenProfession.name.includes('용병') ? 12 : 10,\r\n                intelligence: chosenProfession.name.includes('마법사') ? 12 : 10,\r\n                agility: chosenProfession.name.includes('도적') ? 12 : 10,\r\n                charisma: chosenProfession.name.includes('왕족') ? 12 : 10,\r\n              },\r\n              inventory: [],\r\n              initialMotivation: chosenProfession.motivation,\r\n              currentLocation: '방랑자의 안식처',\r\n              reputation: {},\r\n              activeQuests: [],\r\n              companions: [],\r\n            };\r\n            setPlayerCharacter(initialCharacterState);\r\n\r\n            promptData = {\r\n              phase: 'characterSelection',\r\n              playerChoice: choice,\r\n              character: initialCharacterState,\r\n              history: gameLog,\r\n              activeUsers: activeUsers.filter(user => user.id !== userId),\r\n              privateChatHistory: []\r\n            };\r\n\r\n            const llmResponse = await callGeminiTextLLM(promptData);\r\n            setGameLog(prev => [...prev, llmResponse.story]);\r\n\r\n            setPlayerCharacter(prev => ({\r\n              ...prev,\r\n              inventory: (llmResponse.inventoryUpdates && llmResponse.inventoryUpdates.length > 0) ? llmResponse.inventoryUpdates : prev.inventory,\r\n              stats: (llmResponse.statChanges && !isObjectEmpty(llmResponse.statChanges)) ? llmResponse.statChanges : prev.stats,\r\n              currentLocation: llmResponse.location || prev.currentLocation,\r\n              reputation: (llmResponse.reputationUpdates && !isObjectEmpty(llmResponse.reputationUpdates)) ? llmResponse.reputationUpdates : prev.reputation,\r\n              activeQuests: (llmResponse.activeQuestsUpdates && llmResponse.activeQuestsUpdates.length > 0) ? llmResponse.activeQuestsUpdates : prev.activeQuests,\r\n              companions: (llmResponse.companionsUpdates && llmResponse.companionsUpdates.length > 0) ? llmResponse.companionsUpdates : prev.companions,\r\n            }));\r\n            setCurrentChoices(llmResponse.choices || []);\r\n            setGamePhase('playing');\r\n          } else {\r\n            setGameLog(prev => [...prev, \"유효하지 않은 선택입니다. 제시된 직업 중 하나를 선택해주세요.\"]);\r\n            setCurrentChoices(Object.keys(professions).map(key => `${key}. ${professions[key].name}`));\r\n          }\r\n\r\n        } else { // gamePhase === 'playing'\r\n          promptData = {\r\n            phase: 'playing',\r\n            playerChoice: choice,\r\n            character: playerCharacter,\r\n            history: gameLog,\r\n            activeUsers: activeUsers.filter(user => user.id !== userId),\r\n            privateChatHistory: []\r\n          };\r\n\r\n          const llmResponse = await callGeminiTextLLM(promptData);\r\n          setGameLog(prev => [...prev, llmResponse.story]);\r\n\r\n          if (db && userId) {\r\n            const sharedLogCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'sharedGameLog');\r\n            await addDoc(sharedLogCollectionRef, {\r\n              userId: userId,\r\n              displayName: `플레이어 ${userId.substring(0, 4)}`,\r\n              content: `[${playerCharacter.profession}]의 선택: ${choice}\\n\\n${llmResponse.story}`,\r\n              timestamp: serverTimestamp(),\r\n            });\r\n          }\r\n\r\n          setPlayerCharacter(prev => ({\r\n            ...prev,\r\n            inventory: (llmResponse.inventoryUpdates && llmResponse.inventoryUpdates.length > 0) ? llmResponse.inventoryUpdates : prev.inventory,\r\n            stats: (llmResponse.statChanges && !isObjectEmpty(llmResponse.statChanges)) ? llmResponse.statChanges : prev.stats,\r\n            currentLocation: llmResponse.location || prev.currentLocation,\r\n            reputation: (llmResponse.reputationUpdates && !isObjectEmpty(llmResponse.reputationUpdates)) ? llmResponse.reputationUpdates : prev.reputation,\r\n            activeQuests: (llmResponse.activeQuestsUpdates && llmResponse.activeQuestsUpdates.length > 0) ? llmResponse.activeQuestsUpdates : prev.activeQuests,\r\n            companions: (llmResponse.companionsUpdates && llmResponse.companionsUpdates.length > 0) ? llmResponse.companionsUpdates : prev.companions,\r\n          }));\r\n          setCurrentChoices(llmResponse.choices || []);\r\n        }\r\n    } catch (error) {\r\n        console.error(\"Error during choice handling:\", error);\r\n        setGameLog(prev => [...prev, `\\n오류가 발생했습니다: ${error.message}`]);\r\n    } finally {\r\n        // [수정] Change status back to false after scenario progress is complete\r\n        if (db && userId) {\r\n            const gameStatusDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'status');\r\n            await setDoc(gameStatusDocRef, { isActionInProgress: false, actingPlayer: null }, { merge: true });\r\n        }\r\n    }\r\n  };\r\n\r\n  const isMyTurn = !isCompanionActionInProgress || (actingPlayer && actingPlayer.id === userId);\r\n  const isCompanionSystemActive = playerCharacter.companions.length > 0;\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center justify-center p-4 font-sans\">\r\n      <div className=\"w-full max-w-5xl bg-gray-800 rounded-lg shadow-xl p-6 md:p-8 flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6\">\r\n        {/* Main game area */}\r\n        <div className=\"flex flex-col w-full lg:w-2/3 space-y-6\">\r\n          {/* User ID display (for debugging and multi-user identification) */}\r\n          {isAuthReady && userId && (\r\n            <div className=\"text-xs text-gray-500 text-center mb-2\">\r\n              사용자 ID: {userId}\r\n            </div>\r\n          )}\r\n\r\n          {/* Game text output area */}\r\n          <div className=\"flex-grow bg-gray-700 p-4 rounded-md overflow-y-auto h-96 custom-scrollbar text-sm md:text-base leading-relaxed\">\r\n            {gameLog.map((line, index) => (\r\n              <p key={index} className=\"whitespace-pre-wrap mb-1\" dangerouslySetInnerHTML={{ __html: line.replace(/\\n/g, '<br />') }}></p>\r\n            ))}\r\n            {isTextLoading && (\r\n              <div className=\"flex justify-center items-center mt-4\">\r\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-300\"></div>\r\n                <span className=\"ml-3 text-gray-400\">\r\n                  이야기를 생성 중...\r\n                </span>\r\n              </div>\r\n            )}\r\n            {/* [추가] Companion action waiting message */}\r\n            {isCompanionSystemActive && isCompanionActionInProgress && !isMyTurn && (\r\n                <div className=\"text-center text-yellow-400 font-semibold p-2 bg-black bg-opacity-20 rounded-md mt-2\">\r\n                    {actingPlayer ? `${actingPlayer.displayName}님이 선택하고 있습니다...` : \"동료가 선택하고 있습니다...\"}\r\n                </div>\r\n            )}\r\n            <div ref={logEndRef} /> {/* Empty div for scroll position */}\r\n          </div>\r\n\r\n          {/* Character info display */}\r\n          {gamePhase === 'playing' && (\r\n            <div className=\"bg-gray-700 p-3 rounded-md text-xs md:text-sm text-gray-300 space-y-1\">\r\n              <p><span className=\"font-semibold text-gray-100\">직업:</span> {playerCharacter.profession}</p>\r\n              <p><span className=\"font-semibold text-gray-100\">위치:</span> {playerCharacter.currentLocation}</p>\r\n              <p><span className=\"font-semibold text-gray-100\">능력치:</span> 힘({playerCharacter.stats.strength}) 지능({playerCharacter.stats.intelligence}) 민첩({playerCharacter.stats.agility}) 카리스마({playerCharacter.stats.charisma})</p>\r\n              <p><span className=\"font-semibold text-gray-100\">인벤토리:</span> {playerCharacter.inventory.length > 0 ? playerCharacter.inventory.join(', ') : '비어있음'}</p>\r\n              <p><span className=\"font-semibold text-gray-100\">평판:</span> {Object.keys(playerCharacter.reputation).length > 0 ? Object.entries(playerCharacter.reputation).map(([key, value]) => `${key}: ${value}`).join(', ') : '없음'}</p>\r\n              <p><span className=\"font-semibold text-gray-100\">퀘스트:</span> {playerCharacter.activeQuests.length > 0 ? playerCharacter.activeQuests.join(', ') : '없음'}</p>\r\n              <p><span className=\"font-semibold text-gray-100\">동료:</span> {playerCharacter.companions.length > 0 ? playerCharacter.companions.join(', ') : '없음'}</p>\r\n            </div>\r\n          )}\r\n\r\n          {/* Choice button area */}\r\n          <div className=\"flex flex-col gap-3\">\r\n            {currentChoices.map((choice, index) => (\r\n              <button\r\n                key={index}\r\n                className=\"px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                onClick={() => handleChoiceClick(choice)}\r\n                // [수정] Disable when companion is acting\r\n                disabled={isTextLoading || (isCompanionSystemActive && !isMyTurn)}\r\n              >\r\n                {choice}\r\n              </button>\r\n            ))}\r\n          </div>\r\n\r\n          {/* Save/Load and Feedback buttons */}\r\n          <div className=\"flex flex-col md:flex-row gap-3 mt-4\">\r\n            <button\r\n              className=\"flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              onClick={saveGame}\r\n              disabled={isTextLoading || !isAuthReady || !userId || gamePhase === 'characterSelection'}\r\n            >\r\n              게임 저장\r\n            </button>\r\n            <button\r\n              className=\"flex-1 px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              onClick={loadGame}\r\n              disabled={isTextLoading || !isAuthReady || !userId}\r\n            >\r\n              게임 불러오기\r\n            </button>\r\n            <button\r\n              className=\"flex-1 px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              onClick={() => setShowFeedbackModal(true)}\r\n              disabled={isTextLoading || !isAuthReady || !userId}\r\n            >\r\n              피드백 보내기\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Multiplayer sidebar */}\r\n        <div className=\"w-full lg:w-1/3 flex flex-col space-y-6 bg-gray-700 p-4 rounded-lg shadow-inner\">\r\n          <h3 className=\"text-lg font-bold text-gray-100 text-center mb-4\">공유된 모험</h3>\r\n\r\n          {/* Active user list */}\r\n          <div className=\"bg-gray-600 p-3 rounded-md h-48 overflow-y-auto custom-scrollbar\">\r\n            <h4 className=\"text-md font-semibold text-gray-200 mb-2\">현재 플레이어들:</h4>\r\n            {activeUsers.length > 0 ? (\r\n              <ul className=\"text-sm text-gray-300 space-y-1\">\r\n                {activeUsers.map(user => (\r\n                  <li\r\n                    key={user.id}\r\n                    className=\"truncate flex justify-between items-center p-1 rounded-md hover:bg-gray-500 cursor-pointer\" // Added hover and cursor styles\r\n                    onDoubleClick={() => user.id !== userId && openPlayerChatModal(user)} // Double-click handler\r\n                  >\r\n                    <span>\r\n                      <span className=\"font-medium text-blue-300\">{user.displayName}</span>\r\n                       {/* [추가] Companion display */}\r\n                       {user.isCompanion && <span className=\"text-green-400 ml-2\">(동료)</span>}\r\n                    </span>\r\n                    {user.id !== userId && ( // Do not show chat button for self\r\n                      <button\r\n                        className=\"ml-2 px-3 py-1 bg-indigo-500 hover:bg-indigo-600 text-white text-xs rounded-md\"\r\n                        onClick={() => openPlayerChatModal(user)}\r\n                      >\r\n                        대화하기\r\n                      </button>\r\n                    )}\r\n                  </li>\r\n                ))}\r\n              </ul>\r\n            ) : (\r\n              <p className=\"text-sm text-gray-400\">활동 중인 플레이어가 없습니다.</p>\r\n            )}\r\n          </div>\r\n\r\n          {/* Shared game log */}\r\n          <div className=\"bg-gray-600 p-3 rounded-md flex-grow h-96 overflow-y-auto custom-scrollbar\">\r\n            <h4 className=\"text-md font-semibold text-gray-200 mb-2\">모든 플레이어의 활동:</h4>\r\n            {sharedGameLog.length > 0 ? (\r\n              <div className=\"text-sm text-gray-300 space-y-2\">\r\n                {sharedGameLog.map((logEntry) => (\r\n                  <div key={logEntry.id} className=\"border-b border-gray-500 pb-2 last:border-b-0\">\r\n                    <p className=\"text-xs text-gray-400 mb-1\">\r\n                      <span className=\"font-medium text-purple-300\">{logEntry.displayName}</span> (\r\n                      {logEntry.timestamp ? new Date(logEntry.timestamp.toMillis()).toLocaleTimeString() : '시간 없음'})\r\n                    </p>\r\n                    <p className=\"whitespace-pre-wrap\" dangerouslySetInnerHTML={{ __html: logEntry.content.replace(/\\n/g, '<br />') }}></p>\r\n                  </div>\r\n                ))}\r\n                <div ref={sharedLogEndRef} />\r\n              </div>\r\n            ) : (\r\n              <p className=\"text-sm text-gray-400\">공유된 활동이 아직 없습니다.</p>\r\n            )}\r\n          </div>\r\n\r\n          {/* Public Chat section */}\r\n          <div className=\"bg-gray-600 p-3 rounded-md flex flex-col h-64\">\r\n            <h4 className=\"text-md font-semibold text-gray-200 mb-2\">공개 채팅:</h4>\r\n            <div className=\"flex-grow overflow-y-auto custom-scrollbar mb-3 text-sm text-gray-300 space-y-2\">\r\n              {chatMessages.length > 0 ? (\r\n                chatMessages.map((msg) => (\r\n                  <div key={msg.id} className=\"border-b border-gray-500 pb-1 last:border-b-0\">\r\n                    <p className=\"text-xs text-gray-400\">\r\n                      <span className=\"font-medium text-green-300\">{msg.displayName}</span> (\r\n                      {msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString() : '시간 없음'}):\r\n                    </p>\r\n                    <p>{msg.message}</p>\r\n                  </div>\r\n                ))\r\n              ) : (\r\n                <p className=\"text-sm text-gray-400\">아직 채팅 메시지가 없습니다.</p>\r\n              )}\r\n              <div ref={chatEndRef} /> {/* Empty div for scroll position */}\r\n            </div>\r\n            <div className=\"flex\">\r\n              <input\r\n                type=\"text\"\r\n                className=\"flex-grow p-2 rounded-l-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm\"\r\n                placeholder=\"메시지를 입력하세요...\"\r\n                value={currentChatMessage}\r\n                onChange={(e) => setCurrentChatMessage(e.target.value)}\r\n                onKeyPress={(e) => {\r\n                  if (e.key === 'Enter') {\r\n                    sendChatMessage();\r\n                  }\r\n                }}\r\n                disabled={!isAuthReady || !userId}\r\n              />\r\n              <button\r\n                className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-r-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm\"\r\n                onClick={sendChatMessage}\r\n                disabled={!isAuthReady || !userId || !currentChatMessage.trim()}\r\n              >\r\n                보내기\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Feedback modal */}\r\n      {showFeedbackModal && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\">\r\n          <div className=\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4\">\r\n            <h3 className=\"text-xl font-bold text-gray-100\">피드백 보내기</h3>\r\n            <textarea\r\n              className=\"w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 h-32 resize-none\"\r\n              placeholder=\"게임에 대한 피드백을 여기에 작성해주세요...\"\r\n              value={feedbackText}\r\n              onChange={(e) => setFeedbackText(e.target.value)}\r\n              disabled={isTextLoading}\r\n            ></textarea>\r\n            <div className=\"flex justify-end gap-3\">\r\n              <button\r\n                className=\"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                onClick={() => setShowFeedbackModal(false)}\r\n                disabled={isTextLoading}\r\n              >\r\n                취소\r\n              </button>\r\n              <button\r\n                className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                onClick={sendFeedback}\r\n                disabled={isTextLoading || !feedbackText.trim()}\r\n              >\r\n                보내기\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Private Chat Modal (modified) */}\r\n      {showPlayerChatModal && selectedPlayerForChat && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\">\r\n          <div className=\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 flex flex-col h-3/4 max-h-[80vh]\">\r\n            <h3 className=\"text-xl font-bold text-gray-100\">\r\n              {selectedPlayerForChat.displayName} ({selectedPlayerForChat.profession}) 님과 대화\r\n            </h3>\r\n            <div className=\"flex-grow bg-gray-700 p-3 rounded-md overflow-y-auto custom-scrollbar text-sm text-gray-300 space-y-2\">\r\n              {privateChatMessages.length > 0 ? (\r\n                privateChatMessages.map((msg) => (\r\n                  <div key={msg.id} className={`flex ${msg.senderId === userId ? 'justify-end' : 'justify-start'}`}>\r\n                    <div className={`p-2 rounded-lg max-w-[80%] ${msg.senderId === userId ? 'bg-blue-600 text-white' : 'bg-gray-600 text-gray-100'}`}>\r\n                      <p className=\"text-xs text-gray-300 mb-1\">\r\n                        <span className=\"font-medium\">{msg.displayName}</span> (\r\n                        {msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString() : '시간 없음'})\r\n                      </p>\r\n                      <p>{msg.message}</p>\r\n                    </div>\r\n                  </div>\r\n                ))\r\n              ) : (\r\n                <p className=\"text-sm text-gray-400 text-center\">아직 대화가 없습니다. 먼저 메시지를 보내세요!</p>\r\n              )}\r\n              <div ref={privateChatEndRef} />\r\n            </div>\r\n            <div className=\"flex\">\r\n              <input\r\n                type=\"text\"\r\n                className=\"flex-grow p-2 rounded-l-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm\"\r\n                placeholder=\"개인 메시지를 입력하세요...\"\r\n                value={currentPrivateChatMessage}\r\n                onChange={(e) => setCurrentPrivateChatMessage(e.target.value)}\r\n                onKeyPress={(e) => {\r\n                  if (e.key === 'Enter') {\r\n                    sendPrivateChatMessage();\r\n                  }\r\n                }}\r\n                disabled={!isAuthReady || !userId || !selectedPlayerForChat}\r\n              />\r\n              <button\r\n                className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-r-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm\"\r\n                onClick={sendPrivateChatMessage}\r\n                disabled={!isAuthReady || !userId || !selectedPlayerForChat || !currentPrivateChatMessage.trim()}\r\n              >\r\n                보내기\r\n              </button>\r\n            </div>\r\n            {/* [수정] Modified button area */}\r\n            <div className=\"flex justify-end gap-3 mt-4\">\r\n              <button\r\n                className=\"px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                onClick={handleEndPrivateChatAndReflectScenario}\r\n                disabled={isTextLoading || privateChatMessages.length === 0}\r\n              >\r\n                대화 종료 및 시나리오 반영\r\n              </button>\r\n              <button\r\n                className=\"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-md transition duration-300\"\r\n                onClick={closePlayerChatModal}\r\n                // [수정] Close button is always active\r\n              >\r\n                닫기\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      <style>\r\n        {`\r\n        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');\r\n        body {\r\n          font-family: 'Noto Sans KR', sans-serif;\r\n        }\r\n        .custom-scrollbar::-webkit-scrollbar {\r\n          width: 8px;\r\n        }\r\n        .custom-scrollbar::-webkit-scrollbar-track {\r\n          background: #4a5568; /* gray-600 */\r\n          border-radius: 10px;\r\n        }\r\n        .custom-scrollbar::-webkit-scrollbar-thumb {\r\n          background: #6b7280; /* gray-500 */\r\n          border-radius: 10px;\r\n        }\r\n        .custom-scrollbar::-webkit-scrollbar-thumb:hover {\r\n          background: #9ca3af; /* gray-400 */\r\n        }\r\n        `}\r\n      </style>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default App;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}