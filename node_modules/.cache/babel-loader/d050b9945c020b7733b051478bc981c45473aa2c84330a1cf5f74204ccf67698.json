{"ast":null,"code":"import React,{useState,useEffect,useMemo,useRef,useCallback}from'react';import{initializeApp}from'firebase/app';import{getAuth,signInAnonymously,signInWithCustomToken,onAuthStateChanged}from'firebase/auth';import{getFirestore,doc,setDoc,getDoc,collection,query,onSnapshot,serverTimestamp,addDoc,getDocs,deleteDoc,runTransaction,orderBy,limit,arrayUnion}from'firebase/firestore';// ====================================================================\n// Firebase configuration information\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const defaultFirebaseConfig={apiKey:'AIzaSyBNJtmpRWzjobrY556bnHkwbZmpFJqgPX8',authDomain:'text-adventure-game-cb731.firebaseapp.com',projectId:'text-adventure-game-cb731',storageBucket:'text-adventure-game-cb731.appspot.com',messagingSenderId:'1092941614820',appId:'1:1092941614820:web:5545f36014b73c268026f1',measurementId:'G-FNGF42T1FP'};const firebaseConfig=defaultFirebaseConfig;const appId=firebaseConfig.projectId;const initialAuthToken=null;// ====================================================================\nconst professions={'1':{name:'몰락한 귀족/기사',motivation:'가문의 몰락 원인을 조사하고, 잃어버린 가문의 보물을 찾아야 합니다.'},'2':{name:'평범한 마을 사람/농부',motivation:'갑자기 마을에 나타난 괴생명체로부터 마을을 지켜야 합니다.'},'3':{name:'젊은 마법사/견습생',motivation:'스승님의 실종에 대한 단서를 찾아야 합니다.'},'4':{name:'용병/모험가',motivation:'의뢰받은 임무를 수행하던 중 예상치 못한 사건에 휘말렸습니다.'},'5':{name:'도적/암살자',motivation:'길드에서 내려온 첫 번째 임무를 완수하고, 그 과정에서 수상한 음모를 감지해야 합니다.'},'6':{name:'왕족/공주/왕자',motivation:'왕실 내의 불화와 암투 속에서 자신의 입지를 다져야 합니다.'}};// Firestore Path Utils\nconst getMainScenarioRef=(db,appId)=>doc(db,'artifacts',appId,'public','data','mainScenario','main');const getPrivatePlayerStateRef=(db,appId,userId)=>doc(db,'artifacts',appId,'users',userId,'playerState','state');const getGameStatusRef=(db,appId)=>doc(db,'artifacts',appId,'public','data','gameStatus','status');const getMajorEventsRef=(db,appId)=>collection(db,'artifacts',appId,'public','data','majorEvents');const getPersonalStoryLogRef=(db,appId,userId)=>collection(db,'artifacts',appId,'users',userId,'personalStoryLog');const getNpcRef=(db,appId,npcId)=>doc(db,'artifacts',appId,'public','data','npcs',npcId);const getActiveTurningPointRef=(db,appId)=>doc(db,'artifacts',appId,'public','data','turningPoints','active');const getWorldviewRef=(db,appId)=>doc(db,'artifacts',appId,'public','data','worldview','main');// State Initialization Utils\nconst getDefaultGameState=()=>({publicLog:[],subtleClues:[],lastUpdate:null});const getDefaultPrivatePlayerState=()=>({stats:{strength:10,intelligence:10,agility:10,charisma:10},inventory:[],initialMotivation:'',reputation:{},activeQuests:[],companions:[],knownClues:[],activeMemories:[],characterCreated:false,profession:'',choices:[],groups:[],npcRelations:{},knownEventIds:[],currentLocation:'방랑자의 안식처'});// Helper Components\nconst LlmErrorModal=_ref=>{let{llmError,llmRetryPrompt,setLlmError,setLlmRetryPrompt,onRetry}=_ref;return/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 text-center\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-xl font-bold text-red-400\",children:\"\\uC624\\uB958\\uAC00 \\uBC1C\\uC0DD\\uD588\\uC2B5\\uB2C8\\uB2E4\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-200\",children:llmError}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-center gap-4\",children:[llmRetryPrompt&&/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md\",onClick:onRetry,children:\"\\uC7AC\\uC2DC\\uB3C4\"}),/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-gray-600 hover:bg-gray-700 font-bold rounded-md\",onClick:()=>{setLlmError(null);setLlmRetryPrompt(null);},children:\"\\uB2EB\\uAE30\"})]})]})});};// Main App Component\nfunction App(){const[gameState,setGameState]=useState(getDefaultGameState());const[personalStoryLog,setPersonalStoryLog]=useState([]);const[privatePlayerState,setPrivatePlayerState]=useState(getDefaultPrivatePlayerState());const[displayedChoices,setDisplayedChoices]=useState([]);const[choicesTimestamp,setChoicesTimestamp]=useState(null);const[isTextLoading,setIsTextLoading]=useState(false);const[activeUsers,setActiveUsers]=useState([]);const[chatMessages,setChatMessages]=useState([]);const[currentChatMessage,setCurrentChatMessage]=useState('');const[actionLocks,setActionLocks]=useState({});const[db,setDb]=useState(null);const[auth,setAuth]=useState(null);const[userId,setUserId]=useState(null);const[isAuthReady,setIsAuthReady]=useState(false);const logEndRef=useRef(null);const chatEndRef=useRef(null);const[nickname,setNickname]=useState(()=>localStorage.getItem('nickname')||'');const[showNicknameModal,setShowNicknameModal]=useState(!localStorage.getItem('nickname'));const[nicknameInput,setNicknameInput]=useState('');const[accordion,setAccordion]=useState({gameLog:true,chat:true,users:true,playerInfo:true,chronicle:true,turningPoint:true});const[showResetModal,setShowResetModal]=useState(false);const[isResetting,setIsResetting]=useState(false);const[llmError,setLlmError]=useState(null);const[llmRetryPrompt,setLlmRetryPrompt]=useState(null);const[isLoading,setIsLoading]=useState(true);const[allMajorEvents,setAllMajorEvents]=useState([]);const[knownMajorEvents,setKnownMajorEvents]=useState([]);const[activeTurningPoint,setActiveTurningPoint]=useState(null);const[worldview,setWorldview]=useState(null);const combinedFeed=useMemo(()=>{const chatFeed=(chatMessages||[]).map(msg=>{var _msg$timestamp;return{...msg,type:'chat',date:((_msg$timestamp=msg.timestamp)===null||_msg$timestamp===void 0?void 0:_msg$timestamp.toDate())||new Date()};});const publicLogFeed=(gameState.publicLog||[]).map((log,index)=>{var _log$timestamp;return{...log,id:`${(_log$timestamp=log.timestamp)===null||_log$timestamp===void 0?void 0:_log$timestamp.toString()}-${index}`||`${Date.now()}-${index}`,type:'system',date:log.timestamp instanceof Date?log.timestamp:new Date()};});return[...chatFeed,...publicLogFeed].sort((a,b)=>a.date.getTime()-b.date.getTime());},[chatMessages,gameState.publicLog]);const getDisplayName=useCallback(uid=>{const safeUid=String(uid||'');if(uid===userId){const safeUserId=String(userId||'');return nickname||`플레이어 ${safeUserId.substring(0,4)}`;}const user=activeUsers.find(u=>u.id===uid);return(user===null||user===void 0?void 0:user.nickname)||`플레이어 ${safeUid.substring(0,4)}`;},[userId,nickname,activeUsers]);// Firebase Initialization\nuseEffect(()=>{try{const app=initializeApp(firebaseConfig);const firestoreDb=getFirestore(app);const firebaseAuth=getAuth(app);setDb(firestoreDb);setAuth(firebaseAuth);const unsubscribeAuth=onAuthStateChanged(firebaseAuth,async user=>{if(user){setUserId(user.uid);setIsAuthReady(true);}else{await(initialAuthToken?signInWithCustomToken(firebaseAuth,initialAuthToken):signInAnonymously(firebaseAuth));}});return()=>unsubscribeAuth();}catch(error){console.error('Firebase initialization error:',error);setLlmError('Firebase 초기화에 실패했습니다.');}},[]);// Player and Personal Data Listener\nuseEffect(()=>{if(!isAuthReady||!db||!userId)return;const privateStateRef=getPrivatePlayerStateRef(db,appId,userId);getDoc(privateStateRef).then(docSnap=>{if(!docSnap.exists()){setDoc(privateStateRef,getDefaultPrivatePlayerState());}});const unsubscribePrivateState=onSnapshot(privateStateRef,snapshot=>{if(snapshot.exists()){setPrivatePlayerState({...getDefaultPrivatePlayerState(),...snapshot.data()});}if(isLoading)setIsLoading(false);});const personalLogQuery=query(getPersonalStoryLogRef(db,appId,userId),orderBy('timestamp','desc'),limit(50));const unsubscribePersonalLog=onSnapshot(personalLogQuery,snapshot=>{const stories=snapshot.docs.map(doc=>({id:doc.id,...doc.data()})).reverse();setPersonalStoryLog(stories);});return()=>{unsubscribePrivateState();unsubscribePersonalLog();};},[isAuthReady,db,userId,isLoading]);// Public Game Data Listeners\nuseEffect(()=>{if(!isAuthReady||!db)return;const unsubscribes=[onSnapshot(getMainScenarioRef(db,appId),snap=>{if(snap.exists()){const data=snap.data();setGameState(prev=>({...prev,publicLog:data.publicLog||[],subtleClues:data.subtleClues||[],lastUpdate:data.lastUpdate}));}}),onSnapshot(getWorldviewRef(db,appId),snap=>setWorldview(snap.exists()?snap.data():null)),onSnapshot(getGameStatusRef(db,appId),docSnap=>{var _docSnap$data;return setActionLocks(((_docSnap$data=docSnap.data())===null||_docSnap$data===void 0?void 0:_docSnap$data.actionLocks)||{});}),onSnapshot(query(collection(db,'artifacts',appId,'public','data','chatMessages')),snapshot=>{const messages=snapshot.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>{var _a$timestamp,_b$timestamp;return(((_a$timestamp=a.timestamp)===null||_a$timestamp===void 0?void 0:_a$timestamp.toMillis())||0)-(((_b$timestamp=b.timestamp)===null||_b$timestamp===void 0?void 0:_b$timestamp.toMillis())||0);});setChatMessages(messages);}),onSnapshot(query(collection(db,'artifacts',appId,'public','data','activeUsers')),snapshot=>{const cutoffTime=Date.now()-60*1000;const users=snapshot.docs.map(d=>({id:d.id,...d.data()})).filter(u=>u.lastActive&&u.lastActive.toMillis()>cutoffTime);setActiveUsers(users);}),onSnapshot(query(getMajorEventsRef(db,appId)),snapshot=>{const events=snapshot.docs.map(doc=>({id:doc.id,...doc.data()})).sort((a,b)=>{var _a$timestamp2,_b$timestamp2;return(((_a$timestamp2=a.timestamp)===null||_a$timestamp2===void 0?void 0:_a$timestamp2.toMillis())||0)-(((_b$timestamp2=b.timestamp)===null||_b$timestamp2===void 0?void 0:_b$timestamp2.toMillis())||0);});setAllMajorEvents(events);}),onSnapshot(getActiveTurningPointRef(db,appId),docSnap=>setActiveTurningPoint(docSnap.exists()?{id:docSnap.id,...docSnap.data()}:null))];return()=>unsubscribes.forEach(unsub=>unsub());},[isAuthReady,db]);// Event Discovery Effect\nuseEffect(()=>{if(!db||!userId||allMajorEvents.length===0)return;const currentKnownIds=privatePlayerState.knownEventIds||[];const newDiscoveredEvents=allMajorEvents.filter(event=>(event===null||event===void 0?void 0:event.location)===privatePlayerState.currentLocation&&!currentKnownIds.includes(event.id)).map(event=>event.id);if(newDiscoveredEvents.length>0){const privateStateRef=getPrivatePlayerStateRef(db,appId,userId);setDoc(privateStateRef,{knownEventIds:arrayUnion(...newDiscoveredEvents)},{merge:true});}},[privatePlayerState.currentLocation,allMajorEvents,privatePlayerState.knownEventIds,db,userId]);useEffect(()=>{const knownEvents=allMajorEvents.filter(event=>(privatePlayerState.knownEventIds||[]).includes(event===null||event===void 0?void 0:event.id));setKnownMajorEvents(knownEvents);},[privatePlayerState.knownEventIds,allMajorEvents]);// User Presence Effect\nuseEffect(()=>{if(!db||!userId||!nickname)return;const userDocRef=doc(db,'artifacts',appId,'public','data','activeUsers',userId);setDoc(userDocRef,{lastActive:serverTimestamp(),nickname:nickname||`플레이어 ${userId.substring(0,4)}`,profession:privatePlayerState.profession},{merge:true});const handleVisibilityChange=()=>{if(document.visibilityState==='visible'){setDoc(userDocRef,{lastActive:serverTimestamp()},{merge:true});}};document.addEventListener('visibilitychange',handleVisibilityChange);return()=>document.removeEventListener('visibilitychange',handleVisibilityChange);},[db,userId,nickname,privatePlayerState.profession]);// Auto-scroll Effects\nuseEffect(()=>{if(accordion.gameLog&&logEndRef.current){logEndRef.current.scrollIntoView({behavior:'smooth'});}},[personalStoryLog,accordion.gameLog]);useEffect(()=>{if(accordion.chat&&chatEndRef.current){chatEndRef.current.scrollIntoView({behavior:'smooth'});}},[combinedFeed,accordion.chat]);// --- Core Game Logic Functions ---\nconst buildSystemPrompt=useCallback(worldviewData=>{const worldSetting=worldviewData?`### 세계관 설정: [${worldviewData.genre}] ${worldviewData.title}\\n${worldviewData.atmosphere}\\n배경: ${worldviewData.background_story}`:`### 세계관 설정: 페이디드 판타지 (Faded Fantasy) 이 세계는 오래되었고, 과거의 영광은 빛이 바랬습니다... (기본값)`;return`### 페르소나 (Persona) 당신은 이 세계의 '수호자'이자 '사관(史官)'이며, 플레이어들에게는 '게임 마스터(GM)'로 알려져 있습니다. 당신의 임무는 단순한 이야기 생성을 넘어, 일관된 역사와 살아 숨 쉬는 세계관을 구축하는 것입니다. 모든 묘사와 사건은 이 세계의 정해진 분위기와 역사적 사실 위에서 피어나는 한 편의 서사시여야 합니다. ${worldSetting} ### 핵심 구동 원칙 1. **일관성의 원칙 (Canon) (가장 중요)**: User Prompt에 제공된 [세계의 연대기], [주요 세력 및 인물], [플레이어 정보]는 이 세계의 '정사(正史)'입니다. 당신은 절대 이 사실들을 왜곡하거나 모순되는 내용을 만들어서는 안 됩니다. 이 정보들을 바탕으로 세계를 확장해 나가십시오. 2. **상호연결성의 원칙 (Interconnection)**: 당신은 뛰어난 이야기꾼으로서, 현재 발생하는 사건을 과거의 역사나 다른 플레이어의 행적과 연결지어야 합니다. 예를 들어, 한 플레이어가 던전에서 발견한 고대 문양은, 다른 플레이어가 수도에서 쫓고 있는 비밀 결사의 상징일 수 있습니다. 세상이 서로 연결되어 있음을 플레이어가 느끼게 하십시오. 3. **장면 중심의 서사 원칙 (Scene-Centric)**: 플레이어의 '[선택]'은 하나의 '장면'을 시작하는 것과 같습니다. 당신의 \"personalStory\"는 반드시 그 선택의 즉각적인 결과와 묘사로 시작되어야 합니다. 대화라면 실제 대화 내용이, 행동이라면 그 행동의 과정과 결과가 구체적으로 서술되어야 합니다. 4. **'보여주기, 말하지 않기' 원칙 (Show, Don't Tell)**: \"마을이 가난하다\"고 설명하지 마십시오. 대신 \"굶주린 아이들이 흙바닥에 주저앉아 있고, 대부분의 건물은 지붕이 허술하게 덧대어져 있다\"고 묘사하십시오. 플레이어가 스스로 분위기와 상황을 파악하게 만드십시오. ### [추가] NPC 상호작용 규칙 - 플레이어가 NPC와 상호작용할 때, 해당 NPC의 [페르소나 카드]가 제공될 수 있습니다. - 당신은 반드시 이 [페르소나 카드]에 명시된 '핵심 정체성'과 '기억 로그'를 바탕으로 NPC의 대사와 행동을 일관성 있게 생성해야 합니다. - 상호작용의 결과로 NPC가 새로운 사실을 알게 되거나 감정이 변했다면, 이를 반영할 '기억 로그 업데이트'를 JSON 출력의 'npcMemoryUpdate' 필드에 요약하여 포함시키십시오. ### JSON 출력 구조 {\"publicLogEntry\": \"만약 이 행동이 주변의 다른 플레이어나 NPC가 명백히 인지할 수 있는 '공개적인 사건'이라면, 3인칭 시점의 객관적인 기록을 한 문장으로 작성. (예: '플레이어 A가 경비병을 공격했다.') 그렇지 않으면 null.\",\"personalStory\": \"플레이어의 선택으로 시작된 '장면'에 대한 상세하고 감정적인 1인칭 또는 2인칭 서사. 플레이어의 내면 묘사, 감각, 대화 내용 등을 포함.\",\"choices\": [\"'personalStory'의 결과에 따라 플레이어가 할 수 있는 논리적인 다음 행동들.\"],\"privateChoices\": [\"오직 행동 주체의 특성 때문에 가능한 특별한 행동들.\"],\"groupChoices\": [\"같은 그룹 소속원들만 할 수 있는 비밀 행동들.\"],\"majorEvent\": {\"summary\": \"만약 이 사건이 후대에 '역사'로 기록될 만한 중대한 전환점이라면, 사관의 어조로 요약. (예: '왕국력 342년, 방랑자의 안식처에서 발생한 이 사건은 훗날 '붉은 달 교단'의 부흥을 알리는 서막이 되었다.') 그렇지 않으면 null.\",\"location\": \"사건이 발생한 장소 이름. majorEvent가 있을 경우 필수.\"},\"sharedStateUpdates\": {\"subtleClues\": [{\"location\": \"장소명\", \"clue\": \"새롭게 생성된 단서\"}]},\"privateStateUpdates\": {\"location\": \"플레이어의 새로운 현재 위치. 변경되었을 경우에만 포함.\",\"inventory\": [\"업데이트된 전체 인벤토리 목록\"],\"stats\": {\"strength\": 12, \"intelligence\": 10, \"agility\": 10, \"charisma\": 10 },\"activeQuests\": [\"업데이트된 개인 퀘스트 목록\"],\"knownClues\": [\"새롭게 알게 된 단서 목록\"],\"groups\": [\"업데이트된 소속 그룹 목록\"],\"npcRelations\": {\"가라크\": \"55 (나에 대한 경계심이 약간 누그러졌다.)\"}},\"npcMemoryUpdate\": {\"npcName\": \"상호작용 한 NPC의 이름\",\"newMemory\": \"NPC의 기억에 추가될 새로운 로그 (예: '플레이어 B가 음식값을 빚지고 도망갔다.')\"},\"turningPointUpdate\": {\"objectiveId\": \"플레이어의 행동이 기여한 목표의 ID\",\"progressIncrement\": 10}}`;},[]);const worldCreationPrompt=`당신은 천재적인 스토리 작가이자 '세계 창조자'입니다. 지금부터 플레이어들이 모험할 새로운 세계의 핵심 설정을 만들어야 합니다. 전통적인 판타지에 얽매이지 말고, 영화, 애니메이션, 소설, 신화 등 모든 장르를 아우르는 독창적이고 매력적인 세계관을 창조하십시오. 사이버펑크, 무협, 스팀펑크, 코스믹 호러, 포스트 아포칼립스, 느와르 등 어떤 것이든 좋습니다. 아래 JSON 구조에 맞춰 응답해주십시오. ### JSON 출력 구조 {\"title\": \"세계관의 이름 (예: '네온 비가 내리는 도시, 2242')\",\"genre\": \"세계관의 장르 (예: '사이버펑크 느와르')\",\"atmosphere\": \"세계의 전체적인 분위기를 묘사하는 2~3 문장의 글\",\"background_story\": \"플레이어가 모험을 시작하기 직전까지의 간략한 배경 역사\"}`;const turningPointCreationPrompt=`당신은 역사의 흐름을 읽는 '운명' 그 자체입니다. 최근 세상에서 벌어진 다음 사건들을 보고, 이 흐름이 하나의 거대한 '전환점(Turning Point)'으로 수렴될 수 있는지 판단하십시오. 현재 활성화된 전환점은 없습니다. 만약 중대한 갈등의 씨앗이나, 거대한 위협, 혹은 새로운 시대의 서막이 보인다면, 그에 맞는 전환점을 아래 JSON 형식으로 생성해주십시오. 아직 시기가 아니라면 'create' 값을 false로 설정하십시오. ### 최근 사건들 {event_summary} ### JSON 출력 구조 {\"create\": true,\"turningPoint\": {\"title\": \"전환점의 제목 (예: '수도에 창궐한 역병')\",\"description\": \"전환점에 대한 흥미로운 설명\",\"status\": \"active\",\"objectives\": [{ \"id\": \"objective_1\", \"description\": \"첫 번째 목표 (예: 역병의 근원 찾기)\", \"progress\": 0, \"goal\": 100 },{ \"id\": \"objective_2\", \"description\": \"두 번째 목표 (예: 치료제 개발 지원)\", \"progress\": 0, \"goal\": 100 }]}}`;const callGeminiTextLLM=async(userPrompt,systemPromptToUse)=>{setIsTextLoading(true);const mainApiKey='AIzaSyDC11rqjU30OJnLjaBFOaazZV0klM5raU8';const backupApiKey='AIzaSyAhscNjW8GmwKPuKzQ47blCY_bDanR-B84';const getApiUrl=apiKey=>`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;const payload={contents:[{role:'user',parts:[{text:systemPromptToUse}]},{role:'model',parts:[{text:'{}'}]},{role:'user',parts:[{text:userPrompt}]}]};const tryGeminiCall=async apiKey=>{return fetch(getApiUrl(apiKey),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});};try{var _result$candidates,_result$candidates$,_result$candidates$$c,_result$candidates$$c2,_result$candidates$$c3;let response=await tryGeminiCall(mainApiKey);if(!response.ok){response=await tryGeminiCall(backupApiKey);}if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}const result=await response.json();const llmOutputText=(_result$candidates=result.candidates)===null||_result$candidates===void 0?void 0:(_result$candidates$=_result$candidates[0])===null||_result$candidates$===void 0?void 0:(_result$candidates$$c=_result$candidates$.content)===null||_result$candidates$$c===void 0?void 0:(_result$candidates$$c2=_result$candidates$$c.parts)===null||_result$candidates$$c2===void 0?void 0:(_result$candidates$$c3=_result$candidates$$c2[0])===null||_result$candidates$$c3===void 0?void 0:_result$candidates$$c3.text;const jsonMatch=llmOutputText===null||llmOutputText===void 0?void 0:llmOutputText.match(/\\{[\\s\\S]*\\}/);if(jsonMatch){return JSON.parse(jsonMatch[0]);}throw new Error('Valid JSON object not found in LLM response.');}catch(error){console.error('LLM API call error:',error);setLlmError(error.message||'LLM 호출 실패');return null;}finally{setIsTextLoading(false);}};const checkAndCreateTurningPoint=useCallback(async()=>{if(activeTurningPoint||!db)return;console.log(\"Checking for new Turning Point...\");const publicLogSummary=(gameState.publicLog||[]).slice(-20).map(e=>e.log).join('\\n');const majorEventsSummary=(allMajorEvents||[]).slice(-10).map(e=>e.summary).join('\\n');const eventSummary=`[최근 공개 사건들]\\n${publicLogSummary}\\n\\n[최근 주요 역사]\\n${majorEventsSummary}`;const prompt=turningPointCreationPrompt.replace('{event_summary}',eventSummary);const llmResponse=await callGeminiTextLLM(prompt,buildSystemPrompt(worldview));if(llmResponse&&llmResponse.create&&llmResponse.turningPoint){console.log(\"New Turning Point detected! Creating...\",llmResponse.turningPoint);const turningPointRef=getActiveTurningPointRef(db,appId);await setDoc(turningPointRef,{...llmResponse.turningPoint,startTimestamp:serverTimestamp()});}else{console.log(\"No new Turning Point detected at this time.\");}},[activeTurningPoint,db,gameState.publicLog,allMajorEvents,worldview,callGeminiTextLLM,buildSystemPrompt,turningPointCreationPrompt]);const buildLlmPrompt=useCallback(async choice=>{var _privatePlayerState$p,_privatePlayerState$c;const factions=(privatePlayerState.groups||[]).join(', ')||'없음';const npcs=Object.entries(privatePlayerState.npcRelations||{}).map(_ref2=>{let[name,value]=_ref2;return`${name} (관계: ${value})`;}).join(', ')||'없음';const personalLogEntries=(personalStoryLog||[]).slice(-10).map(entry=>{var _entry$action,_entry$story;return`[나의 행동: ${(_entry$action=entry===null||entry===void 0?void 0:entry.action)!==null&&_entry$action!==void 0?_entry$action:'알 수 없는 행동'}] -> ${(_entry$story=entry===null||entry===void 0?void 0:entry.story)!==null&&_entry$story!==void 0?_entry$story:''}`;}).join('\\n');const publicLogEntries=(gameState.publicLog||[]).slice(-10).map(entry=>{var _entry$actor$displayN,_entry$actor,_entry$log;return`[${(_entry$actor$displayN=entry===null||entry===void 0?void 0:(_entry$actor=entry.actor)===null||_entry$actor===void 0?void 0:_entry$actor.displayName)!==null&&_entry$actor$displayN!==void 0?_entry$actor$displayN:'누군가'}] ${(_entry$log=entry===null||entry===void 0?void 0:entry.log)!==null&&_entry$log!==void 0?_entry$log:''}`;}).join('\\n');const activeMemorySection=privatePlayerState.activeMemories&&privatePlayerState.activeMemories.length>0?`[나의 활성 기억 (My Active Memories)]\\n- 이것은 내가 이 세계에서 가장 중요하다고 생각하는 핵심 정보들입니다. 당신은 이 정보를 반드시 최우선으로 고려하여 이야기를 진행해야 합니다.\\n- ${privatePlayerState.activeMemories.join('\\n- ')}\\n`:'';let npcPersonaCardSection='';const npcMatch=choice.match(/(.+)에게 말을 건다/);if(npcMatch&&db){const npcName=npcMatch[1].trim();const npcId=npcName.replace(/\\s+/g,'_');const npcRef=getNpcRef(db,appId,npcId);const npcSnap=await getDoc(npcRef);if(npcSnap.exists()){const npcData=npcSnap.data();npcPersonaCardSection=`\\n[NPC 페르소나 카드: ${npcName}]\\n- 핵심 정체성: ${npcData.core_identity||'아직 알려지지 않음'}\\n- 기억 로그: \\n${npcData.memory_log&&npcData.memory_log.length>0?npcData.memory_log.map(log=>`- ${log}`).join('\\n'):'- 특별한 기억 없음'}\\n`;}else{npcPersonaCardSection=`\\n[NPC 페르소나 카드: ${npcName}]\\n- 핵심 정체성: 당신이 이번 상호작용을 통해 이 NPC의 성격을 처음으로 설정합니다.\\n- 기억 로그: - 특별한 기억 없음\\n`;}}let turningPointSection=\"\";if(activeTurningPoint&&activeTurningPoint.status==='active'){turningPointSection=`\\n[현재 진행중인 주요 분기점: ${activeTurningPoint.title}]\\n- 개요: ${activeTurningPoint.description}\\n- 현재 목표 및 진척도:\\n${(activeTurningPoint.objectives||[]).map(obj=>`  - ${obj.description} (${obj.progress}/${obj.goal})`).join('\\n')}\\n- 당신의 행동이 이 분기점의 목표에 기여한다면, 'turningPointUpdate'를 통해 결과를 알려주십시오.\\n`;}return`${activeMemorySection}${npcPersonaCardSection}${turningPointSection}[세계의 연대기 (World Chronicle)]\\n- 내가 발견한, 세상에 일어난 주요 역사적 사건들입니다. 이 기록은 절대적인 사실입니다.\\n- ${knownMajorEvents.length>0?knownMajorEvents.map(h=>h.summary).join('\\n- '):'아직 기록된 역사가 없음'}\\n\\n[나의 여정록 (My Journey Log) - 최근 기록]\\n- 이것은 나의 개인적인 경험과 생각의 기록입니다.\\n${personalLogEntries||'아직 여정을 시작하지 않음'}\\n\\n[주변의 최근 사건들 (Recent Public Events)]\\n- 내가 있는 장소 주변에서 최근 일어난 공개적인 사건들입니다.\\n${publicLogEntries||'최근에 주변에서 별다른 일은 없었음'}\\n\\n[주요 세력 및 인물 (Key Factions & NPCs)]\\n- 나와 관련된 주요 세력: ${factions}\\n- 나와 관계를 맺은 주요 인물: ${npcs}\\n\\n[나의 현재 상태 (My Current State)]\\n- 이름: ${getDisplayName(userId)}\\n- 직업: ${(_privatePlayerState$p=privatePlayerState.profession)!==null&&_privatePlayerState$p!==void 0?_privatePlayerState$p:'미정'}\\n- 현재 위치: ${(_privatePlayerState$c=privatePlayerState.currentLocation)!==null&&_privatePlayerState$c!==void 0?_privatePlayerState$c:'알 수 없는 곳'}\\n- 소지품 및 능력치: ${JSON.stringify({inventory:privatePlayerState.inventory||[],stats:privatePlayerState.stats||{}})}\\n\\n[주변 관찰자 (Nearby Observers)]\\n- 현재 장소에 함께 있는 다른 플레이어들입니다. 이들은 이번 턴에 행동하지 않습니다.\\n- ${(activeUsers||[]).map(u=>u.nickname||`플레이어 ${u.id.substring(0,4)}`).join(', ')||'주변에 다른 플레이어가 없음'}\\n\\n[나의 선택 (My Action)]\\n- 위 모든 상황 속에서, 나는 다음 행동을 선택했습니다. 이 선택으로 시작될 '장면'을 연출해주십시오.\\n- \"${choice}\"`;},[privatePlayerState,personalStoryLog,gameState.publicLog,db,activeTurningPoint,knownMajorEvents,getDisplayName,userId,activeUsers]);const updatePrivateState=useCallback(async llmResponse=>{const privateStateRef=getPrivatePlayerStateRef(db,appId,userId);const updates=llmResponse.privateStateUpdates?{...llmResponse.privateStateUpdates}:{};if(updates.npcRelations&&typeof updates.npcRelations==='object'){const existingRelations=privatePlayerState.npcRelations||{};updates.npcRelations={...existingRelations,...updates.npcRelations};}else if(Object.prototype.hasOwnProperty.call(updates,'npcRelations')){delete updates.npcRelations;console.warn(`[Data Warning] LLM이 보낸 npcRelations 포맷이 유효하지 않아 무시합니다.`);}const newPrivateChoices=llmResponse.privateChoices||[];const newGroupChoices=llmResponse.groupChoices||[];updates.choices=[...newPrivateChoices,...newGroupChoices];if(Object.keys(updates).length>0){await setDoc(privateStateRef,updates,{merge:true});}},[db,userId,privatePlayerState.npcRelations]);const updateNarratives=useCallback(async function(llmResponse,playerChoice){var _llmResponse$majorEve,_llmResponse$majorEve2,_updatedScenarioDoc$d;let isDeclarative=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;const mainScenarioRef=getMainScenarioRef(db,appId);await runTransaction(db,async transaction=>{var _llmResponse$sharedSt;const scenarioDoc=await transaction.get(mainScenarioRef);if(!scenarioDoc.exists()){throw new Error('치명적 오류: 게임의 기본 시나리오 데이터가 없습니다.');}let currentData=scenarioDoc.data();let currentPublicLog=currentData.publicLog||[];if(isDeclarative){currentPublicLog=[...currentPublicLog,{actor:{id:userId,displayName:getDisplayName(userId)},log:\"❗ 세계 흐름의 변동이 일어납니다!\",isDeclaration:true,timestamp:new Date(new Date().getTime()-1)}];}const updates={subtleClues:((_llmResponse$sharedSt=llmResponse.sharedStateUpdates)===null||_llmResponse$sharedSt===void 0?void 0:_llmResponse$sharedSt.subtleClues)||currentData.subtleClues,lastUpdate:serverTimestamp()};if(llmResponse.publicLogEntry){updates.publicLog=[...currentPublicLog,{actor:{id:userId,displayName:getDisplayName(userId)},log:llmResponse.publicLogEntry,timestamp:new Date()}];}else if(isDeclarative){updates.publicLog=currentPublicLog;}transaction.update(mainScenarioRef,updates);});await addDoc(getPersonalStoryLogRef(db,appId,userId),{action:playerChoice,story:llmResponse.personalStory||'특별한 일은 일어나지 않았다.',timestamp:serverTimestamp()});if((_llmResponse$majorEve=llmResponse.majorEvent)!==null&&_llmResponse$majorEve!==void 0&&_llmResponse$majorEve.summary&&(_llmResponse$majorEve2=llmResponse.majorEvent)!==null&&_llmResponse$majorEve2!==void 0&&_llmResponse$majorEve2.location){await addDoc(getMajorEventsRef(db,appId),{...llmResponse.majorEvent,timestamp:serverTimestamp(),actor:{id:userId,displayName:getDisplayName(userId)}});checkAndCreateTurningPoint();}if(llmResponse.npcMemoryUpdate&&db){const{npcName,newMemory}=llmResponse.npcMemoryUpdate;if(npcName&&newMemory){const npcId=npcName.replace(/\\s+/g,'_');await setDoc(getNpcRef(db,appId,npcId),{name:npcName,memory_log:arrayUnion(newMemory)},{merge:true});}}if(llmResponse.turningPointUpdate&&activeTurningPoint){const{objectiveId,progressIncrement}=llmResponse.turningPointUpdate;if(objectiveId&&typeof progressIncrement==='number'){const turningPointRef=getActiveTurningPointRef(db,appId);await runTransaction(db,async transaction=>{const tpDoc=await transaction.get(turningPointRef);if(!tpDoc.exists())return;const tpData=tpDoc.data();const newObjectives=(tpData.objectives||[]).map(obj=>{if(obj.id===objectiveId){const newProgress=(obj.progress||0)+progressIncrement;return{...obj,progress:Math.min(Math.max(newProgress,0),obj.goal)};}return obj;});transaction.update(turningPointRef,{objectives:newObjectives});});}}await updatePrivateState(llmResponse);const newPublicChoices=llmResponse.choices||[];setDisplayedChoices(newPublicChoices);const updatedScenarioDoc=await getDoc(mainScenarioRef);setChoicesTimestamp(((_updatedScenarioDoc$d=updatedScenarioDoc.data())===null||_updatedScenarioDoc$d===void 0?void 0:_updatedScenarioDoc$d.lastUpdate)||null);},[db,userId,getDisplayName,checkAndCreateTurningPoint,activeTurningPoint,updatePrivateState]);const handleDeclarativeAction=useCallback(async actionText=>{setIsTextLoading(true);setLlmRetryPrompt({playerChoice:actionText,isDeclarative:true});const gameStatusRef=getGameStatusRef(db,appId);const scope=`declarative:${privatePlayerState.currentLocation}`;try{var _await$getDoc$data;const currentLocks=((_await$getDoc$data=(await getDoc(gameStatusRef)).data())===null||_await$getDoc$data===void 0?void 0:_await$getDoc$data.actionLocks)||{};if(currentLocks[scope]&&currentLocks[scope]!==userId){throw new Error(`현재 다른 플레이어(${getDisplayName(currentLocks[scope])})의 중대한 행동으로 인해 추가 행동을 할 수 없습니다.`);}await setDoc(gameStatusRef,{actionLocks:{...currentLocks,[scope]:userId}},{merge:true});const systemPromptToUse=buildSystemPrompt(worldview);const userPromptText=await buildLlmPrompt(actionText);const llmResponse=await callGeminiTextLLM(userPromptText,systemPromptToUse);if(llmResponse){await updateNarratives(llmResponse,actionText,true);setLlmError(null);setLlmRetryPrompt(null);}else if(!llmError){setLlmError(\"LLM으로부터 유효한 응답을 받지 못했습니다.\");}}catch(error){console.error(\"선언적 행동 처리 중 오류:\",error.message);setLlmError(error.message);}finally{const finalLocksDoc=await getDoc(gameStatusRef);if(finalLocksDoc.exists()){const finalLocks=finalLocksDoc.data().actionLocks||{};if(finalLocks[scope]===userId){delete finalLocks[scope];await setDoc(gameStatusRef,{actionLocks:finalLocks},{merge:true});}}setIsTextLoading(false);}},[db,privatePlayerState.currentLocation,userId,getDisplayName,buildSystemPrompt,worldview,buildLlmPrompt,callGeminiTextLLM,updateNarratives,llmError]);const getActionScope=useCallback(choice=>{const npcMatch=choice.match(/(.+)에게 말을 건다/);if(npcMatch){return`npc:${npcMatch[1].trim()}`;}return`location:${privatePlayerState.currentLocation}`;},[privatePlayerState.currentLocation]);const performPlayerAction=useCallback(async choice=>{setIsTextLoading(true);setLlmRetryPrompt({playerChoice:choice});const mainScenarioRef=getMainScenarioRef(db,appId);const gameStatusRef=getGameStatusRef(db,appId);const scope=getActionScope(choice);try{var _await$getDoc$data2;const freshScenarioDoc=await getDoc(mainScenarioRef);const serverTimestampValue=freshScenarioDoc.exists()?freshScenarioDoc.data().lastUpdate:null;if(choicesTimestamp&&serverTimestampValue&&choicesTimestamp.toMillis()<serverTimestampValue.toMillis()){var _gameState$publicLog;const oldLogCount=((_gameState$publicLog=gameState.publicLog)===null||_gameState$publicLog===void 0?void 0:_gameState$publicLog.length)||0;const newPublicLog=freshScenarioDoc.data().publicLog||[];const interveningEvents=newPublicLog.slice(oldLogCount).map(log=>`[${log.actor.displayName}] ${log.log}`).join(', ');const conflictResolutionUserPrompt=`[상황]\\n- 나의 원래 행동: \"${choice}\"\\n- 내가 행동하기 직전에 벌어진 실제 사건: \"${interveningEvents||'알 수 없는 변화'}\"\\n\\n[지시]\\n위 상황을 바탕으로, 나의 행동이 실패하고 실제 사건을 목격하는 장면을 1인칭 또는 2인칭 시점에서 극적으로 묘사해주십시오. 예시: 내가 '경비병에게 말을 걸려고' 했으나, 실제로는 '다른 플레이어가 경비병을 암살했다'면, \"당신이 경비병에게 다가가려던 찰나, 어둠 속에서 날아온 화살이 경비병의 목에 박히는 것을 목격합니다.\" 와 같이 서술합니다. 반드시 'personalStory'와 현재 상황에 맞는 새로운 'choices'를 포함한 JSON 형식으로만 응답해주십시오.`;const systemPromptToUse=buildSystemPrompt(worldview);const llmResponse=await callGeminiTextLLM(conflictResolutionUserPrompt,systemPromptToUse);if(llmResponse){await addDoc(getPersonalStoryLogRef(db,appId,userId),{action:choice,story:llmResponse.personalStory,timestamp:serverTimestamp()});await updatePrivateState(llmResponse);setDisplayedChoices(llmResponse.choices||[]);setChoicesTimestamp(serverTimestampValue);}else{const conflictStory=`당신이 '${choice}'(을)를 하려던 찰나, 세상은 이미 당신의 예상과 달라져 있었습니다. 주변을 다시 둘러보니 상황이 바뀌어 있습니다.`;await addDoc(getPersonalStoryLogRef(db,appId,userId),{action:choice,story:conflictStory,timestamp:serverTimestamp()});setDisplayedChoices([\"주변을 다시 살핀다.\"]);setPrivatePlayerState(prev=>({...prev,choices:[]}));setChoicesTimestamp(serverTimestampValue);}setIsTextLoading(false);return;}const currentLocks=((_await$getDoc$data2=(await getDoc(gameStatusRef)).data())===null||_await$getDoc$data2===void 0?void 0:_await$getDoc$data2.actionLocks)||{};if(currentLocks[scope]&&currentLocks[scope]!==userId){throw new Error(`현재 '${scope.split(':')[1]}'(은)는 다른 플레이어(${getDisplayName(currentLocks[scope])})가 사용 중입니다.`);}await setDoc(gameStatusRef,{actionLocks:{...currentLocks,[scope]:userId}},{merge:true});const systemPromptToUse=buildSystemPrompt(worldview);const userPromptText=await buildLlmPrompt(choice);const llmResponse=await callGeminiTextLLM(userPromptText,systemPromptToUse);if(llmResponse){await updateNarratives(llmResponse,choice,false);setLlmError(null);setLlmRetryPrompt(null);}else if(!llmError){setLlmError('LLM으로부터 유효한 응답을 받지 못했습니다.');}}catch(error){console.error('행동 처리 중 오류:',error.message);setLlmError(error.message);}finally{const finalLocksDoc=await getDoc(gameStatusRef);if(finalLocksDoc.exists()){const finalLocks=finalLocksDoc.data().actionLocks||{};if(finalLocks[scope]===userId){delete finalLocks[scope];await setDoc(gameStatusRef,{actionLocks:finalLocks},{merge:true});}}setIsTextLoading(false);}},[db,getActionScope,choicesTimestamp,gameState.publicLog,buildSystemPrompt,worldview,callGeminiTextLLM,userId,updatePrivateState,getDisplayName,buildLlmPrompt,updateNarratives,llmError]);const createCharacter=useCallback(async choice=>{setIsTextLoading(true);try{const worldviewRef=getWorldviewRef(db,appId);let currentWorldview=worldview;if(!currentWorldview){console.log(\"No worldview found. Creating a new one...\");const llmResponse=await callGeminiTextLLM(worldCreationPrompt,worldCreationPrompt);if(llmResponse){await setDoc(worldviewRef,llmResponse);currentWorldview=llmResponse;setWorldview(llmResponse);}else{throw new Error(\"Failed to create a new worldview.\");}}const choiceKey=choice.split('.')[0];const selectedProfession=professions[choiceKey];if(selectedProfession){await setDoc(getPrivatePlayerStateRef(db,appId,userId),{...getDefaultPrivatePlayerState(),characterCreated:true,profession:selectedProfession.name,initialMotivation:selectedProfession.motivation,currentLocation:'방랑자의 안식처'},{merge:true});await addDoc(getPersonalStoryLogRef(db,appId,userId),{action:'여정에 나서다',story:`나는 '${selectedProfession.name}'으로서, '${selectedProfession.motivation}'라는 동기를 품고 이 세상에 첫 발을 내디뎠다.`,timestamp:serverTimestamp()});const mainScenarioRef=getMainScenarioRef(db,appId);await runTransaction(db,async transaction=>{const scenarioDoc=await transaction.get(mainScenarioRef);const baseData=scenarioDoc.exists()?scenarioDoc.data():getDefaultGameState();const cleanedPublicLog=(baseData.publicLog||[]).map(log=>{var _log$timestamp2;return{...log,timestamp:(_log$timestamp2=log.timestamp)!==null&&_log$timestamp2!==void 0&&_log$timestamp2.toDate?log.timestamp.toDate():new Date()};});const newPublicLogEntry={actor:{id:userId,displayName:getDisplayName(userId)},log:`새로운 모험가, '${getDisplayName(userId)}'님이 여관에 모습을 드러냈습니다.`,timestamp:new Date()};const updatedPublicLog=[...cleanedPublicLog,newPublicLogEntry];const payload={...baseData,publicLog:updatedPublicLog,lastUpdate:serverTimestamp()};transaction.set(mainScenarioRef,payload);});const startingChoices=['여관을 둘러본다.','다른 모험가에게 말을 건다.','여관 주인에게 정보를 묻는다.'];setDisplayedChoices(startingChoices);const updatedDoc=await getDoc(mainScenarioRef);if(updatedDoc.exists()){setChoicesTimestamp(updatedDoc.data().lastUpdate);}}}catch(e){console.error('등장 이벤트 추가 실패: ',e);setLlmError('게임 세계에 합류하는 중 오류가 발생했습니다. 문제가 지속되면 \\'전체 데이터 초기화\\'를 시도해 주세요.');}finally{setIsTextLoading(false);}},[db,worldview,callGeminiTextLLM,worldCreationPrompt,userId,getDisplayName]);const handleChoiceClick=useCallback(async choice=>{if(isTextLoading)return;if(!privatePlayerState.characterCreated){await createCharacter(choice);}else{await performPlayerAction(choice);}},[isTextLoading,privatePlayerState.characterCreated,createCharacter,performPlayerAction]);const sendChatMessage=async()=>{if(!db||!userId||!isAuthReady||!currentChatMessage.trim())return;const messageText=currentChatMessage.trim();setCurrentChatMessage('');const chatCollectionRef=collection(db,'artifacts',appId,'public','data','chatMessages');if(messageText.startsWith('!')){const actionText=messageText.substring(1).trim();if(actionText){await addDoc(chatCollectionRef,{userId,displayName:getDisplayName(userId),message:`*${actionText} (선언)*`,isAction:true,timestamp:serverTimestamp()});await handleDeclarativeAction(actionText);}}else{await addDoc(chatCollectionRef,{userId,displayName:getDisplayName(userId),message:messageText,isAction:false,timestamp:serverTimestamp()});}};const toggleAccordion=key=>{setAccordion(prev=>({...prev,[key]:!prev[key]}));};const toggleActiveMemory=async(clue,activate)=>{if(!db||!userId)return;const privateStateRef=getPrivatePlayerStateRef(db,appId,userId);let currentMemories=privatePlayerState.activeMemories||[];if(activate){if(!currentMemories.includes(clue)){currentMemories=[...currentMemories,clue];}}else{currentMemories=currentMemories.filter(memory=>memory!==clue);}await setDoc(privateStateRef,{activeMemories:currentMemories},{merge:true});};const summarizeAndArchiveEvents=async()=>{alert(\"시대 요약 기능은 다음 업데이트에서 구현될 예정입니다. 이 버튼을 누르면, '세계의 연대기'에 기록된 주요 사건들이 하나의 '역사 요약문'으로 압축되어, 게임의 장기적인 맥락을 유지하면서도 데이터 부담을 줄이게 됩니다.\");};// --- Render logic ---\nif(showNicknameModal){return/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-xl font-bold text-gray-100\",children:\"\\uB2C9\\uB124\\uC784\\uC744 \\uC785\\uB825\\uD558\\uC138\\uC694\"}),/*#__PURE__*/_jsx(\"input\",{className:\"w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg\",placeholder:\"\\uB2C9\\uB124\\uC784\",value:nicknameInput,onChange:e=>setNicknameInput(e.target.value),onKeyDown:e=>{if(e.key==='Enter')handleNicknameSubmit();},autoFocus:true}),/*#__PURE__*/_jsx(\"button\",{className:\"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md transition duration-300 disabled:opacity-50\",onClick:handleNicknameSubmit,disabled:!nicknameInput.trim(),children:\"\\uC2DC\\uC791\\uD558\\uAE30\"})]})});}if(isLoading||privatePlayerState.characterCreated&&!worldview){return/*#__PURE__*/_jsxs(\"div\",{className:\"min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-16 w-16 border-b-2 border-gray-300\"}),/*#__PURE__*/_jsx(\"span\",{className:\"ml-4 text-xl\",children:isLoading?'데이터를 불러오는 중...':'세계를 구축하는 중...'})]});}const handleRetry=async()=>{if(llmRetryPrompt!==null&&llmRetryPrompt!==void 0&&llmRetryPrompt.playerChoice){setLlmError(null);if(llmRetryPrompt.isDeclarative){await handleDeclarativeAction(llmRetryPrompt.playerChoice);}else{await handleChoiceClick(llmRetryPrompt.playerChoice);}}};return/*#__PURE__*/_jsxs(\"div\",{className:\"min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center justify-center p-4 font-sans\",children:[llmError&&/*#__PURE__*/_jsx(LlmErrorModal,{llmError:llmError,llmRetryPrompt:llmRetryPrompt,setLlmError:setLlmError,setLlmRetryPrompt:setLlmRetryPrompt,onRetry:handleRetry}),showResetModal&&/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-xl font-bold text-red-400\",children:\"\\u26A0\\uFE0F \\uBAA8\\uB4E0 \\uB370\\uC774\\uD130\\uB97C \\uCD08\\uAE30\\uD654\\uD560\\uAE4C\\uC694?\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-200\",children:\"\\uC774 \\uC791\\uC5C5\\uC740 \\uB418\\uB3CC\\uB9B4 \\uC218 \\uC5C6\\uC2B5\\uB2C8\\uB2E4. \\uBAA8\\uB4E0 \\uC2DC\\uB098\\uB9AC\\uC624, \\uB85C\\uADF8, \\uC720\\uC800, \\uCC44\\uD305 \\uB370\\uC774\\uD130\\uAC00 \\uC0AD\\uC81C\\uB429\\uB2C8\\uB2E4.\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-end gap-3\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-gray-600 hover:bg-gray-700 font-bold rounded-md\",onClick:()=>setShowResetModal(false),disabled:isResetting,children:\"\\uCDE8\\uC18C\"}),/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-red-600 hover:bg-red-700 font-bold rounded-md\",onClick:resetAllGameData,disabled:isResetting,children:isResetting?'초기화 중...':'초기화'})]})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"w-full max-w-5xl bg-gray-800 rounded-lg shadow-xl p-6 md:p-8 flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col w-full lg:w-2/3 space-y-6\",children:[/*#__PURE__*/_jsx(RenderGameLog,{accordion:accordion,toggleAccordion:toggleAccordion,summarizeAndArchiveEvents:summarizeAndArchiveEvents,setShowResetModal:setShowResetModal,personalStoryLog:personalStoryLog,privatePlayerState:privatePlayerState,isTextLoading:isTextLoading,actionLocks:actionLocks,userId:userId,getDisplayName:getDisplayName,logEndRef:logEndRef}),/*#__PURE__*/_jsx(RenderChoices,{privatePlayerState:privatePlayerState,displayedChoices:displayedChoices,handleChoiceClick:handleChoiceClick,isTextLoading:isTextLoading,actionLocks:actionLocks,getActionScope:getActionScope,userId:userId,getDisplayName:getDisplayName})]}),/*#__PURE__*/_jsx(RenderSidebar,{worldview:worldview,activeTurningPoint:activeTurningPoint,accordion:accordion,toggleAccordion:toggleAccordion,privatePlayerState:privatePlayerState,getDisplayName:getDisplayName,userId:userId,toggleActiveMemory:toggleActiveMemory,knownMajorEvents:knownMajorEvents,activeUsers:activeUsers,combinedFeed:combinedFeed,chatEndRef:chatEndRef,currentChatMessage:currentChatMessage,setCurrentChatMessage:setCurrentChatMessage,sendChatMessage:sendChatMessage,isAuthReady:isAuthReady})]}),/*#__PURE__*/_jsx(\"style\",{children:`\n        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');\n        body { font-family: 'Noto Sans KR', sans-serif; }\n        .custom-scrollbar::-webkit-scrollbar { width: 8px; }\n        .custom-scrollbar::-webkit-scrollbar-track { background: #4a5568; border-radius: 10px; }\n        .custom-scrollbar::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 10px; }\n        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }\n      `})]});}export default App;","map":{"version":3,"names":["React","useState","useEffect","useMemo","useRef","useCallback","initializeApp","getAuth","signInAnonymously","signInWithCustomToken","onAuthStateChanged","getFirestore","doc","setDoc","getDoc","collection","query","onSnapshot","serverTimestamp","addDoc","getDocs","deleteDoc","runTransaction","orderBy","limit","arrayUnion","jsx","_jsx","jsxs","_jsxs","defaultFirebaseConfig","apiKey","authDomain","projectId","storageBucket","messagingSenderId","appId","measurementId","firebaseConfig","initialAuthToken","professions","name","motivation","getMainScenarioRef","db","getPrivatePlayerStateRef","userId","getGameStatusRef","getMajorEventsRef","getPersonalStoryLogRef","getNpcRef","npcId","getActiveTurningPointRef","getWorldviewRef","getDefaultGameState","publicLog","subtleClues","lastUpdate","getDefaultPrivatePlayerState","stats","strength","intelligence","agility","charisma","inventory","initialMotivation","reputation","activeQuests","companions","knownClues","activeMemories","characterCreated","profession","choices","groups","npcRelations","knownEventIds","currentLocation","LlmErrorModal","_ref","llmError","llmRetryPrompt","setLlmError","setLlmRetryPrompt","onRetry","className","children","onClick","App","gameState","setGameState","personalStoryLog","setPersonalStoryLog","privatePlayerState","setPrivatePlayerState","displayedChoices","setDisplayedChoices","choicesTimestamp","setChoicesTimestamp","isTextLoading","setIsTextLoading","activeUsers","setActiveUsers","chatMessages","setChatMessages","currentChatMessage","setCurrentChatMessage","actionLocks","setActionLocks","setDb","auth","setAuth","setUserId","isAuthReady","setIsAuthReady","logEndRef","chatEndRef","nickname","setNickname","localStorage","getItem","showNicknameModal","setShowNicknameModal","nicknameInput","setNicknameInput","accordion","setAccordion","gameLog","chat","users","playerInfo","chronicle","turningPoint","showResetModal","setShowResetModal","isResetting","setIsResetting","isLoading","setIsLoading","allMajorEvents","setAllMajorEvents","knownMajorEvents","setKnownMajorEvents","activeTurningPoint","setActiveTurningPoint","worldview","setWorldview","combinedFeed","chatFeed","map","msg","_msg$timestamp","type","date","timestamp","toDate","Date","publicLogFeed","log","index","_log$timestamp","id","toString","now","sort","a","b","getTime","getDisplayName","uid","safeUid","String","safeUserId","substring","user","find","u","app","firestoreDb","firebaseAuth","unsubscribeAuth","error","console","privateStateRef","then","docSnap","exists","unsubscribePrivateState","snapshot","data","personalLogQuery","unsubscribePersonalLog","stories","docs","reverse","unsubscribes","snap","prev","_docSnap$data","messages","d","_a$timestamp","_b$timestamp","toMillis","cutoffTime","filter","lastActive","events","_a$timestamp2","_b$timestamp2","forEach","unsub","length","currentKnownIds","newDiscoveredEvents","event","location","includes","merge","knownEvents","userDocRef","handleVisibilityChange","document","visibilityState","addEventListener","removeEventListener","current","scrollIntoView","behavior","buildSystemPrompt","worldviewData","worldSetting","genre","title","atmosphere","background_story","worldCreationPrompt","turningPointCreationPrompt","callGeminiTextLLM","userPrompt","systemPromptToUse","mainApiKey","backupApiKey","getApiUrl","payload","contents","role","parts","text","tryGeminiCall","fetch","method","headers","body","JSON","stringify","_result$candidates","_result$candidates$","_result$candidates$$c","_result$candidates$$c2","_result$candidates$$c3","response","ok","Error","status","result","json","llmOutputText","candidates","content","jsonMatch","match","parse","message","checkAndCreateTurningPoint","publicLogSummary","slice","e","join","majorEventsSummary","summary","eventSummary","prompt","replace","llmResponse","create","turningPointRef","startTimestamp","buildLlmPrompt","choice","_privatePlayerState$p","_privatePlayerState$c","factions","npcs","Object","entries","_ref2","value","personalLogEntries","entry","_entry$action","_entry$story","action","story","publicLogEntries","_entry$actor$displayN","_entry$actor","_entry$log","actor","displayName","activeMemorySection","npcPersonaCardSection","npcMatch","npcName","trim","npcRef","npcSnap","npcData","core_identity","memory_log","turningPointSection","description","objectives","obj","progress","goal","h","updatePrivateState","updates","privateStateUpdates","existingRelations","prototype","hasOwnProperty","call","warn","newPrivateChoices","privateChoices","newGroupChoices","groupChoices","keys","updateNarratives","playerChoice","_llmResponse$majorEve","_llmResponse$majorEve2","_updatedScenarioDoc$d","isDeclarative","arguments","undefined","mainScenarioRef","transaction","_llmResponse$sharedSt","scenarioDoc","get","currentData","currentPublicLog","isDeclaration","sharedStateUpdates","publicLogEntry","update","personalStory","majorEvent","npcMemoryUpdate","newMemory","turningPointUpdate","objectiveId","progressIncrement","tpDoc","tpData","newObjectives","newProgress","Math","min","max","newPublicChoices","updatedScenarioDoc","handleDeclarativeAction","actionText","gameStatusRef","scope","_await$getDoc$data","currentLocks","userPromptText","finalLocksDoc","finalLocks","getActionScope","performPlayerAction","_await$getDoc$data2","freshScenarioDoc","serverTimestampValue","_gameState$publicLog","oldLogCount","newPublicLog","interveningEvents","conflictResolutionUserPrompt","conflictStory","split","createCharacter","worldviewRef","currentWorldview","choiceKey","selectedProfession","baseData","cleanedPublicLog","_log$timestamp2","newPublicLogEntry","updatedPublicLog","set","startingChoices","updatedDoc","handleChoiceClick","sendChatMessage","messageText","chatCollectionRef","startsWith","isAction","toggleAccordion","key","toggleActiveMemory","clue","activate","currentMemories","memory","summarizeAndArchiveEvents","alert","placeholder","onChange","target","onKeyDown","handleNicknameSubmit","autoFocus","disabled","handleRetry","resetAllGameData","RenderGameLog","RenderChoices","RenderSidebar"],"sources":["/workspaces/jemini/src/App.jsx"],"sourcesContent":["import React, { useState, useEffect, useMemo, useRef, useCallback } from 'react';\nimport { initializeApp } from 'firebase/app';\nimport {\n  getAuth,\n  signInAnonymously,\n  signInWithCustomToken,\n  onAuthStateChanged,\n} from 'firebase/auth';\nimport {\n  getFirestore,\n  doc,\n  setDoc,\n  getDoc,\n  collection,\n  query,\n  onSnapshot,\n  serverTimestamp,\n  addDoc,\n  getDocs,\n  deleteDoc,\n  runTransaction,\n  orderBy,\n  limit,\n  arrayUnion,\n} from 'firebase/firestore';\n\n// ====================================================================\n// Firebase configuration information\nconst defaultFirebaseConfig = {\n  apiKey: 'AIzaSyBNJtmpRWzjobrY556bnHkwbZmpFJqgPX8',\n  authDomain: 'text-adventure-game-cb731.firebaseapp.com',\n  projectId: 'text-adventure-game-cb731',\n  storageBucket: 'text-adventure-game-cb731.appspot.com',\n  messagingSenderId: '1092941614820',\n  appId: '1:1092941614820:web:5545f36014b73c268026f1',\n  measurementId: 'G-FNGF42T1FP',\n};\n\nconst firebaseConfig = defaultFirebaseConfig;\nconst appId = firebaseConfig.projectId;\nconst initialAuthToken = null;\n// ====================================================================\n\nconst professions = {\n  '1': { name: '몰락한 귀족/기사', motivation: '가문의 몰락 원인을 조사하고, 잃어버린 가문의 보물을 찾아야 합니다.' },\n  '2': { name: '평범한 마을 사람/농부', motivation: '갑자기 마을에 나타난 괴생명체로부터 마을을 지켜야 합니다.' },\n  '3': { name: '젊은 마법사/견습생', motivation: '스승님의 실종에 대한 단서를 찾아야 합니다.' },\n  '4': { name: '용병/모험가', motivation: '의뢰받은 임무를 수행하던 중 예상치 못한 사건에 휘말렸습니다.' },\n  '5': { name: '도적/암살자', motivation: '길드에서 내려온 첫 번째 임무를 완수하고, 그 과정에서 수상한 음모를 감지해야 합니다.' },\n  '6': { name: '왕족/공주/왕자', motivation: '왕실 내의 불화와 암투 속에서 자신의 입지를 다져야 합니다.' },\n};\n\n// Firestore Path Utils\nconst getMainScenarioRef = (db, appId) => doc(db, 'artifacts', appId, 'public', 'data', 'mainScenario', 'main');\nconst getPrivatePlayerStateRef = (db, appId, userId) => doc(db, 'artifacts', appId, 'users', userId, 'playerState', 'state');\nconst getGameStatusRef = (db, appId) => doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'status');\nconst getMajorEventsRef = (db, appId) => collection(db, 'artifacts', appId, 'public', 'data', 'majorEvents');\nconst getPersonalStoryLogRef = (db, appId, userId) => collection(db, 'artifacts', appId, 'users', userId, 'personalStoryLog');\nconst getNpcRef = (db, appId, npcId) => doc(db, 'artifacts', appId, 'public', 'data', 'npcs', npcId);\nconst getActiveTurningPointRef = (db, appId) => doc(db, 'artifacts', appId, 'public', 'data', 'turningPoints', 'active');\nconst getWorldviewRef = (db, appId) => doc(db, 'artifacts', appId, 'public', 'data', 'worldview', 'main');\n\n// State Initialization Utils\nconst getDefaultGameState = () => ({\n  publicLog: [],\n  subtleClues: [],\n  lastUpdate: null,\n});\n\nconst getDefaultPrivatePlayerState = () => ({\n  stats: { strength: 10, intelligence: 10, agility: 10, charisma: 10 },\n  inventory: [],\n  initialMotivation: '',\n  reputation: {},\n  activeQuests: [],\n  companions: [],\n  knownClues: [],\n  activeMemories: [],\n  characterCreated: false,\n  profession: '',\n  choices: [],\n  groups: [],\n  npcRelations: {},\n  knownEventIds: [],\n  currentLocation: '방랑자의 안식처',\n});\n\n// Helper Components\nconst LlmErrorModal = ({ llmError, llmRetryPrompt, setLlmError, setLlmRetryPrompt, onRetry }) => (\n    <div className=\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\">\n        <div className=\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 text-center\">\n            <h3 className=\"text-xl font-bold text-red-400\">오류가 발생했습니다</h3>\n            <p className=\"text-gray-200\">{llmError}</p>\n            <div className=\"flex justify-center gap-4\">\n                {llmRetryPrompt && (\n                    <button className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md\" onClick={onRetry}>\n                        재시도\n                    </button>\n                )}\n                <button className=\"px-4 py-2 bg-gray-600 hover:bg-gray-700 font-bold rounded-md\" onClick={() => { setLlmError(null); setLlmRetryPrompt(null); }}>\n                    닫기\n                </button>\n            </div>\n        </div>\n    </div>\n);\n\n// Main App Component\nfunction App() {\n  const [gameState, setGameState] = useState(getDefaultGameState());\n  const [personalStoryLog, setPersonalStoryLog] = useState([]);\n  const [privatePlayerState, setPrivatePlayerState] = useState(getDefaultPrivatePlayerState());\n  const [displayedChoices, setDisplayedChoices] = useState([]);\n  const [choicesTimestamp, setChoicesTimestamp] = useState(null);\n  const [isTextLoading, setIsTextLoading] = useState(false);\n  const [activeUsers, setActiveUsers] = useState([]);\n  const [chatMessages, setChatMessages] = useState([]);\n  const [currentChatMessage, setCurrentChatMessage] = useState('');\n  const [actionLocks, setActionLocks] = useState({});\n  const [db, setDb] = useState(null);\n  const [auth, setAuth] = useState(null);\n  const [userId, setUserId] = useState(null);\n  const [isAuthReady, setIsAuthReady] = useState(false);\n  const logEndRef = useRef(null);\n  const chatEndRef = useRef(null);\n  const [nickname, setNickname] = useState(() => localStorage.getItem('nickname') || '');\n  const [showNicknameModal, setShowNicknameModal] = useState(!localStorage.getItem('nickname'));\n  const [nicknameInput, setNicknameInput] = useState('');\n  const [accordion, setAccordion] = useState({ gameLog: true, chat: true, users: true, playerInfo: true, chronicle: true, turningPoint: true });\n  const [showResetModal, setShowResetModal] = useState(false);\n  const [isResetting, setIsResetting] = useState(false);\n  const [llmError, setLlmError] = useState(null);\n  const [llmRetryPrompt, setLlmRetryPrompt] = useState(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [allMajorEvents, setAllMajorEvents] = useState([]);\n  const [knownMajorEvents, setKnownMajorEvents] = useState([]);\n  const [activeTurningPoint, setActiveTurningPoint] = useState(null);\n  const [worldview, setWorldview] = useState(null);\n\n  const combinedFeed = useMemo(() => {\n    const chatFeed = (chatMessages || []).map((msg) => ({ ...msg, type: 'chat', date: msg.timestamp?.toDate() || new Date() }));\n    const publicLogFeed = (gameState.publicLog || []).map((log, index) => ({ ...log, id: `${log.timestamp?.toString()}-${index}` || `${Date.now()}-${index}`, type: 'system', date: log.timestamp instanceof Date ? log.timestamp : new Date() }));\n    return [...chatFeed, ...publicLogFeed].sort((a, b) => a.date.getTime() - b.date.getTime());\n  }, [chatMessages, gameState.publicLog]);\n  \n  const getDisplayName = useCallback((uid) => {\n    const safeUid = String(uid || '');\n    if (uid === userId) {\n      const safeUserId = String(userId || '');\n      return nickname || `플레이어 ${safeUserId.substring(0, 4)}`;\n    }\n    const user = activeUsers.find((u) => u.id === uid);\n    return user?.nickname || `플레이어 ${safeUid.substring(0, 4)}`;\n  }, [userId, nickname, activeUsers]);\n\n  // Firebase Initialization\n  useEffect(() => {\n    try {\n      const app = initializeApp(firebaseConfig);\n      const firestoreDb = getFirestore(app);\n      const firebaseAuth = getAuth(app);\n      setDb(firestoreDb);\n      setAuth(firebaseAuth);\n\n      const unsubscribeAuth = onAuthStateChanged(firebaseAuth, async (user) => {\n        if (user) {\n          setUserId(user.uid);\n          setIsAuthReady(true);\n        } else {\n          await (initialAuthToken ? signInWithCustomToken(firebaseAuth, initialAuthToken) : signInAnonymously(firebaseAuth));\n        }\n      });\n      return () => unsubscribeAuth();\n    } catch (error) {\n      console.error('Firebase initialization error:', error);\n      setLlmError('Firebase 초기화에 실패했습니다.');\n    }\n  }, []);\n\n  // Player and Personal Data Listener\n  useEffect(() => {\n    if (!isAuthReady || !db || !userId) return;\n\n    const privateStateRef = getPrivatePlayerStateRef(db, appId, userId);\n    getDoc(privateStateRef).then((docSnap) => {\n      if (!docSnap.exists()) {\n        setDoc(privateStateRef, getDefaultPrivatePlayerState());\n      }\n    });\n\n    const unsubscribePrivateState = onSnapshot(privateStateRef, (snapshot) => {\n      if (snapshot.exists()) {\n        setPrivatePlayerState({ ...getDefaultPrivatePlayerState(), ...snapshot.data() });\n      }\n      if (isLoading) setIsLoading(false);\n    });\n\n    const personalLogQuery = query(getPersonalStoryLogRef(db, appId, userId), orderBy('timestamp', 'desc'), limit(50));\n    const unsubscribePersonalLog = onSnapshot(personalLogQuery, (snapshot) => {\n      const stories = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() })).reverse();\n      setPersonalStoryLog(stories);\n    });\n\n    return () => {\n      unsubscribePrivateState();\n      unsubscribePersonalLog();\n    };\n  }, [isAuthReady, db, userId, isLoading]);\n\n  // Public Game Data Listeners\n  useEffect(() => {\n    if (!isAuthReady || !db) return;\n    const unsubscribes = [\n      onSnapshot(getMainScenarioRef(db, appId), (snap) => { if (snap.exists()) { const data = snap.data(); setGameState((prev) => ({ ...prev, publicLog: data.publicLog || [], subtleClues: data.subtleClues || [], lastUpdate: data.lastUpdate })); } }),\n      onSnapshot(getWorldviewRef(db, appId), (snap) => setWorldview(snap.exists() ? snap.data() : null)),\n      onSnapshot(getGameStatusRef(db, appId), (docSnap) => setActionLocks(docSnap.data()?.actionLocks || {})),\n      onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'chatMessages')), (snapshot) => { const messages = snapshot.docs.map((d) => ({ id: d.id, ...d.data() })).sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0)); setChatMessages(messages); }),\n      onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'activeUsers')), (snapshot) => { const cutoffTime = Date.now() - 60 * 1000; const users = snapshot.docs.map((d) => ({ id: d.id, ...d.data() })).filter((u) => u.lastActive && u.lastActive.toMillis() > cutoffTime); setActiveUsers(users); }),\n      onSnapshot(query(getMajorEventsRef(db, appId)), (snapshot) => { const events = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() })).sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0)); setAllMajorEvents(events); }),\n      onSnapshot(getActiveTurningPointRef(db, appId), (docSnap) => setActiveTurningPoint(docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null)),\n    ];\n    return () => unsubscribes.forEach((unsub) => unsub());\n  }, [isAuthReady, db]);\n\n  // Event Discovery Effect\n  useEffect(() => {\n    if (!db || !userId || allMajorEvents.length === 0) return;\n    const currentKnownIds = privatePlayerState.knownEventIds || [];\n    const newDiscoveredEvents = allMajorEvents.filter(event => event?.location === privatePlayerState.currentLocation && !currentKnownIds.includes(event.id)).map(event => event.id);\n    if (newDiscoveredEvents.length > 0) {\n      const privateStateRef = getPrivatePlayerStateRef(db, appId, userId);\n      setDoc(privateStateRef, { knownEventIds: arrayUnion(...newDiscoveredEvents) }, { merge: true });\n    }\n  }, [privatePlayerState.currentLocation, allMajorEvents, privatePlayerState.knownEventIds, db, userId]);\n\n  useEffect(() => {\n    const knownEvents = allMajorEvents.filter((event) => (privatePlayerState.knownEventIds || []).includes(event?.id));\n    setKnownMajorEvents(knownEvents);\n  }, [privatePlayerState.knownEventIds, allMajorEvents]);\n\n  // User Presence Effect\n  useEffect(() => {\n    if (!db || !userId || !nickname) return;\n    const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'activeUsers', userId);\n    setDoc(userDocRef, { lastActive: serverTimestamp(), nickname: nickname || `플레이어 ${userId.substring(0, 4)}`, profession: privatePlayerState.profession, }, { merge: true });\n    const handleVisibilityChange = () => { if (document.visibilityState === 'visible') { setDoc(userDocRef, { lastActive: serverTimestamp() }, { merge: true }); } };\n    document.addEventListener('visibilitychange', handleVisibilityChange);\n    return () => document.removeEventListener('visibilitychange', handleVisibilityChange);\n  }, [db, userId, nickname, privatePlayerState.profession]);\n\n  // Auto-scroll Effects\n  useEffect(() => { if (accordion.gameLog && logEndRef.current) { logEndRef.current.scrollIntoView({ behavior: 'smooth' }); } }, [personalStoryLog, accordion.gameLog]);\n  useEffect(() => { if (accordion.chat && chatEndRef.current) { chatEndRef.current.scrollIntoView({ behavior: 'smooth' }); } }, [combinedFeed, accordion.chat]);\n\n  // --- Core Game Logic Functions ---\n  \n  const buildSystemPrompt = useCallback((worldviewData) => {\n    const worldSetting = worldviewData ? `### 세계관 설정: [${worldviewData.genre}] ${worldviewData.title}\\n${worldviewData.atmosphere}\\n배경: ${worldviewData.background_story}` : `### 세계관 설정: 페이디드 판타지 (Faded Fantasy) 이 세계는 오래되었고, 과거의 영광은 빛이 바랬습니다... (기본값)`;\n    return `### 페르소나 (Persona) 당신은 이 세계의 '수호자'이자 '사관(史官)'이며, 플레이어들에게는 '게임 마스터(GM)'로 알려져 있습니다. 당신의 임무는 단순한 이야기 생성을 넘어, 일관된 역사와 살아 숨 쉬는 세계관을 구축하는 것입니다. 모든 묘사와 사건은 이 세계의 정해진 분위기와 역사적 사실 위에서 피어나는 한 편의 서사시여야 합니다. ${worldSetting} ### 핵심 구동 원칙 1. **일관성의 원칙 (Canon) (가장 중요)**: User Prompt에 제공된 [세계의 연대기], [주요 세력 및 인물], [플레이어 정보]는 이 세계의 '정사(正史)'입니다. 당신은 절대 이 사실들을 왜곡하거나 모순되는 내용을 만들어서는 안 됩니다. 이 정보들을 바탕으로 세계를 확장해 나가십시오. 2. **상호연결성의 원칙 (Interconnection)**: 당신은 뛰어난 이야기꾼으로서, 현재 발생하는 사건을 과거의 역사나 다른 플레이어의 행적과 연결지어야 합니다. 예를 들어, 한 플레이어가 던전에서 발견한 고대 문양은, 다른 플레이어가 수도에서 쫓고 있는 비밀 결사의 상징일 수 있습니다. 세상이 서로 연결되어 있음을 플레이어가 느끼게 하십시오. 3. **장면 중심의 서사 원칙 (Scene-Centric)**: 플레이어의 '[선택]'은 하나의 '장면'을 시작하는 것과 같습니다. 당신의 \"personalStory\"는 반드시 그 선택의 즉각적인 결과와 묘사로 시작되어야 합니다. 대화라면 실제 대화 내용이, 행동이라면 그 행동의 과정과 결과가 구체적으로 서술되어야 합니다. 4. **'보여주기, 말하지 않기' 원칙 (Show, Don't Tell)**: \"마을이 가난하다\"고 설명하지 마십시오. 대신 \"굶주린 아이들이 흙바닥에 주저앉아 있고, 대부분의 건물은 지붕이 허술하게 덧대어져 있다\"고 묘사하십시오. 플레이어가 스스로 분위기와 상황을 파악하게 만드십시오. ### [추가] NPC 상호작용 규칙 - 플레이어가 NPC와 상호작용할 때, 해당 NPC의 [페르소나 카드]가 제공될 수 있습니다. - 당신은 반드시 이 [페르소나 카드]에 명시된 '핵심 정체성'과 '기억 로그'를 바탕으로 NPC의 대사와 행동을 일관성 있게 생성해야 합니다. - 상호작용의 결과로 NPC가 새로운 사실을 알게 되거나 감정이 변했다면, 이를 반영할 '기억 로그 업데이트'를 JSON 출력의 'npcMemoryUpdate' 필드에 요약하여 포함시키십시오. ### JSON 출력 구조 {\"publicLogEntry\": \"만약 이 행동이 주변의 다른 플레이어나 NPC가 명백히 인지할 수 있는 '공개적인 사건'이라면, 3인칭 시점의 객관적인 기록을 한 문장으로 작성. (예: '플레이어 A가 경비병을 공격했다.') 그렇지 않으면 null.\",\"personalStory\": \"플레이어의 선택으로 시작된 '장면'에 대한 상세하고 감정적인 1인칭 또는 2인칭 서사. 플레이어의 내면 묘사, 감각, 대화 내용 등을 포함.\",\"choices\": [\"'personalStory'의 결과에 따라 플레이어가 할 수 있는 논리적인 다음 행동들.\"],\"privateChoices\": [\"오직 행동 주체의 특성 때문에 가능한 특별한 행동들.\"],\"groupChoices\": [\"같은 그룹 소속원들만 할 수 있는 비밀 행동들.\"],\"majorEvent\": {\"summary\": \"만약 이 사건이 후대에 '역사'로 기록될 만한 중대한 전환점이라면, 사관의 어조로 요약. (예: '왕국력 342년, 방랑자의 안식처에서 발생한 이 사건은 훗날 '붉은 달 교단'의 부흥을 알리는 서막이 되었다.') 그렇지 않으면 null.\",\"location\": \"사건이 발생한 장소 이름. majorEvent가 있을 경우 필수.\"},\"sharedStateUpdates\": {\"subtleClues\": [{\"location\": \"장소명\", \"clue\": \"새롭게 생성된 단서\"}]},\"privateStateUpdates\": {\"location\": \"플레이어의 새로운 현재 위치. 변경되었을 경우에만 포함.\",\"inventory\": [\"업데이트된 전체 인벤토리 목록\"],\"stats\": {\"strength\": 12, \"intelligence\": 10, \"agility\": 10, \"charisma\": 10 },\"activeQuests\": [\"업데이트된 개인 퀘스트 목록\"],\"knownClues\": [\"새롭게 알게 된 단서 목록\"],\"groups\": [\"업데이트된 소속 그룹 목록\"],\"npcRelations\": {\"가라크\": \"55 (나에 대한 경계심이 약간 누그러졌다.)\"}},\"npcMemoryUpdate\": {\"npcName\": \"상호작용 한 NPC의 이름\",\"newMemory\": \"NPC의 기억에 추가될 새로운 로그 (예: '플레이어 B가 음식값을 빚지고 도망갔다.')\"},\"turningPointUpdate\": {\"objectiveId\": \"플레이어의 행동이 기여한 목표의 ID\",\"progressIncrement\": 10}}`;\n  }, []);\n\n  const worldCreationPrompt = `당신은 천재적인 스토리 작가이자 '세계 창조자'입니다. 지금부터 플레이어들이 모험할 새로운 세계의 핵심 설정을 만들어야 합니다. 전통적인 판타지에 얽매이지 말고, 영화, 애니메이션, 소설, 신화 등 모든 장르를 아우르는 독창적이고 매력적인 세계관을 창조하십시오. 사이버펑크, 무협, 스팀펑크, 코스믹 호러, 포스트 아포칼립스, 느와르 등 어떤 것이든 좋습니다. 아래 JSON 구조에 맞춰 응답해주십시오. ### JSON 출력 구조 {\"title\": \"세계관의 이름 (예: '네온 비가 내리는 도시, 2242')\",\"genre\": \"세계관의 장르 (예: '사이버펑크 느와르')\",\"atmosphere\": \"세계의 전체적인 분위기를 묘사하는 2~3 문장의 글\",\"background_story\": \"플레이어가 모험을 시작하기 직전까지의 간략한 배경 역사\"}`;\n  const turningPointCreationPrompt = `당신은 역사의 흐름을 읽는 '운명' 그 자체입니다. 최근 세상에서 벌어진 다음 사건들을 보고, 이 흐름이 하나의 거대한 '전환점(Turning Point)'으로 수렴될 수 있는지 판단하십시오. 현재 활성화된 전환점은 없습니다. 만약 중대한 갈등의 씨앗이나, 거대한 위협, 혹은 새로운 시대의 서막이 보인다면, 그에 맞는 전환점을 아래 JSON 형식으로 생성해주십시오. 아직 시기가 아니라면 'create' 값을 false로 설정하십시오. ### 최근 사건들 {event_summary} ### JSON 출력 구조 {\"create\": true,\"turningPoint\": {\"title\": \"전환점의 제목 (예: '수도에 창궐한 역병')\",\"description\": \"전환점에 대한 흥미로운 설명\",\"status\": \"active\",\"objectives\": [{ \"id\": \"objective_1\", \"description\": \"첫 번째 목표 (예: 역병의 근원 찾기)\", \"progress\": 0, \"goal\": 100 },{ \"id\": \"objective_2\", \"description\": \"두 번째 목표 (예: 치료제 개발 지원)\", \"progress\": 0, \"goal\": 100 }]}}`;\n\n  const callGeminiTextLLM = async (userPrompt, systemPromptToUse) => {\n    setIsTextLoading(true);\n    const mainApiKey = 'AIzaSyDC11rqjU30OJnLjaBFOaazZV0klM5raU8';\n    const backupApiKey = 'AIzaSyAhscNjW8GmwKPuKzQ47blCY_bDanR-B84';\n    const getApiUrl = (apiKey) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;\n    const payload = {\n      contents: [\n        { role: 'user', parts: [{ text: systemPromptToUse }] },\n        { role: 'model', parts: [{ text: '{}' }] },\n        { role: 'user', parts: [{ text: userPrompt }] },\n      ],\n    };\n\n    const tryGeminiCall = async (apiKey) => {\n      return fetch(getApiUrl(apiKey), {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(payload),\n      });\n    };\n\n    try {\n      let response = await tryGeminiCall(mainApiKey);\n      if (!response.ok) {\n        response = await tryGeminiCall(backupApiKey);\n      }\n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n      const result = await response.json();\n      const llmOutputText = result.candidates?.[0]?.content?.parts?.[0]?.text;\n      const jsonMatch = llmOutputText?.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        return JSON.parse(jsonMatch[0]);\n      }\n      throw new Error('Valid JSON object not found in LLM response.');\n    } catch (error) {\n      console.error('LLM API call error:', error);\n      setLlmError(error.message || 'LLM 호출 실패');\n      return null;\n    } finally {\n      setIsTextLoading(false);\n    }\n  };\n  \n  const checkAndCreateTurningPoint = useCallback(async () => {\n    if (activeTurningPoint || !db) return;\n    console.log(\"Checking for new Turning Point...\");\n    const publicLogSummary = (gameState.publicLog || []).slice(-20).map(e => e.log).join('\\n');\n    const majorEventsSummary = (allMajorEvents || []).slice(-10).map(e => e.summary).join('\\n');\n    const eventSummary = `[최근 공개 사건들]\\n${publicLogSummary}\\n\\n[최근 주요 역사]\\n${majorEventsSummary}`;\n    const prompt = turningPointCreationPrompt.replace('{event_summary}', eventSummary);\n    const llmResponse = await callGeminiTextLLM(prompt, buildSystemPrompt(worldview));\n    if (llmResponse && llmResponse.create && llmResponse.turningPoint) {\n      console.log(\"New Turning Point detected! Creating...\", llmResponse.turningPoint);\n      const turningPointRef = getActiveTurningPointRef(db, appId);\n      await setDoc(turningPointRef, { ...llmResponse.turningPoint, startTimestamp: serverTimestamp() });\n    } else {\n      console.log(\"No new Turning Point detected at this time.\");\n    }\n  }, [activeTurningPoint, db, gameState.publicLog, allMajorEvents, worldview, callGeminiTextLLM, buildSystemPrompt, turningPointCreationPrompt]);\n\n\n  const buildLlmPrompt = useCallback(async (choice) => {\n    const factions = (privatePlayerState.groups || []).join(', ') || '없음';\n    const npcs = Object.entries(privatePlayerState.npcRelations || {}).map(([name, value]) => `${name} (관계: ${value})`).join(', ') || '없음';\n    const personalLogEntries = (personalStoryLog || []).slice(-10).map((entry) => `[나의 행동: ${entry?.action ?? '알 수 없는 행동'}] -> ${entry?.story ?? ''}`).join('\\n');\n    const publicLogEntries = (gameState.publicLog || []).slice(-10).map((entry) => `[${entry?.actor?.displayName ?? '누군가'}] ${entry?.log ?? ''}`).join('\\n');\n    const activeMemorySection = privatePlayerState.activeMemories && privatePlayerState.activeMemories.length > 0 ? `[나의 활성 기억 (My Active Memories)]\\n- 이것은 내가 이 세계에서 가장 중요하다고 생각하는 핵심 정보들입니다. 당신은 이 정보를 반드시 최우선으로 고려하여 이야기를 진행해야 합니다.\\n- ${privatePlayerState.activeMemories.join('\\n- ')}\\n` : '';\n    let npcPersonaCardSection = '';\n    const npcMatch = choice.match(/(.+)에게 말을 건다/);\n    if (npcMatch && db) {\n      const npcName = npcMatch[1].trim();\n      const npcId = npcName.replace(/\\s+/g, '_');\n      const npcRef = getNpcRef(db, appId, npcId);\n      const npcSnap = await getDoc(npcRef);\n      if (npcSnap.exists()) {\n        const npcData = npcSnap.data();\n        npcPersonaCardSection = `\\n[NPC 페르소나 카드: ${npcName}]\\n- 핵심 정체성: ${npcData.core_identity || '아직 알려지지 않음'}\\n- 기억 로그: \\n${npcData.memory_log && npcData.memory_log.length > 0 ? npcData.memory_log.map((log) => `- ${log}`).join('\\n') : '- 특별한 기억 없음'}\\n`;\n      } else {\n        npcPersonaCardSection = `\\n[NPC 페르소나 카드: ${npcName}]\\n- 핵심 정체성: 당신이 이번 상호작용을 통해 이 NPC의 성격을 처음으로 설정합니다.\\n- 기억 로그: - 특별한 기억 없음\\n`;\n      }\n    }\n    let turningPointSection = \"\";\n    if (activeTurningPoint && activeTurningPoint.status === 'active') {\n      turningPointSection = `\\n[현재 진행중인 주요 분기점: ${activeTurningPoint.title}]\\n- 개요: ${activeTurningPoint.description}\\n- 현재 목표 및 진척도:\\n${(activeTurningPoint.objectives || []).map(obj => `  - ${obj.description} (${obj.progress}/${obj.goal})`).join('\\n')}\\n- 당신의 행동이 이 분기점의 목표에 기여한다면, 'turningPointUpdate'를 통해 결과를 알려주십시오.\\n`;\n    }\n    return `${activeMemorySection}${npcPersonaCardSection}${turningPointSection}[세계의 연대기 (World Chronicle)]\\n- 내가 발견한, 세상에 일어난 주요 역사적 사건들입니다. 이 기록은 절대적인 사실입니다.\\n- ${knownMajorEvents.length > 0 ? knownMajorEvents.map((h) => h.summary).join('\\n- ') : '아직 기록된 역사가 없음'}\\n\\n[나의 여정록 (My Journey Log) - 최근 기록]\\n- 이것은 나의 개인적인 경험과 생각의 기록입니다.\\n${personalLogEntries || '아직 여정을 시작하지 않음'}\\n\\n[주변의 최근 사건들 (Recent Public Events)]\\n- 내가 있는 장소 주변에서 최근 일어난 공개적인 사건들입니다.\\n${publicLogEntries || '최근에 주변에서 별다른 일은 없었음'}\\n\\n[주요 세력 및 인물 (Key Factions & NPCs)]\\n- 나와 관련된 주요 세력: ${factions}\\n- 나와 관계를 맺은 주요 인물: ${npcs}\\n\\n[나의 현재 상태 (My Current State)]\\n- 이름: ${getDisplayName(userId)}\\n- 직업: ${privatePlayerState.profession ?? '미정'}\\n- 현재 위치: ${privatePlayerState.currentLocation ?? '알 수 없는 곳'}\\n- 소지품 및 능력치: ${JSON.stringify({ inventory: privatePlayerState.inventory || [], stats: privatePlayerState.stats || {} })}\\n\\n[주변 관찰자 (Nearby Observers)]\\n- 현재 장소에 함께 있는 다른 플레이어들입니다. 이들은 이번 턴에 행동하지 않습니다.\\n- ${(activeUsers || []).map((u) => u.nickname || `플레이어 ${u.id.substring(0, 4)}`).join(', ') || '주변에 다른 플레이어가 없음'}\\n\\n[나의 선택 (My Action)]\\n- 위 모든 상황 속에서, 나는 다음 행동을 선택했습니다. 이 선택으로 시작될 '장면'을 연출해주십시오.\\n- \"${choice}\"`;\n  }, [privatePlayerState, personalStoryLog, gameState.publicLog, db, activeTurningPoint, knownMajorEvents, getDisplayName, userId, activeUsers]);\n\n  const updatePrivateState = useCallback(async (llmResponse) => {\n    const privateStateRef = getPrivatePlayerStateRef(db, appId, userId);\n    const updates = llmResponse.privateStateUpdates ? { ...llmResponse.privateStateUpdates } : {};\n    if (updates.npcRelations && typeof updates.npcRelations === 'object') {\n      const existingRelations = privatePlayerState.npcRelations || {};\n      updates.npcRelations = { ...existingRelations, ...updates.npcRelations };\n    } else if (Object.prototype.hasOwnProperty.call(updates, 'npcRelations')) {\n      delete updates.npcRelations;\n      console.warn(`[Data Warning] LLM이 보낸 npcRelations 포맷이 유효하지 않아 무시합니다.`);\n    }\n    const newPrivateChoices = llmResponse.privateChoices || [];\n    const newGroupChoices = llmResponse.groupChoices || [];\n    updates.choices = [...newPrivateChoices, ...newGroupChoices];\n    if (Object.keys(updates).length > 0) {\n      await setDoc(privateStateRef, updates, { merge: true });\n    }\n  }, [db, userId, privatePlayerState.npcRelations]);\n  \n  const updateNarratives = useCallback(async (llmResponse, playerChoice, isDeclarative = false) => {\n    const mainScenarioRef = getMainScenarioRef(db, appId);\n    await runTransaction(db, async (transaction) => {\n      const scenarioDoc = await transaction.get(mainScenarioRef);\n      if (!scenarioDoc.exists()) { throw new Error('치명적 오류: 게임의 기본 시나리오 데이터가 없습니다.'); }\n      let currentData = scenarioDoc.data();\n      let currentPublicLog = currentData.publicLog || [];\n      if (isDeclarative) { currentPublicLog = [...currentPublicLog, { actor: { id: userId, displayName: getDisplayName(userId) }, log: \"❗ 세계 흐름의 변동이 일어납니다!\", isDeclaration: true, timestamp: new Date(new Date().getTime() - 1) }]; }\n      const updates = { subtleClues: llmResponse.sharedStateUpdates?.subtleClues || currentData.subtleClues, lastUpdate: serverTimestamp(), };\n      if (llmResponse.publicLogEntry) { updates.publicLog = [...currentPublicLog, { actor: { id: userId, displayName: getDisplayName(userId) }, log: llmResponse.publicLogEntry, timestamp: new Date() }]; }\n      else if (isDeclarative) { updates.publicLog = currentPublicLog; }\n      transaction.update(mainScenarioRef, updates);\n    });\n\n    await addDoc(getPersonalStoryLogRef(db, appId, userId), { action: playerChoice, story: llmResponse.personalStory || '특별한 일은 일어나지 않았다.', timestamp: serverTimestamp() });\n    \n    if (llmResponse.majorEvent?.summary && llmResponse.majorEvent?.location) {\n      await addDoc(getMajorEventsRef(db, appId), { ...llmResponse.majorEvent, timestamp: serverTimestamp(), actor: { id: userId, displayName: getDisplayName(userId) }, });\n      checkAndCreateTurningPoint();\n    }\n    \n    if (llmResponse.npcMemoryUpdate && db) {\n      const { npcName, newMemory } = llmResponse.npcMemoryUpdate;\n      if (npcName && newMemory) {\n        const npcId = npcName.replace(/\\s+/g, '_');\n        await setDoc(getNpcRef(db, appId, npcId), { name: npcName, memory_log: arrayUnion(newMemory) }, { merge: true });\n      }\n    }\n\n    if (llmResponse.turningPointUpdate && activeTurningPoint) {\n      const { objectiveId, progressIncrement } = llmResponse.turningPointUpdate;\n      if (objectiveId && typeof progressIncrement === 'number') {\n        const turningPointRef = getActiveTurningPointRef(db, appId);\n        await runTransaction(db, async (transaction) => {\n          const tpDoc = await transaction.get(turningPointRef);\n          if (!tpDoc.exists()) return;\n          const tpData = tpDoc.data();\n          const newObjectives = (tpData.objectives || []).map((obj) => {\n            if (obj.id === objectiveId) {\n              const newProgress = (obj.progress || 0) + progressIncrement;\n              return { ...obj, progress: Math.min(Math.max(newProgress, 0), obj.goal) };\n            }\n            return obj;\n          });\n          transaction.update(turningPointRef, { objectives: newObjectives });\n        });\n      }\n    }\n    \n    await updatePrivateState(llmResponse);\n    \n    const newPublicChoices = llmResponse.choices || [];\n    setDisplayedChoices(newPublicChoices);\n    const updatedScenarioDoc = await getDoc(mainScenarioRef);\n    setChoicesTimestamp(updatedScenarioDoc.data()?.lastUpdate || null);\n  }, [db, userId, getDisplayName, checkAndCreateTurningPoint, activeTurningPoint, updatePrivateState]);\n\n  const handleDeclarativeAction = useCallback(async (actionText) => {\n    setIsTextLoading(true);\n    setLlmRetryPrompt({ playerChoice: actionText, isDeclarative: true });\n    const gameStatusRef = getGameStatusRef(db, appId);\n    const scope = `declarative:${privatePlayerState.currentLocation}`;\n    try {\n      const currentLocks = (await getDoc(gameStatusRef)).data()?.actionLocks || {};\n      if (currentLocks[scope] && currentLocks[scope] !== userId) {\n        throw new Error(`현재 다른 플레이어(${getDisplayName(currentLocks[scope])})의 중대한 행동으로 인해 추가 행동을 할 수 없습니다.`);\n      }\n      await setDoc(gameStatusRef, { actionLocks: { ...currentLocks, [scope]: userId } }, { merge: true });\n      const systemPromptToUse = buildSystemPrompt(worldview);\n      const userPromptText = await buildLlmPrompt(actionText);\n      const llmResponse = await callGeminiTextLLM(userPromptText, systemPromptToUse);\n      if (llmResponse) {\n        await updateNarratives(llmResponse, actionText, true);\n        setLlmError(null);\n        setLlmRetryPrompt(null);\n      } else if (!llmError) {\n        setLlmError(\"LLM으로부터 유효한 응답을 받지 못했습니다.\");\n      }\n    } catch (error) {\n      console.error(\"선언적 행동 처리 중 오류:\", error.message);\n      setLlmError(error.message);\n    } finally {\n      const finalLocksDoc = await getDoc(gameStatusRef);\n      if (finalLocksDoc.exists()) {\n        const finalLocks = finalLocksDoc.data().actionLocks || {};\n        if (finalLocks[scope] === userId) {\n          delete finalLocks[scope];\n          await setDoc(gameStatusRef, { actionLocks: finalLocks }, { merge: true });\n        }\n      }\n      setIsTextLoading(false);\n    }\n  }, [db, privatePlayerState.currentLocation, userId, getDisplayName, buildSystemPrompt, worldview, buildLlmPrompt, callGeminiTextLLM, updateNarratives, llmError]);\n\n  const getActionScope = useCallback((choice) => {\n      const npcMatch = choice.match(/(.+)에게 말을 건다/);\n      if (npcMatch) {\n        return `npc:${npcMatch[1].trim()}`;\n      }\n      return `location:${privatePlayerState.currentLocation}`;\n  }, [privatePlayerState.currentLocation]);\n\n  const performPlayerAction = useCallback(async (choice) => {\n    setIsTextLoading(true);\n    setLlmRetryPrompt({ playerChoice: choice });\n    const mainScenarioRef = getMainScenarioRef(db, appId);\n    const gameStatusRef = getGameStatusRef(db, appId);\n    const scope = getActionScope(choice);\n    try {\n      const freshScenarioDoc = await getDoc(mainScenarioRef);\n      const serverTimestampValue = freshScenarioDoc.exists() ? freshScenarioDoc.data().lastUpdate : null;\n      if (choicesTimestamp && serverTimestampValue && choicesTimestamp.toMillis() < serverTimestampValue.toMillis()) {\n        const oldLogCount = gameState.publicLog?.length || 0;\n        const newPublicLog = freshScenarioDoc.data().publicLog || [];\n        const interveningEvents = newPublicLog.slice(oldLogCount).map(log => `[${log.actor.displayName}] ${log.log}`).join(', ');\n        const conflictResolutionUserPrompt = `[상황]\\n- 나의 원래 행동: \"${choice}\"\\n- 내가 행동하기 직전에 벌어진 실제 사건: \"${interveningEvents || '알 수 없는 변화'}\"\\n\\n[지시]\\n위 상황을 바탕으로, 나의 행동이 실패하고 실제 사건을 목격하는 장면을 1인칭 또는 2인칭 시점에서 극적으로 묘사해주십시오. 예시: 내가 '경비병에게 말을 걸려고' 했으나, 실제로는 '다른 플레이어가 경비병을 암살했다'면, \"당신이 경비병에게 다가가려던 찰나, 어둠 속에서 날아온 화살이 경비병의 목에 박히는 것을 목격합니다.\" 와 같이 서술합니다. 반드시 'personalStory'와 현재 상황에 맞는 새로운 'choices'를 포함한 JSON 형식으로만 응답해주십시오.`;\n        const systemPromptToUse = buildSystemPrompt(worldview);\n        const llmResponse = await callGeminiTextLLM(conflictResolutionUserPrompt, systemPromptToUse);\n        if (llmResponse) {\n          await addDoc(getPersonalStoryLogRef(db, appId, userId), { action: choice, story: llmResponse.personalStory, timestamp: serverTimestamp() });\n          await updatePrivateState(llmResponse);\n          setDisplayedChoices(llmResponse.choices || []);\n          setChoicesTimestamp(serverTimestampValue);\n        } else {\n          const conflictStory = `당신이 '${choice}'(을)를 하려던 찰나, 세상은 이미 당신의 예상과 달라져 있었습니다. 주변을 다시 둘러보니 상황이 바뀌어 있습니다.`;\n          await addDoc(getPersonalStoryLogRef(db, appId, userId), { action: choice, story: conflictStory, timestamp: serverTimestamp() });\n          setDisplayedChoices([\"주변을 다시 살핀다.\"]);\n          setPrivatePlayerState(prev => ({ ...prev, choices: [] }));\n          setChoicesTimestamp(serverTimestampValue);\n        }\n        setIsTextLoading(false);\n        return;\n      }\n      const currentLocks = (await getDoc(gameStatusRef)).data()?.actionLocks || {};\n      if (currentLocks[scope] && currentLocks[scope] !== userId) {\n        throw new Error(`현재 '${scope.split(':')[1]}'(은)는 다른 플레이어(${getDisplayName(currentLocks[scope])})가 사용 중입니다.`);\n      }\n      await setDoc(gameStatusRef, { actionLocks: { ...currentLocks, [scope]: userId } }, { merge: true });\n      const systemPromptToUse = buildSystemPrompt(worldview);\n      const userPromptText = await buildLlmPrompt(choice);\n      const llmResponse = await callGeminiTextLLM(userPromptText, systemPromptToUse);\n      if (llmResponse) {\n        await updateNarratives(llmResponse, choice, false);\n        setLlmError(null);\n        setLlmRetryPrompt(null);\n      } else if (!llmError) {\n        setLlmError('LLM으로부터 유효한 응답을 받지 못했습니다.');\n      }\n    } catch (error) {\n      console.error('행동 처리 중 오류:', error.message);\n      setLlmError(error.message);\n    } finally {\n      const finalLocksDoc = await getDoc(gameStatusRef);\n      if (finalLocksDoc.exists()) {\n        const finalLocks = finalLocksDoc.data().actionLocks || {};\n        if (finalLocks[scope] === userId) {\n          delete finalLocks[scope];\n          await setDoc(gameStatusRef, { actionLocks: finalLocks }, { merge: true });\n        }\n      }\n      setIsTextLoading(false);\n    }\n  }, [db, getActionScope, choicesTimestamp, gameState.publicLog, buildSystemPrompt, worldview, callGeminiTextLLM, userId, updatePrivateState, getDisplayName, buildLlmPrompt, updateNarratives, llmError]);\n  \n  const createCharacter = useCallback(async (choice) => {\n    setIsTextLoading(true);\n    try {\n      const worldviewRef = getWorldviewRef(db, appId);\n      let currentWorldview = worldview;\n      if (!currentWorldview) {\n        console.log(\"No worldview found. Creating a new one...\");\n        const llmResponse = await callGeminiTextLLM(worldCreationPrompt, worldCreationPrompt);\n        if (llmResponse) {\n          await setDoc(worldviewRef, llmResponse);\n          currentWorldview = llmResponse;\n          setWorldview(llmResponse);\n        } else {\n          throw new Error(\"Failed to create a new worldview.\");\n        }\n      }\n      const choiceKey = choice.split('.')[0];\n      const selectedProfession = professions[choiceKey];\n      if (selectedProfession) {\n        await setDoc(getPrivatePlayerStateRef(db, appId, userId), { ...getDefaultPrivatePlayerState(), characterCreated: true, profession: selectedProfession.name, initialMotivation: selectedProfession.motivation, currentLocation: '방랑자의 안식처' }, { merge: true });\n        await addDoc(getPersonalStoryLogRef(db, appId, userId), { action: '여정에 나서다', story: `나는 '${selectedProfession.name}'으로서, '${selectedProfession.motivation}'라는 동기를 품고 이 세상에 첫 발을 내디뎠다.`, timestamp: serverTimestamp(), });\n        const mainScenarioRef = getMainScenarioRef(db, appId);\n        await runTransaction(db, async (transaction) => {\n          const scenarioDoc = await transaction.get(mainScenarioRef);\n          const baseData = scenarioDoc.exists() ? scenarioDoc.data() : getDefaultGameState();\n          const cleanedPublicLog = (baseData.publicLog || []).map((log) => ({ ...log, timestamp: log.timestamp?.toDate ? log.timestamp.toDate() : new Date() }));\n          const newPublicLogEntry = { actor: { id: userId, displayName: getDisplayName(userId) }, log: `새로운 모험가, '${getDisplayName(userId)}'님이 여관에 모습을 드러냈습니다.`, timestamp: new Date() };\n          const updatedPublicLog = [...cleanedPublicLog, newPublicLogEntry];\n          const payload = { ...baseData, publicLog: updatedPublicLog, lastUpdate: serverTimestamp() };\n          transaction.set(mainScenarioRef, payload);\n        });\n        const startingChoices = ['여관을 둘러본다.', '다른 모험가에게 말을 건다.', '여관 주인에게 정보를 묻는다.'];\n        setDisplayedChoices(startingChoices);\n        const updatedDoc = await getDoc(mainScenarioRef);\n        if (updatedDoc.exists()) {\n          setChoicesTimestamp(updatedDoc.data().lastUpdate);\n        }\n      }\n    } catch (e) {\n      console.error('등장 이벤트 추가 실패: ', e);\n      setLlmError('게임 세계에 합류하는 중 오류가 발생했습니다. 문제가 지속되면 \\'전체 데이터 초기화\\'를 시도해 주세요.');\n    } finally {\n      setIsTextLoading(false);\n    }\n  }, [db, worldview, callGeminiTextLLM, worldCreationPrompt, userId, getDisplayName]);\n\n  const handleChoiceClick = useCallback(async (choice) => {\n    if (isTextLoading) return;\n    if (!privatePlayerState.characterCreated) {\n      await createCharacter(choice);\n    } else {\n      await performPlayerAction(choice);\n    }\n  }, [isTextLoading, privatePlayerState.characterCreated, createCharacter, performPlayerAction]);\n\n  const sendChatMessage = async () => {\n    if (!db || !userId || !isAuthReady || !currentChatMessage.trim()) return;\n    const messageText = currentChatMessage.trim();\n    setCurrentChatMessage('');\n    const chatCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'chatMessages');\n    if (messageText.startsWith('!')) {\n      const actionText = messageText.substring(1).trim();\n      if (actionText) {\n        await addDoc(chatCollectionRef, { userId, displayName: getDisplayName(userId), message: `*${actionText} (선언)*`, isAction: true, timestamp: serverTimestamp() });\n        await handleDeclarativeAction(actionText);\n      }\n    } else {\n      await addDoc(chatCollectionRef, { userId, displayName: getDisplayName(userId), message: messageText, isAction: false, timestamp: serverTimestamp() });\n    }\n  };\n  \n  const toggleAccordion = (key) => {\n    setAccordion((prev) => ({ ...prev, [key]: !prev[key] }));\n  };\n\n  const toggleActiveMemory = async (clue, activate) => {\n    if (!db || !userId) return;\n    const privateStateRef = getPrivatePlayerStateRef(db, appId, userId);\n    let currentMemories = privatePlayerState.activeMemories || [];\n    if (activate) {\n      if (!currentMemories.includes(clue)) {\n        currentMemories = [...currentMemories, clue];\n      }\n    } else {\n      currentMemories = currentMemories.filter((memory) => memory !== clue);\n    }\n    await setDoc(privateStateRef, { activeMemories: currentMemories }, { merge: true });\n  };\n  \n  const summarizeAndArchiveEvents = async () => {\n    alert(\"시대 요약 기능은 다음 업데이트에서 구현될 예정입니다. 이 버튼을 누르면, '세계의 연대기'에 기록된 주요 사건들이 하나의 '역사 요약문'으로 압축되어, 게임의 장기적인 맥락을 유지하면서도 데이터 부담을 줄이게 됩니다.\");\n  };\n\n  // --- Render logic ---\n\n  if (showNicknameModal) {\n    return (\n      <div className=\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\">\n        <div className=\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4\">\n          <h3 className=\"text-xl font-bold text-gray-100\">닉네임을 입력하세요</h3>\n          <input className=\"w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg\" placeholder=\"닉네임\" value={nicknameInput} onChange={e => setNicknameInput(e.target.value)} onKeyDown={e => { if (e.key === 'Enter') handleNicknameSubmit(); }} autoFocus />\n          <button className=\"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md transition duration-300 disabled:opacity-50\" onClick={handleNicknameSubmit} disabled={!nicknameInput.trim()}>시작하기</button>\n        </div>\n      </div>\n    );\n  }\n\n  if (isLoading || (privatePlayerState.characterCreated && !worldview)) {\n    return (\n      <div className=\"min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-16 w-16 border-b-2 border-gray-300\"></div>\n        <span className=\"ml-4 text-xl\">{isLoading ? '데이터를 불러오는 중...' : '세계를 구축하는 중...'}</span>\n      </div>\n    );\n  }\n  \n  const handleRetry = async () => {\n    if (llmRetryPrompt?.playerChoice) {\n      setLlmError(null);\n      if (llmRetryPrompt.isDeclarative) {\n        await handleDeclarativeAction(llmRetryPrompt.playerChoice);\n      } else {\n        await handleChoiceClick(llmRetryPrompt.playerChoice);\n      }\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center justify-center p-4 font-sans\">\n      {llmError && <LlmErrorModal \n        llmError={llmError}\n        llmRetryPrompt={llmRetryPrompt}\n        setLlmError={setLlmError}\n        setLlmRetryPrompt={setLlmRetryPrompt}\n        onRetry={handleRetry} \n      />}\n      {showResetModal && (<div className=\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\"><div className=\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4\"><h3 className=\"text-xl font-bold text-red-400\">⚠️ 모든 데이터를 초기화할까요?</h3><p className=\"text-gray-200\">이 작업은 되돌릴 수 없습니다. 모든 시나리오, 로그, 유저, 채팅 데이터가 삭제됩니다.</p><div className=\"flex justify-end gap-3\"><button className=\"px-4 py-2 bg-gray-600 hover:bg-gray-700 font-bold rounded-md\" onClick={() => setShowResetModal(false)} disabled={isResetting}>취소</button><button className=\"px-4 py-2 bg-red-600 hover:bg-red-700 font-bold rounded-md\" onClick={resetAllGameData} disabled={isResetting}>{isResetting ? '초기화 중...' : '초기화'}</button></div></div></div>)}\n      \n      <div className=\"w-full max-w-5xl bg-gray-800 rounded-lg shadow-xl p-6 md:p-8 flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6\">\n        <div className=\"flex flex-col w-full lg:w-2/3 space-y-6\">\n          <RenderGameLog\n              accordion={accordion}\n              toggleAccordion={toggleAccordion}\n              summarizeAndArchiveEvents={summarizeAndArchiveEvents}\n              setShowResetModal={setShowResetModal}\n              personalStoryLog={personalStoryLog}\n              privatePlayerState={privatePlayerState}\n              isTextLoading={isTextLoading}\n              actionLocks={actionLocks}\n              userId={userId}\n              getDisplayName={getDisplayName}\n              logEndRef={logEndRef}\n          />\n          <RenderChoices\n              privatePlayerState={privatePlayerState}\n              displayedChoices={displayedChoices}\n              handleChoiceClick={handleChoiceClick}\n              isTextLoading={isTextLoading}\n              actionLocks={actionLocks}\n              getActionScope={getActionScope}\n              userId={userId}\n              getDisplayName={getDisplayName}\n          />\n        </div>\n        <RenderSidebar\n            worldview={worldview}\n            activeTurningPoint={activeTurningPoint}\n            accordion={accordion}\n            toggleAccordion={toggleAccordion}\n            privatePlayerState={privatePlayerState}\n            getDisplayName={getDisplayName}\n            userId={userId}\n            toggleActiveMemory={toggleActiveMemory}\n            knownMajorEvents={knownMajorEvents}\n            activeUsers={activeUsers}\n            combinedFeed={combinedFeed}\n            chatEndRef={chatEndRef}\n            currentChatMessage={currentChatMessage}\n            setCurrentChatMessage={setCurrentChatMessage}\n            sendChatMessage={sendChatMessage}\n            isAuthReady={isAuthReady}\n        />\n      </div>\n      <style>{`\n        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');\n        body { font-family: 'Noto Sans KR', sans-serif; }\n        .custom-scrollbar::-webkit-scrollbar { width: 8px; }\n        .custom-scrollbar::-webkit-scrollbar-track { background: #4a5568; border-radius: 10px; }\n        .custom-scrollbar::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 10px; }\n        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }\n      `}</style>\n    </div>\n  );\n}\n\nexport default App;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}