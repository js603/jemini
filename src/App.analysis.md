# App.jsx 코드 분석

이 문서는 `src/App.jsx`의 전체 구조와 주요 기능, 멀티플레이어, 채팅, 스토리텔링, 파이어베이스 연동 등 핵심 로직을 한국어로 분석한 문서입니다.

---

## 1. 전체 구조
- **React 함수형 컴포넌트**로 작성됨
- **파이어베이스(Firebase)**를 통한 인증, 실시간 데이터베이스, Firestore, 채팅, 멀티플레이어 기능 구현
- **Gemini LLM API**를 활용한 스토리 생성(텍스트 어드벤처)
- **Tailwind CSS** 기반의 UI 스타일링

---

## 2. 주요 상태(State) 및 변수
- `gameLog`: 개인 게임 로그(텍스트 어드벤처 진행 내역)
- `isTextLoading`: LLM 응답 대기 상태
- `gamePhase`: 'characterSelection'(직업 선택) 또는 'playing'(게임 진행)
- `playerCharacter`: 플레이어 캐릭터 정보(직업, 능력치, 인벤토리, 동기, 위치, 평판, 퀘스트, 동료)
- `currentChoices`: 현재 선택지(버튼)
- `sharedGameLog`: 모든 플레이어의 공유 로그(멀티플레이어)
- `activeUsers`: 현재 접속 중인 플레이어 목록
- `chatMessages`: 공개 채팅 메시지 목록
- `privateChatMessages`: 개인 채팅 메시지 목록
- `isCompanionActionInProgress`, `actingPlayer`: 동료/플레이어의 턴 진행 상태
- `db`, `auth`, `userId`, `isAuthReady`: 파이어베이스 인증 및 DB 연결 상태

---

## 3. 파이어베이스 연동
- **초기화**: `initializeApp`, `getFirestore`, `getAuth`로 파이어베이스 앱/DB/인증 객체 생성
- **익명 로그인**: `signInAnonymously`로 자동 로그인, 인증 상태 변화 감지(`onAuthStateChanged`)
- **실시간 데이터 리스너**:
  - 공유 로그(`sharedGameLog`), 활동 유저(`activeUsers`), 공개 채팅(`chatMessages`), 게임 상태(`gameStatus`), 개인 채팅(`privateChats`), 알림(`incomingMessages`) 등 Firestore 컬렉션/도큐먼트에 실시간 리스너(`onSnapshot`) 등록
- **유저 프레즌스 관리**: 30초마다 자신의 활동 상태(`lastActive`) 갱신, 1분 이상 비활동 유저는 클린업
- **게임 저장/불러오기**: 개인 경로(`/artifacts/{appId}/users/{userId}/textAdventureGame/gameState`)에 저장/로드
- **피드백 전송**: `/feedback` 컬렉션에 최근 로그와 캐릭터 스냅샷과 함께 저장

---

## 4. 멀티플레이어 및 채팅 시스템
- **공유 로그**: 모든 플레이어의 주요 선택/이벤트가 Firestore에 기록되어 실시간으로 동기화됨
- **활동 유저 목록**: 최근 1분 내 활동한 유저만 표시, 동료 여부도 표시
- **공개 채팅**: Firestore 컬렉션에 메시지 저장 및 실시간 표시
- **개인 채팅**: 두 유저의 ID로 채팅방 ID 생성, Firestore에 메시지 저장/수신, 알림(`incomingMessages`)으로 새 메시지 감지 및 모달 자동 오픈
- **채팅 종료**: 상대방이 채팅 종료 시 실시간으로 모달 닫힘 및 안내 메시지 출력

---

## 5. 스토리텔링 및 LLM 연동
- **시스템 프롬프트**: 중세 판타지 멀티플레이어 텍스트 어드벤처의 마스터 역할을 LLM에게 부여, JSON 스키마로 응답 강제
- **Gemini API 호출**: 현재 상태, 캐릭터 정보, 최근 로그, 선택지, 멀티플레이어 정보, 최근 개인 대화 내역 등 포함하여 프롬프트 구성 후 LLM 호출
- **응답 처리**: LLM의 JSON 응답에서 스토리, 선택지, 능력치/인벤토리/퀘스트/동료/위치/평판 등 상태 업데이트
- **선택지 클릭**: 선택지 클릭 시 LLM 호출, 결과 반영, 공유 로그 기록, 동료 시스템(턴제) 동작
- **개인 대화 종료 시**: 대화 내용을 LLM에 반영하여 시나리오 진행

---

## 6. UI/UX
- **메인 게임 영역**: 게임 로그, 캐릭터 정보, 선택지 버튼, 저장/불러오기/피드백 버튼
- **사이드바**: 활동 유저, 공유 로그, 공개 채팅
- **모달**: 피드백, 개인 채팅(실시간 메시지, 대화 종료 및 시나리오 반영)
- **로딩/턴제 안내**: LLM 응답 대기, 동료 턴 안내 등 시각적 피드백

---

## 7. 기타 특징
- **능력치/인벤토리/퀘스트/동료/평판** 등은 LLM이 JSON으로 관리, 클라이언트는 이를 반영
- **멀티플레이어**: 모든 플레이어의 선택이 공유 시나리오에 영향을 미침
- **동료 시스템**: 동료가 있으면 턴제 진행, 현재 턴 안내
- **클린 코드**: useEffect, useState, useRef 등 React 훅 적극 활용, Firestore 경로 일관성 유지

---

## 8. 결론
이 코드는 파이어베이스와 LLM(Gemini)을 결합하여 실시간 멀티플레이어 텍스트 어드벤처 게임을 구현한 예시로, 실시간 데이터 동기화, 멀티유저 채팅, LLM 기반 스토리텔링, 동료/턴제 시스템 등 다양한 최신 웹 기술이 통합되어 있습니다. 