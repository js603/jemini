{"ast":null,"code":"import React,{useState,useEffect,useRef}from'react';import{initializeApp}from'firebase/app';import{getAuth,signInAnonymously,signInWithCustomToken,onAuthStateChanged}from'firebase/auth';import{getFirestore,doc,setDoc,getDoc,collection,query,onSnapshot,serverTimestamp,addDoc,getDocs,deleteDoc,runTransaction}from'firebase/firestore';// ====================================================================\n// Firebase configuration information - 수정 금지\nimport{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const defaultFirebaseConfig={apiKey:\"AIzaSyBNJtmpRWzjobrY556bnHkwbZmpFJqgPX8\",authDomain:\"text-adventure-game-cb731.firebaseapp.com\",projectId:\"text-adventure-game-cb731\",storageBucket:\"text-adventure-game-cb731.appspot.com\",messagingSenderId:\"1092941614820\",appId:\"1:1092941614820:web:5545f36014b73c268026f1\",measurementId:\"G-FNGF42T1FP\"};// 수정금지\nconst firebaseConfig=defaultFirebaseConfig;const appId=firebaseConfig.projectId;const initialAuthToken=null;// ====================================================================\nconst professions={'1':{name:'몰락한 귀족/기사',motivation:'가문의 몰락 원인을 조사하고, 잃어버린 가문의 보물을 찾아야 합니다.'},'2':{name:'평범한 마을 사람/농부',motivation:'갑자기 마을에 나타난 괴생명체로부터 마을을 지켜야 합니다.'},'3':{name:'젊은 마법사/견습생',motivation:'스승님의 실종에 대한 단서를 찾아야 합니다.'},'4':{name:'용병/모험가',motivation:'의뢰받은 임무를 수행하던 중 예상치 못한 사건에 휘말렸습니다.'},'5':{name:'도적/암살자',motivation:'길드에서 내려온 첫 번째 임무를 완수하고, 그 과정에서 수상한 음모를 감지해야 합니다.'},'6':{name:'왕족/공주/왕자',motivation:'왕실 내의 불화와 암투 속에서 자신의 입지를 다져야 합니다.'}};// Firestore 경로 유틸\nconst getMainScenarioRef=(db,appId)=>doc(db,'artifacts',appId,'public','data','mainScenario','main');const getPrivatePlayerStateRef=(db,appId,userId)=>doc(db,'artifacts',appId,'users',userId,'playerState','state');const getGameStatusRef=(db,appId)=>doc(db,'artifacts',appId,'public','data','gameStatus','status');const getMajorEventsRef=(db,appId)=>collection(db,'artifacts',appId,'public','data','majorEvents');// 상태 초기화 유틸\nconst getDefaultGameState=()=>({phase:'playing',log:[],choices:[],player:{currentLocation:'방랑자의 안식처'},subtleClues:[]});const getDefaultPrivatePlayerState=()=>({stats:{strength:10,intelligence:10,agility:10,charisma:10},inventory:[],initialMotivation:'',reputation:{},activeQuests:[],companions:[],knownClues:[],characterCreated:false,profession:'',choices:[],groups:[],npcRelations:{},knownEventIds:[]});function App(){const[gameState,setGameState]=useState(getDefaultGameState());const[privatePlayerState,setPrivatePlayerState]=useState(getDefaultPrivatePlayerState());const[isTextLoading,setIsTextLoading]=useState(false);const[activeUsers,setActiveUsers]=useState([]);const[chatMessages,setChatMessages]=useState([]);const[currentChatMessage,setCurrentChatMessage]=useState('');const[actionLocks,setActionLocks]=useState({});const[db,setDb]=useState(null);const[auth,setAuth]=useState(null);const[userId,setUserId]=useState(null);const[isAuthReady,setIsAuthReady]=useState(false);const logEndRef=useRef(null);const chatEndRef=useRef(null);const[nickname,setNickname]=useState(()=>localStorage.getItem('nickname')||'');const[showNicknameModal,setShowNicknameModal]=useState(!localStorage.getItem('nickname'));const[nicknameInput,setNicknameInput]=useState('');const[accordion,setAccordion]=useState({gameLog:true,chat:true,users:true,playerInfo:true,chronicle:true});const[showResetModal,setShowResetModal]=useState(false);const[isResetting,setIsResetting]=useState(false);const[llmError,setLlmError]=useState(null);const[llmRetryPrompt,setLlmRetryPrompt]=useState(null);const[isLoading,setIsLoading]=useState(true);const[allMajorEvents,setAllMajorEvents]=useState([]);const[knownMajorEvents,setKnownMajorEvents]=useState([]);const handleNicknameSubmit=()=>{if(nicknameInput.trim()){const finalNickname=nicknameInput.trim();setNickname(finalNickname);localStorage.setItem('nickname',finalNickname);setShowNicknameModal(false);if(userId&&db){const userDocRef=doc(db,'artifacts',appId,'public','data','activeUsers',userId);setDoc(userDocRef,{nickname:finalNickname},{merge:true});}}};const getDisplayName=uid=>{const safeUid=String(uid||'');if(uid===userId){const safeUserId=String(userId||'');return nickname||`플레이어 ${safeUserId.substring(0,4)}`;}const user=activeUsers.find(u=>u.id===uid);return(user===null||user===void 0?void 0:user.nickname)||`플레이어 ${safeUid.substring(0,4)}`;};const resetAllGameData=async()=>{if(!db||!isAuthReady)return;setIsResetting(true);try{const collectionsToDelete=[collection(db,'artifacts',appId,'public','data','chatMessages'),collection(db,'artifacts',appId,'public','data','activeUsers'),getMajorEventsRef(db,appId)];for(const colRef of collectionsToDelete){const snapshot=await getDocs(colRef);for(const docSnap of snapshot.docs){await deleteDoc(docSnap.ref);}}const usersColRef=collection(db,'artifacts',appId,'users');const usersSnapshot=await getDocs(usersColRef);for(const userDoc of usersSnapshot.docs){const playerStateColRef=collection(db,'artifacts',appId,'users',userDoc.id,'playerState');const playerStateSnapshot=await getDocs(playerStateColRef);for(const stateDoc of playerStateSnapshot.docs){await deleteDoc(stateDoc.ref);}await deleteDoc(doc(db,'artifacts',appId,'users',userDoc.id));}await deleteDoc(getMainScenarioRef(db,appId));await deleteDoc(getGameStatusRef(db,appId));localStorage.clear();setGameState(getDefaultGameState());setPrivatePlayerState(getDefaultPrivatePlayerState());setChatMessages([]);setActionLocks({});console.log(\"모든 서버 및 클라이언트 데이터가 성공적으로 초기화되었습니다.\");}catch(e){console.error(\"전체 데이터 초기화 중 오류 발생:\",e);}finally{setIsResetting(false);setShowResetModal(false);window.location.reload();}};useEffect(()=>{try{const app=initializeApp(firebaseConfig);const firestoreDb=getFirestore(app);const firebaseAuth=getAuth(app);setDb(firestoreDb);setAuth(firebaseAuth);const unsubscribeAuth=onAuthStateChanged(firebaseAuth,async user=>{if(user){setUserId(user.uid);setIsAuthReady(true);}else{await(initialAuthToken?signInWithCustomToken(firebaseAuth,initialAuthToken):signInAnonymously(firebaseAuth));}});return()=>unsubscribeAuth();}catch(error){console.error(\"Firebase initialization error:\",error);setLlmError(\"Firebase 초기화에 실패했습니다.\");}},[]);useEffect(()=>{if(!isAuthReady||!db||!userId)return;const privateStateRef=getPrivatePlayerStateRef(db,appId,userId);getDoc(privateStateRef).then(docSnap=>{if(!docSnap.exists()){setDoc(privateStateRef,getDefaultPrivatePlayerState());}});const unsubscribe=onSnapshot(privateStateRef,snapshot=>{if(snapshot.exists()){setPrivatePlayerState({...getDefaultPrivatePlayerState(),...snapshot.data()});}if(isLoading)setIsLoading(false);},err=>{console.error(\"Private state listener error:\",err);setLlmError(\"개인 정보를 불러오는 중 오류가 발생했습니다.\");setIsLoading(false);});return()=>unsubscribe();},[isAuthReady,db,userId]);useEffect(()=>{if(!isAuthReady||!db)return;const unsubscribes=[onSnapshot(getMainScenarioRef(db,appId),snap=>{if(snap.exists()){const data=snap.data();setGameState(prev=>{var _data$player;return{...prev,log:data.storyLog||[],choices:data.choices||[],player:{...prev.player,currentLocation:((_data$player=data.player)===null||_data$player===void 0?void 0:_data$player.currentLocation)||prev.player.currentLocation},subtleClues:data.subtleClues||[]};});}}),onSnapshot(getGameStatusRef(db,appId),docSnap=>{var _docSnap$data;setActionLocks(((_docSnap$data=docSnap.data())===null||_docSnap$data===void 0?void 0:_docSnap$data.actionLocks)||{});}),onSnapshot(query(collection(db,'artifacts',appId,'public','data','chatMessages')),snapshot=>{const messages=snapshot.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>{var _a$timestamp,_b$timestamp;return(((_a$timestamp=a.timestamp)===null||_a$timestamp===void 0?void 0:_a$timestamp.toMillis())||0)-(((_b$timestamp=b.timestamp)===null||_b$timestamp===void 0?void 0:_b$timestamp.toMillis())||0);});setChatMessages(messages);}),onSnapshot(query(collection(db,'artifacts',appId,'public','data','activeUsers')),snapshot=>{const cutoffTime=Date.now()-60*1000;const users=snapshot.docs.map(d=>({id:d.id,...d.data()})).filter(u=>u.lastActive&&u.lastActive.toMillis()>cutoffTime);setActiveUsers(users);}),onSnapshot(query(getMajorEventsRef(db,appId)),snapshot=>{const events=snapshot.docs.map(doc=>({id:doc.id,...doc.data()})).sort((a,b)=>{var _a$timestamp2,_b$timestamp2;return(((_a$timestamp2=a.timestamp)===null||_a$timestamp2===void 0?void 0:_a$timestamp2.toMillis())||0)-(((_b$timestamp2=b.timestamp)===null||_b$timestamp2===void 0?void 0:_b$timestamp2.toMillis())||0);});setAllMajorEvents(events);})];return()=>unsubscribes.forEach(unsub=>unsub());},[isAuthReady,db]);useEffect(()=>{if(!db||!userId||allMajorEvents.length===0)return;const currentKnownIds=privatePlayerState.knownEventIds||[];const newDiscoveredEvents=[];allMajorEvents.forEach(event=>{if((event===null||event===void 0?void 0:event.location)===gameState.player.currentLocation&&!currentKnownIds.includes(event.id)){newDiscoveredEvents.push(event.id);}});if(newDiscoveredEvents.length>0){const privateStateRef=getPrivatePlayerStateRef(db,appId,userId);const updatedKnownEventIds=[...currentKnownIds,...newDiscoveredEvents];setDoc(privateStateRef,{knownEventIds:updatedKnownEventIds},{merge:true});}const knownEvents=allMajorEvents.filter(event=>(privatePlayerState.knownEventIds||[]).includes(event===null||event===void 0?void 0:event.id));setKnownMajorEvents(knownEvents);},[gameState.player.currentLocation,allMajorEvents,privatePlayerState.knownEventIds,db,userId]);useEffect(()=>{if(!db||!userId||!nickname)return;const userDocRef=doc(db,'artifacts',appId,'public','data','activeUsers',userId);setDoc(userDocRef,{lastActive:serverTimestamp(),nickname:nickname||`플레이어 ${userId.substring(0,4)}`,profession:privatePlayerState.profession},{merge:true});const handleVisibilityChange=()=>{if(document.visibilityState==='visible'){setDoc(userDocRef,{lastActive:serverTimestamp()},{merge:true});}};document.addEventListener('visibilitychange',handleVisibilityChange);return()=>document.removeEventListener('visibilitychange',handleVisibilityChange);},[db,userId,nickname,privatePlayerState.profession]);useEffect(()=>{if(accordion.gameLog&&logEndRef.current)logEndRef.current.scrollIntoView({behavior:\"smooth\"});},[gameState.log,accordion.gameLog]);useEffect(()=>{if(accordion.chat&&chatEndRef.current)chatEndRef.current.scrollIntoView({behavior:\"smooth\"});},[chatMessages,accordion.chat]);const systemPrompt=`\n    ### 페르소나 (Persona)\n    당신은 이 세계의 '수호자'이자 '사관(史官)'이며, 플레이어들에게는 '게임 마스터(GM)'로 알려져 있습니다. 당신의 임무는 단순한 이야기 생성을 넘어, 일관된 역사와 살아 숨 쉬는 세계관을 구축하는 것입니다. 모든 묘사와 사건은 이 세계의 정해진 분위기와 역사적 사실 위에서 피어나는 한 편의 서사시여야 합니다.\n\n    ### 세계관 설정: 페이디드 판타지 (Faded Fantasy)\n    이 세계는 오래되었고, 과거의 영광은 빛이 바랬습니다. 위대한 왕국들은 쇠락의 길을 걷고 있으며, 잊혀진 유적에는 강력하지만 위험한 마법의 흔적이 남아있습니다. 도시는 화려함 뒤에 부패를 숨기고 있고, 황야에는 미지의 위험이 도사립니다. 사람들은 서로를 쉽게 믿지 않으며, 각자의 생존을 위해 발버둥 칩니다. 당신의 모든 묘사는 이 '아름답지만 슬픈' 분위기를 반영해야 합니다.\n\n    ### 핵심 구동 원칙\n    1.  **일관성의 원칙 (Canon) (가장 중요)**: User Prompt에 제공된 [세계의 연대기], [주요 세력 및 인물], [플레이어 정보]는 이 세계의 '정사(正史)'입니다. 당신은 절대 이 사실들을 왜곡하거나 모순되는 내용을 만들어서는 안 됩니다. 이 정보들을 바탕으로 세계를 확장해 나가십시오.\n\n    2.  **상호연결성의 원칙 (Interconnection)**: 당신은 뛰어난 이야기꾼으로서, 현재 발생하는 사건을 과거의 역사나 다른 플레이어의 행적과 연결지어야 합니다. 예를 들어, 한 플레이어가 던전에서 발견한 고대 문양은, 다른 플레이어가 수도에서 쫓고 있는 비밀 결사의 상징일 수 있습니다. 세상이 서로 연결되어 있음을 플레이어가 느끼게 하십시오.\n\n    3.  **장면 중심의 서사 원칙 (Scene-Centric)**: 플레이어의 '[선택]'은 하나의 '장면'을 시작하는 것과 같습니다. 당신의 \"story\"는 반드시 그 선택의 즉각적인 결과와 묘사로 시작되어야 합니다. 대화라면 실제 대화 내용이, 행동이라면 그 행동의 과정과 결과가 구체적으로 서술되어야 합니다.\n\n    4.  **'보여주기, 말하지 않기' 원칙 (Show, Don't Tell)**: \"마을이 가난하다\"고 설명하지 마십시오. 대신 \"굶주린 아이들이 흙바닥에 주저앉아 있고, 대부분의 건물은 지붕이 허술하게 덧대어져 있다\"고 묘사하십시오. 플레이어가 스스로 분위기와 상황을 파악하게 만드십시오.\n\n    ### JSON 출력 구조\n    {\n      \"story\": \"상기된 모든 원칙에 따라, 플레이어의 선택으로 시작된 '장면'에 대한 구체적이고 즉각적인 묘사.\",\n      \"groupStory\": \"행동 주체와 같은 그룹 소속원들만 볼 수 있는 비밀스러운 이야기. 해당사항 없으면 null.\",\n      \"choices\": [\"묘사된 '장면'의 결과에 따라 플레이어가 할 수 있는 논리적인 다음 행동들.\"],\n      \"privateChoices\": [\"오직 행동 주체의 특성 때문에 가능한 특별한 행동들.\"],\n      \"groupChoices\": [\"같은 그룹 소속원들만 할 수 있는 비밀 행동들.\"],\n      \"majorEvent\": {\n        \"summary\": \"만약 이 사건이 후대에 '역사'로 기록될 만한 중대한 전환점이라면, 사관의 어조로 요약. (예: '왕국력 342년, 방랑자의 안식처에서 발생한 이 사건은 훗날 '붉은 달 교단'의 부흥을 알리는 서막이 되었다.') 그렇지 않으면 null.\",\n        \"location\": \"사건이 발생한 장소 이름. majorEvent가 있을 경우 필수.\"\n      },\n      \"sharedStateUpdates\": {\n        \"location\": \"플레이어 그룹의 현재 위치. 변경되었을 경우에만 포함.\",\n        \"subtleClues\": [{\"location\": \"장소명\", \"clue\": \"새롭게 생성된 단서\"}]\n      },\n      \"privateStateUpdates\": {\n        \"inventory\": [\"업데이트된 전체 인벤토리 목록\"],\n        \"stats\": {\"strength\": 12, \"intelligence\": 10, \"agility\": 10, \"charisma\": 10 },\n        \"activeQuests\": [\"업데이트된 개인 퀘스트 목록\"],\n        \"knownClues\": [\"새롭게 알게 된 단서 목록\"],\n        \"groups\": [\"업데이트된 소속 그룹 목록\"],\n        \"npcRelations\": {\"가라크\": 55, \"엘라라\": -10}\n      }\n    }\n  `;const buildLlmPrompt=choice=>{var _privatePlayerState$p,_gameState$player$cur;const factions=(privatePlayerState.groups||[]).join(', ')||'없음';const npcs=Object.entries(privatePlayerState.npcRelations||{}).map(_ref=>{let[name,value]=_ref;return`${name} (관계도: ${value})`;}).join(', ')||'없음';const recentHistory=(gameState.log||[]).slice(-10).map(event=>{var _event$actor$displayN,_event$actor,_event$action,_event$publicStory;return`[${(_event$actor$displayN=event===null||event===void 0?void 0:(_event$actor=event.actor)===null||_event$actor===void 0?void 0:_event$actor.displayName)!==null&&_event$actor$displayN!==void 0?_event$actor$displayN:'누군가'}]가 ${(_event$action=event===null||event===void 0?void 0:event.action)!==null&&_event$action!==void 0?_event$action:'알 수 없는 행동'}을(를) 통해 다음을 겪음: ${(_event$publicStory=event===null||event===void 0?void 0:event.publicStory)!==null&&_event$publicStory!==void 0?_event$publicStory:''}`;}).join('\\n');const userPrompt=`\n[세계의 연대기 (Chronicle of the World)]\n- 이 세계에서 지금까지 벌어진 주요 역사적 사건들입니다. 이 기록은 절대적인 사실입니다.\n- ${knownMajorEvents.length>0?knownMajorEvents.map(h=>h.summary).join('\\n- '):\"아직 기록된 역사가 없음\"}\n\n[주요 세력 및 인물 (Key Factions & NPCs)]\n- 플레이어와 관련된 주요 세력: ${factions}\n- 플레이어와 관계를 맺은 주요 인물: ${npcs}\n\n[플레이어의 현재 상태 및 위치 (Player's Current State & Location)]\n- 이름: ${getDisplayName(userId)}\n- 직업: ${(_privatePlayerState$p=privatePlayerState.profession)!==null&&_privatePlayerState$p!==void 0?_privatePlayerState$p:'미정'}\n- 현재 위치: ${(_gameState$player$cur=gameState.player.currentLocation)!==null&&_gameState$player$cur!==void 0?_gameState$player$cur:'알 수 없는 곳'}\n- 소지품 및 능력치: ${JSON.stringify({inventory:privatePlayerState.inventory||[],stats:privatePlayerState.stats||{}})}\n\n[플레이어의 최근 경험 (Player's Recent Experiences)]\n- 플레이어가 최근 겪은 사건들의 기록입니다.\n${recentHistory}\n\n[주변 관찰자 (Nearby Observers)]\n- 현재 장소에 함께 있는 다른 플레이어들입니다. 이들은 이번 턴에 행동하지 않습니다.\n- ${(activeUsers||[]).map(u=>u.nickname||`플레이어 ${u.id.substring(0,4)}`).join(', ')||\"주변에 다른 플레이어가 없음\"}\n\n[플레이어의 선택 (Player's Action)]\n- 위 모든 상황 속에서, 플레이어는 다음 행동을 선택했습니다. 이 선택으로 시작될 '장면'을 연출해주십시오.\n- \"${choice}\"\n`;return userPrompt;};const callGeminiTextLLM=async userPrompt=>{setIsTextLoading(true);const mainApiKey=\"AIzaSyDC11rqjU30OJnLjaBFOaazZV0klM5raU8\";const backupApiKey=\"AIzaSyAhscNjW8GmwKPuKzQ47blCY_bDanR-B84\";const getApiUrl=apiKey=>`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;const payload={contents:[{role:\"user\",parts:[{text:systemPrompt}]},{role:\"model\",parts:[{text:\"{}\"}]},{role:\"user\",parts:[{text:userPrompt}]}]};const tryGeminiCall=async apiKey=>fetch(getApiUrl(apiKey),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});try{var _result$candidates,_result$candidates$,_result$candidates$$c,_result$candidates$$c2,_result$candidates$$c3;let response=await tryGeminiCall(mainApiKey);if(!response.ok){response=await tryGeminiCall(backupApiKey);}if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}const result=await response.json();const llmOutputText=(_result$candidates=result.candidates)===null||_result$candidates===void 0?void 0:(_result$candidates$=_result$candidates[0])===null||_result$candidates$===void 0?void 0:(_result$candidates$$c=_result$candidates$.content)===null||_result$candidates$$c===void 0?void 0:(_result$candidates$$c2=_result$candidates$$c.parts)===null||_result$candidates$$c2===void 0?void 0:(_result$candidates$$c3=_result$candidates$$c2[0])===null||_result$candidates$$c3===void 0?void 0:_result$candidates$$c3.text;const jsonMatch=llmOutputText===null||llmOutputText===void 0?void 0:llmOutputText.match(/\\{[\\s\\S]*\\}/);if(jsonMatch)return JSON.parse(jsonMatch[0]);throw new Error(\"Valid JSON object not found in LLM response.\");}catch(error){console.error(\"LLM API call error:\",error);setLlmError(error.message||'LLM 호출 실패');return null;}finally{setIsTextLoading(false);}};const sendChatMessage=async()=>{if(!db||!userId||!isAuthReady||!currentChatMessage.trim())return;try{const chatCollectionRef=collection(db,'artifacts',appId,'public','data','chatMessages');await addDoc(chatCollectionRef,{userId,displayName:getDisplayName(userId),message:currentChatMessage,timestamp:serverTimestamp()});setCurrentChatMessage('');}catch(error){console.error(\"Error sending chat message:\",error);}};const updatePublicState=async(llmResponse,playerChoice)=>{const mainScenarioRef=getMainScenarioRef(db,appId);if(llmResponse.majorEvent&&llmResponse.majorEvent.summary&&llmResponse.majorEvent.location){const majorEventsRef=collection(db,'artifacts',appId,'public','data','majorEvents');await addDoc(majorEventsRef,{...llmResponse.majorEvent,timestamp:serverTimestamp(),actor:{id:userId,displayName:getDisplayName(userId)}});}const newEvent={actor:{id:userId,displayName:getDisplayName(userId)},action:playerChoice,publicStory:llmResponse.story||\"특별한 일은 일어나지 않았다.\",groupStory:llmResponse.groupStory||null,timestamp:new Date()};await runTransaction(db,async transaction=>{var _llmResponse$sharedSt,_llmResponse$sharedSt2;const scenarioDoc=await transaction.get(mainScenarioRef);const currentData=scenarioDoc.exists()?scenarioDoc.data():getDefaultGameState();const newStoryLog=[...(currentData.storyLog||[]),newEvent];const updateData={storyLog:newStoryLog,lastUpdate:serverTimestamp()};if(llmResponse.choices&&llmResponse.choices.length>0){updateData.choices=llmResponse.choices;}if((_llmResponse$sharedSt=llmResponse.sharedStateUpdates)!==null&&_llmResponse$sharedSt!==void 0&&_llmResponse$sharedSt.location){updateData['player.currentLocation']=llmResponse.sharedStateUpdates.location;}if((_llmResponse$sharedSt2=llmResponse.sharedStateUpdates)!==null&&_llmResponse$sharedSt2!==void 0&&_llmResponse$sharedSt2.subtleClues){updateData.subtleClues=llmResponse.sharedStateUpdates.subtleClues;}if(scenarioDoc.exists()){transaction.update(mainScenarioRef,updateData);}else{transaction.set(mainScenarioRef,{...currentData,...updateData});}});};const updatePrivateState=async llmResponse=>{const privateStateRef=getPrivatePlayerStateRef(db,appId,userId);const updates=llmResponse.privateStateUpdates?{...llmResponse.privateStateUpdates}:{};const newPrivateChoices=llmResponse.privateChoices||[];const newGroupChoices=llmResponse.groupChoices||[];if(newPrivateChoices.length>0||newGroupChoices.length>0){updates.choices=[...newPrivateChoices,...newGroupChoices];}if(Object.keys(updates).length>0){await setDoc(privateStateRef,updates,{merge:true});}};const getActionScope=choice=>{const npcMatch=choice.match(/(.+)에게 말을 건다/);if(npcMatch){return`npc:${npcMatch[1].trim()}`;}return`location:${gameState.player.currentLocation}`;};const createCharacter=async choice=>{setIsTextLoading(true);try{const choiceKey=choice.split('.')[0];const selectedProfession=professions[choiceKey];if(selectedProfession){const privateStateRef=getPrivatePlayerStateRef(db,appId,userId);await setDoc(privateStateRef,{...getDefaultPrivatePlayerState(),characterCreated:true,profession:selectedProfession.name,initialMotivation:selectedProfession.motivation},{merge:true});const newEvent={story:`어둠침침한 여관 문이 삐걱거리며 열리더니, 새로운 모험가가 모습을 드러냅니다. 바로 '${getDisplayName(userId)}'라는 이름의 ${selectedProfession.name}입니다. 그의 마음 속에는 '${selectedProfession.motivation}'라는 동기가 자리잡고 있습니다.`,choices:[\"여관을 둘러본다.\",\"다른 모험가에게 말을 건다.\",\"여관 주인에게 정보를 묻는다.\"]};await updatePublicState(newEvent,\"여관에 들어선다\");}}catch(e){console.error(\"등장 이벤트 추가 실패: \",e);setLlmError(\"게임 세계에 합류하는 중 오류가 발생했습니다.\");}finally{setIsTextLoading(false);}};const performPlayerAction=async choice=>{const gameStatusRef=getGameStatusRef(db,appId);const scope=getActionScope(choice);setIsTextLoading(true);setLlmRetryPrompt({playerChoice:choice});try{var _await$getDoc$data;const currentLocks=((_await$getDoc$data=(await getDoc(gameStatusRef)).data())===null||_await$getDoc$data===void 0?void 0:_await$getDoc$data.actionLocks)||{};if(currentLocks[scope]&&currentLocks[scope]!==userId){throw new Error(`현재 '${scope.split(':')[1]}'(은)는 다른 플레이어(${getDisplayName(currentLocks[scope])})가 사용 중입니다.`);}await setDoc(gameStatusRef,{actionLocks:{...currentLocks,[scope]:userId}},{merge:true});const userPromptText=buildLlmPrompt(choice);const llmResponse=await callGeminiTextLLM(userPromptText);if(llmResponse){await updatePublicState(llmResponse,choice);await updatePrivateState(llmResponse);setLlmError(null);setLlmRetryPrompt(null);}else if(!llmError){setLlmError(\"LLM으로부터 유효한 응답을 받지 못했습니다.\");}}catch(error){console.error(\"행동 처리 중 오류:\",error.message);setLlmError(error.message);}finally{const finalLocksDoc=await getDoc(gameStatusRef);if(finalLocksDoc.exists()){const finalLocks=finalLocksDoc.data().actionLocks||{};if(finalLocks[scope]===userId){delete finalLocks[scope];await setDoc(gameStatusRef,{actionLocks:finalLocks},{merge:true});}}setIsTextLoading(false);}};const handleChoiceClick=async choice=>{if(isTextLoading)return;if(!privatePlayerState.characterCreated){await createCharacter(choice);}else{await performPlayerAction(choice);}};const toggleAccordion=key=>{setAccordion(prev=>({...prev,[key]:!prev[key]}));};const LlmErrorModal=()=>/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 text-center\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-xl font-bold text-red-400\",children:\"\\uC624\\uB958\\uAC00 \\uBC1C\\uC0DD\\uD588\\uC2B5\\uB2C8\\uB2E4\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-200\",children:llmError}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-center gap-4\",children:[llmRetryPrompt&&/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md\",onClick:async()=>{setLlmError(null);if(llmRetryPrompt.playerChoice){await handleChoiceClick(llmRetryPrompt.playerChoice);}},children:\"\\uC7AC\\uC2DC\\uB3C4\"}),/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-gray-600 hover:bg-gray-700 font-bold rounded-md\",onClick:()=>{setLlmError(null);setLlmRetryPrompt(null);},children:\"\\uB2EB\\uAE30\"})]})]})});if(showNicknameModal){return/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-xl font-bold text-gray-100\",children:\"\\uB2C9\\uB124\\uC784\\uC744 \\uC785\\uB825\\uD558\\uC138\\uC694\"}),/*#__PURE__*/_jsx(\"input\",{className:\"w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg\",placeholder:\"\\uB2C9\\uB124\\uC784\",value:nicknameInput,onChange:e=>setNicknameInput(e.target.value),onKeyDown:e=>{if(e.key==='Enter')handleNicknameSubmit();},autoFocus:true}),/*#__PURE__*/_jsx(\"button\",{className:\"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md transition duration-300 disabled:opacity-50\",onClick:handleNicknameSubmit,disabled:!nicknameInput.trim(),children:\"\\uC2DC\\uC791\\uD558\\uAE30\"})]})});}if(isLoading){return/*#__PURE__*/_jsxs(\"div\",{className:\"min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-16 w-16 border-b-2 border-gray-300\"}),/*#__PURE__*/_jsx(\"span\",{className:\"ml-4 text-xl\",children:\"\\uB370\\uC774\\uD130\\uB97C \\uBD88\\uB7EC\\uC624\\uB294 \\uC911...\"})]});}const renderGameLog=()=>/*#__PURE__*/_jsxs(\"div\",{className:\"mb-2\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between cursor-pointer select-none\",onClick:()=>toggleAccordion('gameLog'),children:[/*#__PURE__*/_jsx(\"h2\",{className:\"text-lg font-bold text-gray-100\",children:\"\\uAC8C\\uC784 \\uB85C\\uADF8\"}),/*#__PURE__*/_jsx(\"div\",{className:\"text-xl\",children:accordion.gameLog?'▼':'▲'})]}),accordion.gameLog&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex justify-end mb-2\",children:/*#__PURE__*/_jsx(\"button\",{className:\"px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded-md\",onClick:()=>setShowResetModal(true),children:\"\\uC804\\uCCB4 \\uB370\\uC774\\uD130 \\uCD08\\uAE30\\uD654\"})}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex-grow bg-gray-700 p-4 rounded-md overflow-y-auto h-96 custom-scrollbar text-sm md:text-base leading-relaxed\",style:{maxHeight:'24rem'},children:[!privatePlayerState.characterCreated&&/*#__PURE__*/_jsxs(\"div\",{className:\"mb-4 p-2 rounded bg-gray-900/50 text-center\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-yellow-300 font-semibold italic text-lg\",children:\"\\uBAA8\\uD5D8\\uC758 \\uC11C\\uB9C9\"}),/*#__PURE__*/_jsx(\"p\",{className:\"whitespace-pre-wrap mt-1\",children:\"\\uB2F9\\uC2E0\\uC740 \\uC5B4\\uB5A4 \\uC6B4\\uBA85\\uC744 \\uC120\\uD0DD\\uD558\\uC2DC\\uACA0\\uC2B5\\uB2C8\\uAE4C?\"})]}),(gameState.log||[]).map((event,index)=>{var _event$actor2,_event$publicStory2;return/*#__PURE__*/_jsxs(\"div\",{className:\"mb-4 p-2 rounded bg-gray-900/50\",children:[(event===null||event===void 0?void 0:(_event$actor2=event.actor)===null||_event$actor2===void 0?void 0:_event$actor2.displayName)&&(event===null||event===void 0?void 0:event.action)&&/*#__PURE__*/_jsxs(\"p\",{className:\"text-yellow-300 font-semibold italic text-sm\",children:[event.actor.displayName,\" \\uB2D8\\uC774 \",event.action,\" \\uC120\\uD0DD\"]}),/*#__PURE__*/_jsx(\"p\",{className:\"whitespace-pre-wrap mt-1\",dangerouslySetInnerHTML:{__html:((_event$publicStory2=event===null||event===void 0?void 0:event.publicStory)!==null&&_event$publicStory2!==void 0?_event$publicStory2:'').replace(/\\n/g,'<br />')}}),(event===null||event===void 0?void 0:event.groupStory)&&(privatePlayerState.groups||[]).length>0&&/*#__PURE__*/_jsxs(\"p\",{className:\"whitespace-pre-wrap mt-2 p-2 rounded bg-green-900/30 border-l-4 border-green-400 text-green-200\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-bold\",children:\"[\\uADF8\\uB8F9 \\uC774\\uC57C\\uAE30] \"}),event.groupStory]})]},index);}),isTextLoading&&/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-center items-center mt-4\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-300\"}),/*#__PURE__*/_jsx(\"span\",{className:\"ml-3 text-gray-400\",children:\"\\uC774\\uC57C\\uAE30\\uB97C \\uC0DD\\uC131 \\uC911...\"})]}),Object.entries(actionLocks||{}).map(_ref2=>{let[scope,lockedBy]=_ref2;if(lockedBy===userId)return null;return/*#__PURE__*/_jsx(\"div\",{className:\"text-center text-yellow-400 font-semibold p-2 bg-black bg-opacity-20 rounded-md mt-2\",children:`'${scope.split(':')[1]}' 영역은 ${getDisplayName(lockedBy)}님이 사용 중입니다...`},scope);}),/*#__PURE__*/_jsx(\"div\",{ref:logEndRef})]})]})]});const renderChoices=()=>/*#__PURE__*/_jsx(\"div\",{className:\"flex flex-col gap-3\",children:privatePlayerState.characterCreated?[...(gameState.choices||[]),...(privatePlayerState.choices||[])].map((choice,index)=>{if(!choice)return null;const scope=getActionScope(choice);const isLockedByOther=actionLocks[scope]&&actionLocks[scope]!==userId;const allPrivateChoices=privatePlayerState.choices||[];const isPersonalChoice=allPrivateChoices.includes(choice);const isPublicChoice=(gameState.choices||[]).includes(choice);let buttonStyle='bg-blue-600 hover:bg-blue-700';let prefix='';if(isPersonalChoice&&!isPublicChoice){buttonStyle='bg-green-600 hover:bg-green-700';prefix='[개인/그룹] ';}if(isLockedByOther){buttonStyle='bg-gray-500 cursor-not-allowed';prefix=`[${getDisplayName(actionLocks[scope])} 사용 중] `;}return/*#__PURE__*/_jsxs(\"button\",{className:`px-6 py-3 font-bold rounded-md shadow-lg transition duration-300 disabled:opacity-50 ${buttonStyle} text-white`,onClick:()=>handleChoiceClick(choice),disabled:isTextLoading||isLockedByOther,children:[prefix,choice]},`${choice}-${index}`);}):Object.keys(professions).map(key=>/*#__PURE__*/_jsxs(\"button\",{onClick:()=>handleChoiceClick(`${key}. ${professions[key].name}`),disabled:isTextLoading,className:\"px-6 py-4 bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white font-bold rounded-md shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-wait text-left\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-lg text-blue-300\",children:`${key}. ${professions[key].name}`}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm font-normal text-gray-300 mt-1\",children:professions[key].motivation})]},key))});const renderSidebar=()=>{var _privatePlayerState$s,_privatePlayerState$s2,_privatePlayerState$s3,_privatePlayerState$s4,_privatePlayerState$s5,_privatePlayerState$s6,_privatePlayerState$s7,_privatePlayerState$s8;return/*#__PURE__*/_jsxs(\"div\",{className:\"w-full lg:w-1/3 flex flex-col space-y-6 bg-gray-700 p-4 rounded-lg shadow-inner\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"mb-2\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between cursor-pointer select-none\",onClick:()=>toggleAccordion('playerInfo'),children:[/*#__PURE__*/_jsx(\"h4\",{className:\"text-md font-semibold text-gray-200\",children:\"\\uB0B4 \\uC815\\uBCF4\"}),/*#__PURE__*/_jsx(\"div\",{className:\"text-xl\",children:accordion.playerInfo?'▼':'▲'})]}),accordion.playerInfo&&/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-600 p-3 rounded-md text-xs md:text-sm text-gray-300 space-y-1 h-48 overflow-y-auto custom-scrollbar\",children:[/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-blue-300\",children:\"\\uC774\\uB984:\"}),\" \",getDisplayName(userId)]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-blue-300\",children:\"\\uC9C1\\uC5C5:\"}),\" \",privatePlayerState.profession||'미정']}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-blue-300\",children:\"\\uC704\\uCE58:\"}),\" \",gameState.player.currentLocation||'알 수 없는 곳']}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-blue-300\",children:\"\\uB2A5\\uB825\\uCE58:\"}),\" \\uD798(\",(_privatePlayerState$s=(_privatePlayerState$s2=privatePlayerState.stats)===null||_privatePlayerState$s2===void 0?void 0:_privatePlayerState$s2.strength)!==null&&_privatePlayerState$s!==void 0?_privatePlayerState$s:10,\") \\uC9C0\\uB2A5(\",(_privatePlayerState$s3=(_privatePlayerState$s4=privatePlayerState.stats)===null||_privatePlayerState$s4===void 0?void 0:_privatePlayerState$s4.intelligence)!==null&&_privatePlayerState$s3!==void 0?_privatePlayerState$s3:10,\") \\uBBFC\\uCCA9(\",(_privatePlayerState$s5=(_privatePlayerState$s6=privatePlayerState.stats)===null||_privatePlayerState$s6===void 0?void 0:_privatePlayerState$s6.agility)!==null&&_privatePlayerState$s5!==void 0?_privatePlayerState$s5:10,\") \\uCE74\\uB9AC\\uC2A4\\uB9C8(\",(_privatePlayerState$s7=(_privatePlayerState$s8=privatePlayerState.stats)===null||_privatePlayerState$s8===void 0?void 0:_privatePlayerState$s8.charisma)!==null&&_privatePlayerState$s7!==void 0?_privatePlayerState$s7:10,\")\"]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-blue-300\",children:\"\\uC778\\uBCA4\\uD1A0\\uB9AC:\"}),\" \",(privatePlayerState.inventory||[]).join(', ')||'비어있음']}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-blue-300\",children:\"\\uD018\\uC2A4\\uD2B8:\"}),\" \",(privatePlayerState.activeQuests||[]).join(', ')||'없음']}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-blue-300\",children:\"\\uB2E8\\uC11C:\"}),\" \",(privatePlayerState.knownClues||[]).join(', ')||'없음']}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-green-300\",children:\"\\uC18C\\uC18D \\uADF8\\uB8F9:\"}),\" \",(privatePlayerState.groups||[]).join(', ')||'없음']}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-yellow-300\",children:\"NPC \\uAD00\\uACC4:\"}),/*#__PURE__*/_jsx(\"ul\",{className:\"list-disc list-inside ml-4\",children:Object.entries(privatePlayerState.npcRelations||{}).length>0?Object.entries(privatePlayerState.npcRelations).map(_ref3=>{let[name,value]=_ref3;return/*#__PURE__*/_jsx(\"li\",{children:`${name}: ${value}`},name);}):/*#__PURE__*/_jsx(\"li\",{children:\"\\uC54C\\uB824\\uC9C4 \\uAD00\\uACC4 \\uC5C6\\uC74C\"})})]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mb-2\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between cursor-pointer select-none\",onClick:()=>toggleAccordion('chronicle'),children:[/*#__PURE__*/_jsx(\"h4\",{className:\"text-md font-semibold text-gray-200\",children:\"\\uB098\\uC758 \\uC5F0\\uB300\\uAE30\"}),/*#__PURE__*/_jsx(\"div\",{className:\"text-xl\",children:accordion.chronicle?'▼':'▲'})]}),accordion.chronicle&&/*#__PURE__*/_jsx(\"div\",{className:\"bg-gray-600 p-3 rounded-md text-xs md:text-sm text-gray-300 space-y-1 h-32 overflow-y-auto custom-scrollbar\",children:(knownMajorEvents||[]).length>0?/*#__PURE__*/_jsx(\"ul\",{className:\"list-disc list-inside\",children:(knownMajorEvents||[]).map(event=>{var _event$summary;return/*#__PURE__*/_jsx(\"li\",{children:(_event$summary=event===null||event===void 0?void 0:event.summary)!==null&&_event$summary!==void 0?_event$summary:'기록이 손상되었습니다.'},event===null||event===void 0?void 0:event.id);})}):/*#__PURE__*/_jsx(\"p\",{children:\"\\uC544\\uC9C1 \\uC54C\\uB824\\uC9C4 \\uC8FC\\uC694 \\uC0AC\\uAC74\\uC774 \\uC5C6\\uC2B5\\uB2C8\\uB2E4. \\uC138\\uC0C1\\uC744 \\uD0D0\\uD5D8\\uD574 \\uBCF4\\uC138\\uC694.\"})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mb-2\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between cursor-pointer select-none\",onClick:()=>toggleAccordion('users'),children:[/*#__PURE__*/_jsx(\"h4\",{className:\"text-md font-semibold text-gray-200\",children:\"\\uD604\\uC7AC \\uD50C\\uB808\\uC774\\uC5B4\\uB4E4\"}),/*#__PURE__*/_jsx(\"div\",{className:\"text-xl\",children:accordion.users?'▼':'▲'})]}),accordion.users&&/*#__PURE__*/_jsx(\"div\",{className:\"bg-gray-600 p-3 rounded-md h-32 overflow-y-auto custom-scrollbar\",children:(activeUsers||[]).length>0?/*#__PURE__*/_jsx(\"ul\",{className:\"text-sm text-gray-300 space-y-1\",children:(activeUsers||[]).map(user=>/*#__PURE__*/_jsxs(\"li\",{className:\"truncate p-1 rounded-md\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"font-medium text-green-300\",children:getDisplayName(user.id)}),/*#__PURE__*/_jsxs(\"span\",{className:\"text-gray-400 text-xs\",children:[\" (\",user.profession||'모험가',\")\"]})]},user.id))}):/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-400\",children:\"\\uD65C\\uB3D9 \\uC911\\uC778 \\uD50C\\uB808\\uC774\\uC5B4\\uAC00 \\uC5C6\\uC2B5\\uB2C8\\uB2E4.\"})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mb-2\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between cursor-pointer select-none\",onClick:()=>toggleAccordion('chat'),children:[/*#__PURE__*/_jsx(\"h4\",{className:\"text-md font-semibold text-gray-200\",children:\"\\uACF5\\uAC1C \\uCC44\\uD305\"}),/*#__PURE__*/_jsx(\"div\",{className:\"text-xl\",children:accordion.chat?'▼':'▲'})]}),accordion.chat&&/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-600 p-3 rounded-md flex flex-col h-48\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex-grow overflow-y-auto custom-scrollbar mb-3 text-sm space-y-2\",children:[(chatMessages||[]).map(msg=>/*#__PURE__*/_jsx(\"div\",{children:/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsxs(\"span\",{className:\"font-medium text-yellow-300\",children:[getDisplayName(msg.userId),\":\"]}),\" \",msg.message]})},msg.id)),/*#__PURE__*/_jsx(\"div\",{ref:chatEndRef})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",className:\"flex-grow p-2 rounded-l-md bg-gray-700 border border-gray-600\",value:currentChatMessage,onChange:e=>setCurrentChatMessage(e.target.value),onKeyPress:e=>e.key==='Enter'&&sendChatMessage(),disabled:!isAuthReady}),/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-blue-600 hover:bg-blue-700 font-bold rounded-r-md\",onClick:sendChatMessage,disabled:!isAuthReady||!currentChatMessage.trim(),children:\"\\uBCF4\\uB0B4\\uAE30\"})]})]})]})]});};return/*#__PURE__*/_jsxs(\"div\",{className:\"min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center justify-center p-4 font-sans\",children:[llmError&&/*#__PURE__*/_jsx(LlmErrorModal,{}),showResetModal&&/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-xl font-bold text-red-400\",children:\"\\u26A0\\uFE0F \\uBAA8\\uB4E0 \\uB370\\uC774\\uD130\\uB97C \\uCD08\\uAE30\\uD654\\uD560\\uAE4C\\uC694?\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-200\",children:\"\\uC774 \\uC791\\uC5C5\\uC740 \\uB418\\uB3CC\\uB9B4 \\uC218 \\uC5C6\\uC2B5\\uB2C8\\uB2E4. \\uBAA8\\uB4E0 \\uC2DC\\uB098\\uB9AC\\uC624, \\uB85C\\uADF8, \\uC720\\uC800, \\uCC44\\uD305 \\uB370\\uC774\\uD130\\uAC00 \\uC0AD\\uC81C\\uB429\\uB2C8\\uB2E4.\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-end gap-3\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-gray-600 hover:bg-gray-700 font-bold rounded-md\",onClick:()=>setShowResetModal(false),disabled:isResetting,children:\"\\uCDE8\\uC18C\"}),/*#__PURE__*/_jsx(\"button\",{className:\"px-4 py-2 bg-red-600 hover:bg-red-700 font-bold rounded-md\",onClick:resetAllGameData,disabled:isResetting,children:isResetting?'초기화 중...':'초기화'})]})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"w-full max-w-5xl bg-gray-800 rounded-lg shadow-xl p-6 md:p-8 flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col w-full lg:w-2/3 space-y-6\",children:[renderGameLog(),renderChoices()]}),renderSidebar()]}),/*#__PURE__*/_jsx(\"style\",{children:`\n        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');\n        body { font-family: 'Noto Sans KR', sans-serif; }\n        .custom-scrollbar::-webkit-scrollbar { width: 8px; }\n        .custom-scrollbar::-webkit-scrollbar-track { background: #4a5568; border-radius: 10px; }\n        .custom-scrollbar::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 10px; }\n        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }\n        `})]});}export default App;","map":{"version":3,"names":["React","useState","useEffect","useRef","initializeApp","getAuth","signInAnonymously","signInWithCustomToken","onAuthStateChanged","getFirestore","doc","setDoc","getDoc","collection","query","onSnapshot","serverTimestamp","addDoc","getDocs","deleteDoc","runTransaction","jsx","_jsx","jsxs","_jsxs","Fragment","_Fragment","defaultFirebaseConfig","apiKey","authDomain","projectId","storageBucket","messagingSenderId","appId","measurementId","firebaseConfig","initialAuthToken","professions","name","motivation","getMainScenarioRef","db","getPrivatePlayerStateRef","userId","getGameStatusRef","getMajorEventsRef","getDefaultGameState","phase","log","choices","player","currentLocation","subtleClues","getDefaultPrivatePlayerState","stats","strength","intelligence","agility","charisma","inventory","initialMotivation","reputation","activeQuests","companions","knownClues","characterCreated","profession","groups","npcRelations","knownEventIds","App","gameState","setGameState","privatePlayerState","setPrivatePlayerState","isTextLoading","setIsTextLoading","activeUsers","setActiveUsers","chatMessages","setChatMessages","currentChatMessage","setCurrentChatMessage","actionLocks","setActionLocks","setDb","auth","setAuth","setUserId","isAuthReady","setIsAuthReady","logEndRef","chatEndRef","nickname","setNickname","localStorage","getItem","showNicknameModal","setShowNicknameModal","nicknameInput","setNicknameInput","accordion","setAccordion","gameLog","chat","users","playerInfo","chronicle","showResetModal","setShowResetModal","isResetting","setIsResetting","llmError","setLlmError","llmRetryPrompt","setLlmRetryPrompt","isLoading","setIsLoading","allMajorEvents","setAllMajorEvents","knownMajorEvents","setKnownMajorEvents","handleNicknameSubmit","trim","finalNickname","setItem","userDocRef","merge","getDisplayName","uid","safeUid","String","safeUserId","substring","user","find","u","id","resetAllGameData","collectionsToDelete","colRef","snapshot","docSnap","docs","ref","usersColRef","usersSnapshot","userDoc","playerStateColRef","playerStateSnapshot","stateDoc","clear","console","e","error","window","location","reload","app","firestoreDb","firebaseAuth","unsubscribeAuth","privateStateRef","then","exists","unsubscribe","data","err","unsubscribes","snap","prev","_data$player","storyLog","_docSnap$data","messages","map","d","sort","a","b","_a$timestamp","_b$timestamp","timestamp","toMillis","cutoffTime","Date","now","filter","lastActive","events","_a$timestamp2","_b$timestamp2","forEach","unsub","length","currentKnownIds","newDiscoveredEvents","event","includes","push","updatedKnownEventIds","knownEvents","handleVisibilityChange","document","visibilityState","addEventListener","removeEventListener","current","scrollIntoView","behavior","systemPrompt","buildLlmPrompt","choice","_privatePlayerState$p","_gameState$player$cur","factions","join","npcs","Object","entries","_ref","value","recentHistory","slice","_event$actor$displayN","_event$actor","_event$action","_event$publicStory","actor","displayName","action","publicStory","userPrompt","h","summary","JSON","stringify","callGeminiTextLLM","mainApiKey","backupApiKey","getApiUrl","payload","contents","role","parts","text","tryGeminiCall","fetch","method","headers","body","_result$candidates","_result$candidates$","_result$candidates$$c","_result$candidates$$c2","_result$candidates$$c3","response","ok","Error","status","result","json","llmOutputText","candidates","content","jsonMatch","match","parse","message","sendChatMessage","chatCollectionRef","updatePublicState","llmResponse","playerChoice","mainScenarioRef","majorEvent","majorEventsRef","newEvent","story","groupStory","transaction","_llmResponse$sharedSt","_llmResponse$sharedSt2","scenarioDoc","get","currentData","newStoryLog","updateData","lastUpdate","sharedStateUpdates","update","set","updatePrivateState","updates","privateStateUpdates","newPrivateChoices","privateChoices","newGroupChoices","groupChoices","keys","getActionScope","npcMatch","createCharacter","choiceKey","split","selectedProfession","performPlayerAction","gameStatusRef","scope","_await$getDoc$data","currentLocks","userPromptText","finalLocksDoc","finalLocks","handleChoiceClick","toggleAccordion","key","LlmErrorModal","className","children","onClick","placeholder","onChange","target","onKeyDown","autoFocus","disabled","renderGameLog","style","maxHeight","index","_event$actor2","_event$publicStory2","dangerouslySetInnerHTML","__html","replace","_ref2","lockedBy","renderChoices","isLockedByOther","allPrivateChoices","isPersonalChoice","isPublicChoice","buttonStyle","prefix","renderSidebar","_privatePlayerState$s","_privatePlayerState$s2","_privatePlayerState$s3","_privatePlayerState$s4","_privatePlayerState$s5","_privatePlayerState$s6","_privatePlayerState$s7","_privatePlayerState$s8","_ref3","_event$summary","msg","type","onKeyPress"],"sources":["C:/workspaces/gemini/src/App.jsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\r\nimport { initializeApp } from 'firebase/app';\r\nimport {\r\n  getAuth,\r\n  signInAnonymously,\r\n  signInWithCustomToken,\r\n  onAuthStateChanged\r\n} from 'firebase/auth';\r\nimport {\r\n  getFirestore,\r\n  doc,\r\n  setDoc,\r\n  getDoc,\r\n  collection,\r\n  query,\r\n  onSnapshot,\r\n  serverTimestamp,\r\n  addDoc,\r\n  getDocs,\r\n  deleteDoc,\r\n  runTransaction\r\n} from 'firebase/firestore';\r\n\r\n// ====================================================================\r\n// Firebase configuration information - 수정 금지\r\nconst defaultFirebaseConfig = {\r\n  apiKey: \"AIzaSyBNJtmpRWzjobrY556bnHkwbZmpFJqgPX8\",\r\n  authDomain: \"text-adventure-game-cb731.firebaseapp.com\",\r\n  projectId: \"text-adventure-game-cb731\",\r\n  storageBucket: \"text-adventure-game-cb731.appspot.com\",\r\n  messagingSenderId: \"1092941614820\",\r\n  appId: \"1:1092941614820:web:5545f36014b73c268026f1\",\r\n  measurementId: \"G-FNGF42T1FP\"\r\n};\r\n\r\n// 수정금지\r\nconst firebaseConfig = defaultFirebaseConfig;\r\nconst appId = firebaseConfig.projectId;\r\nconst initialAuthToken = null;\r\n// ====================================================================\r\n\r\nconst professions = {\r\n  '1': { name: '몰락한 귀족/기사', motivation: '가문의 몰락 원인을 조사하고, 잃어버린 가문의 보물을 찾아야 합니다.' },\r\n  '2': { name: '평범한 마을 사람/농부', motivation: '갑자기 마을에 나타난 괴생명체로부터 마을을 지켜야 합니다.' },\r\n  '3': { name: '젊은 마법사/견습생', motivation: '스승님의 실종에 대한 단서를 찾아야 합니다.' },\r\n  '4': { name: '용병/모험가', motivation: '의뢰받은 임무를 수행하던 중 예상치 못한 사건에 휘말렸습니다.' },\r\n  '5': { name: '도적/암살자', motivation: '길드에서 내려온 첫 번째 임무를 완수하고, 그 과정에서 수상한 음모를 감지해야 합니다.' },\r\n  '6': { name: '왕족/공주/왕자', motivation: '왕실 내의 불화와 암투 속에서 자신의 입지를 다져야 합니다.' },\r\n};\r\n\r\n// Firestore 경로 유틸\r\nconst getMainScenarioRef = (db, appId) => doc(db, 'artifacts', appId, 'public', 'data', 'mainScenario', 'main');\r\nconst getPrivatePlayerStateRef = (db, appId, userId) => doc(db, 'artifacts', appId, 'users', userId, 'playerState', 'state');\r\nconst getGameStatusRef = (db, appId) => doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'status');\r\nconst getMajorEventsRef = (db, appId) => collection(db, 'artifacts', appId, 'public', 'data', 'majorEvents');\r\n\r\n\r\n// 상태 초기화 유틸\r\nconst getDefaultGameState = () => ({\r\n  phase: 'playing',\r\n  log: [],\r\n  choices: [],\r\n  player: {\r\n    currentLocation: '방랑자의 안식처',\r\n  },\r\n  subtleClues: [],\r\n});\r\n\r\nconst getDefaultPrivatePlayerState = () => ({\r\n    stats: { strength: 10, intelligence: 10, agility: 10, charisma: 10 },\r\n    inventory: [],\r\n    initialMotivation: '',\r\n    reputation: {},\r\n    activeQuests: [],\r\n    companions: [],\r\n    knownClues: [],\r\n    characterCreated: false,\r\n    profession: '',\r\n    choices: [],\r\n    groups: [],\r\n    npcRelations: {},\r\n    knownEventIds: [],\r\n});\r\n\r\n\r\nfunction App() {\r\n  const [gameState, setGameState] = useState(getDefaultGameState());\r\n  const [privatePlayerState, setPrivatePlayerState] = useState(getDefaultPrivatePlayerState());\r\n  const [isTextLoading, setIsTextLoading] = useState(false);\r\n  const [activeUsers, setActiveUsers] = useState([]);\r\n  const [chatMessages, setChatMessages] = useState([]);\r\n  const [currentChatMessage, setCurrentChatMessage] = useState('');\r\n  const [actionLocks, setActionLocks] = useState({});\r\n  const [db, setDb] = useState(null);\r\n  const [auth, setAuth] = useState(null);\r\n  const [userId, setUserId] = useState(null);\r\n  const [isAuthReady, setIsAuthReady] = useState(false);\r\n  const logEndRef = useRef(null);\r\n  const chatEndRef = useRef(null);\r\n  const [nickname, setNickname] = useState(() => localStorage.getItem('nickname') || '');\r\n  const [showNicknameModal, setShowNicknameModal] = useState(!localStorage.getItem('nickname'));\r\n  const [nicknameInput, setNicknameInput] = useState('');\r\n  const [accordion, setAccordion] = useState({ gameLog: true, chat: true, users: true, playerInfo: true, chronicle: true });\r\n  const [showResetModal, setShowResetModal] = useState(false);\r\n  const [isResetting, setIsResetting] = useState(false);\r\n  const [llmError, setLlmError] = useState(null);\r\n  const [llmRetryPrompt, setLlmRetryPrompt] = useState(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [allMajorEvents, setAllMajorEvents] = useState([]);\r\n  const [knownMajorEvents, setKnownMajorEvents] = useState([]);\r\n\r\n  const handleNicknameSubmit = () => {\r\n    if (nicknameInput.trim()) {\r\n      const finalNickname = nicknameInput.trim();\r\n      setNickname(finalNickname);\r\n      localStorage.setItem('nickname', finalNickname);\r\n      setShowNicknameModal(false);\r\n      if (userId && db) {\r\n          const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'activeUsers', userId);\r\n          setDoc(userDocRef, { nickname: finalNickname }, { merge: true });\r\n      }\r\n    }\r\n  };\r\n\r\n  const getDisplayName = (uid) => {\r\n    const safeUid = String(uid || '');\r\n    if (uid === userId) {\r\n      const safeUserId = String(userId || '');\r\n      return nickname || `플레이어 ${safeUserId.substring(0, 4)}`;\r\n    }\r\n    const user = activeUsers.find(u => u.id === uid);\r\n    return user?.nickname || `플레이어 ${safeUid.substring(0, 4)}`;\r\n  };\r\n\r\n  const resetAllGameData = async () => {\r\n    if (!db || !isAuthReady) return;\r\n    setIsResetting(true);\r\n    try {\r\n        const collectionsToDelete = [\r\n            collection(db, 'artifacts', appId, 'public', 'data', 'chatMessages'),\r\n            collection(db, 'artifacts', appId, 'public', 'data', 'activeUsers'),\r\n            getMajorEventsRef(db, appId)\r\n        ];\r\n\r\n        for (const colRef of collectionsToDelete) {\r\n            const snapshot = await getDocs(colRef);\r\n            for (const docSnap of snapshot.docs) {\r\n                await deleteDoc(docSnap.ref);\r\n            }\r\n        }\r\n\r\n        const usersColRef = collection(db, 'artifacts', appId, 'users');\r\n        const usersSnapshot = await getDocs(usersColRef);\r\n        for (const userDoc of usersSnapshot.docs) {\r\n            const playerStateColRef = collection(db, 'artifacts', appId, 'users', userDoc.id, 'playerState');\r\n            const playerStateSnapshot = await getDocs(playerStateColRef);\r\n            for (const stateDoc of playerStateSnapshot.docs) {\r\n                await deleteDoc(stateDoc.ref);\r\n            }\r\n            await deleteDoc(doc(db, 'artifacts', appId, 'users', userDoc.id));\r\n        }\r\n\r\n        await deleteDoc(getMainScenarioRef(db, appId));\r\n        await deleteDoc(getGameStatusRef(db, appId));\r\n        \r\n        localStorage.clear();\r\n\r\n        setGameState(getDefaultGameState());\r\n        setPrivatePlayerState(getDefaultPrivatePlayerState());\r\n        setChatMessages([]);\r\n        setActionLocks({});\r\n\r\n        console.log(\"모든 서버 및 클라이언트 데이터가 성공적으로 초기화되었습니다.\");\r\n\r\n    } catch (e) {\r\n        console.error(\"전체 데이터 초기화 중 오류 발생:\", e);\r\n    } finally {\r\n      setIsResetting(false);\r\n      setShowResetModal(false);\r\n      window.location.reload();\r\n    }\r\n  };\r\n  \r\n  useEffect(() => {\r\n    try {\r\n      const app = initializeApp(firebaseConfig);\r\n      const firestoreDb = getFirestore(app);\r\n      const firebaseAuth = getAuth(app);\r\n      setDb(firestoreDb);\r\n      setAuth(firebaseAuth);\r\n      const unsubscribeAuth = onAuthStateChanged(firebaseAuth, async (user) => {\r\n        if (user) {\r\n          setUserId(user.uid);\r\n          setIsAuthReady(true);\r\n        } else {\r\n            await (initialAuthToken ? signInWithCustomToken(firebaseAuth, initialAuthToken) : signInAnonymously(firebaseAuth));\r\n        }\r\n      });\r\n      return () => unsubscribeAuth();\r\n    } catch (error) {\r\n      console.error(\"Firebase initialization error:\", error);\r\n      setLlmError(\"Firebase 초기화에 실패했습니다.\");\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!isAuthReady || !db || !userId) return;\r\n    const privateStateRef = getPrivatePlayerStateRef(db, appId, userId);\r\n    getDoc(privateStateRef).then(docSnap => {\r\n        if (!docSnap.exists()) {\r\n            setDoc(privateStateRef, getDefaultPrivatePlayerState());\r\n        }\r\n    });\r\n    const unsubscribe = onSnapshot(privateStateRef, (snapshot) => {\r\n      if (snapshot.exists()) {\r\n        setPrivatePlayerState({ ...getDefaultPrivatePlayerState(), ...snapshot.data() });\r\n      }\r\n      if (isLoading) setIsLoading(false);\r\n    }, (err) => {\r\n      console.error(\"Private state listener error:\", err);\r\n      setLlmError(\"개인 정보를 불러오는 중 오류가 발생했습니다.\");\r\n      setIsLoading(false);\r\n    });\r\n    return () => unsubscribe();\r\n  }, [isAuthReady, db, userId]);\r\n\r\n  useEffect(() => {\r\n    if (!isAuthReady || !db) return;\r\n\r\n    const unsubscribes = [\r\n      onSnapshot(getMainScenarioRef(db, appId), (snap) => {\r\n        if (snap.exists()) {\r\n          const data = snap.data();\r\n          setGameState(prev => ({\r\n            ...prev,\r\n            log: data.storyLog || [],\r\n            choices: data.choices || [],\r\n            player: { ...prev.player, currentLocation: data.player?.currentLocation || prev.player.currentLocation },\r\n            subtleClues: data.subtleClues || []\r\n          }));\r\n        }\r\n      }),\r\n      onSnapshot(getGameStatusRef(db, appId), (docSnap) => {\r\n        setActionLocks(docSnap.data()?.actionLocks || {});\r\n      }),\r\n      onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'chatMessages')), (snapshot) => {\r\n        const messages = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));\r\n        setChatMessages(messages);\r\n      }),\r\n      onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'activeUsers')), (snapshot) => {\r\n        const cutoffTime = Date.now() - 60 * 1000;\r\n        const users = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).filter(u => u.lastActive && u.lastActive.toMillis() > cutoffTime);\r\n        setActiveUsers(users);\r\n      }),\r\n      onSnapshot(query(getMajorEventsRef(db, appId)), (snapshot) => {\r\n        const events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))\r\n            .sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));\r\n        setAllMajorEvents(events);\r\n      })\r\n    ];\r\n    return () => unsubscribes.forEach(unsub => unsub());\r\n  }, [isAuthReady, db]);\r\n\r\n  useEffect(() => {\r\n    if (!db || !userId || allMajorEvents.length === 0) return;\r\n\r\n    const currentKnownIds = privatePlayerState.knownEventIds || [];\r\n    const newDiscoveredEvents = [];\r\n\r\n    allMajorEvents.forEach(event => {\r\n        if (event?.location === gameState.player.currentLocation && !currentKnownIds.includes(event.id)) {\r\n            newDiscoveredEvents.push(event.id);\r\n        }\r\n    });\r\n\r\n    if (newDiscoveredEvents.length > 0) {\r\n        const privateStateRef = getPrivatePlayerStateRef(db, appId, userId);\r\n        const updatedKnownEventIds = [...currentKnownIds, ...newDiscoveredEvents];\r\n        setDoc(privateStateRef, { knownEventIds: updatedKnownEventIds }, { merge: true });\r\n    }\r\n\r\n    const knownEvents = allMajorEvents.filter(event => (privatePlayerState.knownEventIds || []).includes(event?.id));\r\n    setKnownMajorEvents(knownEvents);\r\n\r\n  }, [gameState.player.currentLocation, allMajorEvents, privatePlayerState.knownEventIds, db, userId]);\r\n\r\n\r\n  useEffect(() => {\r\n    if (!db || !userId || !nickname) return;\r\n    const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'activeUsers', userId);\r\n    setDoc(userDocRef, {\r\n      lastActive: serverTimestamp(),\r\n      nickname: nickname || `플레이어 ${userId.substring(0, 4)}`,\r\n      profession: privatePlayerState.profession,\r\n    }, { merge: true });\r\n\r\n    const handleVisibilityChange = () => {\r\n      if (document.visibilityState === 'visible') {\r\n        setDoc(userDocRef, { lastActive: serverTimestamp() }, { merge: true });\r\n      }\r\n    };\r\n    document.addEventListener('visibilitychange', handleVisibilityChange);\r\n    return () => document.removeEventListener('visibilitychange', handleVisibilityChange);\r\n  }, [db, userId, nickname, privatePlayerState.profession]);\r\n\r\n  useEffect(() => {\r\n    if (accordion.gameLog && logEndRef.current) logEndRef.current.scrollIntoView({ behavior: \"smooth\" });\r\n  }, [gameState.log, accordion.gameLog]);\r\n\r\n  useEffect(() => {\r\n    if (accordion.chat && chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: \"smooth\" });\r\n  }, [chatMessages, accordion.chat]);\r\n\r\n  const systemPrompt = `\r\n    ### 페르소나 (Persona)\r\n    당신은 이 세계의 '수호자'이자 '사관(史官)'이며, 플레이어들에게는 '게임 마스터(GM)'로 알려져 있습니다. 당신의 임무는 단순한 이야기 생성을 넘어, 일관된 역사와 살아 숨 쉬는 세계관을 구축하는 것입니다. 모든 묘사와 사건은 이 세계의 정해진 분위기와 역사적 사실 위에서 피어나는 한 편의 서사시여야 합니다.\r\n\r\n    ### 세계관 설정: 페이디드 판타지 (Faded Fantasy)\r\n    이 세계는 오래되었고, 과거의 영광은 빛이 바랬습니다. 위대한 왕국들은 쇠락의 길을 걷고 있으며, 잊혀진 유적에는 강력하지만 위험한 마법의 흔적이 남아있습니다. 도시는 화려함 뒤에 부패를 숨기고 있고, 황야에는 미지의 위험이 도사립니다. 사람들은 서로를 쉽게 믿지 않으며, 각자의 생존을 위해 발버둥 칩니다. 당신의 모든 묘사는 이 '아름답지만 슬픈' 분위기를 반영해야 합니다.\r\n\r\n    ### 핵심 구동 원칙\r\n    1.  **일관성의 원칙 (Canon) (가장 중요)**: User Prompt에 제공된 [세계의 연대기], [주요 세력 및 인물], [플레이어 정보]는 이 세계의 '정사(正史)'입니다. 당신은 절대 이 사실들을 왜곡하거나 모순되는 내용을 만들어서는 안 됩니다. 이 정보들을 바탕으로 세계를 확장해 나가십시오.\r\n\r\n    2.  **상호연결성의 원칙 (Interconnection)**: 당신은 뛰어난 이야기꾼으로서, 현재 발생하는 사건을 과거의 역사나 다른 플레이어의 행적과 연결지어야 합니다. 예를 들어, 한 플레이어가 던전에서 발견한 고대 문양은, 다른 플레이어가 수도에서 쫓고 있는 비밀 결사의 상징일 수 있습니다. 세상이 서로 연결되어 있음을 플레이어가 느끼게 하십시오.\r\n\r\n    3.  **장면 중심의 서사 원칙 (Scene-Centric)**: 플레이어의 '[선택]'은 하나의 '장면'을 시작하는 것과 같습니다. 당신의 \"story\"는 반드시 그 선택의 즉각적인 결과와 묘사로 시작되어야 합니다. 대화라면 실제 대화 내용이, 행동이라면 그 행동의 과정과 결과가 구체적으로 서술되어야 합니다.\r\n\r\n    4.  **'보여주기, 말하지 않기' 원칙 (Show, Don't Tell)**: \"마을이 가난하다\"고 설명하지 마십시오. 대신 \"굶주린 아이들이 흙바닥에 주저앉아 있고, 대부분의 건물은 지붕이 허술하게 덧대어져 있다\"고 묘사하십시오. 플레이어가 스스로 분위기와 상황을 파악하게 만드십시오.\r\n\r\n    ### JSON 출력 구조\r\n    {\r\n      \"story\": \"상기된 모든 원칙에 따라, 플레이어의 선택으로 시작된 '장면'에 대한 구체적이고 즉각적인 묘사.\",\r\n      \"groupStory\": \"행동 주체와 같은 그룹 소속원들만 볼 수 있는 비밀스러운 이야기. 해당사항 없으면 null.\",\r\n      \"choices\": [\"묘사된 '장면'의 결과에 따라 플레이어가 할 수 있는 논리적인 다음 행동들.\"],\r\n      \"privateChoices\": [\"오직 행동 주체의 특성 때문에 가능한 특별한 행동들.\"],\r\n      \"groupChoices\": [\"같은 그룹 소속원들만 할 수 있는 비밀 행동들.\"],\r\n      \"majorEvent\": {\r\n        \"summary\": \"만약 이 사건이 후대에 '역사'로 기록될 만한 중대한 전환점이라면, 사관의 어조로 요약. (예: '왕국력 342년, 방랑자의 안식처에서 발생한 이 사건은 훗날 '붉은 달 교단'의 부흥을 알리는 서막이 되었다.') 그렇지 않으면 null.\",\r\n        \"location\": \"사건이 발생한 장소 이름. majorEvent가 있을 경우 필수.\"\r\n      },\r\n      \"sharedStateUpdates\": {\r\n        \"location\": \"플레이어 그룹의 현재 위치. 변경되었을 경우에만 포함.\",\r\n        \"subtleClues\": [{\"location\": \"장소명\", \"clue\": \"새롭게 생성된 단서\"}]\r\n      },\r\n      \"privateStateUpdates\": {\r\n        \"inventory\": [\"업데이트된 전체 인벤토리 목록\"],\r\n        \"stats\": {\"strength\": 12, \"intelligence\": 10, \"agility\": 10, \"charisma\": 10 },\r\n        \"activeQuests\": [\"업데이트된 개인 퀘스트 목록\"],\r\n        \"knownClues\": [\"새롭게 알게 된 단서 목록\"],\r\n        \"groups\": [\"업데이트된 소속 그룹 목록\"],\r\n        \"npcRelations\": {\"가라크\": 55, \"엘라라\": -10}\r\n      }\r\n    }\r\n  `;\r\n\r\n  const buildLlmPrompt = (choice) => {\r\n    const factions = (privatePlayerState.groups || []).join(', ') || '없음';\r\n    const npcs = Object.entries(privatePlayerState.npcRelations || {})\r\n      .map(([name, value]) => `${name} (관계도: ${value})`)\r\n      .join(', ') || '없음';\r\n\r\n    const recentHistory = (gameState.log || []).slice(-10).map(event =>\r\n      `[${event?.actor?.displayName ?? '누군가'}]가 ${event?.action ?? '알 수 없는 행동'}을(를) 통해 다음을 겪음: ${event?.publicStory ?? ''}`\r\n    ).join('\\n');\r\n\r\n    const userPrompt = `\r\n[세계의 연대기 (Chronicle of the World)]\r\n- 이 세계에서 지금까지 벌어진 주요 역사적 사건들입니다. 이 기록은 절대적인 사실입니다.\r\n- ${knownMajorEvents.length > 0 ? knownMajorEvents.map(h => h.summary).join('\\n- ') : \"아직 기록된 역사가 없음\"}\r\n\r\n[주요 세력 및 인물 (Key Factions & NPCs)]\r\n- 플레이어와 관련된 주요 세력: ${factions}\r\n- 플레이어와 관계를 맺은 주요 인물: ${npcs}\r\n\r\n[플레이어의 현재 상태 및 위치 (Player's Current State & Location)]\r\n- 이름: ${getDisplayName(userId)}\r\n- 직업: ${privatePlayerState.profession ?? '미정'}\r\n- 현재 위치: ${gameState.player.currentLocation ?? '알 수 없는 곳'}\r\n- 소지품 및 능력치: ${JSON.stringify({ inventory: privatePlayerState.inventory || [], stats: privatePlayerState.stats || {} })}\r\n\r\n[플레이어의 최근 경험 (Player's Recent Experiences)]\r\n- 플레이어가 최근 겪은 사건들의 기록입니다.\r\n${recentHistory}\r\n\r\n[주변 관찰자 (Nearby Observers)]\r\n- 현재 장소에 함께 있는 다른 플레이어들입니다. 이들은 이번 턴에 행동하지 않습니다.\r\n- ${(activeUsers || []).map(u => u.nickname || `플레이어 ${u.id.substring(0,4)}`).join(', ') || \"주변에 다른 플레이어가 없음\"}\r\n\r\n[플레이어의 선택 (Player's Action)]\r\n- 위 모든 상황 속에서, 플레이어는 다음 행동을 선택했습니다. 이 선택으로 시작될 '장면'을 연출해주십시오.\r\n- \"${choice}\"\r\n`;\r\n    return userPrompt;\r\n  };\r\n\r\n  const callGeminiTextLLM = async (userPrompt) => {\r\n    setIsTextLoading(true);\r\n    const mainApiKey = \"AIzaSyDC11rqjU30OJnLjaBFOaazZV0klM5raU8\";\r\n    const backupApiKey = \"AIzaSyAhscNjW8GmwKPuKzQ47blCY_bDanR-B84\";\r\n    const getApiUrl = (apiKey) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;\r\n\r\n    const payload = { contents: [{ role: \"user\", parts: [{ text: systemPrompt }] }, { role: \"model\", parts: [{ text: \"{}\" }] }, { role: \"user\", parts: [{ text: userPrompt }] }] };\r\n\r\n    const tryGeminiCall = async (apiKey) => fetch(getApiUrl(apiKey), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });\r\n\r\n    try {\r\n      let response = await tryGeminiCall(mainApiKey);\r\n      if (!response.ok) {\r\n        response = await tryGeminiCall(backupApiKey);\r\n      }\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n      const result = await response.json();\r\n      const llmOutputText = result.candidates?.[0]?.content?.parts?.[0]?.text;\r\n      const jsonMatch = llmOutputText?.match(/\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) return JSON.parse(jsonMatch[0]);\r\n      throw new Error(\"Valid JSON object not found in LLM response.\");\r\n    } catch (error) {\r\n      console.error(\"LLM API call error:\", error);\r\n      setLlmError(error.message || 'LLM 호출 실패');\r\n      return null;\r\n    } finally {\r\n      setIsTextLoading(false);\r\n    }\r\n  };\r\n\r\n  const sendChatMessage = async () => {\r\n    if (!db || !userId || !isAuthReady || !currentChatMessage.trim()) return;\r\n    try {\r\n      const chatCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'chatMessages');\r\n      await addDoc(chatCollectionRef, { userId, displayName: getDisplayName(userId), message: currentChatMessage, timestamp: serverTimestamp() });\r\n      setCurrentChatMessage('');\r\n    } catch (error) {\r\n      console.error(\"Error sending chat message:\", error);\r\n    }\r\n  };\r\n\r\n  const updatePublicState = async (llmResponse, playerChoice) => {\r\n    const mainScenarioRef = getMainScenarioRef(db, appId);\r\n\r\n    if (llmResponse.majorEvent && llmResponse.majorEvent.summary && llmResponse.majorEvent.location) {\r\n        const majorEventsRef = collection(db, 'artifacts', appId, 'public', 'data', 'majorEvents');\r\n        await addDoc(majorEventsRef, {\r\n            ...llmResponse.majorEvent,\r\n            timestamp: serverTimestamp(),\r\n            actor: { id: userId, displayName: getDisplayName(userId) }\r\n        });\r\n    }\r\n\r\n    const newEvent = {\r\n        actor: { id: userId, displayName: getDisplayName(userId) },\r\n        action: playerChoice,\r\n        publicStory: llmResponse.story || \"특별한 일은 일어나지 않았다.\",\r\n        groupStory: llmResponse.groupStory || null,\r\n        timestamp: new Date()\r\n    };\r\n  \r\n    await runTransaction(db, async (transaction) => {\r\n        const scenarioDoc = await transaction.get(mainScenarioRef);\r\n        const currentData = scenarioDoc.exists() ? scenarioDoc.data() : getDefaultGameState();\r\n        const newStoryLog = [...(currentData.storyLog || []), newEvent];\r\n        const updateData = {\r\n          storyLog: newStoryLog,\r\n          lastUpdate: serverTimestamp()\r\n        };\r\n        if (llmResponse.choices && llmResponse.choices.length > 0) {\r\n          updateData.choices = llmResponse.choices;\r\n        }\r\n        if (llmResponse.sharedStateUpdates?.location) {\r\n          updateData['player.currentLocation'] = llmResponse.sharedStateUpdates.location;\r\n        }\r\n        if (llmResponse.sharedStateUpdates?.subtleClues) {\r\n          updateData.subtleClues = llmResponse.sharedStateUpdates.subtleClues;\r\n        }\r\n        if (scenarioDoc.exists()) {\r\n            transaction.update(mainScenarioRef, updateData);\r\n        } else {\r\n            transaction.set(mainScenarioRef, { ...currentData, ...updateData });\r\n        }\r\n    });\r\n  };\r\n  \r\n  const updatePrivateState = async (llmResponse) => {\r\n    const privateStateRef = getPrivatePlayerStateRef(db, appId, userId);\r\n  \r\n    const updates = llmResponse.privateStateUpdates ? { ...llmResponse.privateStateUpdates } : {};\r\n  \r\n    const newPrivateChoices = llmResponse.privateChoices || [];\r\n    const newGroupChoices = llmResponse.groupChoices || [];\r\n    if (newPrivateChoices.length > 0 || newGroupChoices.length > 0) {\r\n      updates.choices = [...newPrivateChoices, ...newGroupChoices];\r\n    }\r\n  \r\n    if (Object.keys(updates).length > 0) {\r\n      await setDoc(privateStateRef, updates, { merge: true });\r\n    }\r\n  };\r\n\r\n  const getActionScope = (choice) => {\r\n    const npcMatch = choice.match(/(.+)에게 말을 건다/);\r\n    if (npcMatch) {\r\n        return `npc:${npcMatch[1].trim()}`;\r\n    }\r\n    return `location:${gameState.player.currentLocation}`;\r\n  };\r\n\r\n  const createCharacter = async (choice) => {\r\n    setIsTextLoading(true);\r\n    try {\r\n        const choiceKey = choice.split('.')[0];\r\n        const selectedProfession = professions[choiceKey];\r\n        if (selectedProfession) {\r\n            const privateStateRef = getPrivatePlayerStateRef(db, appId, userId);\r\n            await setDoc(privateStateRef, {\r\n                ...getDefaultPrivatePlayerState(),\r\n                characterCreated: true,\r\n                profession: selectedProfession.name,\r\n                initialMotivation: selectedProfession.motivation,\r\n            }, { merge: true });\r\n\r\n            const newEvent = {\r\n                story: `어둠침침한 여관 문이 삐걱거리며 열리더니, 새로운 모험가가 모습을 드러냅니다. 바로 '${getDisplayName(userId)}'라는 이름의 ${selectedProfession.name}입니다. 그의 마음 속에는 '${selectedProfession.motivation}'라는 동기가 자리잡고 있습니다.`,\r\n                choices: [\"여관을 둘러본다.\", \"다른 모험가에게 말을 건다.\", \"여관 주인에게 정보를 묻는다.\"]\r\n            };\r\n\r\n            await updatePublicState(newEvent, \"여관에 들어선다\");\r\n        }\r\n    } catch (e) {\r\n        console.error(\"등장 이벤트 추가 실패: \", e);\r\n        setLlmError(\"게임 세계에 합류하는 중 오류가 발생했습니다.\");\r\n    } finally {\r\n        setIsTextLoading(false);\r\n    }\r\n  };\r\n\r\n  const performPlayerAction = async (choice) => {\r\n    const gameStatusRef = getGameStatusRef(db, appId);\r\n    const scope = getActionScope(choice);\r\n\r\n    setIsTextLoading(true);\r\n    setLlmRetryPrompt({ playerChoice: choice });\r\n\r\n    try {\r\n        const currentLocks = (await getDoc(gameStatusRef)).data()?.actionLocks || {};\r\n        if (currentLocks[scope] && currentLocks[scope] !== userId) {\r\n            throw new Error(`현재 '${scope.split(':')[1]}'(은)는 다른 플레이어(${getDisplayName(currentLocks[scope])})가 사용 중입니다.`);\r\n        }\r\n        await setDoc(gameStatusRef, { actionLocks: { ...currentLocks, [scope]: userId } }, { merge: true });\r\n\r\n        const userPromptText = buildLlmPrompt(choice);\r\n        const llmResponse = await callGeminiTextLLM(userPromptText);\r\n\r\n        if (llmResponse) {\r\n            await updatePublicState(llmResponse, choice);\r\n            await updatePrivateState(llmResponse);\r\n            setLlmError(null);\r\n            setLlmRetryPrompt(null);\r\n        } else if (!llmError) {\r\n            setLlmError(\"LLM으로부터 유효한 응답을 받지 못했습니다.\");\r\n        }\r\n    } catch (error) {\r\n        console.error(\"행동 처리 중 오류:\", error.message);\r\n        setLlmError(error.message);\r\n    } finally {\r\n        const finalLocksDoc = await getDoc(gameStatusRef);\r\n        if (finalLocksDoc.exists()) {\r\n            const finalLocks = finalLocksDoc.data().actionLocks || {};\r\n            if (finalLocks[scope] === userId) {\r\n                delete finalLocks[scope];\r\n                await setDoc(gameStatusRef, { actionLocks: finalLocks }, { merge: true });\r\n            }\r\n        }\r\n        setIsTextLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleChoiceClick = async (choice) => {\r\n    if (isTextLoading) return;\r\n\r\n    if (!privatePlayerState.characterCreated) {\r\n        await createCharacter(choice);\r\n    } else {\r\n        await performPlayerAction(choice);\r\n    }\r\n  };\r\n  \r\n  const toggleAccordion = (key) => {\r\n    setAccordion(prev => ({ ...prev, [key]: !prev[key] }));\r\n  };\r\n\r\n  const LlmErrorModal = () => (\r\n    <div className=\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\">\r\n      <div className=\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 text-center\">\r\n        <h3 className=\"text-xl font-bold text-red-400\">오류가 발생했습니다</h3>\r\n        <p className=\"text-gray-200\">{llmError}</p>\r\n        <div className=\"flex justify-center gap-4\">\r\n          {llmRetryPrompt && (\r\n            <button\r\n              className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md\"\r\n              onClick={async () => {\r\n                setLlmError(null);\r\n                if (llmRetryPrompt.playerChoice) {\r\n                  await handleChoiceClick(llmRetryPrompt.playerChoice);\r\n                }\r\n              }}\r\n            >\r\n              재시도\r\n            </button>\r\n          )}\r\n          <button\r\n            className=\"px-4 py-2 bg-gray-600 hover:bg-gray-700 font-bold rounded-md\"\r\n            onClick={() => {\r\n              setLlmError(null);\r\n              setLlmRetryPrompt(null);\r\n            }}\r\n          >\r\n            닫기\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  if (showNicknameModal) {\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\">\r\n          <div className=\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4\">\r\n            <h3 className=\"text-xl font-bold text-gray-100\">닉네임을 입력하세요</h3>\r\n            <input className=\"w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg\" placeholder=\"닉네임\" value={nicknameInput} onChange={e => setNicknameInput(e.target.value)} onKeyDown={e => { if (e.key === 'Enter') handleNicknameSubmit(); }} autoFocus />\r\n            <button className=\"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md transition duration-300 disabled:opacity-50\" onClick={handleNicknameSubmit} disabled={!nicknameInput.trim()}>시작하기</button>\r\n          </div>\r\n        </div>\r\n    )\r\n  }\r\n\r\n  if (isLoading) {\r\n    return <div className=\"min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center\"><div className=\"animate-spin rounded-full h-16 w-16 border-b-2 border-gray-300\"></div><span className=\"ml-4 text-xl\">데이터를 불러오는 중...</span></div>;\r\n  }\r\n  \r\n  const renderGameLog = () => (\r\n    <div className=\"mb-2\">\r\n      <div className=\"flex items-center justify-between cursor-pointer select-none\" onClick={() => toggleAccordion('gameLog')}>\r\n        <h2 className=\"text-lg font-bold text-gray-100\">게임 로그</h2>\r\n        <div className=\"text-xl\">{accordion.gameLog ? '▼' : '▲'}</div>\r\n      </div>\r\n      {accordion.gameLog && (\r\n        <>\r\n          <div className=\"flex justify-end mb-2\">\r\n            <button className=\"px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded-md\" onClick={() => setShowResetModal(true)}>전체 데이터 초기화</button>\r\n          </div>\r\n          <div className=\"flex-grow bg-gray-700 p-4 rounded-md overflow-y-auto h-96 custom-scrollbar text-sm md:text-base leading-relaxed\" style={{ maxHeight: '24rem' }}>\r\n            {!privatePlayerState.characterCreated && (\r\n              <div className=\"mb-4 p-2 rounded bg-gray-900/50 text-center\">\r\n                  <p className=\"text-yellow-300 font-semibold italic text-lg\">모험의 서막</p>\r\n                  <p className=\"whitespace-pre-wrap mt-1\">당신은 어떤 운명을 선택하시겠습니까?</p>\r\n              </div>\r\n            )}\r\n            {(gameState.log || []).map((event, index) => (\r\n              <div key={index} className=\"mb-4 p-2 rounded bg-gray-900/50\">\r\n                {event?.actor?.displayName && event?.action && (\r\n                   <p className=\"text-yellow-300 font-semibold italic text-sm\">\r\n                      {event.actor.displayName} 님이 {event.action} 선택\r\n                   </p>\r\n                )}\r\n                <p className=\"whitespace-pre-wrap mt-1\" dangerouslySetInnerHTML={{ __html: (event?.publicStory ?? '').replace(/\\n/g, '<br />') }}></p>\r\n                {event?.groupStory && (privatePlayerState.groups || []).length > 0 && (\r\n                    <p className=\"whitespace-pre-wrap mt-2 p-2 rounded bg-green-900/30 border-l-4 border-green-400 text-green-200\">\r\n                        <span className=\"font-bold\">[그룹 이야기] </span>\r\n                        {event.groupStory}\r\n                    </p>\r\n                )}\r\n              </div>\r\n            ))}\r\n            {isTextLoading && (\r\n              <div className=\"flex justify-center items-center mt-4\">\r\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-300\"></div>\r\n                <span className=\"ml-3 text-gray-400\">이야기를 생성 중...</span>\r\n              </div>\r\n            )}\r\n            {Object.entries(actionLocks || {}).map(([scope, lockedBy]) => {\r\n              if (lockedBy === userId) return null;\r\n              return (\r\n                  <div key={scope} className=\"text-center text-yellow-400 font-semibold p-2 bg-black bg-opacity-20 rounded-md mt-2\">\r\n                      {`'${scope.split(':')[1]}' 영역은 ${getDisplayName(lockedBy)}님이 사용 중입니다...`}\r\n                  </div>\r\n              )\r\n            })}\r\n            <div ref={logEndRef} />\r\n          </div>\r\n        </>\r\n      )}\r\n    </div>\r\n  );\r\n\r\n  const renderChoices = () => (\r\n    <div className=\"flex flex-col gap-3\">\r\n        {privatePlayerState.characterCreated ? (\r\n            [...(gameState.choices || []), ...(privatePlayerState.choices || [])].map((choice, index) => {\r\n                if (!choice) return null;\r\n                const scope = getActionScope(choice);\r\n                const isLockedByOther = actionLocks[scope] && actionLocks[scope] !== userId;\r\n                const allPrivateChoices = privatePlayerState.choices || [];\r\n                const isPersonalChoice = allPrivateChoices.includes(choice);\r\n                const isPublicChoice = (gameState.choices || []).includes(choice);\r\n                \r\n                let buttonStyle = 'bg-blue-600 hover:bg-blue-700';\r\n                let prefix = '';\r\n\r\n                if (isPersonalChoice && !isPublicChoice) {\r\n                  buttonStyle = 'bg-green-600 hover:bg-green-700';\r\n                  prefix = '[개인/그룹] ';\r\n                }\r\n                \r\n                if (isLockedByOther) {\r\n                  buttonStyle = 'bg-gray-500 cursor-not-allowed';\r\n                  prefix = `[${getDisplayName(actionLocks[scope])} 사용 중] `;\r\n                }\r\n\r\n                return (\r\n                    <button\r\n                        key={`${choice}-${index}`}\r\n                        className={`px-6 py-3 font-bold rounded-md shadow-lg transition duration-300 disabled:opacity-50 ${buttonStyle} text-white`}\r\n                        onClick={() => handleChoiceClick(choice)}\r\n                        disabled={isTextLoading || isLockedByOther}\r\n                    >\r\n                        {prefix}{choice}\r\n                    </button>\r\n                )\r\n            })\r\n        ) : (\r\n            Object.keys(professions).map(key => (\r\n                <button\r\n                    key={key}\r\n                    onClick={() => handleChoiceClick(`${key}. ${professions[key].name}`)}\r\n                    disabled={isTextLoading}\r\n                    className=\"px-6 py-4 bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white font-bold rounded-md shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-wait text-left\"\r\n                >\r\n                    <p className=\"text-lg text-blue-300\">{`${key}. ${professions[key].name}`}</p>\r\n                    <p className=\"text-sm font-normal text-gray-300 mt-1\">{professions[key].motivation}</p>\r\n                </button>\r\n            ))\r\n        )}\r\n    </div>\r\n  );\r\n\r\n  const renderSidebar = () => (\r\n    <div className=\"w-full lg:w-1/3 flex flex-col space-y-6 bg-gray-700 p-4 rounded-lg shadow-inner\">\r\n        <div className=\"mb-2\">\r\n            <div className=\"flex items-center justify-between cursor-pointer select-none\" onClick={() => toggleAccordion('playerInfo')}>\r\n                <h4 className=\"text-md font-semibold text-gray-200\">내 정보</h4>\r\n                <div className=\"text-xl\">{accordion.playerInfo ? '▼' : '▲'}</div>\r\n            </div>\r\n            {accordion.playerInfo && (\r\n              <div className=\"bg-gray-600 p-3 rounded-md text-xs md:text-sm text-gray-300 space-y-1 h-48 overflow-y-auto custom-scrollbar\">\r\n                <p><span className=\"font-semibold text-blue-300\">이름:</span> {getDisplayName(userId)}</p>\r\n                <p><span className=\"font-semibold text-blue-300\">직업:</span> {privatePlayerState.profession || '미정'}</p>\r\n                <p><span className=\"font-semibold text-blue-300\">위치:</span> {gameState.player.currentLocation || '알 수 없는 곳'}</p>\r\n                <p><span className=\"font-semibold text-blue-300\">능력치:</span> 힘({privatePlayerState.stats?.strength ?? 10}) 지능({privatePlayerState.stats?.intelligence ?? 10}) 민첩({privatePlayerState.stats?.agility ?? 10}) 카리스마({privatePlayerState.stats?.charisma ?? 10})</p>\r\n                <p><span className=\"font-semibold text-blue-300\">인벤토리:</span> {(privatePlayerState.inventory || []).join(', ') || '비어있음'}</p>\r\n                <p><span className=\"font-semibold text-blue-300\">퀘스트:</span> {(privatePlayerState.activeQuests || []).join(', ') || '없음'}</p>\r\n                <p><span className=\"font-semibold text-blue-300\">단서:</span> {(privatePlayerState.knownClues || []).join(', ') || '없음'}</p>\r\n                <p><span className=\"font-semibold text-green-300\">소속 그룹:</span> {(privatePlayerState.groups || []).join(', ') || '없음'}</p>\r\n                <div>\r\n                    <span className=\"font-semibold text-yellow-300\">NPC 관계:</span>\r\n                    <ul className=\"list-disc list-inside ml-4\">\r\n                        {Object.entries(privatePlayerState.npcRelations || {}).length > 0 ? \r\n                            Object.entries(privatePlayerState.npcRelations).map(([name, value]) => <li key={name}>{`${name}: ${value}`}</li>) :\r\n                            <li>알려진 관계 없음</li>\r\n                        }\r\n                    </ul>\r\n                </div>\r\n              </div>\r\n            )}\r\n        </div>\r\n\r\n        <div className=\"mb-2\">\r\n            <div className=\"flex items-center justify-between cursor-pointer select-none\" onClick={() => toggleAccordion('chronicle')}>\r\n                <h4 className=\"text-md font-semibold text-gray-200\">나의 연대기</h4>\r\n                <div className=\"text-xl\">{accordion.chronicle ? '▼' : '▲'}</div>\r\n            </div>\r\n            {accordion.chronicle && (\r\n                <div className=\"bg-gray-600 p-3 rounded-md text-xs md:text-sm text-gray-300 space-y-1 h-32 overflow-y-auto custom-scrollbar\">\r\n                    {(knownMajorEvents || []).length > 0 ? (\r\n                        <ul className=\"list-disc list-inside\">\r\n                            {(knownMajorEvents || []).map((event) => <li key={event?.id}>{event?.summary ?? '기록이 손상되었습니다.'}</li>)}\r\n                        </ul>\r\n                    ) : (\r\n                        <p>아직 알려진 주요 사건이 없습니다. 세상을 탐험해 보세요.</p>\r\n                    )}\r\n                </div>\r\n            )}\r\n        </div>\r\n        \r\n        <div className=\"mb-2\">\r\n            <div className=\"flex items-center justify-between cursor-pointer select-none\" onClick={() => toggleAccordion('users')}>\r\n                <h4 className=\"text-md font-semibold text-gray-200\">현재 플레이어들</h4>\r\n                <div className=\"text-xl\">{accordion.users ? '▼' : '▲'}</div>\r\n            </div>\r\n            {accordion.users && (\r\n                <div className=\"bg-gray-600 p-3 rounded-md h-32 overflow-y-auto custom-scrollbar\">\r\n                    {(activeUsers || []).length > 0 ? (\r\n                        <ul className=\"text-sm text-gray-300 space-y-1\">\r\n                            {(activeUsers || []).map(user => (\r\n                                <li key={user.id} className=\"truncate p-1 rounded-md\">\r\n                                    <span className=\"font-medium text-green-300\">{getDisplayName(user.id)}</span>\r\n                                    <span className=\"text-gray-400 text-xs\"> ({user.profession || '모험가'})</span>\r\n                                </li>\r\n                            ))}\r\n                        </ul>\r\n                    ) : <p className=\"text-sm text-gray-400\">활동 중인 플레이어가 없습니다.</p>}\r\n                </div>\r\n            )}\r\n        </div>\r\n        \r\n        <div className=\"mb-2\">\r\n            <div className=\"flex items-center justify-between cursor-pointer select-none\" onClick={() => toggleAccordion('chat')}>\r\n                <h4 className=\"text-md font-semibold text-gray-200\">공개 채팅</h4>\r\n                <div className=\"text-xl\">{accordion.chat ? '▼' : '▲'}</div>\r\n            </div>\r\n            {accordion.chat && (\r\n                <div className=\"bg-gray-600 p-3 rounded-md flex flex-col h-48\">\r\n                    <div className=\"flex-grow overflow-y-auto custom-scrollbar mb-3 text-sm space-y-2\">\r\n                        {(chatMessages || []).map((msg) => (\r\n                            <div key={msg.id}><p><span className=\"font-medium text-yellow-300\">{getDisplayName(msg.userId)}:</span> {msg.message}</p></div>\r\n                        ))}\r\n                        <div ref={chatEndRef} />\r\n                    </div>\r\n                    <div className=\"flex\">\r\n                        <input type=\"text\" className=\"flex-grow p-2 rounded-l-md bg-gray-700 border border-gray-600\" value={currentChatMessage} onChange={(e) => setCurrentChatMessage(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && sendChatMessage()} disabled={!isAuthReady} />\r\n                        <button className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 font-bold rounded-r-md\" onClick={sendChatMessage} disabled={!isAuthReady || !currentChatMessage.trim()}>보내기</button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center justify-center p-4 font-sans\">\r\n      {llmError && <LlmErrorModal />}\r\n      {showResetModal && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50\">\r\n          <div className=\"bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4\">\r\n            <h3 className=\"text-xl font-bold text-red-400\">⚠️ 모든 데이터를 초기화할까요?</h3>\r\n            <p className=\"text-gray-200\">이 작업은 되돌릴 수 없습니다. 모든 시나리오, 로그, 유저, 채팅 데이터가 삭제됩니다.</p>\r\n            <div className=\"flex justify-end gap-3\">\r\n              <button className=\"px-4 py-2 bg-gray-600 hover:bg-gray-700 font-bold rounded-md\" onClick={() => setShowResetModal(false)} disabled={isResetting}>취소</button>\r\n              <button className=\"px-4 py-2 bg-red-600 hover:bg-red-700 font-bold rounded-md\" onClick={resetAllGameData} disabled={isResetting}>{isResetting ? '초기화 중...' : '초기화'}</button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"w-full max-w-5xl bg-gray-800 rounded-lg shadow-xl p-6 md:p-8 flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6\">\r\n        <div className=\"flex flex-col w-full lg:w-2/3 space-y-6\">\r\n            {renderGameLog()}\r\n            {renderChoices()}\r\n        </div>\r\n        {renderSidebar()}\r\n      </div>\r\n\r\n      <style>\r\n        {`\r\n        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');\r\n        body { font-family: 'Noto Sans KR', sans-serif; }\r\n        .custom-scrollbar::-webkit-scrollbar { width: 8px; }\r\n        .custom-scrollbar::-webkit-scrollbar-track { background: #4a5568; border-radius: 10px; }\r\n        .custom-scrollbar::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 10px; }\r\n        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }\r\n        `}\r\n      </style>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default App;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}